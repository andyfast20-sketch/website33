<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latency Dashboard - Super Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; font-weight: 700; }
        .panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 30px; margin-bottom: 20px; }
        .panel h2 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .call-list { display: grid; gap: 12px; max-height: 500px; overflow-y: auto; }
        .call-card { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.3s; border-left: 4px solid rgba(255, 255, 255, 0.3); }
        .call-card:hover { background: rgba(0, 0, 0, 0.4); border-left-color: #2ecc71; }
        .call-card.selected { background: rgba(46, 204, 113, 0.2); border-left-color: #2ecc71; }
        .call-label { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .call-label input { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 6px 10px; color: white; font-size: 13px; font-weight: 600; width: 120px; }
        .call-label button { background: rgba(46, 204, 113, 0.8); border: none; border-radius: 6px; padding: 6px 14px; color: white; font-weight: 600; cursor: pointer; font-size: 12px; }
        .call-label button:hover { background: rgba(46, 204, 113, 1); }
        .call-meta { font-size: 13px; opacity: 0.8; margin-bottom: 4px; }
        .latency-grid { display: grid; gap: 15px; margin-top: 20px; }
        .latency-event { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 14px; border-left: 4px solid #667eea; }
        .latency-event.green { border-left-color: #2ecc71; }
        .latency-event.orange { border-left-color: #f39c12; }
        .latency-event.red { border-left-color: #e74c3c; }
        .event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .event-name { font-size: 15px; font-weight: 700; }
        .event-time { font-size: 18px; font-weight: 800; }
        .event-desc { font-size: 13px; opacity: 0.8; }
        .turn-group { background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .turn-header { font-size: 16px; font-weight: 700; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3); }
        .loading { text-align: center; padding: 40px; font-size: 18px; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚è±Ô∏è Latency Dashboard</h1>
            <button class="btn btn-primary" onclick="window.location.href='/super-admin.html'">‚Üê Back to Super Admin</button>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 3fr; gap: 20px;">
            <!-- Call List Panel -->
            <div class="panel">
                <h2>üìû Recent Calls</h2>
                <div class="call-list" id="callList">
                    <div class="loading">Loading calls...</div>
                </div>
            </div>

            <!-- Latency Events Panel -->
            <div class="panel">
                <h2>üìä Latency Breakdown</h2>
                <div id="latencyContent">
                    <div class="loading">Select a call to view latency breakdown</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedCallUuid = null;

        async function loadCalls() {
            try {
                const resp = await fetch('/api/super-admin/recent-calls');
                const data = await resp.json();
                const container = document.getElementById('callList');
                
                if (!data.success || !data.calls || data.calls.length === 0) {
                    container.innerHTML = '<div class="loading">No calls found</div>';
                    return;
                }

                container.innerHTML = '';
                data.calls.forEach(call => {
                    const card = document.createElement('div');
                    card.className = 'call-card';
                    card.onclick = () => selectCall(call.call_uuid, card);
                    
                    const startTime = new Date(call.start_time);
                    const label = call.call_label || '';
                    
                    card.innerHTML = `
                        <div class="call-label">
                            <input type="text" value="${label}" placeholder="Label (e.g., Test 1)" 
                                   onchange="updateLabel('${call.call_uuid}', this.value)" onclick="event.stopPropagation()">
                            <button onclick="event.stopPropagation(); updateLabel('${call.call_uuid}', this.previousElementSibling.value)">üíæ</button>
                        </div>
                        <div class="call-meta">üìû ${call.caller_number || 'Unknown'}</div>
                        <div class="call-meta">üïí ${startTime.toLocaleString()}</div>
                        <div class="call-meta">‚è±Ô∏è ${call.duration || 0}s duration</div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                console.error('Failed to load calls:', e);
                document.getElementById('callList').innerHTML = '<div class="loading" style="color: #e74c3c;">Error loading calls</div>';
            }
        }

        async function updateLabel(callUuid, label) {
            try {
                await fetch('/api/super-admin/update-call-label', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({call_uuid: callUuid, label: label})
                });
            } catch (e) {
                console.error('Failed to update label:', e);
            }
        }

        async function selectCall(callUuid, element) {
            selectedCallUuid = callUuid;
            document.querySelectorAll('.call-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            await loadLatencyEvents(callUuid);
        }

        async function loadLatencyEvents(callUuid) {
            const container = document.getElementById('latencyContent');
            container.innerHTML = '<div class="loading">Loading latency data...</div>';
            
            try {
                const resp = await fetch(`/api/super-admin/call-latency-events/${callUuid}`);
                const data = await resp.json();
                
                if (!data.success || !data.events || data.events.length === 0) {
                    container.innerHTML = '<div class="loading">No latency data available for this call</div>';
                    return;
                }

                // Group by turn
                const turns = {};
                data.events.forEach(evt => {
                    const turn = evt.turn_index;
                    if (!turns[turn]) turns[turn] = [];
                    turns[turn].push(evt);
                });

                container.innerHTML = '';
                Object.keys(turns).sort((a, b) => parseInt(a) - parseInt(b)).forEach(turnIndex => {
                    const turnDiv = document.createElement('div');
                    turnDiv.className = 'turn-group';
                    turnDiv.innerHTML = `<div class="turn-header">Turn ${turnIndex}</div>`;
                    
                    const events = turns[turnIndex];
                    events.forEach(evt => {
                        const ms = Math.round(evt.ms_from_turn_start || 0);
                        let color = 'green';
                        if (ms > 2000) color = 'red';
                        else if (ms > 1000) color = 'orange';
                        
                        const eventDiv = document.createElement('div');
                        eventDiv.className = `latency-event ${color}`;
                        eventDiv.innerHTML = `
                            <div class="event-header">
                                <div class="event-name">${formatEventName(evt.event_name)}</div>
                                <div class="event-time ${color}">${ms}ms</div>
                            </div>
                            <div class="event-desc">${getEventDescription(evt.event_name)}</div>
                        `;
                        turnDiv.appendChild(eventDiv);
                    });
                    
                    container.appendChild(turnDiv);
                });
            } catch (e) {
                console.error('Failed to load latency events:', e);
                container.innerHTML = '<div class="loading" style="color: #e74c3c;">Error loading latency data</div>';
            }
        }

        function formatEventName(name) {
            return name.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function getEventDescription(name) {
            const descriptions = {
                'caller_stopped': 'Caller finished speaking (VAD detected end of speech)',
                'brain_triggered_openrouter': 'OpenRouter brain request sent',
                'brain_triggered_openai': 'OpenAI brain request sent',
                'first_token_openrouter': 'First text token received from OpenRouter',
                'first_audio_speechmatics': 'First audio byte received from Speechmatics TTS',
                'first_audio_openai': 'First audio playback started from OpenAI'
            };
            return descriptions[name] || 'Latency event';
        }

        loadCalls();
    </script>
</body>
</html>
