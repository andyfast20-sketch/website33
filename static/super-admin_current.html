<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Secure Access</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-container { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border-radius: 24px; padding: 50px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); text-align: center; max-width: 450px; width: 100%; border: 1px solid rgba(255, 255, 255, 0.2); }
        .login-container h1 { color: white; font-size: 32px; margin-bottom: 10px; font-weight: 700; }
        .login-container p { color: rgba(255, 255, 255, 0.8); margin-bottom: 40px; font-size: 16px; }
        .input-group { margin-bottom: 30px; }
        .input-group input { width: 100%; padding: 18px 24px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 18px; text-align: center; letter-spacing: 4px; transition: all 0.3s; }
        .input-group input::placeholder { color: rgba(255, 255, 255, 0.5); letter-spacing: normal; }
        .input-group input:focus { outline: none; border-color: white; background: rgba(255, 255, 255, 0.2); box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
        .btn-login { width: 100%; padding: 18px; border: none; border-radius: 12px; background: white; color: #667eea; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .error-message { color: #ff6b6b; background: rgba(255, 107, 107, 0.2); padding: 12px; border-radius: 8px; margin-top: 20px; display: none; font-weight: 600; }
        .main-container { display: none; max-width: 1400px; width: 100%; }
        .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: white; font-size: 28px; font-weight: 700; }
        .btn-logout { padding: 12px 24px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background: rgba(255, 255, 255, 0.3); }
        .panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 30px; margin-bottom: 20px; color: white; }
        .panel h2 { font-size: 22px; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .api-keys-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .api-key-section { background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; border-left: 4px solid #667eea; }
        .api-key-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: white; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .api-key-section .status { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 600; }
        .status.configured { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .status.not-configured { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .input-wrapper { position: relative; margin-bottom: 10px; }
        .input-wrapper input { width: 100%; padding: 10px 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; font-family: 'Courier New', monospace; transition: all 0.3s; }
        .input-wrapper input::placeholder { color: rgba(255, 255, 255, 0.4); }
        .input-wrapper input:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.15); }
        .btn-save { padding: 8px 16px; border: none; border-radius: 6px; background: #2ecc71; color: white; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; width: 100%; }
        .btn-save:hover { background: #27ae60; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4); }
        .brain-selector { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .brain-selector h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: white; }
        .brain-options { display: flex; gap: 15px; }
        .brain-option { flex: 1; padding: 20px; border: 3px solid rgba(255, 255, 255, 0.2); border-radius: 12px; background: rgba(255, 255, 255, 0.05); cursor: pointer; transition: all 0.3s; text-align: center; }
        .brain-option:hover { border-color: rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.1); }
        .brain-option.selected { border-color: #2ecc71; background: rgba(46, 204, 113, 0.2); }
        .brain-option input[type="radio"] { display: none; }
        .brain-option-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: white; }
        .brain-option-desc { font-size: 13px; color: rgba(255, 255, 255, 0.7); }
        .alert { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: min(980px, calc(100vw - 40px)); width: calc(100vw - 40px); padding: 15px 20px; border-radius: 8px; font-weight: 600; display: none; font-size: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); }
        .alert-success { background: rgba(46, 204, 113, 0.3); color: #2ecc71; border: 2px solid #2ecc71; }
        .alert-error { background: rgba(231, 76, 60, 0.3); color: #e74c3c; border: 2px solid #e74c3c; }
        .alert-warning { background: rgba(243, 156, 18, 0.95); color: white; border: 2px solid rgba(255, 255, 255, 0.3); }
        .alert-info { background: rgba(52, 152, 219, 0.3); color: #3498db; border: 2px solid #3498db; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
        .filler-section { background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .filler-section h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: white; }
        .filler-section textarea { width: 100%; min-height: 150px; padding: 14px 18px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; font-family: inherit; resize: vertical; }
        .filler-section textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.15); }
        .hint { font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-top: 8px; font-style: italic; }
        .filler-slot { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px; border: 2px solid rgba(255, 255, 255, 0.2); transition: all 0.3s; }
        .filler-slot.has-audio { border-color: rgba(46, 204, 113, 0.5); background: rgba(46, 204, 113, 0.1); }
        .filler-slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filler-slot-title { font-size: 16px; font-weight: 700; color: white; }
        .filler-slot-status { font-size: 12px; padding: 4px 10px; border-radius: 6px; font-weight: 600; }
        .filler-slot-status.filled { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .filler-slot-status.empty { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .filler-slot-controls { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .btn-slot { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-slot.play { background: rgba(52, 152, 219, 0.8); color: white; }
        .btn-slot.regenerate { background: rgba(155, 89, 182, 0.8); color: white; }
        .btn-slot.delete { background: rgba(231, 76, 60, 0.8); color: white; }
        .btn-slot:hover { transform: translateY(-1px); opacity: 1; }
        .btn-slot:disabled { opacity: 0.5; cursor: not-allowed; }
        .accounts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 1200px) { .accounts-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .accounts-grid { grid-template-columns: 1fr; } }
        .account-card { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 18px; border-left: 4px solid #667eea; display: flex; flex-direction: column; gap: 12px; transition: all 0.3s; height: 100%; }
        .account-card:hover { background: rgba(0, 0, 0, 0.4); border-left-color: #2ecc71; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .account-info { flex: 1; }
        .account-name { font-size: 15px; font-weight: 700; color: white; margin-bottom: 8px; }
        .account-email { font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 5px; }
        .account-phone { font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 8px; }
        .account-credits { text-align: center; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .credits-amount { font-size: 24px; font-weight: 800; color: #2ecc71; }
        .credits-label { font-size: 11px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        .credit-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: center; }
        .credit-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: white; }
        .credit-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .credit-btn.add { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .credit-btn.add:hover { background: linear-gradient(135deg, #27ae60, #229954); }
        .credit-btn.remove { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .credit-btn.remove:hover { background: linear-gradient(135deg, #c0392b, #a93226); }
        .call-analysis-section { margin-top: 20px; }
        .call-selector { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .call-item { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px 15px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; }
        .call-item:hover { background: rgba(255, 255, 255, 0.1); border-left-color: #2ecc71; }
        .call-item.selected { background: rgba(46, 204, 113, 0.2); border-left-color: #2ecc71; }
        .call-time { font-size: 12px; color: rgba(255, 255, 255, 0.6); }
        .call-from { font-size: 14px; font-weight: 600; color: white; margin: 4px 0; }
        .call-duration { font-size: 12px; color: rgba(255, 255, 255, 0.7); }
        .timing-stage { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #667eea; transition: all 0.3s; }
        .timing-stage.optimal { border-left-color: #2ecc71; }
        .timing-stage.good { border-left-color: #3498db; }
        .timing-stage.slow { border-left-color: #f39c12; }
        .timing-stage.critical_bottleneck { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.15); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .stage-name { font-size: 16px; font-weight: 700; color: white; }
        .stage-duration { font-size: 18px; font-weight: 800; color: #2ecc71; }
        .stage-duration.slow { color: #f39c12; }
        .stage-duration.critical { color: #e74c3c; }
        .stage-desc { font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px; }
        .stage-note { font-size: 12px; color: #e74c3c; font-weight: 600; margin-top: 8px; background: rgba(231, 76, 60, 0.2); padding: 6px 10px; border-radius: 4px; }
        .bottleneck-card { background: linear-gradient(135deg, rgba(231, 76, 60, 0.2) 0%, rgba(192, 57, 43, 0.2) 100%); border: 2px solid #e74c3c; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .bottleneck-title { font-size: 20px; font-weight: 800; color: #e74c3c; margin-bottom: 15px; }
        .recommendation { background: rgba(46, 204, 113, 0.2); border-radius: 8px; padding: 12px; margin-top: 10px; }
        .recommendation-title { font-size: 14px; font-weight: 700; color: #2ecc71; margin-bottom: 8px; }
        .alternative { font-size: 13px; color: rgba(255, 255, 255, 0.9); padding: 6px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .alternative:last-child { border-bottom: none; }
        .btn-analyze { padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 15px; }
        .btn-analyze:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn-analyze:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Floating Streaming Status Indicator */
        .streaming-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: move;
            user-select: none;
        }
        .streaming-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: flicker 1.5s infinite;
        }
        .streaming-indicator.active {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        .streaming-indicator.inactive {
            background: #e74c3c;
            box-shadow: 0 0 10px #e74c3c;
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .streaming-label {
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .streaming-mode {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Service Health Monitor */
        .health-monitor {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .health-monitor-title {
            font-size: 12px;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .health-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .health-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
        }
        .health-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        .health-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }
        .health-circle::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            padding: 4px;
            background: linear-gradient(45deg, currentColor, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.6;
        }
        .health-circle.ok {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: #2ecc71;
            animation: pulse-green 2s ease-in-out infinite;
        }
        .health-circle.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #e74c3c;
            animation: pulse-red 1s ease-in-out infinite;
        }
        .health-circle.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #f39c12;
            animation: pulse-orange 1.5s ease-in-out infinite;
        }
        .health-circle.checking {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #3498db;
            animation: pulse-blue 1.5s ease-in-out infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.9), 0 0 30px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0), 0 0 40px rgba(231, 76, 60, 0.3); }
        }
        @keyframes pulse-orange {
            0%, 100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.8); }
            50% { box-shadow: 0 0 0 12px rgba(243, 156, 18, 0); }
        }
        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
        }
        .health-icon {
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .health-label {
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-align: center;
            line-height: 1.2;
            white-space: nowrap;
        }
        .health-status {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            white-space: nowrap;
        }
        
        /* Modal for Health Details */
        .health-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .health-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .health-modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }
        
        /* Global Instructions Modal */
        .instructions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .instructions-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .instructions-modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .instructions-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .instructions-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .instructions-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
        }
        .instructions-modal-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }
        .instructions-modal-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
        }
        .instructions-modal-textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.4);
        }
        .instructions-modal-hint {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
            font-style: italic;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn-open-instructions {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-open-instructions:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }
        
        /* Diagnostics Modal */
        .diagnostics-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .diagnostics-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .diagnostics-modal-content {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.98) 0%, rgba(52, 73, 94, 0.98) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(52, 152, 219, 0.3);
        }
        .diagnostics-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(231, 76, 60, 0.3);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1;
        }
        .diagnostics-modal-close:hover {
            background: rgba(231, 76, 60, 0.6);
            transform: rotate(90deg);
        }
        .diagnostics-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .diagnostics-modal-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
        }
        .console-logs {
            background: #000;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .console-log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #ddd;
        }
        .console-log-entry.error {
            color: #ff6b6b;
            font-weight: 600;
        }
        .console-log-entry.warn {
            color: #f39c12;
        }
        .console-log-entry.info {
            color: #3498db;
        }
        .console-log-timestamp {
            color: #888;
            margin-right: 8px;
        }
        .error-analysis {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }
        .error-analysis.show {
            display: block;
            animation: slideUp 0.3s;
        }
        .error-analysis-title {
            font-size: 18px;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .error-analysis-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: white;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .btn-analyze-errors {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .btn-analyze-errors:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        .btn-analyze-errors:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-copy-analysis {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-copy-analysis:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .health-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .health-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .health-modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
        }
        .health-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            text-align: center;
            margin-bottom: 10px;
        }
        .health-modal-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .health-modal-details {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .health-modal-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .health-modal-detail:last-child {
            border-bottom: none;
        }
        .health-modal-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }
        .health-modal-value {
            font-size: 13px;
            color: white;
            font-weight: 700;
        }
        .health-modal-status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
        }
        .health-modal-status.ok {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        .health-modal-status.error {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        .health-modal-status.warning {
            background: rgba(243, 156, 18, 0.3);
            color: #f39c12;
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <h1>üîê Super Admin</h1>
        <p>Secure Access Required</p>
        <div class="input-group">
            <input type="password" id="passwordInput" placeholder="Enter Password" autocomplete="off">
        </div>
        <button class="btn-login" onclick="attemptLogin()">Unlock</button>
        <div class="error-message" id="errorMessage">Incorrect password. Access denied.</div>

        <!-- First-time setup (local installs). Requires SUPER_ADMIN_SETUP_TOKEN on the server. -->
        <div id="setupBox" style="display:none; margin-top: 18px; padding-top: 18px; border-top: 1px solid rgba(255,255,255,0.18); width: 100%;">
            <div style="font-weight: 900; color: rgba(255,255,255,0.92); margin-bottom: 10px; text-align: center;">First-time setup</div>
            <div class="input-group">
                <input type="text" id="setupTokenInput" placeholder="Setup Token (SUPER_ADMIN_SETUP_TOKEN)" autocomplete="off">
            </div>
            <div class="input-group">
                <input type="text" id="setupUsernameInput" placeholder="Super Admin Username (optional)" autocomplete="off">
            </div>
            <div class="input-group">
                <input type="password" id="setupPasswordInput" placeholder="New Password (6+ chars)" autocomplete="new-password">
            </div>
            <div class="input-group">
                <input type="password" id="setupPasswordConfirmInput" placeholder="Confirm Password" autocomplete="new-password">
            </div>
            <button class="btn-login" onclick="attemptBootstrap()" style="margin-top: 6px;">Set Password</button>
            <div class="error-message" id="setupMessage" style="display:none; margin-top: 10px;"></div>
        </div>
    </div>

    <div class="main-container" id="mainDashboard">
        <!-- Floating Speechmatics Streaming Status -->
        <div class="streaming-status" id="streamingStatus" style="display: none;">
            <div class="streaming-indicator" id="streamingIndicator"></div>
            <div>
                <div class="streaming-label" id="streamingLabel">Checking...</div>
                <div class="streaming-mode" id="streamingMode"></div>
            </div>
        </div>

        <!-- Live Brain Usage (OpenAI vs DeepSeek vs Groq) -->
        <div class="panel" style="margin-bottom: 25px;">
            <div class="panel-header">
                <h2>üß† Live Brain Usage</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Shows what % of assistant turns were produced by OpenAI vs DeepSeek vs Groq in the current active call</p>
            </div>
            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; margin-top: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                <div>
                    <div style="font-weight: 800;">Active Call</div>
                    <div id="liveBrainUsageCall" style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Checking‚Ä¶</div>
                    <div id="liveBrainUsageProviders" style="font-size: 12px; margin-top: 6px; opacity: 0.95;"></div>
                    <div id="liveBrainUsageReasons" style="font-size: 12px; margin-top: 4px; opacity: 0.75;"></div>
                </div>
                <div id="liveBrainUsageText" style="font-size: 16px; font-weight: 900;">OpenAI 0% | DeepSeek 0% | Groq 0%</div>
            </div>
        </div>
        
        <div class="header">
            <h1>üîß Super Admin - System Configuration</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn-logout" onclick="window.open('/', '_blank')" style="background: rgba(52, 152, 219, 0.3);">
                    üåê Open Website
                </button>
                <button class="btn-logout" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <!-- Content Moderation Alerts (Top Banner) -->
        <div id="contentModerationBanner" onclick="showFlaggedAccountsModal()" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); padding: 18px 20px; border-radius: 14px; margin: 0 0 18px 0; cursor: pointer; border: 2px solid rgba(255,255,255,0.25); box-shadow: 0 10px 30px rgba(0,0,0,0.25);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="font-size: 34px; line-height: 1;">üö®</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 800; color: white; letter-spacing: 0.3px;">Content Moderation Alerts</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 2px;">Click to view flagged & suspended accounts</div>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.18); padding: 10px 16px; border-radius: 12px; text-align: center; min-width: 110px;">
                    <div id="flaggedAccountsBadge" style="font-size: 24px; font-weight: 900; color: white;">‚Ä¶</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.85); margin-top: 2px;">Flagged</div>
                </div>
            </div>
        </div>

        <!-- Service Health Monitor -->
        <div class="health-monitor">
            <div class="health-monitor-title">
                <span>‚ö°</span> LIVE SERVICE STATUS
            </div>
            <div class="health-grid">
                <div class="health-item" onclick="showHealthDetails('openai')">
                    <div class="health-circle checking" id="health-openai">
                        <div class="health-icon">üß†</div>
                    </div>
                    <div class="health-label">OpenAI</div>
                    <div class="health-status" id="status-openai">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('speechmatics')">
                    <div class="health-circle checking" id="health-speechmatics">
                        <div class="health-icon">üéôÔ∏è</div>
                    </div>
                    <div class="health-label">Speechmatics</div>
                    <div class="health-status" id="status-speechmatics">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('vonage')">
                    <div class="health-circle checking" id="health-vonage">
                        <div class="health-icon">üìû</div>
                    </div>
                    <div class="health-label">Vonage</div>
                    <div class="health-status" id="status-vonage">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('database')">
                    <div class="health-circle checking" id="health-database">
                        <div class="health-icon">üíæ</div>
                    </div>
                    <div class="health-label">Database</div>
                    <div class="health-status" id="status-database">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('webhook')">
                    <div class="health-circle checking" id="health-webhook">
                        <div class="health-icon">üåê</div>
                    </div>
                    <div class="health-label">Webhook</div>
                    <div class="health-status" id="status-webhook">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('deepseek')">
                    <div class="health-circle checking" id="health-deepseek">
                        <div class="health-icon">üîÆ</div>
                    </div>
                    <div class="health-label">DeepSeek</div>
                    <div class="health-status" id="status-deepseek">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('credits')">
                    <div class="health-circle checking" id="health-credits">
                        <div class="health-icon">üí≥</div>
                    </div>
                    <div class="health-label">Credits</div>
                    <div class="health-status" id="status-credits">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('server')">
                    <div class="health-circle checking" id="health-server">
                        <div class="health-icon">üñ•Ô∏è</div>
                    </div>
                    <div class="health-label">Server</div>
                    <div class="health-status" id="status-server">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('ngrok')">
                    <div class="health-circle checking" id="health-ngrok">
                        <div class="health-icon">üåâ</div>
                    </div>
                    <div class="health-label">Ngrok Tunnel</div>
                    <div class="health-status" id="status-ngrok">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('cloudflare')" ondblclick="startCloudflare(event)">
                    <div class="health-circle checking" id="health-cloudflare">
                        <div class="health-icon">‚òÅÔ∏è</div>
                    </div>
                    <div class="health-label">Cloudflare Tunnel</div>
                    <div class="health-status" id="status-cloudflare">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('activecalls')">
                    <div class="health-circle checking" id="health-activecalls">
                        <div class="health-icon">üìû</div>
                    </div>
                    <div class="health-label">Active Calls</div>
                    <div class="health-status" id="status-activecalls">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('resources')">
                    <div class="health-circle checking" id="health-resources">
                        <div class="health-icon">‚ö°</div>
                    </div>
                    <div class="health-label">Resources</div>
                    <div class="health-status" id="status-resources">Checking...</div>
                </div>
            </div>
        </div>

        <!-- System Controls Panel -->
        <div class="panel" style="margin-bottom: 25px;">
            <div class="panel-header">
                <h2>üõ†Ô∏è System Controls</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Quick diagnostic and recovery tools</p>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9);" onclick="testCall()">
                    üìû Test Call Sarah
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);" onclick="testVoicePipeline()">
                    üî¨ Diagnose Voice Issues
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #10ac84, #01a3a4);" onclick="autoFixVoice()">
                    ü§ñ Auto-Fix Voice Issues
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" onclick="restartVoiceEngine()">
                    üîÑ Restart Voice Engine
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #ff4757, #c23616);" onclick="restartServer()">
                    üîÅ Restart Server
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #f39c12, #e67e22);" onclick="clearCallCache()">
                    üóëÔ∏è Clear Call Cache
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);" onclick="checkWebhooks()">
                    üåê Verify Webhooks
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #1abc9c, #16a085);" onclick="testOpenAI()">
                    üß† Test OpenAI Connection
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #34495e, #2c3e50);" onclick="viewServerLogs()">
                    üìã View Recent Logs
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" onclick="openDiagnostics()">
                    üîç Console Diagnostics
                </button>
                <button class="btn" id="reloadConfigBtn" style="background: linear-gradient(135deg, #f39c12, #e67e22); display: none;" onclick="reloadConfiguration()">
                    üîÑ Reload Configuration
                </button>
            </div>
        </div>

        <!-- Recent Calls (for Brain Provider audit) -->
        <div class="panel" style="margin-bottom: 25px;">
            <div class="panel-header">
                <h2>üìû Recent Calls</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Shows the last 5 completed calls and which brain was selected vs actually used</p>
            </div>
            <div class="call-selector">
                <div id="recentCallsList" style="text-align: center; color: rgba(255,255,255,0.75); padding: 16px;">Loading‚Ä¶</div>
            </div>
        </div>

        <!-- Tunnel Provider Configuration -->
        <div class="panel" style="margin-bottom: 25px;">
            <div class="panel-header">
                <h2>üåê Tunnel Provider</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Choose your public tunnel provider (ngrok or Cloudflare)</p>
            </div>
            
            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; margin-top: 15px;">
                <!-- Provider Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">Provider:</label>
                    <select id="tunnelProvider" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;" onchange="handleTunnelProviderChange()">
                        <option value="ngrok">ngrok (Free, Random URLs)</option>
                        <option value="cloudflare">Cloudflare Quick (Temporary .trycloudflare.com URLs)</option>
                    </select>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 8px;">
                        <strong>ngrok:</strong> Free random URLs (~50-150ms latency)<br>
                        <strong>Cloudflare:</strong> Temporary URLs (~20-80ms faster, more stable)
                    </div>
                </div>

                <!-- Cloudflare Options (hidden by default) -->
                <div id="cloudflareOptions" style="display: none; margin-bottom: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">Custom Domain (Optional):</label>
                    <input type="text" id="cloudflareDomain" placeholder="example.yourdomain.com" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; margin-bottom: 10px;">
                    
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">Tunnel Token (Optional):</label>
                    <input type="password" id="cloudflareTunnelToken" placeholder="eyJhIjoixxxx..." style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; font-family: 'Courier New', monospace;">
                    
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 8px;">
                        Leave blank for temporary .trycloudflare.com URLs (no setup required)
                    </div>
                </div>

                <!-- Current Tunnel Status -->
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600;">Status:</span>
                        <span id="tunnelStatus" style="padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; background: rgba(231, 76, 60, 0.2); color: #e74c3c;">Not Running</span>
                    </div>
                    <div id="tunnelUrlDisplay" style="display: none;">
                        <span style="font-weight: 600; display: block; margin-bottom: 5px;">Public URL:</span>
                        <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 6px; font-size: 13px; word-break: break-all; color: #2ecc71;" id="tunnelUrl">-</code>
                    </div>
                </div>

                <!-- Vonage Webhook URLs -->
                <div style="background: rgba(52, 152, 219, 0.15); border: 2px solid rgba(52, 152, 219, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <div style="font-weight: 700; font-size: 12px; color: #3498db; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">üìû Vonage Webhook URLs</div>
                    <div style="margin-bottom: 6px;">
                        <span style="font-size: 11px; color: rgba(255, 255, 255, 0.6); display: block; margin-bottom: 3px;">Answer URL:</span>
                        <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 6px 8px; border-radius: 4px; font-size: 11px; word-break: break-all; color: #ecf0f1; font-family: 'Courier New', monospace;" id="vonageAnswerUrl">-</code>
                    </div>
                    <div>
                        <span style="font-size: 11px; color: rgba(255, 255, 255, 0.6); display: block; margin-bottom: 3px;">Event URL:</span>
                        <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 6px 8px; border-radius: 4px; font-size: 11px; word-break: break-all; color: #ecf0f1; font-family: 'Courier New', monospace;" id="vonageEventUrl">-</code>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" id="startTunnelBtn" style="background: linear-gradient(135deg, #2ecc71, #27ae60); flex: 1; min-width: 150px;" onclick="startTunnel()">
                        ‚ñ∂Ô∏è Start Tunnel
                    </button>
                    <button class="btn" id="stopTunnelBtn" style="background: linear-gradient(135deg, #e74c3c, #c0392b); flex: 1; min-width: 150px; display: none;" onclick="stopTunnel()">
                        ‚èπÔ∏è Stop Tunnel
                    </button>
                    <button class="btn" id="fixEngagedBtn" style="background: linear-gradient(135deg, #f39c12, #e67e22); flex: 1; min-width: 180px;" onclick="fixEngagedTone()">
                        üõ† Fix Engaged Tone
                    </button>
                    <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9); flex: 1; min-width: 150px;" onclick="saveTunnelConfig()">
                        üíæ Save Configuration
                    </button>
                </div>

                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                    ‚ö†Ô∏è <strong>Note:</strong> Cloudflare requires <code>cloudflared</code> to be installed. Download from <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/" target="_blank" style="color: #3498db;">cloudflare.com</a>
                </div>
            </div>
        </div>

        <!-- OpenRouter Test Panel -->
        <div class="panel">
            <h2>üß™ OpenRouter API Test</h2>
            <p style="margin-bottom: 15px; color: rgba(255, 255, 255, 0.7); font-size: 14px;">
                Test OpenRouter connectivity and verify your API key is working. This will make a minimal API call (uses ~10 tokens).
            </p>

            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 15px;">
                <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px;">OpenRouter Voice Model (fastest first) ‚Äî $/1M tokens</div>
                <select id="openrouterModelSelect" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 13px; font-family: 'Courier New', monospace;">
                    <option value="" style="background: #34495e; color: #ecf0f1;">Loading models...</option>
                </select>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                    <button class="btn" id="refreshOpenRouterModelsBtn" style="background: linear-gradient(135deg, #34495e, #2c3e50); flex: 1; min-width: 160px;" onclick="loadOpenRouterModels()">üîÑ Refresh Models</button>
                    <button class="btn" id="saveOpenRouterModelBtn" style="background: linear-gradient(135deg, #3498db, #2980b9); flex: 1; min-width: 160px;" onclick="saveOpenRouterModel()">üíæ Save Model</button>
                </div>
                <div id="openrouterModelStatus" style="margin-top: 10px; font-size: 13px; opacity: 0.85;"></div>
            </div>
            
            <button class="btn" id="testOpenRouterBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 100%; max-width: 300px;" onclick="testOpenRouter()">
                üîå Test OpenRouter Connection
            </button>
            
            <div id="openrouterTestResult" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;">
                <div id="openrouterTestMessage" style="font-weight: 600; margin-bottom: 8px;"></div>
                <div id="openrouterTestDetails" style="font-size: 13px; opacity: 0.9; font-family: 'Courier New', monospace;"></div>
            </div>
        </div>

        <!-- Configuration Warning Banner -->
        <div id="configWarningBanner" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">‚ö†Ô∏è Configuration Issue Detected</div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 15px;">API keys are stored in the database but not loading correctly. Click below to reload configuration.</div>
            <button class="btn" style="background: white; color: #e74c3c; padding: 12px 24px; font-weight: 700;" onclick="reloadConfiguration()">
                üîÑ Fix Configuration Now
            </button>
        </div>

        <!-- Health Details Modal -->
        <div class="health-modal" id="healthModal" onclick="closeHealthModal(event)">
            <div class="health-modal-content" onclick="event.stopPropagation()">
                <button class="health-modal-close" onclick="closeHealthModal()">‚úï</button>
                <div class="health-modal-icon" id="modalIcon">üîß</div>
                <div class="health-modal-title" id="modalTitle">Service Status</div>
                <div class="health-modal-desc" id="modalDesc">Loading...</div>
                <div class="health-modal-details" id="modalDetails"></div>
                <div class="health-modal-status" id="modalStatus">Checking...</div>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <!-- Diagnostics Modal -->
        <div class="diagnostics-modal" id="diagnosticsModal" onclick="closeDiagnosticsModal(event)">
            <div class="diagnostics-modal-content" onclick="event.stopPropagation()" style="position: relative;">
                <button class="diagnostics-modal-close" onclick="closeDiagnosticsModal()">‚úï</button>
                <div class="diagnostics-modal-title">
                    üîç Console Diagnostics
                </div>
                <div class="diagnostics-modal-desc">Monitor console activity and analyze errors with AI</div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 16px; color: white; font-weight: 600;">üìä Console Logs</h3>
                        <div>
                            <button class="btn-analyze-errors" id="analyzeBtn" onclick="analyzeErrors()" disabled>
                                ü§ñ Analyze Errors
                            </button>
                            <button onclick="clearConsoleLogs()" style="padding: 8px 16px; background: rgba(231, 76, 60, 0.2); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>
                    <div class="console-logs" id="consoleLogs">
                        <div style="color: #888; text-align: center; padding: 20px;">Capturing console activity...</div>
                    </div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">
                        <span id="logCount">0</span> logs | <span id="errorCount" style="color: #ff6b6b;">0</span> errors
                    </div>
                </div>
                
                <div class="error-analysis" id="errorAnalysis">
                    <div class="error-analysis-title">
                        ü§ñ AI Error Analysis
                        <button class="btn-copy-analysis" onclick="copyAnalysisToClipboard()" style="margin-left: auto; font-size: 12px; padding: 6px 12px;">
                            üìã Copy
                        </button>
                    </div>
                    <div class="error-analysis-content" id="analysisContent">
                        Analysis will appear here...
                    </div>
                </div>
            </div>
        </div>

        <!-- Number Management Panel -->
        <div class="panel">
            <h2>üìû Vonage Number Management</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">View and manage all Vonage phone numbers, their assignments, and availability status.</p>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9);" onclick="syncVonageNumbers()">
                    üîÑ Sync from Vonage
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #27ae60, #229954);" onclick="loadVonageNumbers()">
                    üîç Refresh List
                </button>
            </div>

            <div id="numbersContainer" style="margin-top: 20px;">
                <div style="text-align: center; padding: 40px; opacity: 0.6;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìû</div>
                    <div>Click "Sync from Vonage" or "Refresh List" to load your numbers</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üß† AI Brain Provider</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">Choose which AI service will handle conversations and decision-making for all accounts.</p>
            <div class="brain-selector">
                <div class="brain-options">
                    <label class="brain-option" id="brainOpenAI">
                        <input type="radio" name="brain" value="openai" onclick="selectBrain('openai')">
                        <div class="brain-option-title">OpenAI</div>
                        <div class="brain-option-desc">GPT-4 powered conversations</div>
                    </label>
                    <label class="brain-option" id="brainDeepSeek">
                        <input type="radio" name="brain" value="deepseek" onclick="selectBrain('deepseek')">
                        <div class="brain-option-title">DeepSeek</div>
                        <div class="brain-option-desc">Advanced reasoning engine</div>
                    </label>
                    <label class="brain-option" id="brainGroq">
                        <input type="radio" name="brain" value="groq" onclick="selectBrain('groq')">
                        <div class="brain-option-title">Groq</div>
                        <div class="brain-option-desc">GroqCloud low-latency chat (not xAI Grok)</div>
                    </label>
                    <label class="brain-option" id="brainOpenRouter">
                        <input type="radio" name="brain" value="openrouter" onclick="selectBrain('openrouter')">
                        <div class="brain-option-title">OpenRouter</div>
                        <div class="brain-option-desc">OpenRouter models (OpenAI-compatible)</div>
                    </label>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üîë API Keys Configuration</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">Manage all API keys securely. Keys are encrypted and stored in the database.</p>

            <div class="api-keys-grid">
                <div class="api-key-section">
                    <h3>OpenAI <span class="status not-configured" id="statusOpenAI">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputOpenAI" placeholder="sk-...">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('openai')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>DeepSeek <span class="status not-configured" id="statusDeepSeek">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputDeepSeek" placeholder="Enter API key">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('deepseek')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Groq <span class="status not-configured" id="statusGroq">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputGroq" placeholder="gsk_... (GroqCloud key)">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('groq')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>OpenRouter <span class="status not-configured" id="statusOpenRouter">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputOpenRouter" placeholder="sk-or-...">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('openrouter')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Speechmatics <span class="status not-configured" id="statusSpeechmatics">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputSpeechmatics" placeholder="Enter API key">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('speechmatics')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Vonage <span class="status not-configured" id="statusVonage">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputVonageKey" placeholder="API Key">
                    </div>
                    <div class="input-wrapper">
                        <input type="password" id="inputVonageSecret" placeholder="API Secret">
                    </div>
                    <div class="input-wrapper">
                        <input type="password" id="inputVonageAppId" placeholder="Application ID">
                    </div>
                    <div class="input-wrapper">
                        <textarea id="inputVonagePrivateKey" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" rows="4" style="width: 100%; padding: 10px 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; font-family: 'Courier New', monospace; resize: vertical;"></textarea>
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('vonage')">üíæ Save</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>ÔøΩ Global Instructions</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">These instructions override all individual account settings and apply to EVERY call across all accounts. Use this to set system-wide rules.</p>
            
            <div class="filler-section" style="margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 16px;">üìù General Instructions</h3>
                <textarea id="globalInstructions" placeholder="Example:\n- Always remain professional\n- Verify caller identity before discussing account details\n- Follow GDPR compliance rules" style="min-height: 150px;"></textarea>
                <div class="hint">Base instructions for all calls</div>
            </div>

            <div class="filler-section" style="margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                <h3 style="color: #e74c3c; margin-bottom: 10px; font-size: 16px;">üö´ CRITICAL: NEVER DO (10 Rules)</h3>
                <p style="font-size: 13px; opacity: 0.9; margin-bottom: 10px; color: #ff6b6b;">These are ABSOLUTE restrictions. The AI must NEVER violate these under any circumstances.</p>
                <textarea id="globalNeverDo" placeholder="Example:\n1. NEVER discuss competitor pricing or products\n2. NEVER share confidential company information\n3. NEVER make unauthorized promises or commitments\n4. NEVER discuss topics outside our service scope\n5. NEVER use offensive or unprofessional language\n6. NEVER share personal data of other customers\n7. NEVER provide medical or legal advice\n8. NEVER bypass security verification procedures\n9. NEVER discuss internal company policies\n10. NEVER transfer calls without proper authorization" style="min-height: 200px; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.05);"></textarea>
                <div class="hint" style="color: #e74c3c; font-weight: 600;">‚ö†Ô∏è HIGHEST PRIORITY - These rules override everything else</div>
            </div>

            <div class="filler-section" style="margin-bottom: 20px; border-left: 4px solid #27ae60;">
                <h3 style="color: #27ae60; margin-bottom: 10px; font-size: 16px;">‚úÖ CRITICAL: MUST DO (5 Rules)</h3>
                <p style="font-size: 13px; opacity: 0.9; margin-bottom: 10px; color: #2ecc71;">These are MANDATORY actions. The AI must ALWAYS follow these rules.</p>
                <textarea id="globalMustDo" placeholder="Example:\n1. MUST verify caller identity before sharing any account information\n2. MUST log all appointment bookings in the system immediately\n3. MUST offer to escalate if unable to resolve the issue\n4. MUST confirm important details back to the caller\n5. MUST end calls professionally with a summary of next steps" style="min-height: 150px; border: 2px solid #27ae60; background: rgba(39, 174, 96, 0.05);"></textarea>
                <div class="hint" style="color: #27ae60; font-weight: 600;">‚úì MANDATORY - These must be followed on every call</div>
            </div>

            <button class="btn-save" onclick="saveGlobalInstructions()" style="margin-top: 15px;">üíæ Save All Global Instructions</button>
        </div>

        <div class="panel">
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
                <h2 style="margin: 0;">üë• Active Accounts</h2>
                <button type="button" onclick="refreshAccountsList(event)" style="background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.22); color: rgba(255,255,255,0.90); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px;">üîÑ Refresh</button>
            </div>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">All accounts with their current credit balances.</p>
            <div id="accountsList" style="max-height: 600px; overflow-y: auto;"></div>
        </div>

        <div class="panel">
            <h2>üéõÔ∏è Backchannel / Turn-Taking Tuning</h2>
            <p style="margin-bottom: 16px; opacity: 0.8; font-size: 14px;">
                Use this to stop the agent treating short acknowledgements like ‚Äúok/yeah/right‚Äù as full turns.
                Higher thresholds = harder to trigger filler + AI response.
            </p>

            <div style="background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.14); border-radius: 14px; padding: 16px;">
                <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 14px; align-items: start;">

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Ignore Backchannels</div>
                        <label style="display:flex; gap: 10px; align-items:center; font-size: 13px; color: rgba(255,255,255,0.85);">
                            <input type="checkbox" id="ignoreBackchannelsAlways" style="transform: scale(1.15);">
                            Ignore ‚Äúok/yeah/right/thanks‚Äù even when agent is silent
                        </label>
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55);">
                            Recommended ON to prevent ‚Äúok‚Äù from triggering filler + response.
                        </div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Backchannel Max Words</div>
                        <input id="backchannelMaxWords" type="number" min="1" max="8" step="1" value="3" style="width: 100%; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 14px;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55);">If an utterance has more than this many words, it‚Äôs treated as a real request.</div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Min User Turn (seconds)</div>
                        <input id="minUserTurnSeconds" type="range" min="0.10" max="1.50" step="0.05" value="0.45" style="width: 100%;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.75);">Current: <span id="minUserTurnSecondsLabel">0.45</span>s</div>
                        <div style="margin-top: 4px; font-size: 12px; color: rgba(255,255,255,0.55);">Utterances shorter than this won‚Äôt trigger filler/AI in Speechmatics mode.</div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Barge-in Min Speech (seconds)</div>
                        <input id="bargeInMinSpeechSeconds" type="range" min="0.10" max="1.50" step="0.05" value="0.55" style="width: 100%;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.75);">Current: <span id="bargeInMinSpeechSecondsLabel">0.55</span>s</div>
                        <div style="margin-top: 4px; font-size: 12px; color: rgba(255,255,255,0.55);">How long caller must talk before we cancel agent speech (interrupt).</div>
                    </div>

                </div>

                <div style="margin-top: 14px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
                    <button class="btn-save" onclick="saveBackchannelSettings()">üíæ Save Tuning</button>
                    <button class="btn-save" onclick="loadBackchannelSettings()" style="background: rgba(255,255,255,0.12);">‚Üª Reload</button>
                    <span id="backchannelSettingsStatus" style="font-size: 13px; opacity: 0.85;"></span>
                </div>
            </div>
        </div>

        <div class="panel">            <h2>ÔøΩüí¨ Filler Words (Sarah Voice)</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">10 audio files using Speechmatics Sarah voice. These will be randomly played during pauses to cover latency.</p>
            
            <div style="margin-bottom: 25px;">
                <button class="btn-save" onclick="generateAllFillers()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 14px 28px;">
                    ‚ú® Generate All 10 with AI
                </button>
                <span id="generateAllStatus" style="margin-left: 15px; font-size: 14px; opacity: 0.8;"></span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;" id="fillerSlots">
                <!-- Filler slots will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Flagged Accounts Modal -->
    <div id="flaggedAccountsModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 5000; align-items:center; justify-content:center; padding: 20px;">
        <div style="background: linear-gradient(135deg, rgba(44, 62, 80, 0.98) 0%, rgba(52, 73, 94, 0.98) 100%); border-radius: 18px; padding: 22px; max-width: 1100px; width: 100%; max-height: 85vh; overflow: hidden; border: 2px solid rgba(231, 76, 60, 0.35); box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative;">
            <button onclick="closeFlaggedAccountsModal()" style="position:absolute; top: 14px; right: 14px; background: rgba(231, 76, 60, 0.3); border:none; color:white; font-size: 22px; width: 38px; height: 38px; border-radius: 50%; cursor:pointer;">√ó</button>
            <div style="font-size: 20px; font-weight: 900; color: white; margin-bottom: 6px;">üö® Content Moderation Alerts</div>
            <div style="font-size: 13px; color: rgba(255,255,255,0.75); margin-bottom: 14px;">Accounts flagged by AI moderation (illegal, sexual content, terrorism, scams, etc.).</div>
            <div id="flaggedAccountsModalContent" style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; height: calc(85vh - 140px); overflow: auto;">
                <div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- Account Config Details Modal -->
    <div id="accountConfigModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 5500; align-items:center; justify-content:center; padding: 20px;">
        <div style="background: linear-gradient(135deg, rgba(44, 62, 80, 0.98) 0%, rgba(52, 73, 94, 0.98) 100%); border-radius: 18px; padding: 22px; max-width: 900px; width: 100%; max-height: 85vh; overflow: hidden; border: 2px solid rgba(52, 152, 219, 0.35); box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative;">
            <button onclick="closeAccountConfigModal()" style="position:absolute; top: 14px; right: 14px; background: rgba(231, 76, 60, 0.3); border:none; color:white; font-size: 22px; width: 38px; height: 38px; border-radius: 50%; cursor:pointer;">√ó</button>
            <div style="font-size: 20px; font-weight: 900; color: white; margin-bottom: 6px;">üëÅÔ∏è Account Configuration</div>
            <div id="accountConfigModalSubtitle" style="font-size: 13px; color: rgba(255,255,255,0.75); margin-bottom: 14px;"></div>
            <div id="accountConfigModalContent" style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; height: calc(85vh - 140px); overflow: auto;">
                <div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables - declare at top to avoid hoisting issues
        let streamingStatusInterval = null;
        let healthCheckInterval = null;
        let healthData = {};
        let selectedCallUuid = null;
        
        // IMPORTANT: Super Admin security is enforced server-side.
        // This page only calls /api/super-admin/login to create a secure session cookie.

        function _getCookie(name) {
            const match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()\[\]\\/+^]/g, '\\$&') + '=([^;]*)'));
            return match ? decodeURIComponent(match[1]) : '';
        }

        function _setErr(msg) {
            const err = document.getElementById('errorMessage');
            if (!err) return;
            if (msg) {
                err.textContent = msg;
                err.style.display = 'block';
            } else {
                err.style.display = 'none';
            }
        }

        // Wrap fetch so all Super Admin requests send cookies + CSRF.
        (function() {
            const _origFetch = window.fetch.bind(window);
            function _setHeader(init, k, v) {
                if (!init.headers) init.headers = {};
                if (init.headers instanceof Headers) init.headers.set(k, v);
                else init.headers[k] = v;
            }
            window.fetch = async function(input, init) {
                init = init || {};
                init.credentials = 'include';
                const method = String(init.method || 'GET').toUpperCase();
                if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
                    const csrf = _getCookie('website33_super_admin_csrf');
                    if (csrf) _setHeader(init, 'X-CSRF-Token', csrf);
                }
                const resp = await _origFetch(input, init);
                // If the session expires, fall back to login screen.
                if (resp.status === 401) {
                    document.getElementById('mainDashboard').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                }
                return resp;
            };
        })();

        async function checkExistingSession() {
            try {
                const resp = await fetch('/api/super-admin/session');
                if (resp.ok) showDashboard();
            } catch (_) {
                // stay on login screen
            }
        }

        function _setSetupMessage(msg, ok=false) {
            const el = document.getElementById('setupMessage');
            if (!el) return;
            if (!msg) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = ok ? 'rgba(46, 204, 113, 0.25)' : 'rgba(231, 76, 60, 0.25)';
            el.style.border = ok ? '1px solid rgba(46, 204, 113, 0.35)' : '1px solid rgba(231, 76, 60, 0.35)';
            el.style.color = ok ? 'rgba(170, 255, 200, 0.95)' : 'rgba(255, 200, 200, 0.95)';
            el.style.padding = '10px 12px';
            el.style.borderRadius = '10px';
        }

        function _showSetupBox(show=true) {
            const box = document.getElementById('setupBox');
            if (!box) return;
            box.style.display = show ? 'block' : 'none';
        }

        async function checkSuperAdminStatus() {
            try {
                const resp = await fetch('/api/super-admin/status');
                if (!resp.ok) return;
                const data = await resp.json().catch(() => ({}));
                if (data && data.configured === false) {
                    _showSetupBox(true);
                    _setErr('Super Admin is not configured yet. Use first-time setup below.');
                }
            } catch (_) {}
        }

        checkExistingSession();
        checkSuperAdminStatus();
        document.getElementById('passwordInput')?.addEventListener('keypress', function(e) { if (e.key === 'Enter') attemptLogin(); });

        async function attemptLogin() {
            const pwd = document.getElementById('passwordInput')?.value || '';
            _setErr('');
            try {
                const resp = await fetch('/api/super-admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });

                if (resp.ok) {
                    document.getElementById('passwordInput').value = '';
                    showDashboard();
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                const err = data?.error || 'Login failed';
                _setErr(err);
                if (resp.status === 503 && String(err).toLowerCase().includes('not configured')) {
                    _showSetupBox(true);
                }
                document.getElementById('passwordInput').value = '';
            } catch (e) {
                _setErr('Login failed');
            }
        }

        async function attemptBootstrap() {
            _setSetupMessage('');
            const token = (document.getElementById('setupTokenInput')?.value || '').trim();
            const username = (document.getElementById('setupUsernameInput')?.value || '').trim();
            const password = (document.getElementById('setupPasswordInput')?.value || '').trim();
            const confirm = (document.getElementById('setupPasswordConfirmInput')?.value || '').trim();

            if (!token) {
                _setSetupMessage('Setup token is required. Set SUPER_ADMIN_SETUP_TOKEN on the server, then paste it here.');
                return;
            }
            if (password.length < 6) {
                _setSetupMessage('Password too short (use at least 6 characters).');
                return;
            }
            if (password !== confirm) {
                _setSetupMessage('Passwords do not match.');
                return;
            }

            try {
                const resp = await fetch('/api/super-admin/bootstrap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setup_token: token, username: username || 'admin', password })
                });
                
                let data = {};
                try {
                    data = await resp.json();
                } catch (jsonErr) {
                    _setSetupMessage(`Setup failed (HTTP ${resp.status}): Unable to parse server response`);
                    return;
                }
                
                if (resp.ok && data && data.success) {
                    _setSetupMessage('Super Admin configured. Loading dashboard‚Ä¶', true);
                    document.getElementById('setupPasswordInput').value = '';
                    document.getElementById('setupPasswordConfirmInput').value = '';
                    document.getElementById('passwordInput').value = '';
                    // If server auto-logged in, go straight to dashboard.
                    if (data.auto_login) {
                        showDashboard();
                        return;
                    }
                    _setErr('Setup complete. Now log in with your new password.');
                    return;
                }
                
                // Show detailed error
                let errMsg = data?.error || data?.detail || 'Setup failed';
                if (resp.status === 403) {
                    errMsg = `Invalid setup token. Make sure SUPER_ADMIN_SETUP_TOKEN in .env matches what you entered. (${errMsg})`;
                } else if (resp.status === 503) {
                    errMsg = `Setup token not configured on server. Add SUPER_ADMIN_SETUP_TOKEN to .env and restart. (${errMsg})`;
                } else if (resp.status === 409) {
                    errMsg = `Super Admin is already configured. Use the login form above instead. (${errMsg})`;
                } else if (resp.status >= 500) {
                    errMsg = `Server error (${resp.status}): ${errMsg}`;
                } else {
                    errMsg = `Setup failed (HTTP ${resp.status}): ${errMsg}`;
                }
                _setSetupMessage(errMsg);
            } catch (e) {
                _setSetupMessage(`Setup failed: Network error or server is not responding. ${e.message || ''}`);
                console.error('Bootstrap error:', e);
            }
        }
        function showDashboard() { 
            document.getElementById('loginScreen').style.display = 'none'; 
            document.getElementById('mainDashboard').style.display = 'block'; 
            loadAllSettings(); 
            loadFlaggedAccountsBadge();
            startStreamingStatusPolling(); 
            startBrainUsagePolling();
            // Delay health monitoring start by 1 second to ensure server is ready after restart
            setTimeout(() => {
                startHealthMonitoring();
            }, 1000);
        }
        async function logout() {
            stopStreamingStatusPolling();
            try { await fetch('/api/super-admin/logout', { method: 'POST' }); } catch (_) {}
            location.reload();
        }
        async function loadAllSettings() {
            const safe = async (label, fn) => {
                try {
                    await fn();
                } catch (e) {
                    console.error(`Error in ${label}:`, e);
                }
            };

            await safe('brain-provider', async () => {
                const brainResp = await fetch('/api/super-admin/brain-provider');
                const brainData = await brainResp.json();
                if (brainData && brainData.success) selectBrain(brainData.provider);
            });

            await safe('checkAPIKeyStatus(openai)', () => checkAPIKeyStatus('openai'));
            await safe('checkAPIKeyStatus(deepseek)', () => checkAPIKeyStatus('deepseek'));
            await safe('checkAPIKeyStatus(groq)', () => checkAPIKeyStatus('groq'));
            await safe('checkAPIKeyStatus(openrouter)', () => checkAPIKeyStatus('openrouter'));
            await safe('checkAPIKeyStatus(speechmatics)', () => checkAPIKeyStatus('speechmatics'));
            await safe('checkAPIKeyStatus(vonage)', () => checkAPIKeyStatus('vonage'));

            await safe('loadGlobalInstructions', () => loadGlobalInstructions());
            await safe('loadBackchannelSettings', () => loadBackchannelSettings());
            await safe('loadAccountsList', () => loadAccountsList());
            await safe('loadFillerSlots', () => loadFillerSlots());
            await safe('loadRecentCalls', () => loadRecentCalls());
            await safe('loadTunnelConfig', () => loadTunnelConfig());
            await safe('loadOpenRouterModels', () => loadOpenRouterModels());
        }

        // ==================== BACKCHANNEL / TURN-TAKING SETTINGS ====================
        function _setBackchannelStatus(msg, ok=true) {
            const el = document.getElementById('backchannelSettingsStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = ok ? 'rgba(120, 255, 160, 0.95)' : 'rgba(255, 140, 140, 0.95)';
        }

        function _wireBackchannelSliders() {
            const minSlider = document.getElementById('minUserTurnSeconds');
            const minLabel = document.getElementById('minUserTurnSecondsLabel');
            const bargeSlider = document.getElementById('bargeInMinSpeechSeconds');
            const bargeLabel = document.getElementById('bargeInMinSpeechSecondsLabel');
            if (minSlider && minLabel) {
                minLabel.textContent = String(Number(minSlider.value).toFixed(2));
                minSlider.oninput = () => { minLabel.textContent = String(Number(minSlider.value).toFixed(2)); };
            }
            if (bargeSlider && bargeLabel) {
                bargeLabel.textContent = String(Number(bargeSlider.value).toFixed(2));
                bargeSlider.oninput = () => { bargeLabel.textContent = String(Number(bargeSlider.value).toFixed(2)); };
            }
        }

        async function loadBackchannelSettings() {
            try {
                _wireBackchannelSliders();
                _setBackchannelStatus('Loading‚Ä¶', true);
                const resp = await fetch('/api/super-admin/backchannel-settings');
                const data = await resp.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed to load');
                const s = data.settings || {};

                const ignore = document.getElementById('ignoreBackchannelsAlways');
                const maxWords = document.getElementById('backchannelMaxWords');
                const minTurn = document.getElementById('minUserTurnSeconds');
                const bargeIn = document.getElementById('bargeInMinSpeechSeconds');

                if (ignore) ignore.checked = !!s.ignore_backchannels_always;
                if (maxWords) maxWords.value = String(s.backchannel_max_words ?? 3);
                if (minTurn) minTurn.value = String(s.min_user_turn_seconds ?? 0.45);
                if (bargeIn) bargeIn.value = String(s.barge_in_min_speech_seconds ?? 0.55);

                _wireBackchannelSliders();
                _setBackchannelStatus('Loaded', true);
            } catch (e) {
                console.error('Error loading backchannel settings:', e);
                _setBackchannelStatus('Load failed', false);
            }
        }

        async function saveBackchannelSettings() {
            try {
                _wireBackchannelSliders();
                _setBackchannelStatus('Saving‚Ä¶', true);

                const ignore = document.getElementById('ignoreBackchannelsAlways')?.checked ?? true;
                const maxWordsRaw = document.getElementById('backchannelMaxWords')?.value ?? '3';
                const minTurnRaw = document.getElementById('minUserTurnSeconds')?.value ?? '0.45';
                const bargeInRaw = document.getElementById('bargeInMinSpeechSeconds')?.value ?? '0.55';

                const payload = {
                    updated_by: 'super-admin',
                    settings: {
                        ignore_backchannels_always: !!ignore,
                        backchannel_max_words: Number(maxWordsRaw),
                        min_user_turn_seconds: Number(minTurnRaw),
                        barge_in_min_speech_seconds: Number(bargeInRaw),
                    }
                };

                console.log('Saving backchannel settings:', payload);

                const resp = await fetch('/api/super-admin/backchannel-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', resp.status);
                const data = await resp.json();
                console.log('Response data:', data);
                
                if (!data || !data.success) throw new Error(data?.error || 'Save failed');

                _setBackchannelStatus('Saved (applies immediately)', true);
            } catch (e) {
                console.error('Error saving backchannel settings:', e);
                _setBackchannelStatus(`Save failed: ${e.message}`, false);
            }
        }

        // ==================== CONTENT MODERATION (FLAGGED ACCOUNTS) ====================
        async function loadFlaggedAccountsBadge() {
            try {
                const response = await fetch('/api/super-admin/flagged-accounts');
                const data = await response.json();
                if (!data || !data.success) return;
                const count = Array.isArray(data.flagged_accounts) ? data.flagged_accounts.length : 0;
                const badge = document.getElementById('flaggedAccountsBadge');
                if (badge) badge.textContent = String(count);
            } catch (error) {
                const badge = document.getElementById('flaggedAccountsBadge');
                if (badge) badge.textContent = '0';
                console.error('Failed to load flagged accounts badge:', error);
            }
        }

        function showFlaggedAccountsModal() {
            const modal = document.getElementById('flaggedAccountsModal');
            if (!modal) return;
            modal.style.display = 'flex';
            const content = document.getElementById('flaggedAccountsModalContent');
            if (content) content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>';
            loadFlaggedAccountsForModal();
        }

        function closeFlaggedAccountsModal() {
            const modal = document.getElementById('flaggedAccountsModal');
            if (modal) modal.style.display = 'none';
        }

        async function loadFlaggedAccountsForModal() {
            try {
                const response = await fetch('/api/super-admin/flagged-accounts');
                const data = await response.json();
                if (!data || !data.success) throw new Error('Failed to load flagged accounts');
                renderFlaggedAccountsModal(Array.isArray(data.flagged_accounts) ? data.flagged_accounts : []);
                loadFlaggedAccountsBadge();
            } catch (error) {
                console.error('Failed to load flagged accounts:', error);
                const content = document.getElementById('flaggedAccountsModalContent');
                if (content) content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.85); padding: 30px;"><div style="color:#ff6b6b; font-weight: 800;">Failed to load flagged accounts</div><div style="margin-top: 8px; opacity: 0.8;">' + String(error.message || error) + '</div></div>';
            }
        }

        function renderFlaggedAccountsModal(accounts) {
            const content = document.getElementById('flaggedAccountsModalContent');
            if (!content) return;
            if (accounts.length === 0) {
                content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.85); padding: 40px;"><div style="font-size: 18px; font-weight: 900; color: #64ff64;">‚úÖ No flagged accounts</div><div style="margin-top: 6px; opacity: 0.85;">All clear.</div></div>';
                return;
            }

            const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
            const rows = accounts.map((account) => {
                const userId = account.user_id;
                const name = escapeHtml(account.name || ('User ' + userId));
                const phone = escapeHtml(account.phone_number || '');
                const isSuspended = !!account.is_suspended;
                const userStatus = String(account.user_status || 'active');
                let status = '<span style="background: rgba(243,156,18,0.22); border: 1px solid rgba(243,156,18,0.55); color: #ffd7a3; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: 12px;">‚ö†Ô∏è Flagged</span>';
                if (userStatus === 'banned') {
                    status = '<span style="background: rgba(231,76,60,0.25); border: 1px solid rgba(231,76,60,0.65); color: #ffd0d0; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">‚õî Banned</span>';
                } else if (userStatus === 'suspended' || isSuspended) {
                    status = '<span style="background: rgba(231,76,60,0.25); border: 1px solid rgba(231,76,60,0.55); color: #ffb3b3; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: 12px;">üîí Suspended</span>';
                }
                const count = Number(account.suspension_count || 0);
                const reasonText = (account.suspension_reason || account.suspension_message || '');
                const reason = escapeHtml(reasonText);
                const whenText = (account.suspended_at || account.user_suspended_at || '');
                const when = escapeHtml(whenText);
                const details = escapeHtml(account.flag_details || account.last_flag_details || '');
                const businessInfo = escapeHtml(account.business_info || '');

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.10);">
                        <td style="padding: 10px 8px;">
                            <div style="font-weight: 900; color: white;">${name}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.65);">${phone}</div>
                        </td>
                        <td style="padding: 10px 8px;">${status}</td>
                        <td style="padding: 10px 8px; text-align:center; font-weight: 900; color: white;">${count}</td>
                        <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.75);">${when || '‚Äî'}</td>
                        <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.85);">${reason || '‚Äî'}</td>
                        <td style="padding: 10px 8px; text-align:right; white-space: nowrap;">
                            ${isSuspended ? `<button onclick="unsuspendAccountFromModal(${userId})" style="background: rgba(39,174,96,0.25); border: 1px solid rgba(39,174,96,0.6); color: #b7ffcf; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 800;">‚úì Unsuspend</button>` : ''}
                            ${(userStatus === 'suspended' || userStatus === 'banned') ? `<button onclick="reactivateAccountFromModal(${userId})" style="margin-left: 8px; background: rgba(39,174,96,0.18); border: 1px solid rgba(39,174,96,0.45); color: rgba(255,255,255,0.92); padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 900;">‚Ü© Reactivate</button>` : ''}
                            ${(userStatus !== 'banned') ? `<button onclick="banAccountFromModal(${userId})" style="margin-left: 8px; background: rgba(231,76,60,0.20); border: 1px solid rgba(231,76,60,0.55); color: #ffd0d0; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 900;">‚õî Ban</button>` : ''}
                            <button onclick="showAccountConfigModal(${userId})" style="margin-left: 8px; background: rgba(52,152,219,0.22); border: 1px solid rgba(52,152,219,0.55); color: #cde8ff; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 800;">üëÅ Details</button>
                        </td>
                    </tr>
                `;
            }).join('');

            content.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.06);">
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Account</th>
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Status</th>
                                <th style="text-align:center; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Flags</th>
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Last Violation</th>
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Reason</th>
                                <th style="text-align:right; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        async function unsuspendAccountFromModal(userId) {
            if (!confirm('Unsuspend this account?')) return;
            try {
                const response = await fetch('/api/super-admin/unsuspend-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                if (!data || !data.success) throw new Error(data?.error || data?.detail || 'Failed to unsuspend');
                if (typeof showAlert === 'function') showAlert('‚úÖ Account unsuspended', 'success');
                loadFlaggedAccountsForModal();
                if (typeof loadAccountsList === 'function') loadAccountsList();
            } catch (error) {
                console.error('Failed to unsuspend account:', error);
                if (typeof showAlert === 'function') showAlert('‚ùå Failed to unsuspend: ' + (error.message || error), 'error');
            }
        }

        async function banAccountFromModal(userId) {
            if (!confirm('Ban this account permanently?')) return;
            try {
                const response = await fetch(`/api/super-admin/account/${userId}/ban`, {
                    method: 'POST'
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || (data && data.success === false)) throw new Error(data?.error || data?.detail || 'Failed to ban');
                if (typeof showAlert === 'function') showAlert('‚õî Account banned', 'success');
                loadFlaggedAccountsForModal();
                if (typeof loadAccountsList === 'function') loadAccountsList();
            } catch (error) {
                console.error('Failed to ban account:', error);
                if (typeof showAlert === 'function') showAlert('‚ùå Failed to ban: ' + (error.message || error), 'error');
            }
        }

        async function reactivateAccountFromModal(userId) {
            if (!confirm('Reactivate this account?')) return;
            try {
                const response = await fetch(`/api/super-admin/account/${userId}/reactivate`, {
                    method: 'POST'
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || (data && data.success === false)) throw new Error(data?.error || data?.detail || 'Failed to reactivate');
                if (typeof showAlert === 'function') showAlert('‚úÖ Account reactivated', 'success');
                loadFlaggedAccountsForModal();
                if (typeof loadAccountsList === 'function') loadAccountsList();
            } catch (error) {
                console.error('Failed to reactivate account:', error);
                if (typeof showAlert === 'function') showAlert('‚ùå Failed to reactivate: ' + (error.message || error), 'error');
            }
        }

        function closeAccountConfigModal() {
            const modal = document.getElementById('accountConfigModal');
            if (modal) modal.style.display = 'none';
        }

        async function showAccountDetailsModal(userId, userName) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('accountDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'accountDetailsModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 999999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; animation: fadeIn 0.2s ease;';
                modal.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 0; border-radius: 20px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <div style="position: sticky; top: 0; background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(10px); padding: 24px 28px; border-bottom: 2px solid rgba(155, 89, 182, 0.3); z-index: 10; border-radius: 20px 20px 0 0;">
                            <h2 style="margin: 0 0 4px 0; font-size: 22px; font-weight: 900; background: linear-gradient(90deg, #9b59b6, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üë§ Account Signup Details</h2>
                            <div id="accountDetailsModalSubtitle" style="font-size: 13px; color: rgba(255,255,255,0.65); font-weight: 600;"></div>
                        </div>
                        <div id="accountDetailsModalContent" style="padding: 28px;"></div>
                        <div style="padding: 20px 28px; border-top: 1px solid rgba(255,255,255,0.08); text-align: right;">
                            <button onclick="closeAccountDetailsModal()" style="background: rgba(155, 89, 182, 0.22); border: 1px solid rgba(155, 89, 182, 0.55); color: #e8d4ff; padding: 10px 24px; border-radius: 12px; cursor: pointer; font-weight: 900; font-size: 13px;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            const subtitle = document.getElementById('accountDetailsModalSubtitle');
            const content = document.getElementById('accountDetailsModalContent');
            
            modal.style.display = 'flex';
            subtitle.textContent = 'Loading‚Ä¶';
            content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading account details‚Ä¶</div>';

            try {
                const response = await fetch(`/api/super-admin/account-details/${userId}`);
                const data = await response.json();
                
                if (!data || !data.success) {
                    throw new Error(data?.error || 'Failed to load account details');
                }

                const d = data.details || {};
                const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

                subtitle.textContent = `${userName} (User ID: ${userId})`;

                const fieldBlock = (label, value, icon = '') => {
                    const displayValue = value || '<span style="opacity:0.5;">(not provided)</span>';
                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 11px; letter-spacing: 0.5px; font-weight: 900; color: rgba(155, 89, 182, 0.85); margin-bottom: 6px; text-transform: uppercase;">${icon} ${label}</div>
                            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(155, 89, 182, 0.25); border-radius: 10px; padding: 12px 14px; color: rgba(255,255,255,0.95); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 13px; word-break: break-word; line-height: 1.5;">${displayValue}</div>
                        </div>
                    `;
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return dateStr;
                    }
                };

                content.innerHTML = `
                    <div style="display: grid; gap: 12px;">
                        ${fieldBlock('Username', escapeHtml(d.username), 'üîë')}
                        ${fieldBlock('Email Address', escapeHtml(d.email), 'üìß')}
                        ${fieldBlock('Mobile Number', escapeHtml(d.mobile), 'üì±')}
                        ${fieldBlock('Mobile E.164 Format', escapeHtml(d.mobile_e164), 'üåç')}
                        ${fieldBlock('Business Name', escapeHtml(d.business_name), 'üè¢')}
                        ${fieldBlock('Website URL', escapeHtml(d.website_url), 'üåê')}
                        ${fieldBlock('Full Name', escapeHtml(d.name), 'üë§')}
                        ${fieldBlock('Assigned Phone Number', escapeHtml(d.phone_number), '‚òéÔ∏è')}
                        ${fieldBlock('Account Created', formatDate(d.created_at), 'üìÖ')}
                        ${fieldBlock('Account Status', escapeHtml(d.status), '‚ú®')}
                        <div style="margin-top: 16px; padding: 14px; background: rgba(231, 76, 60, 0.12); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 10px; font-size: 12px; color: rgba(255,255,255,0.85); line-height: 1.6;">
                            <div style="font-weight: 900; color: #ff6b6b; margin-bottom: 6px;">üîí SECURITY NOTE</div>
                            Passwords are securely hashed using PBKDF2 and cannot be displayed. Original passwords are never stored in plain text for security reasons.
                        </div>
                    </div>
                `;
            } catch (error) {
                subtitle.textContent = `${userName} (User ID: ${userId})`;
                content.innerHTML = `
                    <div style="text-align:center; padding: 30px;">
                        <div style="color:#ff6b6b; font-weight: 800; font-size: 16px; margin-bottom: 10px;">‚ùå Failed to Load Account Details</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 13px;">${escapeHtml(String(error.message || error))}</div>
                    </div>
                `;
            }
        }

        function closeAccountDetailsModal() {
            const modal = document.getElementById('accountDetailsModal');
            if (modal) modal.style.display = 'none';
        }

        async function showAccountConfigModal(userId) {
            const modal = document.getElementById('accountConfigModal');
            const subtitle = document.getElementById('accountConfigModalSubtitle');
            const content = document.getElementById('accountConfigModalContent');
            if (!modal || !subtitle || !content) return;

            modal.style.display = 'flex';
            subtitle.textContent = 'Loading‚Ä¶';
            content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>';

            try {
                const response = await fetch(`/api/super-admin/account-config/${userId}`);
                const data = await response.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed to load account config');

                const cfg = data.config || {};
                const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

                subtitle.textContent = `${data.name || 'Account'} (User ID: ${data.user_id})`;

                const phoneNumber = escapeHtml(cfg.PHONE_NUMBER || '');
                const businessInfo = escapeHtml(cfg.BUSINESS_INFO || '');
                const callGreeting = escapeHtml(cfg.CALL_GREETING || '');

                const fieldBlock = (label, value, isMultiline) => {
                    const displayValue = value || '<span style="opacity:0.6;">(empty)</span>';
                    return `
                        <div style="margin-bottom: 14px;">
                            <div style="font-size: 12px; letter-spacing: 0.4px; font-weight: 900; color: rgba(255,255,255,0.85); margin-bottom: 6px;">${label}</div>
                            <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 12px; color: rgba(255,255,255,0.92); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; white-space: ${isMultiline ? 'pre-wrap' : 'normal'}; word-break: break-word;">${displayValue}</div>
                        </div>
                    `;
                };

                content.innerHTML = `
                    ${fieldBlock('PHONE NUMBER', phoneNumber, false)}
                    ${fieldBlock('BUSINESS INFORMATION', businessInfo, true)}
                    ${fieldBlock('CALL GREETING (Opening Line)', callGreeting, true)}
                `;
            } catch (error) {
                subtitle.textContent = `User ID: ${userId}`;
                content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.85); padding: 30px;"><div style="color:#ff6b6b; font-weight: 800;">Failed to load account configuration</div><div style="margin-top: 8px; opacity: 0.8;">' + String(error.message || error) + '</div></div>';
            }
        }
        async function checkAPIKeyStatus(provider) { try { let endpoint = '', statusId = ''; if (provider === 'openai') { endpoint = '/api/super-admin/openai-key'; statusId = 'statusOpenAI'; } else if (provider === 'deepseek') { endpoint = '/api/super-admin/deepseek-key'; statusId = 'statusDeepSeek'; } else if (provider === 'groq') { endpoint = '/api/super-admin/groq-key'; statusId = 'statusGroq'; } else if (provider === 'openrouter') { endpoint = '/api/super-admin/openrouter-key'; statusId = 'statusOpenRouter'; } else if (provider === 'speechmatics') { endpoint = '/api/super-admin/speechmatics-key'; statusId = 'statusSpeechmatics'; } else if (provider === 'vonage') { endpoint = '/api/super-admin/vonage-keys'; statusId = 'statusVonage'; } const response = await fetch(endpoint); const data = await response.json(); const statusEl = document.getElementById(statusId); if (data.configured) { statusEl.textContent = '‚úÖ Configured'; statusEl.className = 'status configured'; } else { statusEl.textContent = '‚ö†Ô∏è Not Configured'; statusEl.className = 'status not-configured'; } } catch (error) { console.error(`Error checking ${provider} status:`, error); } }
        function selectBrain(provider) { document.getElementById('brainOpenAI').classList.remove('selected'); document.getElementById('brainDeepSeek').classList.remove('selected'); document.getElementById('brainGroq').classList.remove('selected'); const br = document.getElementById('brainOpenRouter'); if (br) br.classList.remove('selected'); if (provider === 'openai') { document.getElementById('brainOpenAI').classList.add('selected'); document.querySelector('input[value="openai"]').checked = true; } else if (provider === 'deepseek') { document.getElementById('brainDeepSeek').classList.add('selected'); document.querySelector('input[value="deepseek"]').checked = true; } else if (provider === 'groq') { document.getElementById('brainGroq').classList.add('selected'); document.querySelector('input[value="groq"]').checked = true; } else if (provider === 'openrouter') { const el = document.getElementById('brainOpenRouter'); if (el) el.classList.add('selected'); document.querySelector('input[value="openrouter"]').checked = true; } else { document.getElementById('brainOpenAI').classList.add('selected'); document.querySelector('input[value="openai"]').checked = true; provider = 'openai'; } saveBrainProvider(provider); }
        async function saveBrainProvider(provider) { try { const response = await fetch('/api/super-admin/brain-provider', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ provider, updated_by: 'super-admin' }) }); const data = await response.json(); if (data.success) showAlert(data.message, 'success'); else showAlert('Failed to update brain provider', 'error'); } catch (error) { console.error('Error saving brain provider:', error); showAlert('Error saving brain provider', 'error'); } }
        async function saveAPIKey(provider) { try { let endpoint = '', body = {}, inputId = ''; if (provider === 'openai') { endpoint = '/api/super-admin/openai-key'; inputId = 'inputOpenAI'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'deepseek') { endpoint = '/api/super-admin/deepseek-key'; inputId = 'inputDeepSeek'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'groq') { endpoint = '/api/super-admin/groq-key'; inputId = 'inputGroq'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'openrouter') { endpoint = '/api/super-admin/openrouter-key'; inputId = 'inputOpenRouter'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'speechmatics') { endpoint = '/api/super-admin/speechmatics-key'; inputId = 'inputSpeechmatics'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'vonage') { endpoint = '/api/super-admin/vonage-keys'; const apiKey = document.getElementById('inputVonageKey').value.trim(); const apiSecret = document.getElementById('inputVonageSecret').value.trim(); const appId = document.getElementById('inputVonageAppId').value.trim(); const privateKey = document.getElementById('inputVonagePrivateKey').value.trim(); if (!apiKey && !apiSecret && !appId && !privateKey) { showAlert('Please enter at least one Vonage credential', 'error'); return; } body = { updated_by: 'super-admin' }; if (apiKey) body.api_key = apiKey; if (apiSecret) body.api_secret = apiSecret; if (appId) body.application_id = appId; if (privateKey) body.private_key_pem = privateKey; } const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); const data = await response.json(); if (data.success) { showAlert(data.message, 'success'); if (inputId) document.getElementById(inputId).value = ''; if (provider === 'vonage') { document.getElementById('inputVonageKey').value = ''; document.getElementById('inputVonageSecret').value = ''; document.getElementById('inputVonageAppId').value = ''; document.getElementById('inputVonagePrivateKey').value = ''; } await checkAPIKeyStatus(provider); } else { showAlert(data.error || 'Failed to save API key', 'error'); } } catch (error) { console.error('Error saving API key:', error); showAlert('Error saving API key', 'error'); } }
        async function loadGlobalInstructions() { 
            try { 
                const response = await fetch('/api/super-admin/global-instructions'); 
                const data = await response.json(); 
                if (data.success) { 
                    const instructions = data.instructions || '';
                    console.log('Loaded instructions length:', instructions.length);
                    
                    // Split sections using the header markers
                    let baseInstructions = instructions;
                    let neverDoText = '';
                    let mustDoText = '';
                    
                    // Find the NEVER DO section
                    const neverDoStart = instructions.indexOf('üö´ CRITICAL: NEVER DO');
                    if (neverDoStart !== -1) {
                        // Base instructions is everything before the NEVER DO marker
                        baseInstructions = instructions.substring(0, neverDoStart).trim();
                        
                        // Find where MUST DO section starts (or end of string)
                        const mustDoStart = instructions.indexOf('‚úÖ CRITICAL: MUST DO', neverDoStart);
                        
                        if (mustDoStart !== -1) {
                            // Extract NEVER DO text (skip the header line)
                            const neverDoSection = instructions.substring(neverDoStart, mustDoStart);
                            const neverDoLines = neverDoSection.split('\n');
                            neverDoText = neverDoLines.slice(1).join('\n').trim(); // Skip first line (header)
                            
                            // Extract MUST DO text (skip the header line)
                            const mustDoSection = instructions.substring(mustDoStart);
                            const mustDoLines = mustDoSection.split('\n');
                            mustDoText = mustDoLines.slice(1).join('\n').trim(); // Skip first line (header)
                        } else {
                            // No MUST DO section, everything after NEVER DO is part of NEVER DO
                            const neverDoSection = instructions.substring(neverDoStart);
                            const neverDoLines = neverDoSection.split('\n');
                            neverDoText = neverDoLines.slice(1).join('\n').trim();
                        }
                    } else {
                        // Check if there's a MUST DO section without NEVER DO
                        const mustDoStart = instructions.indexOf('‚úÖ CRITICAL: MUST DO');
                        if (mustDoStart !== -1) {
                            baseInstructions = instructions.substring(0, mustDoStart).trim();
                            const mustDoSection = instructions.substring(mustDoStart);
                            const mustDoLines = mustDoSection.split('\n');
                            mustDoText = mustDoLines.slice(1).join('\n').trim();
                        }
                    }
                    
                    document.getElementById('globalInstructions').value = baseInstructions;
                    document.getElementById('globalNeverDo').value = neverDoText;
                    document.getElementById('globalMustDo').value = mustDoText;
                    
                    console.log('‚úÖ Parsed sections - Base:', baseInstructions.length, 'chars, NeverDo:', neverDoText.length, 'chars, MustDo:', mustDoText.length, 'chars');
                } 
            } catch (error) { 
                console.error('Error loading global instructions:', error); 
            } 
        }
        async function saveGlobalInstructions() { 
            try { 
                const instructionsTextarea = document.getElementById('globalInstructions');
                const neverDoTextarea = document.getElementById('globalNeverDo');
                const mustDoTextarea = document.getElementById('globalMustDo');
                
                if (!instructionsTextarea || !neverDoTextarea || !mustDoTextarea) {
                    console.error('Global instructions textareas not found');
                    showAlert('Error: Instructions fields not found', 'error');
                    return;
                }
                
                // Get all three sections
                const baseInstructions = instructionsTextarea.value.trim();
                const neverDo = neverDoTextarea.value.trim();
                const mustDo = mustDoTextarea.value.trim();
                
                console.log('Saving sections:');
                console.log('Base:', baseInstructions.substring(0, 50));
                console.log('NeverDo:', neverDo.substring(0, 50));
                console.log('MustDo:', mustDo.substring(0, 50));
                
                // Combine all sections with clear formatting
                let combinedInstructions = baseInstructions;
                
                if (neverDo) {
                    combinedInstructions += '\n\nüö´ CRITICAL: NEVER DO - ABSOLUTE RESTRICTIONS (HIGHEST PRIORITY):\n' + neverDo;
                }
                
                if (mustDo) {
                    combinedInstructions += '\n\n‚úÖ CRITICAL: MUST DO - MANDATORY ACTIONS (REQUIRED ON EVERY CALL):\n' + mustDo;
                }
                
                console.log('Combined instructions (first 200 chars):', combinedInstructions.substring(0, 200));
                
                const response = await fetch('/api/super-admin/global-instructions', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ instructions: combinedInstructions, updated_by: 'super-admin' }) 
                }); 
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json(); 
                console.log('Save response:', data);
                
                if (data.success) {
                    showAlert('‚úÖ All global instructions saved successfully!', 'success');
                    // Don't call closeInstructionsModal() - we're not using a modal, instructions are on the page
                } else {
                    showAlert('‚ùå Failed to save: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) { 
                console.error('Error saving global instructions:', error); 
                showAlert('‚ùå Error saving global instructions: ' + error.message, 'error'); 
            } 
        }
        async function loadAccountsList() { 
            try { 
                const response = await fetch(`/api/super-admin/accounts?t=${Date.now()}`); 
                const data = await response.json(); 
                const container = document.getElementById('accountsList'); 
                if (!data.success || !data.accounts || data.accounts.length === 0) { 
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">No accounts found</div>'; 
                    return; 
                }

                const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
                const fmtPlan = (acc) => {
                    const planStatus = acc.plan_status || 'trial';
                    const trialDays = Number(acc.trial_days_remaining ?? 0);
                    if (planStatus === 'upgraded') return '‚úÖ Upgraded';
                    if (planStatus === 'trial_expired') return '‚õî Trial Expired';
                    if (trialDays === 1) return `üéÅ Free Trial - 1 day left`;
                    if (trialDays === 0) return `üéÅ Free Trial - Last day`;
                    return `üéÅ Free Trial - ${trialDays} days left`;
                };
                const canExtendTrial = (acc) => {
                    const planStatus = acc.plan_status || 'trial';
                    return planStatus === 'trial' || planStatus === 'trial_expired';
                };
                const fmtCredits = (acc) => {
                    const v = Number(acc.credits ?? acc.minutes_remaining ?? 0);
                    return String(Math.round(isFinite(v) ? v : 0));
                };
                const fmtLastCall = (acc) => {
                    const v = acc.last_call;
                    if (!v) return '‚Äî';
                    return escapeHtml(v);
                };
                const fmtStatus = (acc) => {
                    const s = String(acc.status || 'active');
                    if (s === 'active') return '<span style="background: rgba(46,204,113,0.18); border: 1px solid rgba(46,204,113,0.45); color: #b7ffcf; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">Active</span>';
                    if (s === 'suspended') return '<span style="background: rgba(231,76,60,0.20); border: 1px solid rgba(231,76,60,0.55); color: #ffb3b3; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">Suspended</span>';
                    if (s === 'banned') return '<span style="background: rgba(231,76,60,0.24); border: 1px solid rgba(231,76,60,0.65); color: #ffb3b3; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">Banned</span>';
                    return `<span style="background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.20); color: rgba(255,255,255,0.85); padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">${escapeHtml(s)}</span>`;
                };

                const rows = data.accounts.map(acc => {
                    const userId = Number(acc.user_id);
                    const name = escapeHtml(acc.name || 'Unknown');
                    const phone = escapeHtml(acc.phone_number || '');
                    const planStatus = acc.plan_status || 'trial';
                    const trialDays = Number(acc.trial_days_remaining ?? 0);
                    const plan = escapeHtml(fmtPlan(acc));
                    let trialLeft = '‚Äî';
                    if (planStatus !== 'upgraded') {
                        if (planStatus === 'trial_expired') trialLeft = '0';
                        else if (trialDays === 0) trialLeft = 'Last day';
                        else trialLeft = `${trialDays}d`;
                    }
                    const credits = fmtCredits(acc);
                    const callsToday = String(Number(acc.calls_today || 0));
                    const lastCall = fmtLastCall(acc);
                    const showExtendTrial = canExtendTrial(acc);

                    return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.10);">
                            <td style="padding: 10px 8px; font-weight: 900; color: white; white-space: nowrap;">${userId}</td>
                            <td style="padding: 10px 8px;">
                                <div style="font-weight: 900; color: white;">${name}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.65);">üìû ${phone || 'No number assigned'}</div>
                            </td>
                            <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.85);">${plan}</td>
                            <td style="padding: 10px 8px; text-align: center; font-weight: 900; color: white;">${trialLeft}</td>
                            <td style="padding: 10px 8px; text-align: right; font-weight: 900; color: #2ecc71;">${credits}</td>
                            <td style="padding: 10px 8px; text-align: center; font-weight: 900; color: white;">${callsToday}</td>
                            <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.75);">${lastCall}</td>
                            <td style="padding: 10px 8px;">${fmtStatus(acc)}</td>
                            <td style="padding: 10px 8px; text-align: right; white-space: nowrap;">
                                <button type="button" onclick="showAccountDetailsModal(${userId}, '${name.replace(/'/g, "\\'")}')" style="background: rgba(155, 89, 182, 0.22); border: 1px solid rgba(155, 89, 182, 0.55); color: #e8d4ff; padding: 7px 10px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px; margin-right: 6px;">üë§ View Details</button>
                                ${showExtendTrial ? `<button type="button" onclick="extendTrial(${userId}, '${name.replace(/'/g, "\\'")}')" style="background: rgba(52, 152, 219, 0.22); border: 1px solid rgba(52, 152, 219, 0.55); color: #cde8ff; padding: 7px 10px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px; margin-right: 6px;">‚è∞ +Trial</button>` : ''}
                                <button type="button" class="credit-btn add" onclick="manageCredits(${userId}, '${name.replace(/'/g, "\\'")}', 'add')" title="Add Credits">‚ûï Add</button>
                                <button type="button" class="credit-btn remove" onclick="manageCredits(${userId}, '${name.replace(/'/g, "\\'")}', 'remove')" title="Remove Credits" style="margin-left: 6px;">‚ûñ Remove</button>
                                <button type="button" onclick="deleteAccount(${userId}, '${name.replace(/'/g, "\\'")}', '${phone.replace(/'/g, "\\'")}')" style="margin-left: 8px; background: rgba(231, 76, 60, 0.22); border: 1px solid rgba(231, 76, 60, 0.55); color: #ffb3b3; padding: 7px 10px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px;">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="overflow-x:auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.06); position: sticky; top: 0; backdrop-filter: blur(10px);">
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">ID</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Account</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Plan</th>
                                    <th style="text-align:center; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Trial Left</th>
                                    <th style="text-align:right; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Credits</th>
                                    <th style="text-align:center; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Calls Today</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Last Call</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Status</th>
                                    <th style="text-align:right; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            } catch (error) { 
                console.error('Error loading accounts:', error); 
                document.getElementById('accountsList').innerHTML = '<div style="text-align: center; padding: 30px; color: #e74c3c;">Error loading accounts</div>'; 
            } 
        }

        function canExtendTrial(acc) {
            return acc.plan_status === 'trial' || acc.plan_status === 'trial_expired';
        }

        async function extendTrial(userId, userName) {
            const daysInput = prompt(`How many days to add to ${userName}'s trial?\n\nNote: Total trial days cannot exceed 5.\n\nEnter days (1-5):`, '1');
            if (!daysInput) return;

            const days = parseInt(daysInput, 10);
            if (isNaN(days) || days < 1 || days > 5) {
                showAlert('Please enter a valid number between 1 and 5', 'error', false);
                return;
            }

            try {
                const res = await fetch(`/api/super-admin/account/${userId}/extend-trial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: days })
                });

                const data = await res.json();

                if (!res.ok) {
                    showAlert(`Failed to extend trial: ${data.detail || data.error || 'Unknown error'}`, 'error', false);
                    return;
                }

                if (data.success) {
                    const added = Number(data.days_added ?? 0);
                    if (added > 0) {
                        showAlert(`‚úÖ Extended ${userName}'s trial by ${added} day(s)`, 'success', false);
                    } else {
                        showAlert(`‚ÑπÔ∏è ${userName} is already at the maximum trial length (5 days)`, 'error', false);
                    }
                    await loadAccountsList();
                } else {
                    showAlert(data.error || 'Failed to extend trial', 'error', false);
                }
            } catch (error) {
                showAlert(`Network error: ${error.message}`, 'error', false);
            }
        }

        async function refreshAccountsList(evt) {
            const btn = evt?.target;
            const prevText = btn?.textContent;
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.75';
                    btn.style.cursor = 'not-allowed';
                    btn.textContent = '‚è≥ Refreshing‚Ä¶';
                }
                await loadAccountsList();
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = 'pointer';
                    btn.textContent = prevText || 'üîÑ Refresh';
                }
            }
        }

        async function deleteAccount(userId, userName, phoneNumber) {
            console.log('deleteAccount called:', { userId, userName, phoneNumber });
            const phoneText = phoneNumber ? `\n\nAssigned number: ${phoneNumber}` : '';
            if (!confirm(`Delete account "${userName}" (ID: ${userId})?${phoneText}\n\nThis cannot be undone.`)) {
                console.log('User cancelled delete');
                return;
            }
            console.log('Sending DELETE request to:', `/api/super-admin/account/${userId}/delete`);
            try {
                const resp = await fetch(`/api/super-admin/account/${userId}/delete`, { method: 'DELETE' });
                console.log('Response status:', resp.status);
                const data = await resp.json();
                console.log('Response data:', data);
                if (!data || !data.success) throw new Error(data?.error || 'Delete failed');
                const released = (data.released_phone_number || '').trim();
                showAlert(released ? `üóëÔ∏è Deleted ${userName}. Number returned: ${released}` : `üóëÔ∏è Deleted ${userName}`, 'success', false);
                await loadAccountsList();
                if (typeof loadFlaggedAccountsBadge === 'function') loadFlaggedAccountsBadge();
            } catch (e) {
                console.error('Failed to delete account:', e);
                showAlert('‚ùå Failed to delete: ' + (e.message || e), 'error', false);
            }
        }
        
        async function manageCredits(userId, userName, action) {
            const actionText = action === 'add' ? 'Add' : 'Remove';
            const minutes = prompt(`${actionText} Credits for ${userName}\n\nEnter number of minutes to ${action === 'add' ? 'add' : 'remove'}:`, '60');
            
            if (minutes === null || minutes === '') return;
            
            const minutesNum = parseInt(minutes);
            if (isNaN(minutesNum) || minutesNum <= 0) {
                showAlert('Please enter a valid number', 'error', false);
                return;
            }
            
            try {
                const endpoint = action === 'add' ? 'add-minutes' : 'remove-minutes';
                const response = await fetch(`/api/super-admin/account/${userId}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ minutes: minutesNum })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const message = action === 'add' 
                        ? `‚úÖ Added ${data.minutes_added} minutes to ${userName}` 
                        : `‚úÖ Removed ${data.minutes_removed} minutes from ${userName}. New balance: ${data.new_balance} minutes`;
                    showAlert(message, 'success', false);
                    await loadAccountsList(); // Reload to show updated credits
                } else {
                    showAlert(`Failed to ${action} credits: ${data.error || 'Unknown error'}`, 'error', false);
                }
            } catch (error) {
                console.error(`Error ${action}ing credits:`, error);
                showAlert(`Error ${action}ing credits`, 'error', false);
            }
        }
        
        async function saveFillerWords() { try { const fillerWords = document.getElementById('fillerWords').value.trim(); const response = await fetch('/api/super-admin/filler-words', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filler_words: fillerWords, updated_by: 'super-admin' }) }); const data = await response.json(); if (data.success) showAlert('Filler words saved successfully', 'success'); else showAlert('Failed to save filler words', 'error'); } catch (error) { console.error('Error saving filler words:', error); showAlert('Error saving filler words', 'error'); } }
        async function loadFillerSlots() { try { const response = await fetch('/api/super-admin/list-fillers?voice_id=sarah'); const data = await response.json(); const container = document.getElementById('fillerSlots'); container.innerHTML = ''; for (let i = 1; i <= 10; i++) { const filler = data.fillers?.find(f => f.number === i); const hasAudio = !!filler; const card = document.createElement('div'); card.className = `filler-slot ${hasAudio ? 'has-audio' : ''}`; const fillerText = (filler?.text || ''); card.innerHTML = `
                    <div class="filler-slot-header">
                        <div class="filler-slot-title">üéôÔ∏è Filler ${i}</div>
                        <div class="filler-slot-status ${hasAudio ? 'filled' : 'empty'}">${hasAudio ? '‚úÖ Ready' : '‚ö™ Empty'}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.8); margin-bottom: 6px;">Filler Text</div>
                        <textarea id="fillerText${i}" placeholder="Type any filler phrase here (e.g., 'Just a second‚Ä¶')" style="width: 100%; min-height: 70px; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 13px; resize: vertical;">${fillerText}</textarea>
                        <div style="margin-top: 6px; font-size: 11px; color: rgba(255,255,255,0.55);">Tip: leave blank to generate a random filler. Long text will be trimmed.</div>
                    </div>
                    <div class="filler-slot-controls">
                        <button class="btn-slot play" onclick="playFiller(${i})" ${!hasAudio ? 'disabled' : ''}>‚ñ∂Ô∏è Play</button>
                        <button class="btn-slot regenerate" onclick="regenerateFiller(${i})">üîÑ Generate</button>
                        <button class="btn-slot delete" onclick="deleteFiller(${i})" ${!hasAudio ? 'disabled' : ''}>üóëÔ∏è Delete</button>
                    </div>
                `; container.appendChild(card); } } catch (error) { console.error('Error loading filler slots:', error); showAlert('Error loading filler slots', 'error'); } }
        async function playFiller(slot) { try { const audio = new Audio(`/api/super-admin/get-filler/${slot}?voice_id=sarah&t=${Date.now()}`); audio.play(); } catch (error) { console.error('Error playing filler:', error); showAlert('Error playing audio', 'error'); } }
        async function regenerateFiller(slot) { 
            try { 
                const btn = event.target; 
                btn.disabled = true; 
                btn.textContent = '‚è≥ Generating...'; 
                const textEl = document.getElementById(`fillerText${slot}`); 
                let customText = (textEl?.value || '').trim();
                
                // Clear the textarea if user wants AI to choose a new word
                if (!customText) {
                    console.log('No custom text provided, AI will choose random filler');
                }
                
                const response = await fetch(`/api/super-admin/regenerate-filler/${slot}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        voice_id: 'sarah', 
                        updated_by: 'super-admin', 
                        use_ai: true, 
                        text: customText || '' 
                    }) 
                }); 
                const data = await response.json(); 
                if (data.success) { 
                    showAlert(`Filler ${slot} generated successfully`, 'success', false); 
                    await loadFillerSlots(); 
                } else { 
                    showAlert(data.error || 'Failed to generate filler', 'error', false); 
                    btn.disabled = false; 
                    btn.textContent = 'üîÑ Generate'; 
                } 
            } catch (error) { 
                console.error('Error regenerating filler:', error); 
                showAlert('Error generating filler', 'error', false); 
            } 
        }
        async function deleteFiller(slot) { 
            if (!confirm(`Delete filler ${slot}?`)) return; 
            try { 
                const response = await fetch(`/api/super-admin/delete-filler/${slot}?voice_id=sarah`, { method: 'DELETE' }); 
                const data = await response.json(); 
                if (data.success) { 
                    showAlert(`Filler ${slot} deleted`, 'success', false); 
                    await loadFillerSlots(); 
                } else { 
                    showAlert('Failed to delete filler', 'error', false); 
                } 
            } catch (error) { 
                console.error('Error deleting filler:', error); 
                showAlert('Error deleting filler', 'error', false); 
            } 
        }
        async function generateAllFillers() { 
            if (!confirm('Generate all 10 filler audio files? This will overwrite existing ones.')) return; 
            try { 
                const statusEl = document.getElementById('generateAllStatus'); 
                statusEl.textContent = '‚è≥ Generating all 10 fillers...'; 
                statusEl.style.color = '#f39c12'; 
                const response = await fetch('/api/super-admin/generate-speechmatics-fillers', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ voice_id: 'sarah', updated_by: 'super-admin' }) 
                }); 
                const data = await response.json(); 
                if (data.success) { 
                    showAlert('All 10 fillers generated successfully!', 'success', false); 
                    statusEl.textContent = '‚úÖ Complete!'; 
                    statusEl.style.color = '#2ecc71'; 
                    await loadFillerSlots(); 
                    setTimeout(() => { statusEl.textContent = ''; }, 3000); 
                } else { 
                    showAlert(data.error || 'Failed to generate fillers', 'error', false); 
                    statusEl.textContent = '‚ùå Failed'; 
                    statusEl.style.color = '#e74c3c'; 
                } 
            } catch (error) { 
                console.error('Error generating all fillers:', error); 
                showAlert('Error generating fillers', 'error', false); 
            } 
        }
        function showAlert(message, type, scrollToTop = false, duration = 5000) { 
            const alertBox = document.getElementById('alertBox'); 
            if (!alertBox) {
                console.error('Alert box not found');
                alert(message); // Fallback to browser alert
                return;
            }
            
            // Use innerHTML if message contains HTML tags, otherwise textContent
            if (message.includes('<')) {
                alertBox.innerHTML = message;
            } else {
                alertBox.textContent = message;
            }
            alertBox.className = `alert alert-${type}`; 
            alertBox.style.display = 'block'; 
            alertBox.style.animation = 'slideIn 0.3s ease-out';
            
            // Optionally scroll to top to make alert visible
            if (scrollToTop) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // Auto-hide after specified duration
            setTimeout(() => { 
                alertBox.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    alertBox.style.display = 'none'; 
                }, 300);
            }, duration); 
        }
        
        // Call Performance Analysis Functions
        // (selectedCallUuid declared at top of script)
        
        // Speechmatics Streaming Status Polling
        // (streamingStatusInterval declared at top of script)
        
        async function updateStreamingStatus() {
            try {
                const response = await fetch('/api/super-admin/speechmatics-streaming-status');
                const data = await response.json();
                
                const indicator = document.getElementById('streamingIndicator');
                const label = document.getElementById('streamingLabel');
                const mode = document.getElementById('streamingMode');
                const statusDiv = document.getElementById('streamingStatus');
                
                if (data.is_streaming) {
                    indicator.className = 'streaming-indicator active';
                    label.textContent = 'WebSocket Streaming';
                    mode.textContent = 'Real-time chunks';
                } else {
                    indicator.className = 'streaming-indicator inactive';
                    label.textContent = 'HTTP Fallback';
                    mode.textContent = 'Batch generation';
                }
                
                statusDiv.style.display = 'flex';
                
                // Make draggable after showing
                if (!statusDiv.classList.contains('draggable-initialized')) {
                    makeStreamingStatusDraggable();
                    statusDiv.classList.add('draggable-initialized');
                }
            } catch (error) {
                console.error('Error fetching streaming status:', error);
            }
        }
        
        function startStreamingStatusPolling() {
            updateStreamingStatus(); // Initial update
            if (streamingStatusInterval) clearInterval(streamingStatusInterval);
            streamingStatusInterval = setInterval(updateStreamingStatus, 2000); // Poll every 2 seconds
        }
        
        function stopStreamingStatusPolling() {
            if (streamingStatusInterval) {
                clearInterval(streamingStatusInterval);
                streamingStatusInterval = null;
            }
        }

        // Live Brain Usage Polling (OpenAI vs DeepSeek vs Groq)
        let brainUsageInterval = null;

        async function updateLiveBrainUsage() {
            try {
                const resp = await fetch('/api/super-admin/live-brain-usage');
                const data = await resp.json();

                const callEl = document.getElementById('liveBrainUsageCall');
                const textEl = document.getElementById('liveBrainUsageText');
                const providersEl = document.getElementById('liveBrainUsageProviders');
                const reasonsEl = document.getElementById('liveBrainUsageReasons');
                if (!callEl || !textEl) return;

                if (!data || !data.success) {
                    callEl.textContent = 'Unavailable';
                    textEl.textContent = 'OpenAI 0% | DeepSeek 0% | Groq 0% | OpenRouter 0%';
                    if (providersEl) providersEl.textContent = '';
                    if (reasonsEl) reasonsEl.textContent = '';
                    return;
                }

                const active = (data.active_calls || []);
                if (!active.length) {
                    callEl.textContent = 'No active call';
                    textEl.textContent = 'OpenAI 0% | DeepSeek 0% | Groq 0% | OpenRouter 0%';
                    if (providersEl) providersEl.textContent = '';
                    if (reasonsEl) reasonsEl.textContent = '';
                    return;
                }

                const a = active[0];
                const selected = (a.selected_provider || 'openai');
                const effective = (a.effective_provider || 'openai');
                const reasons = Array.isArray(a.gating_reasons) ? a.gating_reasons : [];
                callEl.textContent = `Call UUID: ${a.call_uuid || 'unknown'}`;
                if (providersEl) {
                    providersEl.innerHTML = `<span style="font-weight: 700;">Selected:</span> ${selected} &nbsp; <span style="font-weight: 700;">Effective:</span> ${effective} &nbsp; <span style="opacity: 0.85;">(turns: ${a.openai_turns || 0} OpenAI / ${a.deepseek_turns || 0} DeepSeek / ${a.groq_turns || 0} Groq / ${a.openrouter_turns || 0} OpenRouter)</span>`;
                }
                if (reasonsEl) {
                    reasonsEl.textContent = reasons.length ? `Why fallback happened: ${reasons.join(', ')}` : '';
                }
                textEl.textContent = `OpenAI ${a.openai_percent || 0}% | DeepSeek ${a.deepseek_percent || 0}% | Groq ${a.groq_percent || 0}% | OpenRouter ${a.openrouter_percent || 0}%`;
            } catch (e) {
                const callEl = document.getElementById('liveBrainUsageCall');
                const textEl = document.getElementById('liveBrainUsageText');
                const providersEl = document.getElementById('liveBrainUsageProviders');
                const reasonsEl = document.getElementById('liveBrainUsageReasons');
                if (callEl) callEl.textContent = 'Error loading';
                if (textEl) textEl.textContent = 'OpenAI 0% | DeepSeek 0% | Groq 0% | OpenRouter 0%';
                if (providersEl) providersEl.textContent = '';
                if (reasonsEl) reasonsEl.textContent = '';
                console.error('Error fetching live brain usage:', e);
            }
        }

        function startBrainUsagePolling() {
            updateLiveBrainUsage();
            if (brainUsageInterval) clearInterval(brainUsageInterval);
            brainUsageInterval = setInterval(updateLiveBrainUsage, 2000);
        }

        function stopBrainUsagePolling() {
            if (brainUsageInterval) {
                clearInterval(brainUsageInterval);
                brainUsageInterval = null;
            }
        }
        
        async function loadRecentCalls() {
            try {
                const container = document.getElementById('recentCallsList');
                if (!container) {
                    console.warn('recentCallsList container not found; skipping recent calls load');
                    return;
                }

                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.75); padding: 20px;">Loading‚Ä¶</div>';

                const response = await fetch('/api/super-admin/recent-calls');

                if (!response.ok) {
                    let detail = '';
                    try {
                        const errJson = await response.json();
                        detail = errJson?.error || errJson?.detail || '';
                    } catch (_) {
                        // ignore parse errors
                    }
                    if (response.status === 401) {
                        container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.75); padding: 20px;">Session expired ‚Äî please log in again.</div>';
                        return;
                    }
                    container.innerHTML = `<div style="text-align: center; color: #e74c3c; padding: 20px;">Error loading calls (HTTP ${response.status})${detail ? `: ${detail}` : ''}</div>`;
                    return;
                }

                const data = await response.json().catch(() => ({}));
                
                if (data.success && data.calls.length > 0) {
                    container.innerHTML = '';
                    
                    data.calls.forEach(call => {
                        const startTime = new Date(call.start_time);
                        const duration = call.duration || 0;
                        const avgResponse = call.average_response_time ? `${call.average_response_time.toFixed(0)}ms avg` : 'N/A';

                        const selected = (call.selected_brain_provider || '').toString().trim();
                        const effective = (call.effective_brain_provider || '').toString().trim();
                        const callMode = (call.call_mode || '').toString().trim();
                        let reasons = call.brain_gating_reasons;
                        try {
                            if (typeof reasons === 'string' && reasons.trim().startsWith('[')) {
                                reasons = JSON.parse(reasons);
                            }
                        } catch (e) {
                            // ignore parse errors
                        }
                        if (!Array.isArray(reasons)) reasons = [];
                        const providerLine = (selected || effective)
                            ? `üß† ${selected ? `Selected: ${selected}` : ''}${selected && effective ? ' / ' : ''}${effective ? `Effective: ${effective}` : ''}${callMode ? ` (${callMode})` : ''}`
                            : '';
                        const reasonsLine = reasons.length ? `Why: ${reasons.join(', ')}` : '';
                        
                        const callItem = document.createElement('div');
                        callItem.className = 'call-item';
                        callItem.onclick = () => selectCall(call.call_uuid, callItem);
                        callItem.innerHTML = `
                            <div class="call-time">${startTime.toLocaleString()}</div>
                            <div class="call-from">üìû ${call.caller_number} ‚Üí ${call.user_phone || 'Unknown'}</div>
                            <div class="call-duration">‚è±Ô∏è ${duration}s | ${avgResponse} | ${call.business_name || 'No business'}</div>
                            ${providerLine ? `<div class="call-duration" style="opacity: 0.9;">${providerLine}</div>` : ''}
                            ${reasonsLine ? `<div class="call-duration" style="opacity: 0.8;">${reasonsLine}</div>` : ''}
                        `;
                        container.appendChild(callItem);
                    });
                } else {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">No recent calls found</div>';
                }
            } catch (error) {
                console.error('Error loading recent calls:', error);
                const container = document.getElementById('recentCallsList');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">Error loading calls</div>';
                }
            }
        }
        
        function selectCall(callUuid, element) {
            selectedCallUuid = callUuid;
            
            // Update UI
            document.querySelectorAll('.call-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            
            // Optional: if a call analysis UI exists in this build, enable it.
            const analyzeBtn = document.getElementById('analyzeCallBtn');
            if (analyzeBtn) analyzeBtn.disabled = false;
            const results = document.getElementById('analysisResults');
            if (results) results.style.display = 'none';
        }
        
        async function analyzeSelectedCall() {
            if (!selectedCallUuid) return;
            
            const btn = document.getElementById('analyzeBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚è≥</span> Analyzing...';
            
            try {
                const response = await fetch(`/api/super-admin/call-analysis/${selectedCallUuid}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResults(data);
                } else {
                    showAlert('Failed to analyze call: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error analyzing call:', error);
                showAlert('Error analyzing call', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function displayAnalysisResults(data) {
            const resultsDiv = document.getElementById('analysisResults');
            const stagesDiv = document.getElementById('timingStages');
            const bottleneckDiv = document.getElementById('bottleneckInfo');
            
            // Display quality score and analysis if available
            let qualityHtml = '';
            if (data.call_info.quality_score !== null && data.call_info.quality_score !== undefined) {
                const score = data.call_info.quality_score;
                let scoreColor = '#27ae60'; // Green
                if (score < 50) scoreColor = '#e74c3c'; // Red
                else if (score < 75) scoreColor = '#f39c12'; // Orange
                
                qualityHtml = `
                    <div class="quality-card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                            <div style="font-size: 48px; font-weight: 900; color: ${scoreColor};">${score}/100</div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 5px;">Call Quality Score</div>
                                <div style="font-size: 13px; opacity: 0.8;">${score >= 80 ? '‚úÖ Excellent' : score >= 60 ? '‚ö†Ô∏è Good' : 'üö® Needs Improvement'}</div>
                            </div>
                            <button onclick="analyzeCallQuality('${data.call_info.call_uuid}')" class="btn-analyze" style="padding: 10px 20px;">
                                üîÑ Re-analyze Quality
                            </button>
                        </div>
                        ${data.call_info.instruction_adherence ? `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">üìã Instruction Adherence:</div>
                                <div style="font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${data.call_info.instruction_adherence}</div>
                            </div>
                        ` : ''}
                        ${data.call_info.performance_issues && data.call_info.performance_issues !== 'None detected' ? `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; border-left: 4px solid #e74c3c;">
                                <div style="font-weight: 600; color: #e74c3c; margin-bottom: 8px;">‚ö†Ô∏è Performance Issues:</div>
                                <div style="font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${data.call_info.performance_issues}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                qualityHtml = `
                    <div class="quality-card" style="background: rgba(255, 193, 7, 0.1); border: 2px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: center;">
                        <div style="font-size: 16px; color: white; margin-bottom: 15px;">üìä No quality analysis yet for this call</div>
                        <button onclick="analyzeCallQuality('${data.call_info.call_uuid}')" class="btn-analyze" style="padding: 12px 24px;">
                            ü§ñ Analyze Call Quality with AI
                        </button>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 10px;">Uses DeepSeek AI to evaluate instruction adherence and performance</div>
                    </div>
                `;
            }
            
            // Display quality section first
            stagesDiv.innerHTML = qualityHtml;
            
            // Display timing stages
            data.timing_analysis.stages.forEach(stage => {
                const stageEl = document.createElement('div');
                stageEl.className = `timing-stage ${stage.status}`;
                
                let durationHtml = '';
                if (stage.actual_duration) {
                    const isLonger = stage.actual_duration && parseInt(stage.actual_duration) > 2000;
                    durationHtml = `<span class="stage-duration ${isLonger ? 'critical' : ''}">${stage.actual_duration}</span>`;
                } else if (stage.typical_duration) {
                    durationHtml = `<span class="stage-duration">${stage.typical_duration}</span>`;
                }
                
                stageEl.innerHTML = `
                    <div class="stage-header">
                        <div class="stage-name">${stage.stage}</div>
                        ${durationHtml}
                    </div>
                    <div class="stage-desc">${stage.description}</div>
                    ${stage.note ? `<div class="stage-note">‚ö†Ô∏è ${stage.note}</div>` : ''}
                `;
                stagesDiv.appendChild(stageEl);
            });
            
            // Display bottleneck info
            if (data.timing_analysis.bottleneck) {
                const bottleneck = data.timing_analysis.bottleneck;
                bottleneckDiv.innerHTML = `
                    <div class="bottleneck-card">
                        <div class="bottleneck-title">üö® Critical Bottleneck Identified</div>
                        <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 10px;">
                            ${bottleneck.stage}: <span style="color: #e74c3c;">${bottleneck.impact}</span>
                        </div>
                        <div class="recommendation">
                            <div class="recommendation-title">üí° Recommended Solutions:</div>
                            <div style="color: rgba(255,255,255,0.9); margin-bottom: 12px;">${bottleneck.recommendation}</div>
                            ${bottleneck.alternatives.map(alt => 
                                `<div class="alternative">
                                    <strong>${alt.provider}:</strong> ${alt.estimated_improvement}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                bottleneckDiv.innerHTML = '';
            }
            
            resultsDiv.style.display = 'block';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function analyzeCallQuality(callUuid) {
            if (!callUuid) return;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">ü§ñ</span> Analyzing with AI...';
            
            try {
                const response = await fetch(`/api/super-admin/analyze-call-quality/${callUuid}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Call quality analysis complete!', 'success');
                    // Reload the analysis to show new scores
                    await analyzeSelectedCall();
                } else {
                    showAlert('‚ùå Analysis failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error analyzing call quality:', error);
                showAlert('‚ùå Error analyzing call quality', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ===== SERVICE HEALTH MONITORING =====
        // (healthCheckInterval and healthData declared at top of script)

        // Health check definitions
        const healthChecks = {
            openai: {
                icon: 'üß†',
                name: 'OpenAI Connection',
                desc: 'Monitors OpenAI API connectivity and authentication. If this is red, the AI brain cannot process calls.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/openai-key');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'error', message: 'API key not configured' };
                        return { status: 'ok', message: 'Connected' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            speechmatics: {
                icon: 'üéôÔ∏è',
                name: 'Speechmatics TTS',
                desc: 'Monitors Speechmatics text-to-speech service. If this is red, voice synthesis will fail.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/speechmatics-key');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'error', message: 'API key not configured' };
                        return { status: 'ok', message: 'TTS ready' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            vonage: {
                icon: 'üìû',
                name: 'Vonage Telephony',
                desc: 'Monitors Vonage API for phone call handling. If this is red, incoming/outgoing calls cannot be processed.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/vonage-keys');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'error', message: 'Credentials not configured' };
                        return { status: 'ok', message: 'Telephony active' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            database: {
                icon: 'üíæ',
                name: 'Database Access',
                desc: 'Checks SQLite database connectivity. If this is red, call logs and settings cannot be stored/retrieved.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/accounts');
                        if (!resp.ok) return { status: 'error', message: 'Query failed' };
                        await resp.json();
                        return { status: 'ok', message: 'DB accessible' };
                    } catch (e) {
                        return { status: 'error', message: 'Connection error' };
                    }
                }
            },
            webhook: {
                icon: 'üåê',
                name: 'Ngrok Webhook',
                desc: 'Monitors webhook URL accessibility for Vonage callbacks. If this is red, incoming calls will not reach the server.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/health');
                        if (!resp.ok) return { status: 'warning', message: 'May not be exposed' };
                        await resp.json();
                        return { status: 'ok', message: 'Webhook accessible' };
                    } catch (e) {
                        return { status: 'warning', message: 'Cannot verify' };
                    }
                }
            },
            deepseek: {
                icon: 'üîÆ',
                name: 'DeepSeek API',
                desc: 'Monitors DeepSeek AI provider (alternative brain). If this is red and selected as brain, AI calls will fail.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/deepseek-key');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'warning', message: 'Not configured' };
                        
                        // Check if it's the active brain
                        try {
                            const brainResp = await fetch('/api/super-admin/brain-provider');
                            if (brainResp.ok) {
                                const brainData = await brainResp.json();
                                if (brainData.provider === 'deepseek') {
                                    return { status: 'ok', message: 'Active brain' };
                                }
                            }
                        } catch (e) {
                            // Ignore brain check error
                        }
                        return { status: 'ok', message: 'Configured (standby)' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            credits: {
                icon: 'üí≥',
                name: 'Account Credits',
                desc: 'Monitors API credit balances. If this is red, one or more services may have exhausted their credits.',
                checkFn: async () => {
                    // This is a placeholder - actual credit checking would require API provider balance endpoints
                    return { status: 'ok', message: 'Monitoring active' };
                }
            },
            server: {
                icon: 'üñ•Ô∏è',
                name: 'Server Health',
                desc: 'Overall server health including memory, CPU, and uptime. If this is red, performance degradation is occurring.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/health');
                        if (!resp.ok) return { status: 'error', message: 'Not responding' };
                        const data = await resp.json();
                        if (data.status === 'healthy') {
                            return { status: 'ok', message: 'Running normally' };
                        }
                        return { status: 'warning', message: 'Performance issues' };
                    } catch (e) {
                        return { status: 'error', message: 'Not responding' };
                    }
                }
            },
            ngrok: {
                icon: 'üåâ',
                name: 'Ngrok Tunnel',
                desc: 'Monitors ngrok tunnel status and public URL availability. If this is red, incoming calls from Vonage cannot reach your server.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/admin/ngrok-status');
                        if (!resp.ok) return { status: 'error', message: 'API error' };
                        const data = await resp.json();
                        if (data.running) {
                            const url = data.url || '';
                            const shortUrl = url.replace('https://', '').substring(0, 25);
                            return { status: 'ok', message: `Active: ${shortUrl}...`, details: data };
                        }
                        return { status: 'error', message: data.message || 'Not running' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            cloudflare: {
                icon: '‚òÅÔ∏è',
                name: 'Cloudflare Tunnel',
                desc: 'Monitors Cloudflare tunnel status and public URL availability. If this is red, incoming calls from Vonage cannot reach your server. Double-click to start the tunnel.',
                checkFn: async () => {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const resp = await fetch('/api/admin/ngrok-status', {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        if (!resp.ok) return { status: 'error', message: 'Not running' };
                        const data = await resp.json();
                        const cloudflareRunning = data.cloudflare_running || false;
                        
                        if (cloudflareRunning) {
                            const url = data.cloudflare_url || '';
                            if (url && url.includes('trycloudflare.com')) {
                                const shortUrl = url.replace('https://', '').replace('http://', '').substring(0, 30);
                                return { status: 'ok', message: shortUrl, details: data };
                            }
                            return { status: 'warning', message: 'Running (no URL yet)', details: data };
                        }
                        return { status: 'error', message: 'Offline - double-click to start' };
                    } catch (e) {
                        if (e.name === 'AbortError') {
                            return { status: 'error', message: 'Offline' };
                        }
                        return { status: 'error', message: 'Offline' };
                    }
                }
            },
            activecalls: {
                icon: 'üìû',
                name: 'Active Calls',
                desc: 'Shows current active call sessions. Turns green when calls are in progress. If always red, no calls are being handled.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/active-calls');
                        if (!resp.ok) return { status: 'error', message: 'API error' };
                        const data = await resp.json();
                        const count = data.count || 0;
                        if (count > 0) {
                            return { status: 'ok', message: `${count} active call${count > 1 ? 's' : ''}` };
                        }
                        return { status: 'checking', message: 'No active calls' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            resources: {
                icon: '‚ö°',
                name: 'System Resources',
                desc: 'Monitors CPU and RAM usage. If this is red or yellow, the server is under heavy load and may experience performance issues.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/health');
                        if (!resp.ok) return { status: 'error', message: 'API error' };
                        const data = await resp.json();
                        const cpu = data.system?.cpu_percent || 0;
                        const mem = data.system?.memory_percent || 0;
                        
                        // Critical thresholds
                        if (cpu > 85 || mem > 90) {
                            return { status: 'error', message: `CPU ${cpu.toFixed(0)}% | RAM ${mem.toFixed(0)}% - Critical!` };
                        }
                        // Warning thresholds
                        if (cpu > 70 || mem > 75) {
                            return { status: 'warning', message: `CPU ${cpu.toFixed(0)}% | RAM ${mem.toFixed(0)}% - High` };
                        }
                        // All good
                        return { status: 'ok', message: `CPU ${cpu.toFixed(0)}% | RAM ${mem.toFixed(0)}%` };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            }
        };

        async function updateHealthStatus(serviceId) {
            const check = healthChecks[serviceId];
            if (!check) {
                console.error(`No health check found for: ${serviceId}`);
                return;
            }

            const circleEl = document.getElementById(`health-${serviceId}`);
            const statusEl = document.getElementById(`status-${serviceId}`);
            
            if (!circleEl || !statusEl) {
                console.error(`Elements not found for ${serviceId}`);
                return;
            }
            
            try {
                console.log(`Checking ${serviceId}...`);
                
                // Add timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Check timeout')), 8000)
                );
                
                const result = await Promise.race([
                    check.checkFn(),
                    timeoutPromise
                ]);
                
                healthData[serviceId] = result;
                
                // Update circle status
                circleEl.className = 'health-circle ' + result.status;
                
                // Update status text
                statusEl.textContent = result.message;
                
                console.log(`${serviceId}: ${result.status} - ${result.message}`);
                
            } catch (error) {
                console.error(`Health check failed for ${serviceId}:`, error);
                const errorMsg = error.message === 'Check timeout' ? 'Timeout' : 'Check failed';
                healthData[serviceId] = { status: 'error', message: errorMsg };
                circleEl.className = 'health-circle error';
                statusEl.textContent = errorMsg;
            }
        }

        async function updateAllHealthStatuses() {
            console.log('üîç Running health checks for all services...');
            const services = Object.keys(healthChecks);
            console.log('Services to check:', services);
            
            await Promise.all(services.map(service => updateHealthStatus(service)));
            
            console.log('‚úÖ All health checks completed');
            
            // Check if we need to show the configuration warning
            checkConfigurationState();
        }
        
        function checkConfigurationState() {
            // Count API key errors
            let apiKeyErrors = 0;
            const apiKeyChecks = ['openai', 'speechmatics', 'vonage', 'deepseek'];
            
            for (const checkName of apiKeyChecks) {
                const data = healthData[checkName];
                if (data && data.status === 'error' && data.message && data.message.includes('not configured')) {
                    apiKeyErrors++;
                }
            }
            
            // Show warning banner and reload button if 2+ API keys show as not configured
            // (likely means they're in DB but not loaded into memory)
            const warningBanner = document.getElementById('configWarningBanner');
            const reloadBtn = document.getElementById('reloadConfigBtn');
            if (apiKeyErrors >= 2) {
                if (warningBanner) warningBanner.style.display = 'block';
                if (reloadBtn) reloadBtn.style.display = 'block';
            } else {
                if (warningBanner) warningBanner.style.display = 'none';
                if (reloadBtn) reloadBtn.style.display = 'none';
            }
        }
        
        async function reloadConfiguration() {
            try {
                showAlert('üîÑ Reloading configuration from database...', 'info');
                
                const response = await fetch('/api/super-admin/reload-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ ' + data.message + ' - Refreshing status indicators...', 'success');
                    
                    // Wait a moment for server to settle, then refresh status checks
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    // Force refresh all health statuses (runs all checks in parallel)
                    await updateAllHealthStatuses();
                    
                    // Hide warning banner after successful reload
                    checkConfigurationState();
                } else {
                    showAlert('‚ùå ' + (data.message || data.error || 'Failed to reload configuration'), 'error');
                }
            } catch (error) {
                console.error('Error reloading configuration:', error);
                showAlert('‚ùå Error: ' + error.message, 'error');
            }
        }

        function startHealthMonitoring() {
            console.log('Starting health monitoring...');
            // Initial check
            updateAllHealthStatuses();
            
            // Poll every 10 seconds for live status updates
            if (healthCheckInterval) clearInterval(healthCheckInterval);
            healthCheckInterval = setInterval(updateAllHealthStatuses, 10000);
            console.log('Health monitoring started, polling every 10 seconds');
        }

        function stopHealthMonitoring() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
        }

        function showHealthDetails(serviceId) {
            const check = healthChecks[serviceId];
            const data = healthData[serviceId] || { status: 'checking', message: 'Loading...' };
            
            const modal = document.getElementById('healthModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalDesc = document.getElementById('modalDesc');
            const modalDetails = document.getElementById('modalDetails');
            const modalStatus = document.getElementById('modalStatus');
            
            // Set content
            modalIcon.textContent = check.icon;
            modalTitle.textContent = check.name;
            modalDesc.textContent = check.desc;
            
            // Build details
            let detailsHTML = '';
            if (data.status === 'error') {
                detailsHTML = `
                    <div class="health-modal-detail">
                        <span class="health-modal-label">What's wrong?</span>
                        <span class="health-modal-value">${data.message}</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Impact</span>
                        <span class="health-modal-value">Service degraded</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Action required</span>
                        <span class="health-modal-value">Configure API keys</span>
                    </div>
                `;
            } else if (data.status === 'warning') {
                detailsHTML = `
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Status</span>
                        <span class="health-modal-value">${data.message}</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Impact</span>
                        <span class="health-modal-value">Limited functionality</span>
                    </div>
                `;
            } else {
                detailsHTML = `
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Status</span>
                        <span class="health-modal-value">${data.message}</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Last checked</span>
                        <span class="health-modal-value">Just now</span>
                    </div>
                `;
            }
            modalDetails.innerHTML = detailsHTML;
            
            // Set overall status
            modalStatus.className = 'health-modal-status ' + data.status;
            if (data.status === 'ok') {
                modalStatus.innerHTML = '‚úÖ All systems operational';
            } else if (data.status === 'warning') {
                modalStatus.innerHTML = '‚ö†Ô∏è Minor issues detected';
            } else {
                modalStatus.innerHTML = 'üö® Service requires attention';
            }
            
            // Show modal
            modal.classList.add('show');
        }

        function closeHealthModal(event) {
            const modal = document.getElementById('healthModal');
            modal.classList.remove('show');
        }

        // ===== SYSTEM CONTROLS =====
        
        async function testCall() {
            showAlert('üîç Testing call system...', 'info');
            try {
                const resp = await fetch('/api/admin/test-call', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Test failed: ' + e.message, 'error');
            }
        }

        async function restartVoiceEngine() {
            if (!confirm('‚ö†Ô∏è This will restart the voice system. Active calls will be dropped. Continue?')) return;
            showAlert('üîÑ Restarting voice engine...', 'info');
            try {
                const resp = await fetch('/api/admin/restart-voice', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert('‚úÖ Voice engine restarted successfully', 'success');
                    setTimeout(() => updateAllHealthStatuses(), 2000);
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Restart failed: ' + e.message, 'error');
            }
        }

        async function clearCallCache() {
            if (!confirm('Clear cached call data? This may help if calls are stuck.')) return;
            showAlert('üóëÔ∏è Clearing call cache...', 'info');
            try {
                const resp = await fetch('/api/admin/clear-cache', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    setTimeout(() => updateAllHealthStatuses(), 2000);
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Clear cache failed: ' + e.message, 'error');
            }
        }

        async function restartServer() {
            if (!confirm('‚ö†Ô∏è RESTART SERVER: This will restart the entire server process. All active calls will be dropped and the page will reload. Continue?')) return;
            
            // Stop health monitoring to prevent errors during restart
            stopHealthMonitoring();
            
            showAlert('üîÅ Server restart initiated... Please wait.', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/restart-server', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data.success) {
                    showAlert('‚úÖ Server is restarting... Waiting for it to come back online.', 'success');
                }
            } catch (e) {
                // Server disconnected (expected during restart)
                showAlert('üîÅ Server is restarting... Waiting for it to come back online.', 'info');
            }
            
            // Wait for server to come back online before reloading
            let attempts = 0;
            const maxAttempts = 30; // 30 seconds max wait
            const checkInterval = setInterval(async () => {
                attempts++;
                try {
                    const healthResp = await fetch('/api/health', { method: 'GET', cache: 'no-cache' });
                    if (healthResp.ok || healthResp.status === 500) {
                        // Server is responding (even if unhealthy status, it's online)
                        clearInterval(checkInterval);
                        showAlert('‚úÖ Server is back online! Reloading page...', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } catch (e) {
                    // Server still down, keep waiting
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        showAlert('‚ö†Ô∏è Server restart timeout. Please refresh the page manually.', 'warning');
                    }
                }
            }, 1000); // Check every second
        }

        async function checkWebhooks() {
            showAlert('üåê Checking webhook configuration...', 'info');
            try {
                const resp = await fetch('/api/admin/check-webhooks');
                const data = await resp.json();
                if (data.success) {
                    const info = `
                        <div style="text-align: left; line-height: 1.8;">
                            <strong>Answer URL:</strong> ${data.answer_url}<br>
                            <strong>Event URL:</strong> ${data.event_url}<br>
                            <strong>Status:</strong> ${data.status}
                        </div>
                    `;
                    showAlert(info, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Check failed: ' + e.message, 'error');
            }
        }

        async function testOpenAI() {
            showAlert('üß† Testing OpenAI connection...', 'info');
            try {
                const resp = await fetch('/api/admin/test-openai', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ OpenAI test passed: ${data.message}`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Test failed: ' + e.message, 'error');
            }
        }

        async function testVoicePipeline() {
            showAlert('üî¨ Running comprehensive voice pipeline diagnostics...', 'info');
            try {
                const resp = await fetch('/api/super-admin/test-voice-pipeline', { method: 'POST' });
                const data = await resp.json();
                
                if (data.success && data.report) {
                    const report = data.report;
                    
                    // Build plain text report for clipboard
                    let plainTextReport = `VOICE PIPELINE DIAGNOSTIC REPORT\n`;
                    plainTextReport += `=================================\n\n`;
                    plainTextReport += `${report.summary}\n\n`;
                    plainTextReport += `Tests: ${report.test_counts.passed} passed, ${report.test_counts.failed} failed, ${report.test_counts.warned} warnings\n`;
                    plainTextReport += `Timestamp: ${report.timestamp}\n\n`;
                    
                    if (report.critical_issues.length > 0) {
                        plainTextReport += `CRITICAL ISSUES:\n`;
                        report.critical_issues.forEach(issue => {
                            plainTextReport += `  - ${issue}\n`;
                        });
                        plainTextReport += `\n`;
                    }
                    
                    if (report.warnings.length > 0) {
                        plainTextReport += `WARNINGS:\n`;
                        report.warnings.forEach(warn => {
                            plainTextReport += `  - ${warn}\n`;
                        });
                        plainTextReport += `\n`;
                    }
                    
                    plainTextReport += `DETAILED TEST RESULTS:\n`;
                    plainTextReport += `======================\n\n`;
                    report.tests.forEach(test => {
                        plainTextReport += `[${test.status}] ${test.name}\n`;
                        plainTextReport += `    ${test.details}\n\n`;
                    });
                    
                    // Copy to clipboard
                    try {
                        await navigator.clipboard.writeText(plainTextReport);
                        console.log('Report copied to clipboard');
                    } catch (e) {
                        console.error('Failed to copy to clipboard:', e);
                    }
                    
                    // Build detailed HTML report
                    let reportHtml = `
                        <div style="text-align: left; max-height: 500px; overflow-y: auto; line-height: 1.6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #2c3e50;">${report.summary}</h3>
                                <button onclick="copyDiagnosticReport()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    üìã Copy Report
                                </button>
                            </div>
                            <div style="margin-bottom: 20px; padding: 10px; background: #ecf0f1; border-radius: 8px;">
                                <strong>Tests:</strong> ${report.test_counts.passed} passed, 
                                ${report.test_counts.failed} failed, 
                                ${report.test_counts.warned} warnings
                            </div>
                    `;
                    
                    // Show critical issues first
                    if (report.critical_issues.length > 0) {
                        reportHtml += `
                            <div style="background: #ffe6e6; padding: 15px; border-left: 4px solid #e74c3c; margin-bottom: 15px; border-radius: 4px;">
                                <strong style="color: #c0392b;">üö® Critical Issues:</strong><br>
                                ${report.critical_issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    // Show warnings
                    if (report.warnings.length > 0) {
                        reportHtml += `
                            <div style="background: #fff3cd; padding: 15px; border-left: 4px solid #f39c12; margin-bottom: 15px; border-radius: 4px;">
                                <strong style="color: #e67e22;">‚ö†Ô∏è Warnings:</strong><br>
                                ${report.warnings.map(warn => `‚Ä¢ ${warn}`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    // Show all test results
                    reportHtml += '<h4 style="margin-top: 20px; color: #34495e;">Detailed Test Results:</h4>';
                    report.tests.forEach(test => {
                        let icon = '';
                        let color = '';
                        if (test.status === 'PASS') {
                            icon = '‚úÖ';
                            color = '#27ae60';
                        } else if (test.status === 'FAIL') {
                            icon = '‚ùå';
                            color = '#e74c3c';
                        } else if (test.status === 'WARN') {
                            icon = '‚ö†Ô∏è';
                            color = '#f39c12';
                        } else {
                            icon = '‚ÑπÔ∏è';
                            color = '#3498db';
                        }
                        
                        reportHtml += `
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${color};">
                                <div style="font-weight: 600; color: ${color};">
                                    ${icon} ${test.name}
                                </div>
                                <div style="font-size: 13px; color: #555; margin-top: 5px;">
                                    ${test.details}
                                </div>
                            </div>
                        `;
                    });
                    
                    reportHtml += `
                            <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 8px; font-size: 13px; color: #155724;">
                                <strong>‚úÖ Report copied to clipboard!</strong><br>
                                You can paste it directly to share with support.
                            </div>
                        </div>
                    `;
                    
                    // Store report for copy button
                    window.lastDiagnosticReport = plainTextReport;
                    
                    showAlert(reportHtml, 'info');
                } else {
                    showAlert(`‚ùå Diagnostic failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Diagnostic test failed: ' + e.message, 'error');
            }
        }

        function copyDiagnosticReport() {
            if (window.lastDiagnosticReport) {
                navigator.clipboard.writeText(window.lastDiagnosticReport).then(() => {
                    showAlert('‚úÖ Report copied to clipboard!', 'success');
                }).catch(err => {
                    showAlert('‚ùå Failed to copy: ' + err.message, 'error');
                });
            }
        }

        async function autoFixVoice() {
            showAlert('ü§ñ Running auto-fix... This will diagnose and automatically apply known solutions.', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/auto-fix-voice', { method: 'POST' });
                const data = await resp.json();
                
                if (data.success) {
                    // Build detailed report
                    let reportHtml = `
                        <div style="text-align: left; max-height: 500px; overflow-y: auto; line-height: 1.6;">
                            <h3 style="margin-top: 0; color: #2c3e50;">${data.message}</h3>
                    `;
                    
                    if (data.fixes_applied && data.fixes_applied.length > 0) {
                        reportHtml += `
                            <div style="margin: 15px 0; padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">
                                <strong style="color: #155724;">‚úÖ Fixes Applied (${data.fixes_applied.length}):</strong><br>
                        `;
                        data.fixes_applied.forEach(fix => {
                            reportHtml += `
                                <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>${fix.fix}</strong><br>
                                    <span style="font-size: 13px; color: #666;">${fix.description}</span>
                                </div>
                            `;
                        });
                        reportHtml += `</div>`;
                    }
                    
                    if (data.log) {
                        reportHtml += `
                            <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap;">
                                ${data.log.replace(/\n/g, '<br>')}
                            </div>
                        `;
                    }
                    
                    if (data.verification && data.verification.critical_issues && data.verification.critical_issues.length > 0) {
                        reportHtml += `
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                <strong style="color: #856404;">‚ö†Ô∏è Remaining Issues:</strong><br>
                                ${data.verification.critical_issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    reportHtml += `
                            <div style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; font-size: 13px;">
                                <strong>üí° What happened:</strong><br>
                                ‚Ä¢ System analyzed voice issues<br>
                                ‚Ä¢ Applied ${data.fixes_applied ? data.fixes_applied.length : 0} known solutions from fix history<br>
                                ‚Ä¢ Re-ran diagnostic to verify results
                            </div>
                        </div>
                    `;
                    
                    showAlert(reportHtml, data.verification && data.verification.critical_issues && data.verification.critical_issues.length === 0 ? 'success' : 'info');
                } else {
                    showAlert(`‚ùå Auto-fix failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Auto-fix failed: ' + e.message, 'error');
            }
        }

        // ===== TUNNEL PROVIDER MANAGEMENT =====
        
        async function loadTunnelConfig() {
            try {
                const resp = await fetch('/api/super-admin/tunnel-config');
                const data = await resp.json();
                
                if (data.success) {
                    document.getElementById('tunnelProvider').value = data.provider || 'ngrok';
                    document.getElementById('cloudflareDomain').value = data.cloudflare_domain || '';
                    
                    // Show/hide cloudflare options
                    handleTunnelProviderChange();
                    
                    // Load current configured webhook URLs immediately
                    await loadCurrentWebhookUrls();
                    
                    // Update status
                    await updateTunnelStatus();
                }
            } catch (e) {
                console.error('Failed to load tunnel config:', e);
            }
        }

        async function loadCurrentWebhookUrls() {
            try {
                const resp = await fetch('/api/admin/ngrok-status');
                const data = await resp.json();
                
                // Use the stored public URL (cloudflare_url or ngrok_url based on provider)
                let publicUrl = '';
                if (data.provider === 'cloudflare') {
                    publicUrl = data.cloudflare_url;
                } else {
                    publicUrl = data.ngrok_url;
                }
                
                // If no active URL, try to get from CONFIG/DB
                if (!publicUrl) {
                    try {
                        const configResp = await fetch('/api/health');
                        const configData = await configResp.json();
                        publicUrl = configData.public_url || '';
                    } catch (e) {
                        console.debug('Could not fetch public URL from health endpoint');
                    }
                }
                
                if (publicUrl && publicUrl !== 'Unknown') {
                    updateWebhookUrls(publicUrl, true); // Pass true to skip change detection on initial load
                }
            } catch (e) {
                console.error('Failed to load current webhook URLs:', e);
            }
        }

        function handleTunnelProviderChange() {
            const provider = document.getElementById('tunnelProvider').value;
            const cloudflareOptions = document.getElementById('cloudflareOptions');
            
            if (provider === 'cloudflare') {
                cloudflareOptions.style.display = 'block';
            } else {
                cloudflareOptions.style.display = 'none';
            }
        }

        async function saveTunnelConfig() {
            const provider = document.getElementById('tunnelProvider').value;
            const domain = document.getElementById('cloudflareDomain').value;
            const token = document.getElementById('cloudflareTunnelToken').value;
            
            showAlert('üíæ Saving tunnel configuration...', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/tunnel-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, domain, token })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    showAlert('‚úÖ Tunnel configuration saved', 'success');
                } else {
                    showAlert('‚ùå Failed to save: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Save failed: ' + e.message, 'error');
            }
        }

        async function startCloudflare(event) {
            if (event) event.stopPropagation(); // Prevent showHealthDetails from firing
            
            const currentStatus = healthData['cloudflare'];
            if (currentStatus && currentStatus.status === 'ok') {
                showAlert('‚ÑπÔ∏è Cloudflare tunnel is already running', 'info');
                return;
            }
            
            if (!confirm('Start Cloudflare tunnel? This will take a few seconds.')) return;
            
            showAlert('‚ñ∂Ô∏è Starting Cloudflare tunnel...', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/start-tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: 'cloudflare' })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    const url = data.url || '';
                    showAlert(`‚úÖ Cloudflare tunnel started successfully! ${url ? 'URL: ' + url : 'Check logs for URL.'}`, 'success');
                    
                    // Wait a moment then refresh the health status
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    await updateHealthStatus('cloudflare');
                } else {
                    showAlert(`‚ùå Failed to start Cloudflare tunnel: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error starting Cloudflare tunnel:', error);
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function startTunnel() {
            const provider = document.getElementById('tunnelProvider').value;
            showAlert(`‚ñ∂Ô∏è Starting ${provider} tunnel...`, 'info');
            
            try {
                const resp = await fetch('/api/super-admin/start-tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    const msg = data.message || (data.url ? `‚úÖ ${provider} tunnel started: ${data.url}` : `‚úÖ ${provider} tunnel started`);
                    showAlert(msg, 'success');
                    await updateTunnelStatus();
                } else {
                    showAlert('‚ùå Failed to start: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Start failed: ' + e.message, 'error');
            }
        }

        async function stopTunnel() {
            const provider = document.getElementById('tunnelProvider').value;
            
            if (!confirm(`‚ö†Ô∏è Stop ${provider} tunnel? Incoming calls will not reach the server until you restart it.`)) return;
            
            showAlert(`‚èπÔ∏è Stopping ${provider} tunnel...`, 'info');
            
            try {
                const resp = await fetch('/api/super-admin/stop-tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    showAlert(data.message || `‚úÖ ${provider} tunnel stopped`, 'success');
                    await updateTunnelStatus();
                } else {
                    showAlert('‚ùå Failed to stop: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Stop failed: ' + e.message, 'error');
            }
        }

        async function fixEngagedTone() {
            const provider = document.getElementById('tunnelProvider').value || 'cloudflare';
            if (!confirm('üõ† This will restart the tunnel and clear active sessions. Continue?')) return;

            showAlert('üõ† Fixing engaged tone (restarting tunnel)...', 'info');
            try {
                const resp = await fetch('/api/super-admin/fix-engaged', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                const data = await resp.json();
                if (data.success) {
                    showAlert(data.message || '‚úÖ Engaged tone fix complete', 'success');
                    await updateTunnelStatus();
                } else {
                    showAlert('‚ùå Fix failed: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Fix failed: ' + e.message, 'error');
            }
        }

        async function testOpenRouter() {
            const btn = document.getElementById('testOpenRouterBtn');
            const resultDiv = document.getElementById('openrouterTestResult');
            const messageDiv = document.getElementById('openrouterTestMessage');
            const detailsDiv = document.getElementById('openrouterTestDetails');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Testing...';
            resultDiv.style.display = 'none';
            
            try {
                const resp = await fetch('/api/super-admin/test-openrouter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();
                
                resultDiv.style.display = 'block';
                
                if (data.success) {
                    resultDiv.style.background = 'rgba(46, 204, 113, 0.2)';
                    resultDiv.style.border = '2px solid #2ecc71';
                    messageDiv.innerHTML = '‚úÖ ' + data.message;
                    
                    if (data.details) {
                        const details = data.details;
                        detailsDiv.innerHTML = `
                            Model: ${details.model || 'N/A'}<br>
                            Latency: ${details.latency_ms || 'N/A'}ms<br>
                            Response: "${details.response_preview || ''}"
                        `;
                    }
                    
                    showAlert('‚úÖ OpenRouter API is working correctly', 'success');
                } else {
                    resultDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                    resultDiv.style.border = '2px solid #e74c3c';
                    messageDiv.innerHTML = '‚ùå ' + data.message;
                    
                    if (data.details) {
                        if (typeof data.details === 'string') {
                            detailsDiv.textContent = data.details;
                        } else {
                            detailsDiv.textContent = JSON.stringify(data.details, null, 2);
                        }
                    }
                    
                    showAlert('‚ùå OpenRouter test failed: ' + data.message, 'error');
                }
            } catch (e) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                resultDiv.style.border = '2px solid #e74c3c';
                messageDiv.innerHTML = '‚ùå Test failed';
                detailsDiv.textContent = e.message;
                
                showAlert('‚ùå Test failed: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîå Test OpenRouter Connection';
            }
        }

        function _setOpenRouterModelStatus(msg, ok=true) {
            const el = document.getElementById('openrouterModelStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = ok ? 'rgba(120, 255, 160, 0.95)' : 'rgba(255, 140, 140, 0.95)';
        }

        async function loadOpenRouterModels() {
            const refreshBtn = document.getElementById('refreshOpenRouterModelsBtn');
            const selectEl = document.getElementById('openrouterModelSelect');
            if (!selectEl) return;

            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'üîÑ Loading...';
            }
            _setOpenRouterModelStatus('Loading models‚Ä¶', true);

            try {
                // Get current selected model
                let selected = '';
                try {
                    const curResp = await fetch('/api/super-admin/openrouter-model');
                    const curData = await curResp.json();
                    if (curData && curData.success) selected = curData.model || '';
                } catch (_) {}

                const resp = await fetch('/api/super-admin/openrouter-models');
                const data = await resp.json();

                if (!data || !data.success) {
                    const msg = data?.error || data?.message || `Failed to load models (HTTP ${resp.status})`;
                    _setOpenRouterModelStatus(msg, false);
                    return;
                }

                const models = Array.isArray(data.models) ? data.models : [];
                const selectedModel = selected || data.selected_model || '';

                selectEl.innerHTML = '';
                if (!models.length) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No models returned from OpenRouter';
                    selectEl.appendChild(opt);
                    _setOpenRouterModelStatus('No models returned', false);
                    return;
                }

                for (const m of models) {
                    const id = m?.id || '';
                    if (!id) continue;
                    const score = m?.call_latency_score || 5;
                    const priceLabel = m?.pricing_per_million?.label ? ` ‚Äî ${m.pricing_per_million.label}` : '';
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = `‚òÖ${score} ${id}${priceLabel}`;
                    opt.style.background = '#34495e';
                    opt.style.color = '#ecf0f1';
                    selectEl.appendChild(opt);
                }

                if (selectedModel) {
                    selectEl.value = selectedModel;
                }

                _setOpenRouterModelStatus('Loaded', true);
            } catch (e) {
                console.error('Error loading OpenRouter models:', e);
                _setOpenRouterModelStatus(`Load failed: ${e.message || e}`, false);
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'üîÑ Refresh Models';
                }
            }
        }

        async function saveOpenRouterModel() {
            const btn = document.getElementById('saveOpenRouterModelBtn');
            const selectEl = document.getElementById('openrouterModelSelect');
            if (!selectEl) return;

            const model = (selectEl.value || '').trim();
            if (!model) {
                _setOpenRouterModelStatus('Select a model first', false);
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'üíæ Saving...';
            }
            _setOpenRouterModelStatus('Saving‚Ä¶', true);

            try {
                const resp = await fetch('/api/super-admin/openrouter-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, updated_by: 'super-admin' })
                });
                const data = await resp.json();

                if (resp.ok && data && data.success) {
                    _setOpenRouterModelStatus(`Saved: ${data.model || model}`, true);
                    showAlert(`‚úÖ OpenRouter model saved: ${data.model || model}`, 'success');
                } else {
                    const err = data?.error || data?.message || `Save failed (HTTP ${resp.status})`;
                    _setOpenRouterModelStatus(err, false);
                    showAlert('‚ùå Failed to save model: ' + err, 'error');
                }
            } catch (e) {
                _setOpenRouterModelStatus(`Save failed: ${e.message || e}`, false);
                showAlert('‚ùå Failed to save model: ' + (e.message || e), 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üíæ Save Model';
                }
            }
        }

        // Track last known webhook URLs to detect changes
        let lastKnownWebhookUrls = {
            answer: null,
            event: null
        };

        async function updateTunnelStatus() {
            try {
                const resp = await fetch('/api/admin/ngrok-status');
                const data = await resp.json();
                
                const statusEl = document.getElementById('tunnelStatus');
                const urlEl = document.getElementById('tunnelUrl');
                const urlDisplay = document.getElementById('tunnelUrlDisplay');
                const startBtn = document.getElementById('startTunnelBtn');
                const stopBtn = document.getElementById('stopTunnelBtn');
                
                if (data.running) {
                    statusEl.style.background = 'rgba(46, 204, 113, 0.2)';
                    statusEl.style.color = '#2ecc71';
                    statusEl.textContent = 'Running';
                    
                    urlEl.textContent = data.url || 'Unknown';
                    urlDisplay.style.display = 'block';
                    
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                    
                    // Update webhook URLs and check for changes
                    updateWebhookUrls(data.url);
                } else {
                    statusEl.style.background = 'rgba(231, 76, 60, 0.2)';
                    statusEl.style.color = '#e74c3c';
                    statusEl.textContent = 'Not Running';
                    
                    urlDisplay.style.display = 'none';
                    
                    startBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to update tunnel status:', e);
            }
        }

        function updateWebhookUrls(publicUrl, skipChangeDetection = false) {
            if (!publicUrl || publicUrl === 'Unknown') return;
            
            const answerUrl = `${publicUrl}/webhooks/answer`;
            const eventUrl = `${publicUrl}/webhooks/events`;
            
            // Update display
            const answerEl = document.getElementById('vonageAnswerUrl');
            const eventEl = document.getElementById('vonageEventUrl');
            
            if (answerEl) answerEl.textContent = answerUrl;
            if (eventEl) eventEl.textContent = eventUrl;
            
            // Check if URLs have changed (only if not initial load)
            const hasChanged = !skipChangeDetection && (
                lastKnownWebhookUrls.answer !== null &&
                (lastKnownWebhookUrls.answer !== answerUrl || lastKnownWebhookUrls.event !== eventUrl)
            );
            
            if (hasChanged) {
                showWebhookChangeAlert(answerUrl, eventUrl);
            }
            
            // Update tracking
            lastKnownWebhookUrls.answer = answerUrl;
            lastKnownWebhookUrls.event = eventUrl;
        }

        function showWebhookChangeAlert(answerUrl, eventUrl) {
            const alertHtml = `
                <div style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.95) 0%, rgba(230, 126, 34, 0.95) 100%); 
                            color: white; padding: 20px; border-radius: 12px; max-width: 600px; 
                            box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">‚ö†Ô∏è Webhook URLs Changed!</div>
                    <div style="font-size: 14px; margin-bottom: 15px; line-height: 1.5;">
                        Your tunnel URL has changed. Update these URLs in your <strong>Vonage Dashboard</strong>:
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">Answer URL (HTTP POST):</div>
                        <code style="display: block; font-size: 12px; word-break: break-all; font-family: 'Courier New', monospace;">${answerUrl}</code>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">Event URL (HTTP POST):</div>
                        <code style="display: block; font-size: 12px; word-break: break-all; font-family: 'Courier New', monospace;">${eventUrl}</code>
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        üí° Go to: <strong>Vonage Dashboard ‚Üí Your Application ‚Üí Edit Settings</strong>
                    </div>
                </div>
            `;
            showAlert(alertHtml, 'warning', 15000);  // Show for 15 seconds
        }

        async function viewServerLogs() {
            showAlert('üìã Fetching recent logs...', 'info');
            try {
                const resp = await fetch('/api/admin/recent-logs');
                const data = await resp.json();
                if (data.success) {
                    const logHtml = `
                        <div style="background: #000; color: #0f0; padding: 15px; border-radius: 8px; 
                                    font-family: monospace; font-size: 11px; max-height: 400px; 
                                    overflow-y: auto; text-align: left; white-space: pre-wrap;">
${data.logs}
                        </div>
                    `;
                    showAlert(logHtml, 'info');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Failed to fetch logs: ' + e.message, 'error');
            }
        }

        // ========== VONAGE NUMBER MANAGEMENT ==========

        async function syncVonageNumbers() {
            showAlert('üîÑ Syncing numbers from Vonage...', 'info');
            try {
                const resp = await fetch('/api/sync-vonage-numbers', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                    // Auto-refresh after sync
                    setTimeout(() => loadVonageNumbers(), 1000);
                } else {
                    showAlert(`‚ö†Ô∏è Sync failed: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Sync error: ' + e.message, 'error');
            }
        }

        async function loadVonageNumbers() {
            const container = document.getElementById('numbersContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.6;"><div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div><div>Loading numbers...</div></div>';

            try {
                const resp = await fetch('/api/owned-numbers');
                const data = await resp.json();
                
                if (!data.success) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #e74c3c;"><div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div><div>${data.error}</div></div>`;
                    return;
                }

                const numbers = data.numbers || [];
                
                if (numbers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; opacity: 0.6;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                            <div>No Vonage numbers found.</div>
                            <div style="margin-top: 10px; font-size: 13px;">Purchase numbers from your Vonage dashboard.</div>
                        </div>
                    `;
                    return;
                }

                // Count available vs assigned
                const availableCount = numbers.filter(n => n.available).length;
                const assignedCount = numbers.length - availableCount;

                let html = `
                    <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">üìä Number Overview</div>
                        <div style="display: flex; justify-content: center; gap: 30px; font-size: 14px;">
                            <div><strong>Total:</strong> ${numbers.length}</div>
                            <div style="color: #27ae60;"><strong>Available:</strong> ${availableCount}</div>
                            <div style="color: #e67e22;"><strong>Assigned:</strong> ${assignedCount}</div>
                        </div>
                    </div>
                `;

                // Display each number
                numbers.forEach(number => {
                    const isAvailable = number.available;
                    const borderColor = isAvailable ? '#27ae60' : '#e67e22';
                    const statusBg = isAvailable ? '#27ae60' : '#e67e22';
                    const statusText = isAvailable ? '‚úÖ AVAILABLE' : `üë§ ${number.assigned_to || 'Unavailable'}`;

                    html += `
                        <div style="background: linear-gradient(135deg, #2c3e50, #34495e); 
                                    padding: 20px; border-radius: 8px; margin-bottom: 15px;
                                    border-left: 4px solid ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                                        üìû ${number.number}
                                    </div>
                                    <div style="font-size: 13px; opacity: 0.7;">
                                        ${number.country || 'Unknown'} ‚Ä¢ ${number.type || 'Unknown Type'}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <div style="background: ${statusBg}; color: white; padding: 8px 15px; 
                                                border-radius: 20px; font-size: 13px; font-weight: bold;">
                                        ${statusText}
                                    </div>
                                    ${generateNumberActionButton(number)}
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #e74c3c;"><div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div><div>Error: ${e.message}</div></div>`;
            }
        }

        function generateNumberActionButton(number) {
            if (number.available) {
                // Available number - option to make unavailable
                return `
                    <button onclick="toggleNumberAvailability('${number.number}', false)" 
                            style="background: linear-gradient(135deg, #e74c3c, #c0392b); 
                                   color: white; border: none; padding: 8px 15px; 
                                   border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        üîí Make Unavailable
                    </button>
                `;
            } else if (number.assigned_to && number.user_id) {
                // Assigned to a user - option to deassign
                return `
                    <button onclick="deassignNumber('${number.number}', ${number.user_id})" 
                            style="background: linear-gradient(135deg, #e67e22, #d35400); 
                                   color: white; border: none; padding: 8px 15px; 
                                   border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        ‚ùå Deassign
                    </button>
                `;
            } else {
                // Manually made unavailable - option to make available
                return `
                    <button onclick="toggleNumberAvailability('${number.number}', true)" 
                            style="background: linear-gradient(135deg, #27ae60, #229954); 
                                   color: white; border: none; padding: 8px 15px; 
                                   border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        üîì Make Available
                    </button>
                `;
            }
        }

        async function toggleNumberAvailability(phoneNumber, makeAvailable) {
            const action = makeAvailable ? 'available' : 'unavailable';
            if (!confirm(`Make ${phoneNumber} ${action}?`)) return;

            showAlert(`üîÑ Updating ${phoneNumber}...`, 'info');
            
            try {
                const resp = await fetch('/api/toggle-number-availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone_number: phoneNumber,
                        available: makeAvailable
                    })
                });
                
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${phoneNumber} is now ${action}`, 'success');
                    loadVonageNumbers(); // Refresh list
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Update failed: ' + e.message, 'error');
            }
        }

        async function deassignNumber(phoneNumber, userId) {
            if (!confirm(`Deassign ${phoneNumber} from this user? The number will become available for reassignment.`)) return;

            showAlert(`üîÑ Deassigning ${phoneNumber}...`, 'info');
            
            try {
                const resp = await fetch('/api/deassign-number', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone_number: phoneNumber,
                        user_id: userId
                    })
                });
                
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${phoneNumber} has been deassigned`, 'success');
                    loadVonageNumbers(); // Refresh list
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Deassign failed: ' + e.message, 'error');
            }
        }

        // Update logout to stop health monitoring
        const originalLogout = logout;
        logout = function() {
            stopHealthMonitoring();
            originalLogout();
        };

        // Global Instructions Modal Functions
        function openInstructionsModal() {
            document.getElementById('instructionsModal').classList.add('show');
        }

        function closeInstructionsModal(event) {
            if (event && event.target.classList.contains('instructions-modal-content')) {
                return; // Don't close if clicking inside modal
            }
            document.getElementById('instructionsModal').classList.remove('show');
        }

        // Make Streaming Status Box Draggable
        function makeStreamingStatusDraggable() {
            const box = document.getElementById('streamingStatus');
            if (!box) {
                console.log('Streaming status box not found');
                return;
            }

            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;

            function dragStart(e) {
                // Get the current transform values
                const style = window.getComputedStyle(box);
                const matrix = new DOMMatrixReadOnly(style.transform);
                currentX = matrix.m41;
                currentY = matrix.m42;

                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
                isDragging = true;

                box.style.cursor = 'grabbing';
                e.preventDefault();
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    box.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
                box.style.cursor = 'move';
            }

            // Remove old listeners if any
            box.removeEventListener('mousedown', dragStart);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', dragEnd);

            // Add new listeners
            box.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            console.log('Streaming status box is now draggable');
        }

        // Don't initialize on timeout, let updateStreamingStatus do it
        // setTimeout(makeStreamingStatusDraggable, 1000);

        // ========== CONSOLE DIAGNOSTICS ==========
        
        // Store console logs
        let consoleLogs = [];
        let consoleErrors = [];

        // Override console methods to capture logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleInfo = console.info;

        console.log = function(...args) {
            captureLog('log', args);
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            captureLog('error', args);
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            captureLog('warn', args);
            originalConsoleWarn.apply(console, args);
        };

        console.info = function(...args) {
            captureLog('info', args);
            originalConsoleInfo.apply(console, args);
        };

        // Capture window errors
        window.addEventListener('error', (event) => {
            captureLog('error', [`${event.message} at ${event.filename}:${event.lineno}:${event.colno}`]);
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            captureLog('error', [`Unhandled Promise Rejection: ${event.reason}`]);
        });

        function captureLog(type, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            const logEntry = {
                type,
                timestamp,
                message
            };

            consoleLogs.push(logEntry);
            if (type === 'error') {
                consoleErrors.push(logEntry);
            }

            // Keep only last 100 logs
            if (consoleLogs.length > 100) {
                consoleLogs.shift();
            }

            // Update diagnostics modal if open
            updateDiagnosticsDisplay();
        }

        function openDiagnostics() {
            document.getElementById('diagnosticsModal').classList.add('show');
            updateDiagnosticsDisplay();
        }

        function closeDiagnosticsModal(event) {
            if (event && event.target.classList.contains('diagnostics-modal-content')) {
                return;
            }
            document.getElementById('diagnosticsModal').classList.remove('show');
            // Hide analysis when closing
            document.getElementById('errorAnalysis').classList.remove('show');
        }

        function updateDiagnosticsDisplay() {
            const logsContainer = document.getElementById('consoleLogs');
            const logCount = document.getElementById('logCount');
            const errorCount = document.getElementById('errorCount');
            const analyzeBtn = document.getElementById('analyzeBtn');

            if (!logsContainer) return;

            logCount.textContent = consoleLogs.length;
            errorCount.textContent = consoleErrors.length;

            // Enable/disable analyze button
            analyzeBtn.disabled = consoleErrors.length === 0;

            if (consoleLogs.length === 0) {
                logsContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No logs captured yet...</div>';
                return;
            }

            // Display last 50 logs (most recent first)
            const recentLogs = consoleLogs.slice(-50).reverse();
            logsContainer.innerHTML = recentLogs.map(log => `
                <div class="console-log-entry ${log.type}">
                    <span class="console-log-timestamp">[${log.timestamp}]</span>
                    <span>[${log.type.toUpperCase()}]</span>
                    ${log.message}
                </div>
            `).join('');
        }

        function clearConsoleLogs() {
            if (!confirm('Clear all console logs?')) return;
            consoleLogs = [];
            consoleErrors = [];
            document.getElementById('errorAnalysis').classList.remove('show');
            updateDiagnosticsDisplay();
            showAlert('Console logs cleared', 'success');
        }

        async function analyzeErrors() {
            if (consoleErrors.length === 0) {
                showAlert('No errors to analyze', 'error');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const errorAnalysis = document.getElementById('errorAnalysis');
            const analysisContent = document.getElementById('analysisContent');

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '‚è≥ Analyzing...';
            errorAnalysis.classList.add('show');
            analysisContent.textContent = 'Analyzing errors with DeepSeek AI...';

            try {
                // Prepare error summary
                const errorSummary = consoleErrors.map(err => 
                    `[${err.timestamp}] ${err.message}`
                ).join('\n\n');

                const response = await fetch('/api/analyze-errors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        errors: errorSummary,
                        context: {
                            page: 'Super Admin Dashboard',
                            timestamp: new Date().toISOString(),
                            errorCount: consoleErrors.length
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    analysisContent.textContent = data.analysis;
                    showAlert('‚úÖ Error analysis complete!', 'success');
                } else {
                    analysisContent.textContent = `Analysis failed: ${data.error}`;
                    showAlert('‚ùå Analysis failed: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error analyzing:', error);
                analysisContent.textContent = `Failed to analyze errors: ${error.message}`;
                showAlert('‚ùå Analysis request failed', 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ü§ñ Analyze Errors';
            }
        }

        function copyAnalysisToClipboard() {
            const analysisContent = document.getElementById('analysisContent').textContent;
            
            navigator.clipboard.writeText(analysisContent).then(() => {
                showAlert('‚úÖ Analysis copied to clipboard!', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = analysisContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('‚úÖ Analysis copied to clipboard!', 'success');
            });
        }

        // Log page load
        console.log('Super Admin Dashboard loaded successfully');
    </script>
</body>
</html>
