<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Secure Access</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-container { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border-radius: 24px; padding: 30px 40px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: space-between; gap: 30px; max-width: 600px; width: 100%; border: 1px solid rgba(255, 255, 255, 0.2); }
        .login-left { flex: 1; }
        .login-container h1 { color: white; font-size: 48px; margin: 0; font-weight: 900; line-height: 1.1; }
        .login-container p { color: rgba(255, 255, 255, 0.8); margin: 5px 0 0 0; font-size: 13px; }
        .login-left { flex: 1; }
        .login-container h1 { color: white; font-size: 48px; margin: 0; font-weight: 900; line-height: 1.1; }
        .login-container p { color: rgba(255, 255, 255, 0.8); margin: 5px 0 0 0; font-size: 13px; }
        .lock-icon { font-size: 36px; margin-bottom: 10px; }
        .login-right { flex: 1; }
        .input-group { margin-bottom: 0; }
        .input-group input { width: 100%; padding: 14px 18px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background: rgba(255, 255, 255, 0.9); color: #333; font-size: 16px; transition: all 0.3s; }
        .input-group input::placeholder { color: rgba(0, 0, 0, 0.4); letter-spacing: normal; }
        .input-group input:focus { outline: none; border-color: white; background: white; box-shadow: 0 0 15px rgba(255, 255, 255, 0.4); }
        .btn-login { width: 100%; padding: 14px; border: none; border-radius: 10px; background: white; color: #667eea; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 12px; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25); }
        .error-message { color: #ff6b6b; background: transparent; padding: 0; border-radius: 0; margin-top: 8px; display: none; font-weight: 600; font-size: 13px; text-align: right; }
        .main-container { display: none; max-width: 1400px; width: 100%; }
        .super-admin-name { color: white; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; display: inline-block; }
        .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: white; font-size: 28px; font-weight: 700; }
        .btn-logout { padding: 12px 24px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background: rgba(255, 255, 255, 0.3); }
        .panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 30px; margin-bottom: 20px; color: white; }
        .panel h2 { font-size: 22px; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .api-keys-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .api-key-section { background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; border-left: 4px solid #667eea; }
        .api-key-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: white; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .api-key-section .status { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 600; }
        .status.configured { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .status.not-configured { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .input-wrapper { position: relative; margin-bottom: 10px; }
        .input-wrapper input { width: 100%; padding: 10px 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; font-family: 'Courier New', monospace; transition: all 0.3s; }
        .input-wrapper input::placeholder { color: rgba(255, 255, 255, 0.4); }
        .input-wrapper input:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.15); }
        .btn-save { padding: 8px 16px; border: none; border-radius: 6px; background: #2ecc71; color: white; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; width: 100%; }
        .btn-save:hover { background: #27ae60; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4); }
        .brain-selector { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .brain-selector h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: white; }
        .brain-options { display: flex; gap: 15px; }
        .brain-option { flex: 1; padding: 20px; border: 3px solid rgba(255, 255, 255, 0.2); border-radius: 12px; background: rgba(255, 255, 255, 0.05); cursor: pointer; transition: all 0.3s; text-align: center; }
        .brain-option:hover { border-color: rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.1); }
        .brain-option.selected { border-color: #2ecc71; background: rgba(46, 204, 113, 0.2); }
        .brain-option input[type="radio"] { display: none; }
        .brain-option-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: white; }
        .brain-option-desc { font-size: 13px; color: rgba(255, 255, 255, 0.7); }
        .alert { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 10001; max-width: min(980px, calc(100vw - 40px)); width: calc(100vw - 40px); padding: 15px 20px; border-radius: 8px; font-weight: 600; display: none; font-size: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); }
        .alert-success { background: rgba(46, 204, 113, 0.3); color: #2ecc71; border: 2px solid #2ecc71; }
        .alert-error { background: rgba(231, 76, 60, 0.3); color: #e74c3c; border: 2px solid #e74c3c; }
        .alert-warning { background: rgba(243, 156, 18, 0.95); color: white; border: 2px solid rgba(255, 255, 255, 0.3); }
        .alert-info { background: rgba(52, 152, 219, 0.3); color: #3498db; border: 2px solid #3498db; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
        .test-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 10000; align-items: center; justify-content: center; }
        .test-modal.show { display: flex; }
        .test-modal-content { background: rgba(255,255,255,0.95); border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .test-modal h3 { color: #667eea; margin-bottom: 20px; font-size: 24px; }
        .test-result { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 13px; color: #2c3e50; }
        .test-result.success { border-left: 4px solid #2ecc71; }
        .test-result.error { border-left: 4px solid #e74c3c; }
        .test-result.warning { border-left: 4px solid #f39c12; }
        .test-result strong { display: block; margin-bottom: 8px; color: #34495e; font-size: 14px; }
        .btn-close-modal { background: #667eea; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        .btn-close-modal:hover { background: #5568d3; }
        .filler-section { background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .filler-section h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: white; }
        .filler-section textarea { width: 100%; min-height: 150px; padding: 14px 18px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; font-family: inherit; resize: vertical; }
        .filler-section textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.15); }
        .hint { font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-top: 8px; font-style: italic; }
        .filler-slot { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 14px; border: 2px solid rgba(255, 255, 255, 0.2); transition: all 0.3s; }
        .filler-slot.has-audio { border-color: rgba(46, 204, 113, 0.5); background: rgba(46, 204, 113, 0.1); }
        .filler-slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filler-slot-title { font-size: 14px; font-weight: 800; color: white; }
        .filler-slot-status { font-size: 12px; padding: 4px 10px; border-radius: 6px; font-weight: 600; }
        .filler-slot-status.filled { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .filler-slot-status.empty { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .filler-slot-controls { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .btn-slot { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-slot.play { background: rgba(52, 152, 219, 0.8); color: white; }
        .btn-slot.regenerate { background: rgba(155, 89, 182, 0.8); color: white; }
        .btn-slot.delete { background: rgba(231, 76, 60, 0.8); color: white; }
        .btn-slot:hover { transform: translateY(-1px); opacity: 1; }
        .btn-slot:disabled { opacity: 0.5; cursor: not-allowed; }
        .accounts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 1200px) { .accounts-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .accounts-grid { grid-template-columns: 1fr; } }
        .account-card { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 18px; border-left: 4px solid #667eea; display: flex; flex-direction: column; gap: 12px; transition: all 0.3s; height: 100%; }
        .account-card:hover { background: rgba(0, 0, 0, 0.4); border-left-color: #2ecc71; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .account-info { flex: 1; }
        .account-name { font-size: 15px; font-weight: 700; color: white; margin-bottom: 8px; }
        .account-email { font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 5px; }
        .account-phone { font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 8px; }
        .account-credits { text-align: center; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .credits-amount { font-size: 24px; font-weight: 800; color: #2ecc71; }
        .credits-label { font-size: 11px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        .credit-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: center; }
        .credit-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: white; }
        .credit-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .credit-btn.add { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .credit-btn.add:hover { background: linear-gradient(135deg, #27ae60, #229954); }
        .credit-btn.remove { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .credit-btn.remove:hover { background: linear-gradient(135deg, #c0392b, #a93226); }
        .call-analysis-section { margin-top: 20px; }
        .call-selector { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .call-item { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px 15px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; }
        .call-item:hover { background: rgba(255, 255, 255, 0.1); border-left-color: #2ecc71; }
        .call-item.selected { background: rgba(46, 204, 113, 0.2); border-left-color: #2ecc71; }
        .call-time { font-size: 12px; color: rgba(255, 255, 255, 0.6); }
        .call-from { font-size: 14px; font-weight: 600; color: white; margin: 4px 0; }
        .call-duration { font-size: 12px; color: rgba(255, 255, 255, 0.7); }
        .timing-stage { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #667eea; transition: all 0.3s; }
        .timing-stage.optimal { border-left-color: #2ecc71; }
        .timing-stage.good { border-left-color: #3498db; }
        .timing-stage.slow { border-left-color: #f39c12; }
        .timing-stage.critical_bottleneck { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.15); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .stage-name { font-size: 16px; font-weight: 700; color: white; }
        .stage-duration { font-size: 18px; font-weight: 800; color: #2ecc71; }
        .stage-duration.slow { color: #f39c12; }
        .stage-duration.critical { color: #e74c3c; }
        .stage-desc { font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px; }
        .stage-note { font-size: 12px; color: #e74c3c; font-weight: 600; margin-top: 8px; background: rgba(231, 76, 60, 0.2); padding: 6px 10px; border-radius: 4px; }
        .bottleneck-card { background: linear-gradient(135deg, rgba(231, 76, 60, 0.2) 0%, rgba(192, 57, 43, 0.2) 100%); border: 2px solid #e74c3c; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .bottleneck-title { font-size: 20px; font-weight: 800; color: #e74c3c; margin-bottom: 15px; }
        .recommendation { background: rgba(46, 204, 113, 0.2); border-radius: 8px; padding: 12px; margin-top: 10px; }
        .recommendation-title { font-size: 14px; font-weight: 700; color: #2ecc71; margin-bottom: 8px; }
        .alternative { font-size: 13px; color: rgba(255, 255, 255, 0.9); padding: 6px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .alternative:last-child { border-bottom: none; }
        .btn-analyze { padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 15px; }
        .btn-analyze:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn-analyze:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Floating Streaming Status Indicator */
        .streaming-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: move;
            user-select: none;
        }
        .streaming-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: flicker 1.5s infinite;
        }
        .streaming-indicator.active {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        .streaming-indicator.inactive {
            background: #e74c3c;
            box-shadow: 0 0 10px #e74c3c;
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .streaming-label {
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .streaming-mode {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Service Health Monitor */
        .health-monitor {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .health-monitor-title {
            font-size: 12px;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .health-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .health-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
        }
        .health-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        .health-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }
        .health-circle::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            padding: 4px;
            background: linear-gradient(45deg, currentColor, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.6;
        }
        .health-circle.ok {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: #2ecc71;
            animation: pulse-green 2s ease-in-out infinite;
        }
        .health-circle.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #e74c3c;
            animation: pulse-red 1s ease-in-out infinite;
        }
        .health-circle.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #f39c12;
            animation: pulse-orange 1.5s ease-in-out infinite;
        }
        .health-circle.checking {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #3498db;
            animation: pulse-blue 1.5s ease-in-out infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.9), 0 0 30px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0), 0 0 40px rgba(231, 76, 60, 0.3); }
        }
        @keyframes pulse-orange {
            0%, 100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.8); }
            50% { box-shadow: 0 0 0 12px rgba(243, 156, 18, 0); }
        }
        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
        }
        .health-icon {
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .health-label {
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-align: center;
            line-height: 1.2;
            white-space: nowrap;
        }
        .health-status {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            white-space: nowrap;
        }
        
        /* Modal for Health Details */
        .health-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .health-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .health-modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }
        
        /* Global Instructions Modal */
        .instructions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .instructions-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .instructions-modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .instructions-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .instructions-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .instructions-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
        }
        .instructions-modal-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }
        .instructions-modal-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
        }
        .instructions-modal-textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.4);
        }
        .instructions-modal-hint {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
            font-style: italic;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn-open-instructions {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-open-instructions:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }
        
        /* Diagnostics Modal */
        .diagnostics-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .diagnostics-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .diagnostics-modal-content {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.98) 0%, rgba(52, 73, 94, 0.98) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(52, 152, 219, 0.3);
        }
        .diagnostics-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(231, 76, 60, 0.3);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1;
        }
        .diagnostics-modal-close:hover {
            background: rgba(231, 76, 60, 0.6);
            transform: rotate(90deg);
        }
        .diagnostics-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .diagnostics-modal-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
        }
        .console-logs {
            background: #000;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .console-log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #ddd;
        }
        .console-log-entry.error {
            color: #ff6b6b;
            font-weight: 600;
        }
        .console-log-entry.warn {
            color: #f39c12;
        }
        .console-log-entry.info {
            color: #3498db;
        }
        .console-log-timestamp {
            color: #888;
            margin-right: 8px;
        }
        .error-analysis {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }
        .error-analysis.show {
            display: block;
            animation: slideUp 0.3s;
        }
        .error-analysis-title {
            font-size: 18px;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .error-analysis-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: white;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .btn-analyze-errors {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .btn-analyze-errors:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        .btn-analyze-errors:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-copy-analysis {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-copy-analysis:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .health-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .health-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .health-modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
        }
        .health-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            text-align: center;
            margin-bottom: 10px;
        }
        .health-modal-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .health-modal-details {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .health-modal-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .health-modal-detail:last-child {
            border-bottom: none;
        }
        .health-modal-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }
        .health-modal-value {
            font-size: 13px;
            color: white;
            font-weight: 700;
        }
        .health-modal-status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
        }
        .health-modal-status.ok {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        .health-modal-status.error {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        .health-modal-status.warning {
            background: rgba(243, 156, 18, 0.3);
            color: #f39c12;
        }
        
        /* Spectacular Animations */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Navigation Menu Styles */
        .nav-menu { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%); backdrop-filter: blur(10px); padding: 12px 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; animation: fadeInUp 0.6s ease-out; }
        .nav-item { padding: 10px 18px; border-radius: 8px; background: rgba(255, 255, 255, 0.15); color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 2px solid transparent; display: flex; align-items: center; gap: 6px; white-space: nowrap; position: relative; overflow: hidden; }
        .nav-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s; }
        .nav-item:hover::before { left: 100%; }
        .nav-item span { font-size: 16px; transition: transform 0.3s; }
        .nav-item:hover span { transform: scale(1.15); }
        .nav-item:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .nav-item.active { background: rgba(46, 204, 113, 0.5); border-color: rgba(46, 204, 113, 0.8); box-shadow: 0 4px 16px rgba(46, 204, 113, 0.4); }
        .nav-item.active span { animation: float 3s ease-in-out infinite; }
        .section-blurred { filter: blur(3px); opacity: 0.3; pointer-events: none; transition: all 0.3s; }
        .section-focused { filter: blur(0); opacity: 1; transition: all 0.3s; }
        .back-to-menu { position: absolute; top: 15px; right: 15px; padding: 8px 16px; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 20px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; z-index: 10; }
        .back-to-menu:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
        .panel { position: relative; }
        .main-container { padding-top: 100px; }
        
        /* Menu Control Handles */
        .menu-resize-handle { position: absolute; bottom: 5px; right: 5px; width: 20px; height: 20px; cursor: nwse-resize; color: rgba(255, 255, 255, 0.5); font-size: 16px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s; z-index: 10; user-select: none; }
        .menu-resize-handle:hover { background: rgba(255, 255, 255, 0.2); color: white; transform: scale(1.2); }
        .menu-move-handle { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); padding: 4px 12px; cursor: grab; color: rgba(255, 255, 255, 0.5); font-size: 14px; border-radius: 8px; transition: all 0.3s; z-index: 10; user-select: none; letter-spacing: 2px; }
        .menu-move-handle:hover { background: rgba(255, 255, 255, 0.2); color: white; }
        .menu-move-handle:active { cursor: grabbing; }
        .nav-menu::-webkit-scrollbar { width: 8px; height: 8px; }
        .nav-menu::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .nav-menu::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .nav-menu::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-left">
            <div class="lock-icon">üîê</div>
            <h1>Super<br>Admin</h1>
            <p>Secure Access Required</p>
        </div>
        <div class="login-right">
            <div class="input-group">
                <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
            </div>
            <button class="btn-login" onclick="attemptLogin()">Unlock</button>
            <div style="text-align: center; margin: 10px 0; color: rgba(255,255,255,0.7); font-size: 13px;">or</div>
            <div class="input-group" id="otpInputGroup" style="display:none;">
                <input type="text" id="otpInput" placeholder="Enter 6-digit code" maxlength="6" autocomplete="off" style="text-align: center; letter-spacing: 4px; font-size: 18px; font-weight: 700;">
            </div>
            <button class="btn-login" onclick="requestOTP()" id="otpBtn" style="background: rgba(255,255,255,0.2); color: white;">üì± Send Code to Mobile</button>
            <div class="error-message" id="errorMessage">Login failed</div>
        </div>

        <!-- First-time setup (local installs). Requires SUPER_ADMIN_SETUP_TOKEN on the server. -->
        <div id="setupBox" style="display:none; margin-top: 18px; padding-top: 18px; border-top: 1px solid rgba(255,255,255,0.18); width: 100%;">
            <div style="font-weight: 900; color: rgba(255,255,255,0.92); margin-bottom: 10px; text-align: center;">First-time setup</div>
            <div class="input-group">
                <input type="text" id="setupTokenInput" placeholder="Setup Token (SUPER_ADMIN_SETUP_TOKEN)" autocomplete="off">
            </div>
            <div class="input-group">
                <input type="text" id="setupUsernameInput" placeholder="Super Admin Username (optional)" autocomplete="off">
            </div>
            <div class="input-group">
                <input type="password" id="setupPasswordInput" placeholder="New Password (6+ chars)" autocomplete="new-password">
            </div>
            <div class="input-group">
                <input type="password" id="setupPasswordConfirmInput" placeholder="Confirm Password" autocomplete="new-password">
            </div>
            <button class="btn-login" onclick="attemptBootstrap()" style="margin-top: 6px;">Set Password</button>
            <div class="error-message" id="setupMessage" style="display:none; margin-top: 10px;"></div>
        </div>
    </div>

    <div class="main-container" id="mainDashboard">
        <!-- Navigation Menu -->
        <div class="nav-menu" id="navMenu">
            <div class="nav-item active" onclick="navigateToSection('overview')"><span>üè†</span> Overview</div>
            <div class="nav-item" onclick="navigateToSection('brain')"><span>üß†</span> AI Brain</div>
            <div class="nav-item" onclick="navigateToSection('openrouter')"><span>üîå</span> OpenRouter</div>
            <div class="nav-item" onclick="navigateToSection('performance')"><span>‚ö°</span> Performance</div>
            <div class="nav-item" onclick="navigateToSection('vonage')"><span>üìû</span> Phone Numbers</div>
            <div class="nav-item" onclick="navigateToSection('api-keys')"><span>üîë</span> API Keys</div>
            <div class="nav-item" onclick="navigateToSection('testing')"><span>üß™</span> Testing</div>
            <div class="nav-item" onclick="navigateToSection('instructions')"><span>üìù</span> Instructions</div>
            <div class="nav-item" onclick="navigateToSection('backchannel')"><span>üéõÔ∏è</span> Turn-Taking</div>
            <div class="nav-item" onclick="navigateToSection('vapi')"><span>üéôÔ∏è</span> Vapi Assistants</div>
            <div class="nav-item" onclick="navigateToSection('filler')"><span>üí¨</span> Filler Words</div>
            <div class="nav-item" onclick="window.open('/latency-dashboard.html', '_blank')"><span>üìä</span> Latency</div>
        </div>
        
        <div class="super-admin-name">Andy</div>
        
        <!-- Floating Speechmatics Streaming Status -->
        <div class="streaming-status" id="streamingStatus" style="display: none;">
            <div class="streaming-indicator" id="streamingIndicator"></div>
            <div>
                <div class="streaming-label" id="streamingLabel">Checking...</div>
                <div class="streaming-mode" id="streamingMode"></div>
            </div>
        </div>

        <!-- Live Brain Usage (OpenAI vs DeepSeek vs Groq) -->
        <div id="section-overview" class="panel section-focused" style="margin-bottom: 25px;">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <div class="panel-header">
                <h2>üß† Live Brain Usage</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Shows what % of assistant turns were produced by OpenAI vs DeepSeek vs Groq in the current active call</p>
            </div>
            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; margin-top: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                <div>
                    <div style="font-weight: 800;">Active Call</div>
                    <div id="liveBrainUsageCall" style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Checking‚Ä¶</div>
                    <div id="liveBrainUsageProviders" style="font-size: 12px; margin-top: 6px; opacity: 0.95;"></div>
                    <div id="liveBrainUsageReasons" style="font-size: 12px; margin-top: 4px; opacity: 0.75;"></div>
                </div>
                <div id="liveBrainUsageText" style="font-size: 16px; font-weight: 900;">OpenAI 0% | DeepSeek 0% | Groq 0%</div>
            </div>
        </div>
        
        <div class="header">
            <h1>üîß Super Admin - System Configuration</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn-logout" onclick="window.open('/', '_blank')" style="background: rgba(52, 152, 219, 0.3);">
                    üåê Open Website
                </button>
                <button class="btn-logout" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <!-- Content Moderation Alerts (Top Banner) -->
        <div id="contentModerationBanner" onclick="showFlaggedAccountsModal()" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); padding: 18px 20px; border-radius: 14px; margin: 0 0 18px 0; cursor: pointer; border: 2px solid rgba(255,255,255,0.25); box-shadow: 0 10px 30px rgba(0,0,0,0.25);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="font-size: 34px; line-height: 1;">üö®</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 800; color: white; letter-spacing: 0.3px;">Content Moderation Alerts</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 2px;">Click to view flagged & suspended accounts</div>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.18); padding: 10px 16px; border-radius: 12px; text-align: center; min-width: 110px;">
                    <div id="flaggedAccountsBadge" style="font-size: 24px; font-weight: 900; color: white;">‚Ä¶</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.85); margin-top: 2px;">Flagged</div>
                </div>
            </div>
        </div>

        <!-- Service Health Monitor -->
        <div class="health-monitor">
            <div class="health-monitor-title">
                <span>‚ö°</span> LIVE SERVICE STATUS
            </div>
            <div class="health-grid">
                <div class="health-item" onclick="showHealthDetails('openai')">
                    <div class="health-circle checking" id="health-openai">
                        <div class="health-icon">üß†</div>
                    </div>
                    <div class="health-label">OpenAI</div>
                    <div class="health-status" id="status-openai">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('speechmatics')">
                    <div class="health-circle checking" id="health-speechmatics">
                        <div class="health-icon">üéôÔ∏è</div>
                    </div>
                    <div class="health-label">Speechmatics</div>
                    <div class="health-status" id="status-speechmatics">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('vonage')">
                    <div class="health-circle checking" id="health-vonage">
                        <div class="health-icon">üìû</div>
                    </div>
                    <div class="health-label">Vonage</div>
                    <div class="health-status" id="status-vonage">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('database')">
                    <div class="health-circle checking" id="health-database">
                        <div class="health-icon">üíæ</div>
                    </div>
                    <div class="health-label">Database</div>
                    <div class="health-status" id="status-database">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('webhook')">
                    <div class="health-circle checking" id="health-webhook">
                        <div class="health-icon">üåê</div>
                    </div>
                    <div class="health-label">Webhook</div>
                    <div class="health-status" id="status-webhook">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('deepseek')">
                    <div class="health-circle checking" id="health-deepseek">
                        <div class="health-icon">üîÆ</div>
                    </div>
                    <div class="health-label">DeepSeek</div>
                    <div class="health-status" id="status-deepseek">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('credits')">
                    <div class="health-circle checking" id="health-credits">
                        <div class="health-icon">üí≥</div>
                    </div>
                    <div class="health-label">Credits</div>
                    <div class="health-status" id="status-credits">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('server')">
                    <div class="health-circle checking" id="health-server">
                        <div class="health-icon">üñ•Ô∏è</div>
                    </div>
                    <div class="health-label">Server</div>
                    <div class="health-status" id="status-server">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('ngrok')">
                    <div class="health-circle checking" id="health-ngrok">
                        <div class="health-icon">üåâ</div>
                    </div>
                    <div class="health-label">Ngrok Tunnel</div>
                    <div class="health-status" id="status-ngrok">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('cloudflare')" ondblclick="startCloudflare(event)">
                    <div class="health-circle checking" id="health-cloudflare">
                        <div class="health-icon">‚òÅÔ∏è</div>
                    </div>
                    <div class="health-label">Cloudflare Tunnel</div>
                    <div class="health-status" id="status-cloudflare">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('activecalls')">
                    <div class="health-circle checking" id="health-activecalls">
                        <div class="health-icon">üìû</div>
                    </div>
                    <div class="health-label">Active Calls</div>
                    <div class="health-status" id="status-activecalls">Checking...</div>
                </div>
                <div class="health-item" onclick="showHealthDetails('resources')">
                    <div class="health-circle checking" id="health-resources">
                        <div class="health-icon">‚ö°</div>
                    </div>
                    <div class="health-label">Resources</div>
                    <div class="health-status" id="status-resources">Checking...</div>
                </div>
            </div>
        </div>

        <!-- System Controls Panel -->
        <div class="panel" style="margin-bottom: 25px;">
            <div class="panel-header">
                <h2>üõ†Ô∏è System Controls</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Quick diagnostic and recovery tools</p>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9);" onclick="testCall()">
                    üìû Test Call Sarah
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);" onclick="testVoicePipeline()">
                    üî¨ Diagnose Voice Issues
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #10ac84, #01a3a4);" onclick="autoFixVoice()">
                    ü§ñ Auto-Fix Voice Issues
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" onclick="restartVoiceEngine()">
                    üîÑ Restart Voice Engine
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #ff4757, #c23616);" onclick="restartServer()">
                    üîÅ Restart Server
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #f39c12, #e67e22);" onclick="clearCallCache()">
                    üóëÔ∏è Clear Call Cache
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);" onclick="checkWebhooks()">
                    üåê Verify Webhooks
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #1abc9c, #16a085);" onclick="testOpenAI()">
                    üß† Test OpenAI Connection
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #34495e, #2c3e50);" onclick="viewServerLogs()">
                    üìã View Recent Logs
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" onclick="openDiagnostics()">
                    üîç Console Diagnostics
                </button>
                <button class="btn" id="reloadConfigBtn" style="background: linear-gradient(135deg, #f39c12, #e67e22); display: none;" onclick="reloadConfiguration()">
                    üîÑ Reload Configuration
                </button>
            </div>
        </div>

        <!-- Recent Calls (for Brain Provider audit) -->
        <div class="panel" style="margin-bottom: 25px; display: none;">
            <div class="panel-header">
                <h2>üìû Recent Calls</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Shows the last 5 completed calls and which brain was selected vs actually used</p>
            </div>
            <div class="call-selector">
                <div id="recentCallsList" style="text-align: center; color: rgba(255,255,255,0.75); padding: 16px;">Loading‚Ä¶</div>
            </div>
        </div>

        <!-- Tunnel Provider Configuration -->
        <div class="panel" style="margin-bottom: 25px;">
            <div class="panel-header">
                <h2>üåê Tunnel Provider</h2>
                <p style="font-size: 13px; opacity: 0.8; margin-top: 8px;">Choose your public tunnel provider (ngrok or Cloudflare)</p>
            </div>
            
            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; margin-top: 15px;">
                <!-- Provider Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">Provider:</label>
                    <select id="tunnelProvider" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;" onchange="handleTunnelProviderChange()">
                        <option value="ngrok">ngrok (Free, Random URLs)</option>
                        <option value="cloudflare">Cloudflare Quick (Temporary .trycloudflare.com URLs)</option>
                    </select>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 8px;">
                        <strong>ngrok:</strong> Free random URLs (~50-150ms latency)<br>
                        <strong>Cloudflare:</strong> Temporary URLs (~20-80ms faster, more stable)
                    </div>
                </div>

                <!-- Cloudflare Options (hidden by default) -->
                <div id="cloudflareOptions" style="display: none; margin-bottom: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">Custom Domain (Optional):</label>
                    <input type="text" id="cloudflareDomain" placeholder="example.yourdomain.com" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; margin-bottom: 10px;">
                    
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">
                        Tunnel Token (Optional):
                        <span id="tokenSavedIndicator" style="display: none; margin-left: 10px; padding: 4px 8px; background: rgba(46, 204, 113, 0.2); color: #2ecc71; border-radius: 4px; font-size: 11px; font-weight: 600;">‚úì SAVED</span>
                    </label>
                    <div style="position: relative;">
                        <input type="password" id="cloudflareTunnelToken" placeholder="eyJhIjoixxxx..." style="width: 100%; padding: 12px; padding-right: 100px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; font-family: 'Courier New', monospace;">
                        <button id="toggleTokenEdit" onclick="toggleTokenEdit()" style="display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.4); padding: 6px 12px; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer;">Edit</button>
                    </div>
                    
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 8px;">
                        Leave blank for temporary .trycloudflare.com URLs (no setup required)
                    </div>
                </div>

                <!-- Current Tunnel Status -->
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600;">Status:</span>
                        <span id="tunnelStatus" style="padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; background: rgba(231, 76, 60, 0.2); color: #e74c3c;">Not Running</span>
                    </div>
                    <div id="tunnelUrlDisplay" style="display: none;">
                        <span style="font-weight: 600; display: block; margin-bottom: 5px;">Public URL:</span>
                        <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 6px; font-size: 13px; word-break: break-all; color: #2ecc71;" id="tunnelUrl">-</code>
                    </div>
                </div>

                <!-- Vonage Webhook URLs -->
                <div style="background: rgba(52, 152, 219, 0.15); border: 2px solid rgba(52, 152, 219, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <div style="font-weight: 700; font-size: 12px; color: #3498db; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">üìû Vonage Webhook URLs</div>
                    <div style="margin-bottom: 6px;">
                        <span style="font-size: 11px; color: rgba(255, 255, 255, 0.6); display: block; margin-bottom: 3px;">Answer URL:</span>
                        <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 6px 8px; border-radius: 4px; font-size: 11px; word-break: break-all; color: #ecf0f1; font-family: 'Courier New', monospace;" id="vonageAnswerUrl">-</code>
                    </div>
                    <div>
                        <span style="font-size: 11px; color: rgba(255, 255, 255, 0.6); display: block; margin-bottom: 3px;">Event URL:</span>
                        <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 6px 8px; border-radius: 4px; font-size: 11px; word-break: break-all; color: #ecf0f1; font-family: 'Courier New', monospace;" id="vonageEventUrl">-</code>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" id="startTunnelBtn" style="background: linear-gradient(135deg, #2ecc71, #27ae60); flex: 1; min-width: 150px;" onclick="startTunnel()">
                        ‚ñ∂Ô∏è Start Tunnel
                    </button>
                    <button class="btn" id="stopTunnelBtn" style="background: linear-gradient(135deg, #e74c3c, #c0392b); flex: 1; min-width: 150px; display: none;" onclick="stopTunnel()">
                        ‚èπÔ∏è Stop Tunnel
                    </button>
                    <button class="btn" id="fixEngagedBtn" style="background: linear-gradient(135deg, #f39c12, #e67e22); flex: 1; min-width: 180px;" onclick="fixEngagedTone()">
                        üõ† Fix Engaged Tone
                    </button>
                    <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9); flex: 1; min-width: 150px;" onclick="saveTunnelConfig()">
                        üíæ Save Configuration
                    </button>
                </div>

                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                    ‚ö†Ô∏è <strong>Note:</strong> Cloudflare requires <code>cloudflared</code> to be installed. Download from <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/" target="_blank" style="color: #3498db;">cloudflare.com</a>
                </div>
            </div>
        </div>

        <!-- OpenRouter Test Panel -->
        <div id="section-openrouter" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üß™ OpenRouter API Test</h2>
            <p style="margin-bottom: 15px; color: rgba(255, 255, 255, 0.7); font-size: 14px;">
                Test OpenRouter connectivity and verify your API key is working. This will make a minimal API call (uses ~10 tokens).
            </p>

            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 15px;">
                <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px;">OpenRouter Voice Model (fastest first) ‚Äî $/1M tokens</div>
                <select id="openrouterModelSelect" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 13px; font-family: 'Courier New', monospace;">
                    <option value="" style="background: #34495e; color: #ecf0f1;">Loading models...</option>
                </select>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                    <button class="btn" id="refreshOpenRouterModelsBtn" style="background: linear-gradient(135deg, #34495e, #2c3e50); flex: 1; min-width: 160px;" onclick="loadOpenRouterModels()">üîÑ Refresh Models</button>
                    <button class="btn" id="useFastestModelsBtn" style="background: linear-gradient(135deg, #27ae60, #229954); flex: 1; min-width: 160px;" onclick="useFastestModels()">‚ö° Use Fastest Models</button>
                    <button class="btn" id="saveOpenRouterModelBtn" style="background: linear-gradient(135deg, #3498db, #2980b9); flex: 1; min-width: 160px;" onclick="saveOpenRouterModel()">üíæ Save Model</button>
                </div>
                <div id="openrouterModelStatus" style="margin-top: 10px; font-size: 13px; opacity: 0.85;"></div>
            </div>
            
            <!-- Racing Mode Panel -->
            <div style="background: rgba(255, 193, 7, 0.15); border: 2px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <span style="font-size: 20px;">üèÅ</span>
                    <div style="font-size: 14px; font-weight: 700;">Racing Mode</div>
                </div>
                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
                    Race multiple models simultaneously. Whichever responds first wins. Guarantees fastest response + reliability.
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="racingEnabledCheckbox" style="width: 20px; height: 20px; cursor: pointer;" onchange="toggleRacingInputs()">
                    <label for="racingEnabledCheckbox" style="font-size: 14px; cursor: pointer; user-select: none;">
                        Enable Racing Mode
                    </label>
                </div>
                
                <div id="racingModelInputs" style="display: none;">
                    <div style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">
                        Select 2-3 models to race. Model 1 (above) is always included.
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Model 2 (optional)</label>
                        <select id="racingModel2Select" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 13px; font-family: 'Courier New', monospace;">
                            <option value="">None</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Model 3 (optional)</label>
                        <select id="racingModel3Select" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 13px; font-family: 'Courier New', monospace;">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" id="saveRacingSettingsBtn" style="background: linear-gradient(135deg, #f39c12, #e67e22); width: 100%; margin-top: 10px;" onclick="saveRacingSettings()">üíæ Save Racing Settings</button>
                <div id="racingStatus" style="margin-top: 10px; font-size: 13px; opacity: 0.85;"></div>
            </div>
            
            <button class="btn" id="testOpenRouterBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 100%; max-width: 300px;" onclick="testOpenRouter()">
                üîå Test OpenRouter Connection
            </button>
            
            <div id="openrouterTestResult" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;">
                <div id="openrouterTestMessage" style="font-weight: 600; margin-bottom: 8px;"></div>
                <div id="openrouterTestDetails" style="font-size: 13px; opacity: 0.9; font-family: 'Courier New', monospace;"></div>
            </div>
        </div>

        <!-- AI Performance Tuning Panel -->
        <div id="section-performance" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>‚ö° AI Performance Tuning</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">
                Adjust these settings to optimize AI response speed. Lower values = faster responses but less context/quality. Changes apply to all new calls immediately after saving.
            </p>

            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                
                <!-- Performance Presets -->
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: #3498db;">üéØ Quick Presets</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <button class="btn" style="background: linear-gradient(135deg, #27ae60, #229954); padding: 10px;" onclick="applyPerformancePreset('maximum_speed')">
                            <div style="font-size: 16px;">üöÄ</div>
                            <div style="font-size: 11px; margin-top: 4px;">Maximum Speed</div>
                            <div style="font-size: 10px; opacity: 0.7;">~300ms responses</div>
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 10px;" onclick="applyPerformancePreset('balanced')">
                            <div style="font-size: 16px;">‚öñÔ∏è</div>
                            <div style="font-size: 11px; margin-top: 4px;">Balanced</div>
                            <div style="font-size: 10px; opacity: 0.7;">~800ms responses</div>
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 10px;" onclick="applyPerformancePreset('maximum_quality')">
                            <div style="font-size: 16px;">üíé</div>
                            <div style="font-size: 11px; margin-top: 4px;">Maximum Quality</div>
                            <div style="font-size: 10px; opacity: 0.7;">~1.5s responses</div>
                        </button>
                    </div>
                </div>

                <!-- Conversation History -->
                <div class="filler-section" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #e67e22;">
                        üí¨ Conversation History Messages
                    </label>
                    <input type="number" id="perfHistoryParts" min="1" max="10" step="1" value="4" 
                           style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 14px;">
                    <div class="hint">How many previous message pairs (caller + AI) to remember. Lower = faster but less context. Default: 4</div>
                    <div style="margin-top: 8px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 12px;">
                        <div>‚Ä¢ <strong>1-2:</strong> Very fast, minimal memory (~200ms faster)</div>
                        <div>‚Ä¢ <strong>3-4:</strong> Balanced, good context (recommended)</div>
                        <div>‚Ä¢ <strong>5-10:</strong> Slower, excellent memory for complex calls</div>
                    </div>
                </div>

                <!-- Max Tokens -->
                <div class="filler-section" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #e67e22;">
                        üé§ Maximum Response Length (tokens)
                    </label>
                    <input type="number" id="perfMaxTokens" min="40" max="200" step="10" value="100" 
                           style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 14px;">
                    <div class="hint">Shorter responses stream faster and complete quicker. Default: 100</div>
                    <div style="margin-top: 8px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 12px;">
                        <div>‚Ä¢ <strong>40-60:</strong> Very fast, brief answers (~50% faster)</div>
                        <div>‚Ä¢ <strong>80-100:</strong> Balanced, complete thoughts (recommended)</div>
                        <div>‚Ä¢ <strong>120-200:</strong> Slower, detailed explanations</div>
                    </div>
                </div>

                <!-- Message Character Limit -->
                <div class="filler-section" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #e67e22;">
                        ‚úÇÔ∏è Message Character Limit
                    </label>
                    <input type="number" id="perfMaxMessageChars" min="100" max="600" step="50" value="300" 
                           style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 14px;">
                    <div class="hint">Truncates long messages to reduce processing time. Default: 300</div>
                    <div style="margin-top: 8px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 12px;">
                        <div>‚Ä¢ <strong>100-200:</strong> Very fast, handles brief conversations</div>
                        <div>‚Ä¢ <strong>250-350:</strong> Balanced, normal conversations (recommended)</div>
                        <div>‚Ä¢ <strong>400-600:</strong> Slower, allows detailed explanations</div>
                    </div>
                </div>

                <!-- Request Timeout -->
                <div class="filler-section" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #e67e22;">
                        ‚è±Ô∏è AI Request Timeout (seconds)
                    </label>
                    <input type="number" id="perfRequestTimeout" min="3" max="15" step="0.5" value="8" 
                           style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 14px;">
                    <div class="hint">How long to wait for AI before giving up. Lower = faster cutoff. Default: 8</div>
                    <div style="margin-top: 8px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 12px;">
                        <div>‚Ä¢ <strong>3-5:</strong> Very aggressive, may cut off responses</div>
                        <div>‚Ä¢ <strong>6-8:</strong> Balanced, allows complete responses (recommended)</div>
                        <div>‚Ä¢ <strong>10-15:</strong> Patient, waits for slow models</div>
                    </div>
                </div>

                <!-- System Instructions Character Limit -->
                <div class="filler-section" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #e67e22;">
                        üìã System Instructions Character Limit
                    </label>
                    <input type="number" id="perfSystemMaxChars" min="1000" max="8000" step="500" value="4000" 
                           style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 14px;">
                    <div class="hint">Limits system prompt length. Shorter = faster first response. Default: 4000</div>
                    <div style="margin-top: 8px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 12px;">
                        <div>‚Ä¢ <strong>1000-2000:</strong> Fast setup, basic instructions only</div>
                        <div>‚Ä¢ <strong>3000-4000:</strong> Balanced, full instructions (recommended)</div>
                        <div>‚Ä¢ <strong>5000-8000:</strong> Slower, very detailed instructions</div>
                    </div>
                </div>

                <!-- Total Prompt Character Limit -->
                <div class="filler-section" style="margin-bottom: 25px;">
                    <label style="display: block; font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #e67e22;">
                        üìù Total Prompt Character Limit
                    </label>
                    <input type="number" id="perfTotalPromptMaxChars" min="2000" max="15000" step="1000" value="6000" 
                           style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: #2c3e50; color: #ecf0f1; font-size: 14px;">
                    <div class="hint">Maximum total prompt size (system + history). Lower = faster. Default: 6000</div>
                    <div style="margin-top: 8px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 12px;">
                        <div>‚Ä¢ <strong>2000-4000:</strong> Very fast, minimal context</div>
                        <div>‚Ä¢ <strong>5000-7000:</strong> Balanced, good context (recommended)</div>
                        <div>‚Ä¢ <strong>8000-15000:</strong> Slower, maximum context retention</div>
                    </div>
                </div>

                <!-- Current Settings Summary -->
                <div id="perfCurrentSettings" style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none;">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; color: #3498db;">üìä Current Performance Profile</div>
                    <div id="perfCurrentProfile" style="font-size: 13px; font-family: 'Courier New', monospace;"></div>
                </div>

                <!-- Save Button -->
                <button class="btn-save" onclick="savePerformanceSettings()" style="width: 100%; padding: 15px; font-size: 15px; font-weight: 700;">
                    üíæ Save Performance Settings
                </button>

                <!-- Analyze Last Call Button -->
                <button class="btn" onclick="analyzeLastCallPerformance()" style="width: 100%; padding: 15px; font-size: 15px; font-weight: 700; background: linear-gradient(135deg, #f39c12, #e67e22); margin-top: 12px;">
                    üîç Analyze Last Call & Get Suggestions
                </button>

                <div id="perfSaveStatus" style="margin-top: 12px; text-align: center; font-size: 13px;"></div>
            </div>
        </div>

        <!-- Performance Suggestions Modal -->
        <div id="perfSuggestionsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; justify-content: center; align-items: center;" onclick="closePerfSuggestionsModal()">
            <div style="background: linear-gradient(135deg, #2c3e50, #34495e); border-radius: 16px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);" onclick="event.stopPropagation()">
                <button onclick="closePerfSuggestionsModal()" style="float: right; background: rgba(255, 255, 255, 0.1); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; font-weight: 700;">‚úï</button>
                
                <div style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #f39c12;">üîç Call Quality Analysis</div>
                
                <div id="perfSuggestionsContent"></div>
                
                <div id="perfSuggestionsApplyStatus" style="margin-top: 14px; text-align: center; font-size: 13px; opacity: 0.9;"></div>

                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button id="applyPerfSuggestionsBtn" class="btn" onclick="applyPerfSuggestions()" style="flex: 1; background: linear-gradient(135deg, #27ae60, #229954); padding: 12px; font-weight: 700;">
                        ‚úÖ Apply All Recommendations
                    </button>
                    <button class="btn" onclick="closePerfSuggestionsModal()" style="flex: 1; background: linear-gradient(135deg, #95a5a6, #7f8c8d); padding: 12px; font-weight: 700;">
                        ‚ùå Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Call Feedback Modal (shown before analysis) -->
        <div id="callFeedbackModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; justify-content: center; align-items: center;" onclick="closeCallFeedbackModal()">
            <div style="background: linear-gradient(135deg, #2c3e50, #34495e); border-radius: 16px; padding: 24px; max-width: 700px; width: calc(100vw - 40px); max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);" onclick="event.stopPropagation()">
                <button onclick="closeCallFeedbackModal()" style="float: right; background: rgba(255, 255, 255, 0.1); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; font-weight: 700;">‚úï</button>

                <div style="font-size: 22px; font-weight: 800; margin-bottom: 6px; color: #f39c12;">üìù Quick questions about the last call</div>
                <div style="font-size: 13px; opacity: 0.85; margin-bottom: 16px;">Answer these so the analysis can combine the logs/transcript with what actually happened.</div>

                <div style="background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.15);">
                    <div style="font-size: 13px; font-weight: 800; margin-bottom: 10px; opacity: 0.8;">Required</div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">Did the AI talk over you?</div>
                        <label style="margin-right: 12px;"><input type="radio" name="fb_talked_over" value="yes"> Yes</label>
                        <label><input type="radio" name="fb_talked_over" value="no"> No</label>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">Were the response times fast enough?</div>
                        <label style="margin-right: 12px;"><input type="radio" name="fb_fast_enough" value="yes"> Yes</label>
                        <label><input type="radio" name="fb_fast_enough" value="no"> No</label>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">Did it talk gibberish / nonsense?</div>
                        <label style="margin-right: 12px;"><input type="radio" name="fb_gibberish" value="yes"> Yes</label>
                        <label><input type="radio" name="fb_gibberish" value="no"> No</label>
                    </div>

                    <div style="margin-bottom: 6px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">Did the call disconnect unexpectedly?</div>
                        <label style="margin-right: 12px;"><input type="radio" name="fb_disconnected" value="yes"> Yes</label>
                        <label><input type="radio" name="fb_disconnected" value="no"> No</label>
                    </div>

                    <div style="height: 1px; background: rgba(255,255,255,0.12); margin: 14px 0;"></div>
                    <div style="font-size: 13px; font-weight: 800; margin-bottom: 10px; opacity: 0.8;">Optional</div>

                    <div style="margin-bottom: 12px;">
                        <label style="display:block; font-size: 14px; font-weight: 700; margin-bottom: 6px;">Any transfer problems?</label>
                        <label style="margin-right: 12px;"><input type="radio" name="fb_transfer_problem" value="yes"> Yes</label>
                        <label><input type="radio" name="fb_transfer_problem" value="no"> No</label>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display:block; font-size: 14px; font-weight: 700; margin-bottom: 6px;">Did it fail to follow instructions?</label>
                        <label style="margin-right: 12px;"><input type="radio" name="fb_instruction_noncompliance" value="yes"> Yes</label>
                        <label><input type="radio" name="fb_instruction_noncompliance" value="no"> No</label>
                    </div>

                    <div style="margin-bottom: 0;">
                        <label style="display:block; font-size: 14px; font-weight: 700; margin-bottom: 6px;">Anything else to note? (optional)</label>
                        <textarea id="fb_notes" placeholder="e.g. it cut off mid sentence, repeated itself, was rude..." style="width: 100%; min-height: 90px; padding: 10px 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; resize: vertical;"></textarea>
                    </div>
                </div>

                <div id="callFeedbackStatus" style="margin-top: 12px; text-align: center; font-size: 13px; opacity: 0.9;"></div>

                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button id="callFeedbackRunBtn" class="btn" onclick="submitCallFeedbackAndAnalyze()" style="flex: 1; background: linear-gradient(135deg, #f39c12, #e67e22); padding: 12px; font-weight: 800;">‚ñ∂ Run analysis</button>
                    <button class="btn" onclick="closeCallFeedbackModal()" style="flex: 1; background: linear-gradient(135deg, #95a5a6, #7f8c8d); padding: 12px; font-weight: 700;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Configuration Warning Banner -->
        <div id="configWarningBanner" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">‚ö†Ô∏è Configuration Issue Detected</div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 15px;">API keys are stored in the database but not loading correctly. Click below to reload configuration.</div>
            <button class="btn" style="background: white; color: #e74c3c; padding: 12px 24px; font-weight: 700;" onclick="reloadConfiguration()">
                üîÑ Fix Configuration Now
            </button>
        </div>

        <!-- Health Details Modal -->
        <div class="health-modal" id="healthModal" onclick="closeHealthModal(event)">
            <div class="health-modal-content" onclick="event.stopPropagation()">
                <button class="health-modal-close" onclick="closeHealthModal()">‚úï</button>
                <div class="health-modal-icon" id="modalIcon">üîß</div>
                <div class="health-modal-title" id="modalTitle">Service Status</div>
                <div class="health-modal-desc" id="modalDesc">Loading...</div>
                <div class="health-modal-details" id="modalDetails"></div>
                <div class="health-modal-status" id="modalStatus">Checking...</div>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <!-- Diagnostics Modal -->
        <div class="diagnostics-modal" id="diagnosticsModal" onclick="closeDiagnosticsModal(event)">
            <div class="diagnostics-modal-content" onclick="event.stopPropagation()" style="position: relative;">
                <button class="diagnostics-modal-close" onclick="closeDiagnosticsModal()">‚úï</button>
                <div class="diagnostics-modal-title">
                    üîç Console Diagnostics
                </div>
                <div class="diagnostics-modal-desc">Monitor console activity and analyze errors with AI</div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 16px; color: white; font-weight: 600;">üìä Console Logs</h3>
                        <div>
                            <button class="btn-analyze-errors" id="analyzeBtn" onclick="analyzeErrors()" disabled>
                                ü§ñ Analyze Errors
                            </button>
                            <button onclick="clearConsoleLogs()" style="padding: 8px 16px; background: rgba(231, 76, 60, 0.2); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>
                    <div class="console-logs" id="consoleLogs">
                        <div style="color: #888; text-align: center; padding: 20px;">Capturing console activity...</div>
                    </div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">
                        <span id="logCount">0</span> logs | <span id="errorCount" style="color: #ff6b6b;">0</span> errors
                    </div>
                </div>
                
                <div class="error-analysis" id="errorAnalysis">
                    <div class="error-analysis-title">
                        ü§ñ AI Error Analysis
                        <button class="btn-copy-analysis" onclick="copyAnalysisToClipboard()" style="margin-left: auto; font-size: 12px; padding: 6px 12px;">
                            üìã Copy
                        </button>
                    </div>
                    <div class="error-analysis-content" id="analysisContent">
                        Analysis will appear here...
                    </div>
                </div>
            </div>
        </div>

        <!-- Number Management Panel -->
        <div id="section-vonage" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üìû Vonage Number Management</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">View and manage all Vonage phone numbers, their assignments, and availability status.</p>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9);" onclick="syncVonageNumbers()">
                    üîÑ Sync from Vonage
                </button>
                <button class="btn" style="background: linear-gradient(135deg, #27ae60, #229954);" onclick="loadVonageNumbers()">
                    üîç Refresh List
                </button>
            </div>

            <div id="numbersContainer" style="margin-top: 20px;">
                <div style="text-align: center; padding: 40px; opacity: 0.6;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìû</div>
                    <div>Click "Sync from Vonage" or "Refresh List" to load your numbers</div>
                </div>
            </div>
        </div>

        <div id="section-brain" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üß† AI Brain Provider</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">Choose which AI service will handle conversations and decision-making for all accounts.</p>
            <div class="brain-selector">
                <div class="brain-options">
                    <label class="brain-option" id="brainOpenAI">
                        <input type="radio" name="brain" value="openai" onclick="selectBrain('openai')">
                        <div class="brain-option-title">OpenAI</div>
                        <div class="brain-option-desc">GPT-4 powered conversations</div>
                    </label>
                    <label class="brain-option" id="brainDeepSeek">
                        <input type="radio" name="brain" value="deepseek" onclick="selectBrain('deepseek')">
                        <div class="brain-option-title">DeepSeek</div>
                        <div class="brain-option-desc">Advanced reasoning engine</div>
                    </label>
                    <label class="brain-option" id="brainGroq">
                        <input type="radio" name="brain" value="groq" onclick="selectBrain('groq')">
                        <div class="brain-option-title">Groq</div>
                        <div class="brain-option-desc">GroqCloud low-latency chat (not xAI Grok)</div>
                    </label>
                    <label class="brain-option" id="brainOpenRouter">
                        <input type="radio" name="brain" value="openrouter" onclick="selectBrain('openrouter')">
                        <div class="brain-option-title">OpenRouter</div>
                        <div class="brain-option-desc">OpenRouter models (OpenAI-compatible)</div>
                    </label>
                </div>
            </div>
        </div>

        <div id="section-api-keys" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üîë API Keys Configuration</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">Manage all API keys securely. Keys are encrypted and stored in the database.</p>

            <div class="api-keys-grid">
                <div class="api-key-section">
                    <h3>OpenAI <span class="status not-configured" id="statusOpenAI">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputOpenAI" placeholder="sk-...">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('openai')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>DeepSeek <span class="status not-configured" id="statusDeepSeek">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputDeepSeek" placeholder="Enter API key">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('deepseek')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Groq <span class="status not-configured" id="statusGroq">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputGroq" placeholder="gsk_... (GroqCloud key)">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('groq')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>OpenRouter <span class="status not-configured" id="statusOpenRouter">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputOpenRouter" placeholder="sk-or-...">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('openrouter')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Speechmatics <span class="status not-configured" id="statusSpeechmatics">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputSpeechmatics" placeholder="Enter API key">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('speechmatics')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Cartesia <span class="status not-configured" id="statusCartesia">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputCartesia" placeholder="sk_car_...">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('cartesia')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Lemonfox <span class="status not-configured" id="statusLemonfox">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputLemonfox" placeholder="lf_...">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('lemonfox')">üíæ Save</button>
                </div>

                <div class="api-key-section">
                    <h3>Vapi <span class="status not-configured" id="statusVapi">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputVapi" placeholder="Enter Private API Key">
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('vapi')">üíæ Save</button>
                    <button class="btn-save" onclick="deleteAPIKey('vapi')" style="background: #c0392b; margin-top: 8px;">üóëÔ∏è Delete</button>
                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.7;">
                        Use your <strong>Private API Key</strong> from vapi.ai dashboard (not Public Key)
                    </div>
                </div>

                <div class="api-key-section">
                    <h3>Vonage <span class="status not-configured" id="statusVonage">‚ö†Ô∏è</span></h3>
                    <div class="input-wrapper">
                        <input type="password" id="inputVonageKey" placeholder="API Key">
                    </div>
                    <div class="input-wrapper">
                        <input type="password" id="inputVonageSecret" placeholder="API Secret">
                    </div>
                    <div class="input-wrapper">
                        <input type="password" id="inputVonageAppId" placeholder="Application ID">
                    </div>
                    <div class="input-wrapper">
                        <textarea id="inputVonagePrivateKey" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" rows="4" style="width: 100%; padding: 10px 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; font-family: 'Courier New', monospace; resize: vertical;"></textarea>
                    </div>
                    <button class="btn-save" onclick="saveAPIKey('vonage')">üíæ Save</button>
                    <button class="btn-save" onclick="testVonageAPI()" style="background: #3498db; margin-top: 8px;">üß™ Test Vonage API</button>
                </div>
            </div>
        </div>

        <div id="section-testing" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üß™ Testing Features</h2>
            <p style="margin-bottom: 16px; opacity: 0.8; font-size: 14px;">
                Enable experimental testing features to diagnose AI response behavior. These settings are for development/testing only.
            </p>

            <div style="background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.14); border-radius: 14px; padding: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px; align-items: start;">

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Response Timeout Test</div>
                        <label style="display:flex; gap: 10px; align-items:center; font-size: 13px; color: rgba(255,255,255,0.85);">
                            <input type="checkbox" id="timeoutTestEnabled" style="transform: scale(1.15);">
                            Play "deleted response" if AI takes too long to respond
                        </label>
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55);">
                            When enabled, an audio message will play if the AI agent doesn't respond within the specified timeout.
                        </div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Timeout Value (seconds)</div>
                        <input id="timeoutTestSeconds" type="number" min="0.5" max="10.0" step="0.5" value="2.0" style="width: 100%; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 14px;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55);">How many seconds to wait before playing the timeout audio.</div>
                    </div>

                </div>

                <div style="margin-top: 14px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
                    <button class="btn-save" onclick="saveTimeoutTestSettings()">üíæ Save Testing Settings</button>
                    <button class="btn-save" onclick="loadTimeoutTestSettings()" style="background: rgba(255,255,255,0.12);">‚Üª Reload</button>
                    <span id="timeoutTestStatus" style="font-size: 13px; opacity: 0.85;"></span>
                </div>
            </div>
        </div>

        <div id="section-instructions" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üìù Global Instructions</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">These instructions override all individual account settings and apply to EVERY call across all accounts. Use this to set system-wide rules.</p>
            
            <div class="filler-section" style="margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 16px;">üìù General Instructions</h3>
                <textarea id="globalInstructions" placeholder="Example:\n- Always remain professional\n- Verify caller identity before discussing account details\n- Follow GDPR compliance rules" style="min-height: 150px;"></textarea>
                <div class="hint">Base instructions for all calls</div>
            </div>

            <div class="filler-section" style="margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                <h3 style="color: #e74c3c; margin-bottom: 10px; font-size: 16px;">üö´ CRITICAL: NEVER DO (10 Rules)</h3>
                <p style="font-size: 13px; opacity: 0.9; margin-bottom: 10px; color: #ff6b6b;">These are ABSOLUTE restrictions. The AI must NEVER violate these under any circumstances.</p>
                <textarea id="globalNeverDo" placeholder="Example:\n1. NEVER discuss competitor pricing or products\n2. NEVER share confidential company information\n3. NEVER make unauthorized promises or commitments\n4. NEVER discuss topics outside our service scope\n5. NEVER use offensive or unprofessional language\n6. NEVER share personal data of other customers\n7. NEVER provide medical or legal advice\n8. NEVER bypass security verification procedures\n9. NEVER discuss internal company policies\n10. NEVER transfer calls without proper authorization" style="min-height: 200px; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.05);"></textarea>
                <div class="hint" style="color: #e74c3c; font-weight: 600;">‚ö†Ô∏è HIGHEST PRIORITY - These rules override everything else</div>
            </div>

            <div class="filler-section" style="margin-bottom: 20px; border-left: 4px solid #27ae60;">
                <h3 style="color: #27ae60; margin-bottom: 10px; font-size: 16px;">‚úÖ CRITICAL: MUST DO (5 Rules)</h3>
                <p style="font-size: 13px; opacity: 0.9; margin-bottom: 10px; color: #2ecc71;">These are MANDATORY actions. The AI must ALWAYS follow these rules.</p>
                <textarea id="globalMustDo" placeholder="Example:\n1. MUST verify caller identity before sharing any account information\n2. MUST log all appointment bookings in the system immediately\n3. MUST offer to escalate if unable to resolve the issue\n4. MUST confirm important details back to the caller\n5. MUST end calls professionally with a summary of next steps" style="min-height: 150px; border: 2px solid #27ae60; background: rgba(39, 174, 96, 0.05);"></textarea>
                <div class="hint" style="color: #27ae60; font-weight: 600;">‚úì MANDATORY - These must be followed on every call</div>
            </div>

            <button class="btn-save" onclick="saveGlobalInstructions()" style="margin-top: 15px;">üíæ Save All Global Instructions</button>
        </div>

        <div class="panel">
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
                <h2 style="margin: 0;">üë• Active Accounts</h2>
                <button type="button" onclick="refreshAccountsList(event)" style="background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.22); color: rgba(255,255,255,0.90); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px;">üîÑ Refresh</button>
            </div>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">All accounts with their current credit balances.</p>
            <div id="accountsList" style="max-height: 600px; overflow-y: auto;"></div>
        </div>

        <div id="section-backchannel" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üéõÔ∏è Backchannel / Turn-Taking Tuning</h2>
            <p style="margin-bottom: 16px; opacity: 0.8; font-size: 14px;">
                Use this to stop the agent treating short acknowledgements like ‚Äúok/yeah/right‚Äù as full turns.
                Higher thresholds = harder to trigger filler + AI response.
            </p>

            <div style="background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.14); border-radius: 14px; padding: 16px;">
                <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 14px; align-items: start;">

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Ignore Backchannels</div>
                        <label style="display:flex; gap: 10px; align-items:center; font-size: 13px; color: rgba(255,255,255,0.85);">
                            <input type="checkbox" id="ignoreBackchannelsAlways" style="transform: scale(1.15);">
                            Ignore ‚Äúok/yeah/right/thanks‚Äù even when agent is silent
                        </label>
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55);">
                            Recommended ON to prevent ‚Äúok‚Äù from triggering filler + response.
                        </div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Backchannel Max Words</div>
                        <input id="backchannelMaxWords" type="number" min="1" max="8" step="1" value="3" style="width: 100%; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 14px;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55);">If an utterance has more than this many words, it‚Äôs treated as a real request.</div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Min User Turn (seconds)</div>
                        <input id="minUserTurnSeconds" type="range" min="0.10" max="1.50" step="0.05" value="0.45" style="width: 100%;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.75);">Current: <span id="minUserTurnSecondsLabel">0.45</span>s</div>
                        <div style="margin-top: 4px; font-size: 12px; color: rgba(255,255,255,0.55);">Utterances shorter than this won‚Äôt trigger filler/AI in Speechmatics mode.</div>
                    </div>

                    <div>
                        <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Barge-in Min Speech (seconds)</div>
                        <input id="bargeInMinSpeechSeconds" type="range" min="0.10" max="5.00" step="0.10" value="2.00" style="width: 100%;">
                        <div style="margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.75);">Current: <span id="bargeInMinSpeechSecondsLabel">2.00</span>s</div>
                        <div style="margin-top: 4px; font-size: 12px; color: rgba(255,255,255,0.55);">How long caller must continuously speak before AI stops talking (interrupts). Recommended: 2.0s</div>
                    </div>

                </div>

                <div style="margin-top: 14px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
                    <button class="btn-save" onclick="saveBackchannelSettings()">üíæ Save Tuning</button>
                    <button class="btn-save" onclick="loadBackchannelSettings()" style="background: rgba(255,255,255,0.12);">‚Üª Reload</button>
                    <span id="backchannelSettingsStatus" style="font-size: 13px; opacity: 0.85;"></span>
                </div>
            </div>
        </div>

        <!-- Vapi Assistants Section -->
        <div id="section-vapi" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üéôÔ∏è Vapi Assistants (Pre-configured)</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">
                Manage pre-configured Vapi assistants that users can select. Create assistants at 
                <a href="https://dashboard.vapi.ai" target="_blank" style="color: #6495ed;">dashboard.vapi.ai</a> 
                and add them here for all users to access.
            </p>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; margin-bottom: 10px;">‚ûï Add New Assistant</h3>
                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; opacity: 0.9;">Name</label>
                        <input type="text" id="vapiAssistantName" placeholder="e.g., Fast Customer Service" 
                            style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; opacity: 0.9;">Assistant ID (from Vapi)</label>
                        <input type="text" id="vapiAssistantId" placeholder="e.g., 677f4245-ef59-4d95-a877-e037e97b8bfe" 
                            style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                    </div>
                    <button class="btn-save" onclick="addVapiAssistant()" style="padding: 10px 20px;">
                        ‚ûï Add
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <h3 style="font-size: 16px; margin-bottom: 10px;">üìã Current Assistants</h3>
                <div id="vapiAssistantsList" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; min-height: 100px;">
                    <p style="color: rgba(255,255,255,0.5); text-align: center;">No assistants added yet</p>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn-save" onclick="saveVapiAssistants()">
                    üíæ Save Assistants
                </button>
                <button class="btn-save" onclick="loadVapiAssistants()" style="background: rgba(255,255,255,0.12);">
                    üîÑ Reload
                </button>
                <span id="vapiAssistantsStatus" style="font-size: 13px; opacity: 0.85;"></span>
            </div>
        </div>

        <div id="section-filler" class="panel section-focused">
            <button class="back-to-menu" onclick="backToMenu()">‚¨ÜÔ∏è Menu</button>
            <h2>üí¨ Filler Words (By Latency)</h2>
            <p style="margin-bottom: 14px; opacity: 0.8; font-size: 14px;">
                The AI uses these phrases as ‚Äúthinking‚Äù fillers. Selection is automatic:
                under 0.5s = none, not bad = Small, average = Medium, very poor = Large.
            </p>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;">
                <div>
                    <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Small</div>
                    <textarea id="fillerWordsSmall" placeholder="One per line (short fillers)" style="width: 100%; min-height: 170px; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 13px; resize: vertical;"></textarea>
                </div>
                <div>
                    <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Medium</div>
                    <textarea id="fillerWordsMedium" placeholder="One per line (medium fillers)" style="width: 100%; min-height: 170px; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 13px; resize: vertical;"></textarea>
                </div>
                <div>
                    <div style="font-size: 13px; font-weight: 800; color: rgba(255,255,255,0.85); margin-bottom: 6px;">Large</div>
                    <textarea id="fillerWordsLarge" placeholder="One per line (long fillers)" style="width: 100%; min-height: 170px; padding: 10px 12px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 13px; resize: vertical;"></textarea>
                </div>
            </div>

            <div style="margin-top: 14px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
                <button class="btn-save" onclick="saveFillerWordsBySize()">üíæ Save Filler Words</button>
                <button class="btn-save" onclick="loadFillerWordsBySize()" style="background: rgba(255,255,255,0.12);">‚Üª Reload</button>
                <span id="fillerWordsBySizeStatus" style="font-size: 13px; opacity: 0.85;"></span>
            </div>
        </div>

        <div class="panel">            <h2>üí¨ Filler Words (Sarah Voice)</h2>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">10 audio files using Speechmatics Sarah voice. These will be randomly played during pauses to cover latency.</p>
            
            <div style="margin-bottom: 25px;">
                <button class="btn-save" onclick="generateAllFillers()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 14px 28px;">
                    ‚ú® Generate All 30 with AI
                </button>
                <span id="generateAllStatus" style="margin-left: 15px; font-size: 14px; opacity: 0.8;"></span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;" id="fillerSlots">
                <!-- Filler slots will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Flagged Accounts Modal -->
    <div id="flaggedAccountsModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 5000; align-items:center; justify-content:center; padding: 20px;">
        <div style="background: linear-gradient(135deg, rgba(44, 62, 80, 0.98) 0%, rgba(52, 73, 94, 0.98) 100%); border-radius: 18px; padding: 22px; max-width: 1100px; width: 100%; max-height: 85vh; overflow: hidden; border: 2px solid rgba(231, 76, 60, 0.35); box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative;">
            <button onclick="closeFlaggedAccountsModal()" style="position:absolute; top: 14px; right: 14px; background: rgba(231, 76, 60, 0.3); border:none; color:white; font-size: 22px; width: 38px; height: 38px; border-radius: 50%; cursor:pointer;">√ó</button>
            <div style="font-size: 20px; font-weight: 900; color: white; margin-bottom: 6px;">üö® Content Moderation Alerts</div>
            <div style="font-size: 13px; color: rgba(255,255,255,0.75); margin-bottom: 14px;">Accounts flagged by AI moderation (illegal, sexual content, terrorism, scams, etc.).</div>
            <div id="flaggedAccountsModalContent" style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; height: calc(85vh - 140px); overflow: auto;">
                <div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- Account Config Details Modal -->
    <div id="accountConfigModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 5500; align-items:center; justify-content:center; padding: 20px;">
        <div style="background: linear-gradient(135deg, rgba(44, 62, 80, 0.98) 0%, rgba(52, 73, 94, 0.98) 100%); border-radius: 18px; padding: 22px; max-width: 900px; width: 100%; max-height: 85vh; overflow: hidden; border: 2px solid rgba(52, 152, 219, 0.35); box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative;">
            <button onclick="closeAccountConfigModal()" style="position:absolute; top: 14px; right: 14px; background: rgba(231, 76, 60, 0.3); border:none; color:white; font-size: 22px; width: 38px; height: 38px; border-radius: 50%; cursor:pointer;">√ó</button>
            <div style="font-size: 20px; font-weight: 900; color: white; margin-bottom: 6px;">üëÅÔ∏è Account Configuration</div>
            <div id="accountConfigModalSubtitle" style="font-size: 13px; color: rgba(255,255,255,0.75); margin-bottom: 14px;"></div>
            <div id="accountConfigModalContent" style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; height: calc(85vh - 140px); overflow: auto;">
                <div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="testModal" class="test-modal" onclick="if(event.target === this) closeTestModal()">
        <div class="test-modal-content">
            <h3 id="testModalTitle">üß™ Vonage API Test Results</h3>
            <div id="testModalBody"></div>
            <button class="btn-close-modal" onclick="closeTestModal()">Close</button>
        </div>
    </div>

    <script>
        // Global variables - declare at top to avoid hoisting issues
        let streamingStatusInterval = null;
        let healthCheckInterval = null;
        let healthData = {};
        let selectedCallUuid = null;
        
        // Navigation functions
        function navigateToSection(sectionName) {
            // Show all sections first
            const sections = document.querySelectorAll('[id^="section-"]');
            sections.forEach(section => {
                section.classList.remove('section-blurred');
                section.classList.add('section-focused');
                const backBtn = section.querySelector('.back-to-menu');
                if (backBtn) backBtn.style.display = 'none';
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (sectionName === 'overview') {
                // Show all sections
                window.scrollTo({top: 0, behavior: 'smooth'});
                document.querySelector('.nav-item').classList.add('active');
                return;
            }
            
            // Blur all sections except the target
            const targetSection = document.getElementById('section-' + sectionName);
            if (targetSection) {
                sections.forEach(section => {
                    if (section.id !== 'section-' + sectionName) {
                        section.classList.add('section-blurred');
                        section.classList.remove('section-focused');
                    } else {
                        section.classList.remove('section-blurred');
                        section.classList.add('section-focused');
                        const backBtn = section.querySelector('.back-to-menu');
                        if (backBtn) backBtn.style.display = 'block';
                    }
                });
                
                // Scroll to section with offset for nav
                const yOffset = -100;
                const y = targetSection.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
                
                // Highlight active nav item
                event.target.classList.add('active');
                
                // Load data when navigating to specific sections
                if (sectionName === 'vapi') {
                    loadVapiAssistants();
                }
            }
        }
        
        function backToMenu() {
            navigateToSection('overview');
        }
        
        // Menu dragging and resizing functionality
        (function initMenuControls() {
            const navMenu = document.getElementById('navMenu');
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            let xOffset = 0, yOffset = 0;
            
            // Add resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'menu-resize-handle';
            resizeHandle.innerHTML = '‚ã∞';
            navMenu.appendChild(resizeHandle);
            
            // Add move handle
            const moveHandle = document.createElement('div');
            moveHandle.className = 'menu-move-handle';
            moveHandle.innerHTML = '‚ãÆ‚ãÆ';
            navMenu.appendChild(moveHandle);
            
            // Dragging functionality
            moveHandle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                if (e.target === moveHandle) {
                    isDragging = true;
                    navMenu.style.cursor = 'grabbing';
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    navMenu.style.transform = `translate(calc(-50% + ${currentX}px), ${currentY}px)`;
                }
            }
            
            function dragEnd() {
                if (isDragging) {
                    isDragging = false;
                    navMenu.style.cursor = '';
                }
            }
            
            // Resizing functionality
            let isResizing = false;
            let startWidth, startHeight, startX, startY;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startWidth = navMenu.offsetWidth;
                startHeight = navMenu.offsetHeight;
                startX = e.clientX;
                startY = e.clientY;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isResizing) {
                    const width = startWidth + (e.clientX - startX);
                    const height = startHeight + (e.clientY - startY);
                    navMenu.style.maxWidth = width + 'px';
                    navMenu.style.width = width + 'px';
                    navMenu.style.height = height + 'px';
                    navMenu.style.overflowY = 'auto';
                }
            });
            
            document.addEventListener('mouseup', function() {
                isResizing = false;
            });
            
            // Double-click to reset position and size
            moveHandle.addEventListener('dblclick', function() {
                xOffset = 0;
                yOffset = 0;
                navMenu.style.transform = 'translateX(-50%)';
                navMenu.style.maxWidth = 'min(1400px, 95vw)';
                navMenu.style.width = '';
                navMenu.style.height = '';
                navMenu.style.overflowY = '';
            });
        })();
        
        // IMPORTANT: Super Admin security is enforced server-side.
        // This page only calls /api/super-admin/login to create a secure session cookie.

        function _getCookie(name) {
            const match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()\[\]\\/+^]/g, '\\$&') + '=([^;]*)'));
            return match ? decodeURIComponent(match[1]) : '';
        }

        function _setErr(msg) {
            const err = document.getElementById('errorMessage');
            if (!err) return;
            if (msg) {
                err.textContent = msg;
                err.style.display = 'block';
            } else {
                err.style.display = 'none';
            }
        }

        // Wrap fetch so all Super Admin requests send cookies + CSRF.
        (function() {
            const _origFetch = window.fetch.bind(window);
            function _setHeader(init, k, v) {
                if (!init.headers) init.headers = {};
                if (init.headers instanceof Headers) init.headers.set(k, v);
                else init.headers[k] = v;
            }
            window.fetch = async function(input, init) {
                init = init || {};
                init.credentials = 'include';
                const method = String(init.method || 'GET').toUpperCase();
                if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
                    const csrf = _getCookie('website33_super_admin_csrf');
                    if (csrf) _setHeader(init, 'X-CSRF-Token', csrf);
                }
                const resp = await _origFetch(input, init);
                // If the session expires, fall back to login screen.
                if (resp.status === 401) {
                    document.getElementById('mainDashboard').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                }
                return resp;
            };
        })();

        async function checkExistingSession() {
            try {
                const resp = await fetch('/api/super-admin/session');
                if (resp.ok) showDashboard();
            } catch (_) {
                // stay on login screen
            }
        }

        function _setSetupMessage(msg, ok=false) {
            const el = document.getElementById('setupMessage');
            if (!el) return;
            if (!msg) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = ok ? 'rgba(46, 204, 113, 0.25)' : 'rgba(231, 76, 60, 0.25)';
            el.style.border = ok ? '1px solid rgba(46, 204, 113, 0.35)' : '1px solid rgba(231, 76, 60, 0.35)';
            el.style.color = ok ? 'rgba(170, 255, 200, 0.95)' : 'rgba(255, 200, 200, 0.95)';
            el.style.padding = '10px 12px';
            el.style.borderRadius = '10px';
        }

        function _showSetupBox(show=true) {
            const box = document.getElementById('setupBox');
            if (!box) return;
            box.style.display = show ? 'block' : 'none';
        }

        async function checkSuperAdminStatus() {
            try {
                const resp = await fetch('/api/super-admin/status');
                if (!resp.ok) return;
                const data = await resp.json().catch(() => ({}));
                if (data && data.configured === false) {
                    _showSetupBox(true);
                    _setErr('Super Admin is not configured yet. Use first-time setup below.');
                }
            } catch (_) {}
        }

        checkExistingSession();
        checkSuperAdminStatus();
        document.getElementById('passwordInput')?.addEventListener('keypress', function(e) { if (e.key === 'Enter') attemptLogin(); });
        document.getElementById('otpInput')?.addEventListener('keypress', function(e) { if (e.key === 'Enter') attemptOTPLogin(); });

        let otpMode = false;

        async function requestOTP() {
            _setErr('');
            const otpBtn = document.getElementById('otpBtn');
            otpBtn.disabled = true;
            otpBtn.textContent = 'üì§ Sending...';

            try {
                const resp = await fetch('/api/super-admin/request-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await resp.json();

                if (resp.ok) {
                    otpMode = true;
                    document.getElementById('passwordInput').parentElement.style.display = 'none';
                    document.getElementById('otpInputGroup').style.display = 'block';
                    otpBtn.textContent = '‚úÖ Code Sent!';
                    otpBtn.style.background = 'rgba(46, 204, 113, 0.3)';
                    setTimeout(() => {
                        otpBtn.textContent = 'üîÑ Resend Code';
                        otpBtn.disabled = false;
                    }, 3000);
                    document.getElementById('otpInput').focus();
                } else {
                    const err = data?.detail || 'Failed to send code';
                    _setErr(err);
                    otpBtn.disabled = false;
                    otpBtn.textContent = 'üì± Send Code to Mobile';
                }
            } catch (e) {
                _setErr('Failed to send code');
                otpBtn.disabled = false;
                otpBtn.textContent = 'üì± Send Code to Mobile';
            }
        }

        async function attemptOTPLogin() {
            const otp = document.getElementById('otpInput')?.value || '';
            if (otp.length !== 6) {
                _setErr('Enter 6-digit code');
                return;
            }
            
            _setErr('');
            try {
                const resp = await fetch('/api/super-admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ otp_code: otp })
                });

                if (resp.ok) {
                    document.getElementById('otpInput').value = '';
                    showDashboard();
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                const err = data?.detail || 'Invalid code';
                _setErr(err);
                document.getElementById('otpInput').value = '';
                document.getElementById('otpInput').focus();
            } catch (e) {
                _setErr('Login failed');
            }
        }

        async function attemptLogin() {
            const pwd = document.getElementById('passwordInput')?.value || '';
            _setErr('');
            try {
                const resp = await fetch('/api/super-admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });

                if (resp.ok) {
                    document.getElementById('passwordInput').value = '';
                    showDashboard();
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                const err = data?.error || data?.detail || 'Login failed';
                _setErr(err);
                if (resp.status === 503 && String(err).toLowerCase().includes('not configured')) {
                    _showSetupBox(true);
                }
                document.getElementById('passwordInput').value = '';
            } catch (e) {
                _setErr('Login failed');
            }
        }

        async function attemptBootstrap() {
            _setSetupMessage('');
            const token = (document.getElementById('setupTokenInput')?.value || '').trim();
            const username = (document.getElementById('setupUsernameInput')?.value || '').trim();
            const password = (document.getElementById('setupPasswordInput')?.value || '').trim();
            const confirm = (document.getElementById('setupPasswordConfirmInput')?.value || '').trim();

            if (!token) {
                _setSetupMessage('Setup token is required. Set SUPER_ADMIN_SETUP_TOKEN on the server, then paste it here.');
                return;
            }
            if (password.length < 6) {
                _setSetupMessage('Password too short (use at least 6 characters).');
                return;
            }
            if (password !== confirm) {
                _setSetupMessage('Passwords do not match.');
                return;
            }

            try {
                const resp = await fetch('/api/super-admin/bootstrap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setup_token: token, username: username || 'admin', password })
                });
                
                let data = {};
                try {
                    data = await resp.json();
                } catch (jsonErr) {
                    _setSetupMessage(`Setup failed (HTTP ${resp.status}): Unable to parse server response`);
                    return;
                }
                
                if (resp.ok && data && data.success) {
                    _setSetupMessage('Super Admin configured. Loading dashboard‚Ä¶', true);
                    document.getElementById('setupPasswordInput').value = '';
                    document.getElementById('setupPasswordConfirmInput').value = '';
                    document.getElementById('passwordInput').value = '';
                    // If server auto-logged in, go straight to dashboard.
                    if (data.auto_login) {
                        showDashboard();
                        return;
                    }
                    _setErr('Setup complete. Now log in with your new password.');
                    return;
                }
                
                // Show detailed error
                let errMsg = data?.error || data?.detail || 'Setup failed';
                if (resp.status === 403) {
                    errMsg = `Invalid setup token. Make sure SUPER_ADMIN_SETUP_TOKEN in .env matches what you entered. (${errMsg})`;
                } else if (resp.status === 503) {
                    errMsg = `Setup token not configured on server. Add SUPER_ADMIN_SETUP_TOKEN to .env and restart. (${errMsg})`;
                } else if (resp.status === 409) {
                    errMsg = `Super Admin is already configured. Use the login form above instead. (${errMsg})`;
                } else if (resp.status >= 500) {
                    errMsg = `Server error (${resp.status}): ${errMsg}`;
                } else {
                    errMsg = `Setup failed (HTTP ${resp.status}): ${errMsg}`;
                }
                _setSetupMessage(errMsg);
            } catch (e) {
                _setSetupMessage(`Setup failed: Network error or server is not responding. ${e.message || ''}`);
                console.error('Bootstrap error:', e);
            }
        }
        function showDashboard() { 
            document.getElementById('loginScreen').style.display = 'none'; 
            document.getElementById('mainDashboard').style.display = 'block'; 
            loadAllSettings(); 
            loadFlaggedAccountsBadge();
            startStreamingStatusPolling(); 
            startBrainUsagePolling();
            // Delay health monitoring start by 1 second to ensure server is ready after restart
            setTimeout(() => {
                startHealthMonitoring();
            }, 1000);
        }
        async function logout() {
            stopStreamingStatusPolling();
            try { await fetch('/api/super-admin/logout', { method: 'POST' }); } catch (_) {}
            location.reload();
        }
        async function loadAllSettings() {
            const safe = async (label, fn) => {
                try {
                    await fn();
                } catch (e) {
                    console.error(`Error in ${label}:`, e);
                }
            };

            await safe('brain-provider', async () => {
                const brainResp = await fetch('/api/super-admin/brain-provider');
                const brainData = await brainResp.json();
                if (brainData && brainData.success) selectBrain(brainData.provider);
            });

            await safe('checkAPIKeyStatus(openai)', () => checkAPIKeyStatus('openai'));
            await safe('checkAPIKeyStatus(deepseek)', () => checkAPIKeyStatus('deepseek'));
            await safe('checkAPIKeyStatus(groq)', () => checkAPIKeyStatus('groq'));
            await safe('checkAPIKeyStatus(openrouter)', () => checkAPIKeyStatus('openrouter'));
            await safe('checkAPIKeyStatus(speechmatics)', () => checkAPIKeyStatus('speechmatics'));
            await safe('checkAPIKeyStatus(cartesia)', () => checkAPIKeyStatus('cartesia'));
            await safe('checkAPIKeyStatus(lemonfox)', () => checkAPIKeyStatus('lemonfox'));
            await safe('checkAPIKeyStatus(vapi)', () => checkAPIKeyStatus('vapi'));
            await safe('checkAPIKeyStatus(vonage)', () => checkAPIKeyStatus('vonage'));

            await safe('loadGlobalInstructions', () => loadGlobalInstructions());
            await safe('loadBackchannelSettings', () => loadBackchannelSettings());
            await safe('loadTimeoutTestSettings', () => loadTimeoutTestSettings());
            await safe('loadFillerWordsBySize', () => loadFillerWordsBySize());
            await safe('loadAccountsList', () => loadAccountsList());
            await safe('loadFillerSlots', () => loadFillerSlots());
            await safe('loadRecentCalls', () => loadRecentCalls());
            await safe('loadTunnelConfig', () => loadTunnelConfig());
            await safe('loadOpenRouterModels', () => loadOpenRouterModels());
            await safe('loadPerformanceSettings', () => loadPerformanceSettings());
            await safe('loadRacingSettings', () => loadRacingSettings());
        }

        // ==================== BACKCHANNEL / TURN-TAKING SETTINGS ====================
        function _setBackchannelStatus(msg, ok=true) {
            const el = document.getElementById('backchannelSettingsStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = ok ? 'rgba(120, 255, 160, 0.95)' : 'rgba(255, 140, 140, 0.95)';
        }

        function _wireBackchannelSliders() {
            const minSlider = document.getElementById('minUserTurnSeconds');
            const minLabel = document.getElementById('minUserTurnSecondsLabel');
            const bargeSlider = document.getElementById('bargeInMinSpeechSeconds');
            const bargeLabel = document.getElementById('bargeInMinSpeechSecondsLabel');
            if (minSlider && minLabel) {
                minLabel.textContent = String(Number(minSlider.value).toFixed(2));
                minSlider.oninput = () => { minLabel.textContent = String(Number(minSlider.value).toFixed(2)); };
            }
            if (bargeSlider && bargeLabel) {
                bargeLabel.textContent = String(Number(bargeSlider.value).toFixed(2));
                bargeSlider.oninput = () => { bargeLabel.textContent = String(Number(bargeSlider.value).toFixed(2)); };
            }
        }

        async function loadBackchannelSettings() {
            try {
                _wireBackchannelSliders();
                _setBackchannelStatus('Loading‚Ä¶', true);
                const resp = await fetch('/api/super-admin/backchannel-settings');
                const data = await resp.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed to load');
                const s = data.settings || {};

                const ignore = document.getElementById('ignoreBackchannelsAlways');
                const maxWords = document.getElementById('backchannelMaxWords');
                const minTurn = document.getElementById('minUserTurnSeconds');
                const bargeIn = document.getElementById('bargeInMinSpeechSeconds');

                if (ignore) ignore.checked = !!s.ignore_backchannels_always;
                if (maxWords) maxWords.value = String(s.backchannel_max_words ?? 3);
                if (minTurn) minTurn.value = String(s.min_user_turn_seconds ?? 0.45);
                if (bargeIn) bargeIn.value = String(s.barge_in_min_speech_seconds ?? 2.00);

                _wireBackchannelSliders();
                _setBackchannelStatus('Loaded', true);
            } catch (e) {
                console.error('Error loading backchannel settings:', e);
                _setBackchannelStatus('Load failed', false);
            }
        }

        async function saveBackchannelSettings() {
            try {
                _wireBackchannelSliders();
                _setBackchannelStatus('Saving‚Ä¶', true);

                const ignore = document.getElementById('ignoreBackchannelsAlways')?.checked ?? true;
                const maxWordsRaw = document.getElementById('backchannelMaxWords')?.value ?? '3';
                const minTurnRaw = document.getElementById('minUserTurnSeconds')?.value ?? '0.45';
                const bargeInRaw = document.getElementById('bargeInMinSpeechSeconds')?.value ?? '2.00';

                const payload = {
                    updated_by: 'super-admin',
                    settings: {
                        ignore_backchannels_always: !!ignore,
                        backchannel_max_words: Number(maxWordsRaw),
                        min_user_turn_seconds: Number(minTurnRaw),
                        barge_in_min_speech_seconds: Number(bargeInRaw),
                    }
                };

                console.log('Saving backchannel settings:', payload);

                const resp = await fetch('/api/super-admin/backchannel-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', resp.status);
                const data = await resp.json();
                console.log('Response data:', data);
                
                if (!data || !data.success) throw new Error(data?.error || 'Save failed');

                _setBackchannelStatus('Saved (applies immediately)', true);
            } catch (e) {
                console.error('Error saving backchannel settings:', e);
                _setBackchannelStatus(`Save failed: ${e.message}`, false);
            }
        }

        // ==================== TIMEOUT TEST SETTINGS ====================
        async function loadTimeoutTestSettings() {
            try {
                _setTimeoutTestStatus('Loading‚Ä¶', true);
                const resp = await fetch('/api/super-admin/timeout-test-settings');
                const data = await resp.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed to load');
                const s = data.settings || {};

                const enabled = document.getElementById('timeoutTestEnabled');
                const seconds = document.getElementById('timeoutTestSeconds');

                if (enabled) enabled.checked = !!s.timeout_test_enabled;
                if (seconds) seconds.value = String(s.timeout_test_seconds ?? 2.0);

                _setTimeoutTestStatus('Loaded', true);
            } catch (e) {
                console.error('Error loading timeout test settings:', e);
                _setTimeoutTestStatus('Load failed', false);
            }
        }

        async function saveTimeoutTestSettings() {
            try {
                _setTimeoutTestStatus('Saving‚Ä¶', true);

                const enabled = document.getElementById('timeoutTestEnabled')?.checked ?? false;
                const secondsRaw = document.getElementById('timeoutTestSeconds')?.value ?? '2.0';

                const payload = {
                    updated_by: 'super-admin',
                    settings: {
                        timeout_test_enabled: !!enabled,
                        timeout_test_seconds: Number(secondsRaw),
                    }
                };

                console.log('Saving timeout test settings:', payload);

                const resp = await fetch('/api/super-admin/timeout-test-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', resp.status);
                const data = await resp.json();
                console.log('Response data:', data);
                
                if (!data || !data.success) throw new Error(data?.error || 'Save failed');

                _setTimeoutTestStatus('Saved (applies immediately)', true);
            } catch (e) {
                console.error('Error saving timeout test settings:', e);
                _setTimeoutTestStatus(`Save failed: ${e.message}`, false);
            }
        }

        function _setTimeoutTestStatus(msg, isSuccess) {
            const el = document.getElementById('timeoutTestStatus');
            if (!el) return;
            el.textContent = msg;
            el.style.color = isSuccess ? 'rgba(39, 174, 96, 0.95)' : 'rgba(231, 76, 60, 0.95)';
        }

        // ==================== CONTENT MODERATION (FLAGGED ACCOUNTS) ====================
        async function loadFlaggedAccountsBadge() {
            try {
                const response = await fetch('/api/super-admin/flagged-accounts');
                const data = await response.json();
                if (!data || !data.success) return;
                const count = Array.isArray(data.flagged_accounts) ? data.flagged_accounts.length : 0;
                const badge = document.getElementById('flaggedAccountsBadge');
                if (badge) badge.textContent = String(count);
            } catch (error) {
                const badge = document.getElementById('flaggedAccountsBadge');
                if (badge) badge.textContent = '0';
                console.error('Failed to load flagged accounts badge:', error);
            }
        }

        function showFlaggedAccountsModal() {
            const modal = document.getElementById('flaggedAccountsModal');
            if (!modal) return;
            modal.style.display = 'flex';
            const content = document.getElementById('flaggedAccountsModalContent');
            if (content) content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>';
            loadFlaggedAccountsForModal();
        }

        function closeFlaggedAccountsModal() {
            const modal = document.getElementById('flaggedAccountsModal');
            if (modal) modal.style.display = 'none';
        }

        async function loadFlaggedAccountsForModal() {
            try {
                const response = await fetch('/api/super-admin/flagged-accounts');
                const data = await response.json();
                if (!data || !data.success) throw new Error('Failed to load flagged accounts');
                renderFlaggedAccountsModal(Array.isArray(data.flagged_accounts) ? data.flagged_accounts : []);
                loadFlaggedAccountsBadge();
            } catch (error) {
                console.error('Failed to load flagged accounts:', error);
                const content = document.getElementById('flaggedAccountsModalContent');
                if (content) content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.85); padding: 30px;"><div style="color:#ff6b6b; font-weight: 800;">Failed to load flagged accounts</div><div style="margin-top: 8px; opacity: 0.8;">' + String(error.message || error) + '</div></div>';
            }
        }

        function renderFlaggedAccountsModal(accounts) {
            const content = document.getElementById('flaggedAccountsModalContent');
            if (!content) return;
            if (accounts.length === 0) {
                content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.85); padding: 40px;"><div style="font-size: 18px; font-weight: 900; color: #64ff64;">‚úÖ No flagged accounts</div><div style="margin-top: 6px; opacity: 0.85;">All clear.</div></div>';
                return;
            }

            const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
            const rows = accounts.map((account) => {
                const userId = account.user_id;
                const name = escapeHtml(account.name || ('User ' + userId));
                const phone = escapeHtml(account.phone_number || '');
                const isSuspended = !!account.is_suspended;
                const userStatus = String(account.user_status || 'active');
                let status = '<span style="background: rgba(243,156,18,0.22); border: 1px solid rgba(243,156,18,0.55); color: #ffd7a3; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: 12px;">‚ö†Ô∏è Flagged</span>';
                if (userStatus === 'banned') {
                    status = '<span style="background: rgba(231,76,60,0.25); border: 1px solid rgba(231,76,60,0.65); color: #ffd0d0; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">‚õî Banned</span>';
                } else if (userStatus === 'suspended' || isSuspended) {
                    status = '<span style="background: rgba(231,76,60,0.25); border: 1px solid rgba(231,76,60,0.55); color: #ffb3b3; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: 12px;">üîí Suspended</span>';
                }
                const count = Number(account.suspension_count || 0);
                const reasonText = (account.suspension_reason || account.suspension_message || '');
                const reason = escapeHtml(reasonText);
                const whenText = (account.suspended_at || account.user_suspended_at || '');
                const when = escapeHtml(whenText);
                const details = escapeHtml(account.flag_details || account.last_flag_details || '');
                const businessInfo = escapeHtml(account.business_info || '');

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.10);">
                        <td style="padding: 10px 8px;">
                            <div style="font-weight: 900; color: white;">${name}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.65);">${phone}</div>
                        </td>
                        <td style="padding: 10px 8px;">${status}</td>
                        <td style="padding: 10px 8px; text-align:center; font-weight: 900; color: white;">${count}</td>
                        <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.75);">${when || '‚Äî'}</td>
                        <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.85);">${reason || '‚Äî'}</td>
                        <td style="padding: 10px 8px; text-align:right; white-space: nowrap;">
                            ${isSuspended ? `<button onclick="unsuspendAccountFromModal(${userId})" style="background: rgba(39,174,96,0.25); border: 1px solid rgba(39,174,96,0.6); color: #b7ffcf; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 800;">‚úì Unsuspend</button>` : ''}
                            ${(userStatus === 'suspended' || userStatus === 'banned') ? `<button onclick="reactivateAccountFromModal(${userId})" style="margin-left: 8px; background: rgba(39,174,96,0.18); border: 1px solid rgba(39,174,96,0.45); color: rgba(255,255,255,0.92); padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 900;">‚Ü© Reactivate</button>` : ''}
                            ${(userStatus !== 'banned') ? `<button onclick="banAccountFromModal(${userId})" style="margin-left: 8px; background: rgba(231,76,60,0.20); border: 1px solid rgba(231,76,60,0.55); color: #ffd0d0; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 900;">‚õî Ban</button>` : ''}
                            <button onclick="showAccountConfigModal(${userId})" style="margin-left: 8px; background: rgba(52,152,219,0.22); border: 1px solid rgba(52,152,219,0.55); color: #cde8ff; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 800;">üëÅ Details</button>
                        </td>
                    </tr>
                `;
            }).join('');

            content.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.06);">
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Account</th>
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Status</th>
                                <th style="text-align:center; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Flags</th>
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Last Violation</th>
                                <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Reason</th>
                                <th style="text-align:right; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        async function unsuspendAccountFromModal(userId) {
            if (!confirm('Unsuspend this account?')) return;
            try {
                const response = await fetch('/api/super-admin/unsuspend-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                if (!data || !data.success) throw new Error(data?.error || data?.detail || 'Failed to unsuspend');
                if (typeof showAlert === 'function') showAlert('‚úÖ Account unsuspended', 'success');
                loadFlaggedAccountsForModal();
                if (typeof loadAccountsList === 'function') loadAccountsList();
            } catch (error) {
                console.error('Failed to unsuspend account:', error);
                if (typeof showAlert === 'function') showAlert('‚ùå Failed to unsuspend: ' + (error.message || error), 'error');
            }
        }

        async function banAccountFromModal(userId) {
            if (!confirm('Ban this account permanently?')) return;
            try {
                const response = await fetch(`/api/super-admin/account/${userId}/ban`, {
                    method: 'POST'
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || (data && data.success === false)) throw new Error(data?.error || data?.detail || 'Failed to ban');
                if (typeof showAlert === 'function') showAlert('‚õî Account banned', 'success');
                loadFlaggedAccountsForModal();
                if (typeof loadAccountsList === 'function') loadAccountsList();
            } catch (error) {
                console.error('Failed to ban account:', error);
                if (typeof showAlert === 'function') showAlert('‚ùå Failed to ban: ' + (error.message || error), 'error');
            }
        }

        async function reactivateAccountFromModal(userId) {
            if (!confirm('Reactivate this account?')) return;
            try {
                const response = await fetch(`/api/super-admin/account/${userId}/reactivate`, {
                    method: 'POST'
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || (data && data.success === false)) throw new Error(data?.error || data?.detail || 'Failed to reactivate');
                if (typeof showAlert === 'function') showAlert('‚úÖ Account reactivated', 'success');
                loadFlaggedAccountsForModal();
                if (typeof loadAccountsList === 'function') loadAccountsList();
            } catch (error) {
                console.error('Failed to reactivate account:', error);
                if (typeof showAlert === 'function') showAlert('‚ùå Failed to reactivate: ' + (error.message || error), 'error');
            }
        }

        function closeAccountConfigModal() {
            const modal = document.getElementById('accountConfigModal');
            if (modal) modal.style.display = 'none';
        }

        async function showAccountDetailsModal(userId, userName) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('accountDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'accountDetailsModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 999999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; animation: fadeIn 0.2s ease;';
                modal.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 0; border-radius: 20px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <div style="position: sticky; top: 0; background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(10px); padding: 24px 28px; border-bottom: 2px solid rgba(155, 89, 182, 0.3); z-index: 10; border-radius: 20px 20px 0 0;">
                            <h2 style="margin: 0 0 4px 0; font-size: 22px; font-weight: 900; background: linear-gradient(90deg, #9b59b6, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üë§ Account Signup Details</h2>
                            <div id="accountDetailsModalSubtitle" style="font-size: 13px; color: rgba(255,255,255,0.65); font-weight: 600;"></div>
                        </div>
                        <div id="accountDetailsModalContent" style="padding: 28px;"></div>
                        <div style="padding: 20px 28px; border-top: 1px solid rgba(255,255,255,0.08); text-align: right;">
                            <button onclick="closeAccountDetailsModal()" style="background: rgba(155, 89, 182, 0.22); border: 1px solid rgba(155, 89, 182, 0.55); color: #e8d4ff; padding: 10px 24px; border-radius: 12px; cursor: pointer; font-weight: 900; font-size: 13px;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            const subtitle = document.getElementById('accountDetailsModalSubtitle');
            const content = document.getElementById('accountDetailsModalContent');
            
            modal.style.display = 'flex';
            subtitle.textContent = 'Loading‚Ä¶';
            content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading account details‚Ä¶</div>';

            try {
                const response = await fetch(`/api/super-admin/account-details/${userId}`);
                const data = await response.json();
                
                if (!data || !data.success) {
                    throw new Error(data?.error || 'Failed to load account details');
                }

                const d = data.details || {};
                const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

                subtitle.textContent = `${userName} (User ID: ${userId})`;

                const fieldBlock = (label, value, icon = '') => {
                    const displayValue = value || '<span style="opacity:0.5;">(not provided)</span>';
                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 11px; letter-spacing: 0.5px; font-weight: 900; color: rgba(155, 89, 182, 0.85); margin-bottom: 6px; text-transform: uppercase;">${icon} ${label}</div>
                            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(155, 89, 182, 0.25); border-radius: 10px; padding: 12px 14px; color: rgba(255,255,255,0.95); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 13px; word-break: break-word; line-height: 1.5;">${displayValue}</div>
                        </div>
                    `;
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return dateStr;
                    }
                };

                content.innerHTML = `
                    <div style="display: grid; gap: 12px;">
                        ${fieldBlock('Username', escapeHtml(d.username), 'üîë')}
                        ${fieldBlock('Email Address', escapeHtml(d.email), 'üìß')}
                        ${fieldBlock('Mobile Number', escapeHtml(d.mobile), 'üì±')}
                        ${fieldBlock('Mobile E.164 Format', escapeHtml(d.mobile_e164), 'üåç')}
                        ${fieldBlock('Business Name', escapeHtml(d.business_name), 'üè¢')}
                        ${fieldBlock('Website URL', escapeHtml(d.website_url), 'üåê')}
                        ${fieldBlock('Full Name', escapeHtml(d.name), 'üë§')}
                        ${fieldBlock('Assigned Phone Number', escapeHtml(d.phone_number), '‚òéÔ∏è')}
                        ${fieldBlock('Account Created', formatDate(d.created_at), 'üìÖ')}
                        ${fieldBlock('Account Status', escapeHtml(d.status), '‚ú®')}
                        <div style="margin-top: 16px; padding: 14px; background: rgba(231, 76, 60, 0.12); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 10px; font-size: 12px; color: rgba(255,255,255,0.85); line-height: 1.6;">
                            <div style="font-weight: 900; color: #ff6b6b; margin-bottom: 6px;">üîí SECURITY NOTE</div>
                            Passwords are securely hashed using PBKDF2 and cannot be displayed. Original passwords are never stored in plain text for security reasons.
                        </div>
                    </div>
                `;
            } catch (error) {
                subtitle.textContent = `${userName} (User ID: ${userId})`;
                content.innerHTML = `
                    <div style="text-align:center; padding: 30px;">
                        <div style="color:#ff6b6b; font-weight: 800; font-size: 16px; margin-bottom: 10px;">‚ùå Failed to Load Account Details</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 13px;">${escapeHtml(String(error.message || error))}</div>
                    </div>
                `;
            }
        }

        function closeAccountDetailsModal() {
            const modal = document.getElementById('accountDetailsModal');
            if (modal) modal.style.display = 'none';
        }

        async function showAccountConfigModal(userId) {
            const modal = document.getElementById('accountConfigModal');
            const subtitle = document.getElementById('accountConfigModalSubtitle');
            const content = document.getElementById('accountConfigModalContent');
            if (!modal || !subtitle || !content) return;

            modal.style.display = 'flex';
            subtitle.textContent = 'Loading‚Ä¶';
            content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.7); padding: 30px;">Loading‚Ä¶</div>';

            try {
                const response = await fetch(`/api/super-admin/account-config/${userId}`);
                const data = await response.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed to load account config');

                const cfg = data.config || {};
                const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

                subtitle.textContent = `${data.name || 'Account'} (User ID: ${data.user_id})`;

                const agentName = escapeHtml(cfg.AGENT_NAME || '');
                const callGreeting = escapeHtml(cfg.CALL_GREETING || '');
                const transferNumber = escapeHtml(cfg.TRANSFER_NUMBER || '');
                const businessInfo = escapeHtml(cfg.BUSINESS_INFO || '');
                const agentPersonality = escapeHtml(cfg.AGENT_PERSONALITY || '');
                const agentInstructions = escapeHtml(cfg.AGENT_INSTRUCTIONS || '');

                const voiceProvider = (cfg.VOICE_PROVIDER || 'openai');
                const openaiVoice = (cfg.VOICE || 'shimmer');
                const googleVoice = (cfg.GOOGLE_VOICE || 'en-GB-Standard-A');
                const speechmaticsVoiceId = (cfg.SPEECHMATICS_VOICE_ID || 'sarah');
                const cartesiaVoiceId = (cfg.CARTESIA_VOICE_ID || 'a0e99841-438c-4a64-b679-ae501e7d6091');
                const lemonfoxVoice = (cfg.LEMONFOX_VOICE || 'heart');

                const fieldBlock = (label, value) => {
                    const displayValue = value || '<span style="opacity:0.4;">(empty)</span>';
                    return `
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px;">${label}</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8); line-height: 1.4; word-break: break-word; white-space: pre-wrap; max-height: 80px; overflow-y: auto;">${displayValue}</div>
                        </div>
                    `;
                };

                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        ${fieldBlock('Agent Name', agentName)}
                        ${fieldBlock('Call Greeting', callGreeting)}
                        ${fieldBlock('Transfer Number', transferNumber)}
                        ${fieldBlock('Business Info', businessInfo)}
                        ${fieldBlock('Agent Personality', agentPersonality)}
                        ${fieldBlock('Agent Instructions', agentInstructions)}
                    </div>

                    <div style="margin-top: 16px; background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 14px;">
                        <div style="font-size: 14px; font-weight: 900; color: rgba(255,255,255,0.9); margin-bottom: 10px;">üé§ Voice Provider & Agent Voice</div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start;">
                            <div>
                                <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.75); margin-bottom: 6px;">Voice Provider</div>
                                <select id="saVoiceProvider_${userId}" onchange="saSwitchAccountVoiceProvider(${userId})" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: white; font-size: 13px;">
                                    <option value="openai">OpenAI</option>
                                    <option value="google">Google Cloud</option>
                                    <option value="speechmatics">Speechmatics</option>
                                    <option value="cartesia">Cartesia</option>
                                    <option value="lemonfox">Lemonfox</option>
                                </select>
                                <div style="margin-top: 6px; font-size: 11px; color: rgba(255,255,255,0.55);">Lemonfox requires a global Lemonfox API key (no filler sounds).</div>
                            </div>

                            <div>
                                <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.75); margin-bottom: 6px;">Agent Voice</div>

                                <div id="saVoiceOpenAIWrap_${userId}" style="display:none;">
                                    <select id="saOpenAIVoice_${userId}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: white; font-size: 13px;">
                                        <option value="shimmer">Shimmer</option>
                                        <option value="nova">Nova</option>
                                        <option value="alloy">Alloy</option>
                                        <option value="echo">Echo</option>
                                        <option value="fable">Fable</option>
                                        <option value="onyx">Onyx</option>
                                    </select>
                                </div>

                                <div id="saVoiceGoogleWrap_${userId}" style="display:none;">
                                    <select id="saGoogleVoice_${userId}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: white; font-size: 13px;">
                                        <option value="en-GB-Standard-A">en-GB-Standard-A</option>
                                        <option value="en-GB-Standard-B">en-GB-Standard-B</option>
                                        <option value="en-GB-Standard-C">en-GB-Standard-C</option>
                                        <option value="en-GB-Standard-D">en-GB-Standard-D</option>
                                        <option value="en-GB-Standard-F">en-GB-Standard-F</option>
                                    </select>
                                </div>

                                <div id="saVoiceSpeechmaticsWrap_${userId}" style="display:none;">
                                    <select id="saSpeechmaticsVoice_${userId}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: white; font-size: 13px;">
                                        <option value="sarah">Sarah</option>
                                    </select>
                                </div>

                                <div id="saVoiceCartesiaWrap_${userId}" style="display:none;">
                                    <select id="saCartesiaVoice_${userId}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: white; font-size: 13px;">
                                        <option value="a0e99841-438c-4a64-b679-ae501e7d6091">British Narration Lady</option>
                                    </select>
                                </div>

                                <div id="saVoiceLemonfoxWrap_${userId}" style="display:none;">
                                    <select id="saLemonfoxVoice_${userId}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: white; font-size: 13px;">
                                        <option value="heart">Heart</option>
                                    </select>
                                    <div id="saLemonfoxStatus_${userId}" style="margin-top: 6px; font-size: 11px; color: rgba(255,255,255,0.55);"></div>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap: 10px; align-items:center; margin-top: 12px; flex-wrap: wrap;">
                            <button onclick="saSaveAccountVoiceSettings(${userId})" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.85) 0%, rgba(39, 174, 96, 0.85) 100%); border: none; color: white; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 900;">üíæ Save Voice Settings</button>
                            <div id="saVoiceSaveStatus_${userId}" style="font-size: 12px; color: rgba(255,255,255,0.7);"></div>
                        </div>
                    </div>
                `;

                // Initialize selects
                const providerEl = document.getElementById(`saVoiceProvider_${userId}`);
                if (providerEl) providerEl.value = voiceProvider;
                const openaiEl = document.getElementById(`saOpenAIVoice_${userId}`);
                if (openaiEl) openaiEl.value = openaiVoice;
                const googleEl = document.getElementById(`saGoogleVoice_${userId}`);
                if (googleEl) googleEl.value = googleVoice;
                const speechEl = document.getElementById(`saSpeechmaticsVoice_${userId}`);
                if (speechEl) speechEl.value = speechmaticsVoiceId;
                const cartesiaEl = document.getElementById(`saCartesiaVoice_${userId}`);
                if (cartesiaEl) cartesiaEl.value = cartesiaVoiceId;
                const lemonfoxEl = document.getElementById(`saLemonfoxVoice_${userId}`);
                if (lemonfoxEl) lemonfoxEl.value = lemonfoxVoice;

                await saSwitchAccountVoiceProvider(userId, true);
            } catch (error) {
                subtitle.textContent = `User ID: ${userId}`;
                content.innerHTML = '<div style="text-align:center; color: rgba(255,255,255,0.85); padding: 30px;"><div style="color:#ff6b6b; font-weight: 800;">Failed to load account configuration</div><div style="margin-top: 8px; opacity: 0.8;">' + String(error.message || error) + '</div></div>';
            }
        }

        async function saSwitchAccountVoiceProvider(userId, suppressLoad=false) {
            const provider = document.getElementById(`saVoiceProvider_${userId}`)?.value || 'openai';
            const show = (wrapId, on) => {
                const el = document.getElementById(`${wrapId}_${userId}`);
                if (el) el.style.display = on ? 'block' : 'none';
            };

            show('saVoiceOpenAIWrap', provider === 'openai');
            show('saVoiceGoogleWrap', provider === 'google');
            show('saVoiceSpeechmaticsWrap', provider === 'speechmatics');
            show('saVoiceCartesiaWrap', provider === 'cartesia');
            show('saVoiceLemonfoxWrap', provider === 'lemonfox');

            if (provider === 'lemonfox' && !suppressLoad) {
                await saLoadLemonfoxVoices(userId);
            }
            if (provider === 'cartesia' && !suppressLoad) {
                await saLoadCartesiaVoices(userId);
            }
        }

        async function saLoadLemonfoxVoices(userId) {
            const selectEl = document.getElementById(`saLemonfoxVoice_${userId}`);
            const statusEl = document.getElementById(`saLemonfoxStatus_${userId}`);
            if (!selectEl) return;

            try {
                const resp = await fetch('/api/lemonfox-voices');
                const data = await resp.json();

                if (!resp.ok || !data.success) {
                    if (statusEl) statusEl.textContent = '‚ö†Ô∏è Failed to load Lemonfox voices.';
                    return;
                }

                const voices = Array.isArray(data.voices) ? data.voices : [];
                const current = selectEl.value;
                selectEl.innerHTML = '';
                for (const v of voices) {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    const name = v.name || v.id;
                    const gender = v.gender ? String(v.gender) : '';
                    const accent = v.accent ? String(v.accent) : '';
                    const meta = [gender, accent].filter(Boolean).join(', ');
                    opt.textContent = meta ? `${name} (${meta})` : name;
                    selectEl.appendChild(opt);
                }

                const hasCurrent = Array.from(selectEl.options).some(o => o.value === current);
                selectEl.value = hasCurrent ? current : (voices[0]?.id || 'heart');
                if (statusEl) statusEl.textContent = '‚úÖ Lemonfox voices loaded.';
            } catch (e) {
                console.error('Failed to load Lemonfox voices:', e);
            }
        }

        async function saLoadCartesiaVoices(userId) {
            const selectEl = document.getElementById(`saCartesiaVoice_${userId}`);
            if (!selectEl) return;
            try {
                const resp = await fetch('/api/cartesia-voices');
                const data = await resp.json();
                if (!resp.ok || !data.success) return;
                const voices = Array.isArray(data.voices) ? data.voices : [];
                const current = selectEl.value;
                selectEl.innerHTML = '';
                for (const v of voices) {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    const label = v.description ? `${v.name} (${v.description})` : v.name;
                    opt.textContent = label;
                    selectEl.appendChild(opt);
                }
                const hasCurrent = Array.from(selectEl.options).some(o => o.value === current);
                selectEl.value = hasCurrent ? current : (voices[0]?.id || 'a0e99841-438c-4a64-b679-ae501e7d6091');
            } catch (e) {
                console.error('Failed to load Cartesia voices (super-admin):', e);
            }
        }

        async function saSaveAccountVoiceSettings(userId) {
            const statusEl = document.getElementById(`saVoiceSaveStatus_${userId}`);
            const setStatus = (msg, ok=true) => {
                if (!statusEl) return;
                statusEl.textContent = msg;
                statusEl.style.color = ok ? 'rgba(255,255,255,0.8)' : 'rgba(255,160,160,0.95)';
            };

            try {
                setStatus('Saving‚Ä¶');

                const voice_provider = document.getElementById(`saVoiceProvider_${userId}`)?.value || 'openai';
                const openai_voice = document.getElementById(`saOpenAIVoice_${userId}`)?.value || null;
                const google_voice = document.getElementById(`saGoogleVoice_${userId}`)?.value || null;
                const speechmatics_voice_id = document.getElementById(`saSpeechmaticsVoice_${userId}`)?.value || null;
                const cartesia_voice_id = document.getElementById(`saCartesiaVoice_${userId}`)?.value || null;
                const lemonfox_voice = document.getElementById(`saLemonfoxVoice_${userId}`)?.value || null;

                const resp = await fetch('/api/super-admin/account-voice-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        voice_provider,
                        openai_voice,
                        google_voice,
                        speechmatics_voice_id,
                        cartesia_voice_id,
                        lemonfox_voice,
                    })
                });
                const data = await resp.json();

                if (!resp.ok || !data.success) {
                    throw new Error(data?.error || 'Failed to save voice settings');
                }

                setStatus('‚úÖ Saved. Applies to new calls.');
                try { showAlert('‚úÖ Voice settings saved for this account', 'success'); } catch (_) {}
            } catch (e) {
                console.error('Failed to save account voice settings:', e);
                setStatus('‚ùå Save failed: ' + (e.message || e), false);
                try { showAlert('‚ùå Failed to save voice settings', 'error'); } catch (_) {}
            }
        }
        async function checkAPIKeyStatus(provider) { try { let endpoint = '', statusId = ''; if (provider === 'openai') { endpoint = '/api/super-admin/openai-key'; statusId = 'statusOpenAI'; } else if (provider === 'deepseek') { endpoint = '/api/super-admin/deepseek-key'; statusId = 'statusDeepSeek'; } else if (provider === 'groq') { endpoint = '/api/super-admin/groq-key'; statusId = 'statusGroq'; } else if (provider === 'openrouter') { endpoint = '/api/super-admin/openrouter-key'; statusId = 'statusOpenRouter'; } else if (provider === 'speechmatics') { endpoint = '/api/super-admin/speechmatics-key'; statusId = 'statusSpeechmatics'; } else if (provider === 'cartesia') { endpoint = '/api/super-admin/cartesia-key'; statusId = 'statusCartesia'; } else if (provider === 'lemonfox') { endpoint = '/api/super-admin/lemonfox-key'; statusId = 'statusLemonfox'; } else if (provider === 'vapi') { endpoint = '/api/super-admin/vapi-key'; statusId = 'statusVapi'; } else if (provider === 'vonage') { endpoint = '/api/super-admin/vonage-keys'; statusId = 'statusVonage'; } const response = await fetch(endpoint); const data = await response.json(); const statusEl = document.getElementById(statusId); if (data.configured) { statusEl.textContent = '‚úÖ Configured'; statusEl.className = 'status configured'; } else { statusEl.textContent = '‚ö†Ô∏è Not Configured'; statusEl.className = 'status not-configured'; } } catch (error) { console.error(`Error checking ${provider} status:`, error); } }
        function selectBrain(provider) { document.getElementById('brainOpenAI').classList.remove('selected'); document.getElementById('brainDeepSeek').classList.remove('selected'); document.getElementById('brainGroq').classList.remove('selected'); const br = document.getElementById('brainOpenRouter'); if (br) br.classList.remove('selected'); if (provider === 'openai') { document.getElementById('brainOpenAI').classList.add('selected'); document.querySelector('input[value="openai"]').checked = true; } else if (provider === 'deepseek') { document.getElementById('brainDeepSeek').classList.add('selected'); document.querySelector('input[value="deepseek"]').checked = true; } else if (provider === 'groq') { document.getElementById('brainGroq').classList.add('selected'); document.querySelector('input[value="groq"]').checked = true; } else if (provider === 'openrouter') { const el = document.getElementById('brainOpenRouter'); if (el) el.classList.add('selected'); document.querySelector('input[value="openrouter"]').checked = true; } else { document.getElementById('brainOpenAI').classList.add('selected'); document.querySelector('input[value="openai"]').checked = true; provider = 'openai'; } saveBrainProvider(provider); }
        async function saveBrainProvider(provider) { try { const response = await fetch('/api/super-admin/brain-provider', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ provider, updated_by: 'super-admin' }) }); const data = await response.json(); if (data.success) showAlert(data.message, 'success'); else showAlert('Failed to update brain provider', 'error'); } catch (error) { console.error('Error saving brain provider:', error); showAlert('Error saving brain provider', 'error'); } }
        async function testVonageAPI() {
            const modal = document.getElementById('testModal');
            const modalBody = document.getElementById('testModalBody');
            modalBody.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 32px;">‚è≥</div><p>Testing Vonage API...</p></div>';
            modal.classList.add('show');

            try {
                const response = await fetch('/api/super-admin/test-vonage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('superAdminToken')}`
                    }
                });
                const data = await response.json();

                let html = '';
                if (data.success) {
                    html += `<div class="test-result success"><strong>‚úÖ Everything Working:</strong> ${data.message}</div>`;
                } else {
                    html += `<div class="test-result error"><strong>‚ùå Problems Found:</strong> ${data.message || 'Your Vonage setup has issues that need fixing'}</div>`;
                }

                if (data.details) {
                    data.details.forEach(detail => {
                        const className = detail.status === 'success' ? 'success' : detail.status === 'warning' ? 'warning' : 'error';
                        const icon = detail.status === 'success' ? '‚úÖ' : detail.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
                        html += `<div class="test-result ${className}"><strong>${icon} ${detail.check}:</strong> ${detail.message}`;
                        
                        // Add fix button if fixable
                        if (detail.fixable && detail.fix_action) {
                            html += `<br><button class="btn-save" onclick="fixVonageIssue('${detail.fix_action}')" style="margin-top: 8px; background: #f39c12;">üîß Fix This</button>`;
                        }
                        html += '</div>';
                    });
                }

                if (data.fixes && data.fixes.length > 0) {
                    html += '<div class="test-result warning"><strong>üîß What You Need To Do:</strong>';
                    html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8;">';
                    data.fixes.forEach(fix => {
                        html += `<li style="margin-bottom: 8px;"><strong>${fix.issue}:</strong> ${fix.action}`;
                        if (fix.fixable && fix.fix_action) {
                            html += ` <button class="btn-save" onclick="fixVonageIssue('${fix.fix_action}')" style="padding: 4px 12px; font-size: 11px; background: #f39c12; margin-left: 8px;">Fix Now</button>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul></div>';
                }

                modalBody.innerHTML = html;
            } catch (error) {
                modalBody.innerHTML = `<div class="test-result error"><strong>‚ùå Test Failed:</strong> Could not run the test. Error: ${error.message}</div>`;
            }
        }

        async function fixVonageIssue(action) {
            showAlert('Attempting to fix issue...', 'info');
            
            try {
                const response = await fetch('/api/super-admin/fix-vonage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('superAdminToken')}`
                    },
                    body: JSON.stringify({ action: action })
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message || 'Issue fixed successfully!', 'success');
                    // Re-run test after 1 second
                    setTimeout(() => testVonageAPI(), 1000);
                } else {
                    showAlert(data.message || 'Could not fix this issue automatically', 'error');
                }
            } catch (error) {
                showAlert('Fix failed: ' + error.message, 'error');
            }
        }

        function closeTestModal() {
            document.getElementById('testModal').classList.remove('show');
        }

        async function saveAPIKey(provider) { try { let endpoint = '', body = {}, inputId = ''; if (provider === 'openai') { endpoint = '/api/super-admin/openai-key'; inputId = 'inputOpenAI'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'deepseek') { endpoint = '/api/super-admin/deepseek-key'; inputId = 'inputDeepSeek'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'groq') { endpoint = '/api/super-admin/groq-key'; inputId = 'inputGroq'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'openrouter') { endpoint = '/api/super-admin/openrouter-key'; inputId = 'inputOpenRouter'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'speechmatics') { endpoint = '/api/super-admin/speechmatics-key'; inputId = 'inputSpeechmatics'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'cartesia') { endpoint = '/api/super-admin/cartesia-key'; inputId = 'inputCartesia'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'lemonfox') { endpoint = '/api/super-admin/lemonfox-key'; inputId = 'inputLemonfox'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'vapi') { endpoint = '/api/super-admin/vapi-key'; inputId = 'inputVapi'; const apiKey = document.getElementById(inputId).value.trim(); if (!apiKey) { showAlert('Please enter an API key', 'error'); return; } body = { api_key: apiKey, updated_by: 'super-admin' }; } else if (provider === 'vonage') { endpoint = '/api/super-admin/vonage-keys'; const apiKey = document.getElementById('inputVonageKey').value.trim(); const apiSecret = document.getElementById('inputVonageSecret').value.trim(); const appId = document.getElementById('inputVonageAppId').value.trim(); const privateKey = document.getElementById('inputVonagePrivateKey').value.trim(); if (!apiKey && !apiSecret && !appId && !privateKey) { showAlert('Please enter at least one Vonage credential', 'error'); return; } body = { updated_by: 'super-admin' }; if (apiKey) body.api_key = apiKey; if (apiSecret) body.api_secret = apiSecret; if (appId) body.application_id = appId; if (privateKey) body.private_key_pem = privateKey; } const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); const data = await response.json(); if (data.success) { showAlert(data.message, 'success'); if (inputId) document.getElementById(inputId).value = ''; if (provider === 'vonage') { document.getElementById('inputVonageKey').value = ''; document.getElementById('inputVonageSecret').value = ''; document.getElementById('inputVonageAppId').value = ''; document.getElementById('inputVonagePrivateKey').value = ''; } await checkAPIKeyStatus(provider); } else { showAlert(data.error || 'Failed to save API key', 'error'); } } catch (error) { console.error('Error saving API key:', error); showAlert('Error saving API key', 'error'); } }

        async function deleteAPIKey(provider) { try { if (provider !== 'vapi') { showAlert('Delete not supported for this provider yet', 'error'); return; } const ok = confirm('Delete the saved Vapi API key? This will disable Vapi calls until you add a new key.'); if (!ok) return; const response = await fetch('/api/super-admin/vapi-key', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ updated_by: 'super-admin' }) }); const data = await response.json(); if (data.success) { try { document.getElementById('inputVapi').value = ''; } catch (_) {} showAlert(data.message || 'Vapi API key deleted', 'success'); await checkAPIKeyStatus('vapi'); } else { showAlert(data.error || 'Failed to delete API key', 'error'); } } catch (error) { console.error('Error deleting API key:', error); showAlert('Error deleting API key', 'error'); } }
        async function loadGlobalInstructions() { 
            try { 
                const response = await fetch('/api/super-admin/global-instructions'); 
                const data = await response.json(); 
                if (data.success) { 
                    const instructions = data.instructions || '';
                    console.log('Loaded instructions length:', instructions.length);
                    
                    // Split sections using the header markers
                    let baseInstructions = instructions;
                    let neverDoText = '';
                    let mustDoText = '';
                    
                    // Find the NEVER DO section
                    const neverDoStart = instructions.indexOf('üö´ CRITICAL: NEVER DO');
                    if (neverDoStart !== -1) {
                        // Base instructions is everything before the NEVER DO marker
                        baseInstructions = instructions.substring(0, neverDoStart).trim();
                        
                        // Find where MUST DO section starts (or end of string)
                        const mustDoStart = instructions.indexOf('‚úÖ CRITICAL: MUST DO', neverDoStart);
                        
                        if (mustDoStart !== -1) {
                            // Extract NEVER DO text (skip the header line)
                            const neverDoSection = instructions.substring(neverDoStart, mustDoStart);
                            const neverDoLines = neverDoSection.split('\n');
                            neverDoText = neverDoLines.slice(1).join('\n').trim(); // Skip first line (header)
                            
                            // Extract MUST DO text (skip the header line)
                            const mustDoSection = instructions.substring(mustDoStart);
                            const mustDoLines = mustDoSection.split('\n');
                            mustDoText = mustDoLines.slice(1).join('\n').trim(); // Skip first line (header)
                        } else {
                            // No MUST DO section, everything after NEVER DO is part of NEVER DO
                            const neverDoSection = instructions.substring(neverDoStart);
                            const neverDoLines = neverDoSection.split('\n');
                            neverDoText = neverDoLines.slice(1).join('\n').trim();
                        }
                    } else {
                        // Check if there's a MUST DO section without NEVER DO
                        const mustDoStart = instructions.indexOf('‚úÖ CRITICAL: MUST DO');
                        if (mustDoStart !== -1) {
                            baseInstructions = instructions.substring(0, mustDoStart).trim();
                            const mustDoSection = instructions.substring(mustDoStart);
                            const mustDoLines = mustDoSection.split('\n');
                            mustDoText = mustDoLines.slice(1).join('\n').trim();
                        }
                    }
                    
                    document.getElementById('globalInstructions').value = baseInstructions;
                    document.getElementById('globalNeverDo').value = neverDoText;
                    document.getElementById('globalMustDo').value = mustDoText;
                    
                    console.log('‚úÖ Parsed sections - Base:', baseInstructions.length, 'chars, NeverDo:', neverDoText.length, 'chars, MustDo:', mustDoText.length, 'chars');
                } 
            } catch (error) { 
                console.error('Error loading global instructions:', error); 
            } 
        }
        async function saveGlobalInstructions() { 
            try { 
                const instructionsTextarea = document.getElementById('globalInstructions');
                const neverDoTextarea = document.getElementById('globalNeverDo');
                const mustDoTextarea = document.getElementById('globalMustDo');
                
                if (!instructionsTextarea || !neverDoTextarea || !mustDoTextarea) {
                    console.error('Global instructions textareas not found');
                    showAlert('Error: Instructions fields not found', 'error');
                    return;
                }
                
                // Get all three sections
                const baseInstructions = instructionsTextarea.value.trim();
                const neverDo = neverDoTextarea.value.trim();
                const mustDo = mustDoTextarea.value.trim();
                
                console.log('Saving sections:');
                console.log('Base:', baseInstructions.substring(0, 50));
                console.log('NeverDo:', neverDo.substring(0, 50));
                console.log('MustDo:', mustDo.substring(0, 50));
                
                // Combine all sections with clear formatting
                let combinedInstructions = baseInstructions;
                
                if (neverDo) {
                    combinedInstructions += '\n\nüö´ CRITICAL: NEVER DO - ABSOLUTE RESTRICTIONS (HIGHEST PRIORITY):\n' + neverDo;
                }
                
                if (mustDo) {
                    combinedInstructions += '\n\n‚úÖ CRITICAL: MUST DO - MANDATORY ACTIONS (REQUIRED ON EVERY CALL):\n' + mustDo;
                }
                
                console.log('Combined instructions (first 200 chars):', combinedInstructions.substring(0, 200));
                
                const response = await fetch('/api/super-admin/global-instructions', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ instructions: combinedInstructions, updated_by: 'super-admin' }) 
                }); 
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json(); 
                console.log('Save response:', data);
                
                if (data.success) {
                    showAlert('‚úÖ All global instructions saved successfully!', 'success');
                    // Don't call closeInstructionsModal() - we're not using a modal, instructions are on the page
                } else {
                    showAlert('‚ùå Failed to save: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) { 
                console.error('Error saving global instructions:', error); 
                showAlert('‚ùå Error saving global instructions: ' + error.message, 'error'); 
            } 
        }
        async function loadAccountsList() { 
            try { 
                const response = await fetch(`/api/super-admin/accounts?t=${Date.now()}`); 
                const data = await response.json(); 
                const container = document.getElementById('accountsList'); 
                if (!data.success || !data.accounts || data.accounts.length === 0) { 
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">No accounts found</div>'; 
                    return; 
                }

                const escapeHtml = (str) => String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
                const fmtPlan = (acc) => {
                    const planStatus = acc.plan_status || 'trial';
                    const trialDays = Number(acc.trial_days_remaining ?? 0);
                    if (planStatus === 'upgraded') return '‚úÖ Upgraded';
                    if (planStatus === 'trial_expired') return '‚õî Trial Expired';
                    if (trialDays === 1) return `üéÅ Free Trial - 1 day left`;
                    if (trialDays === 0) return `üéÅ Free Trial - Last day`;
                    return `üéÅ Free Trial - ${trialDays} days left`;
                };
                const canExtendTrial = (acc) => {
                    const planStatus = acc.plan_status || 'trial';
                    return planStatus === 'trial' || planStatus === 'trial_expired';
                };
                const fmtCredits = (acc) => {
                    const v = Number(acc.credits ?? acc.minutes_remaining ?? 0);
                    return String(Math.round(isFinite(v) ? v : 0));
                };
                const fmtLastCall = (acc) => {
                    const v = acc.last_call;
                    if (!v) return '‚Äî';
                    return escapeHtml(v);
                };
                const fmtStatus = (acc) => {
                    const s = String(acc.status || 'active');
                    if (s === 'active') return '<span style="background: rgba(46,204,113,0.18); border: 1px solid rgba(46,204,113,0.45); color: #b7ffcf; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">Active</span>';
                    if (s === 'suspended') return '<span style="background: rgba(231,76,60,0.20); border: 1px solid rgba(231,76,60,0.55); color: #ffb3b3; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">Suspended</span>';
                    if (s === 'banned') return '<span style="background: rgba(231,76,60,0.24); border: 1px solid rgba(231,76,60,0.65); color: #ffb3b3; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">Banned</span>';
                    return `<span style="background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.20); color: rgba(255,255,255,0.85); padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;">${escapeHtml(s)}</span>`;
                };

                const rows = data.accounts.map(acc => {
                    const userId = Number(acc.user_id);
                    const name = escapeHtml(acc.name || 'Unknown');
                    const phone = escapeHtml(acc.phone_number || '');
                    const planStatus = acc.plan_status || 'trial';
                    const trialDays = Number(acc.trial_days_remaining ?? 0);
                    const plan = escapeHtml(fmtPlan(acc));
                    let trialLeft = '‚Äî';
                    if (planStatus !== 'upgraded') {
                        if (planStatus === 'trial_expired') trialLeft = '0';
                        else if (trialDays === 0) trialLeft = 'Last day';
                        else trialLeft = `${trialDays}d`;
                    }
                    const credits = fmtCredits(acc);
                    const callsToday = String(Number(acc.calls_today || 0));
                    const lastCall = fmtLastCall(acc);
                    const showExtendTrial = canExtendTrial(acc);

                    return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.10);">
                            <td style="padding: 10px 8px; font-weight: 900; color: white; white-space: nowrap;">${userId}</td>
                            <td style="padding: 10px 8px;">
                                <div style="font-weight: 900; color: white;">${name}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.65);">üìû ${phone || 'No number assigned'}</div>
                            </td>
                            <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.85);">${plan}</td>
                            <td style="padding: 10px 8px; text-align: center; font-weight: 900; color: white;">${trialLeft}</td>
                            <td style="padding: 10px 8px; text-align: right; font-weight: 900; color: #2ecc71;">${credits}</td>
                            <td style="padding: 10px 8px; text-align: center; font-weight: 900; color: white;">${callsToday}</td>
                            <td style="padding: 10px 8px; font-size: 12px; color: rgba(255,255,255,0.75);">${lastCall}</td>
                            <td style="padding: 10px 8px;">${fmtStatus(acc)}</td>
                            <td style="padding: 10px 8px; text-align: right; white-space: nowrap;">
                                <button type="button" onclick="showAccountDetailsModal(${userId}, '${name.replace(/'/g, "\\'")}')" style="background: rgba(155, 89, 182, 0.22); border: 1px solid rgba(155, 89, 182, 0.55); color: #e8d4ff; padding: 7px 10px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px; margin-right: 6px;">üë§ View Details</button>
                                ${showExtendTrial ? `<button type="button" onclick="extendTrial(${userId}, '${name.replace(/'/g, "\\'")}')" style="background: rgba(52, 152, 219, 0.22); border: 1px solid rgba(52, 152, 219, 0.55); color: #cde8ff; padding: 7px 10px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px; margin-right: 6px;">‚è∞ +Trial</button>` : ''}
                                <button type="button" class="credit-btn add" onclick="manageCredits(${userId}, '${name.replace(/'/g, "\\'")}', 'add')" title="Add Credits">‚ûï Add</button>
                                <button type="button" class="credit-btn remove" onclick="manageCredits(${userId}, '${name.replace(/'/g, "\\'")}', 'remove')" title="Remove Credits" style="margin-left: 6px;">‚ûñ Remove</button>
                                <button type="button" onclick="deleteAccount(${userId}, '${name.replace(/'/g, "\\'")}', '${phone.replace(/'/g, "\\'")}')" style="margin-left: 8px; background: rgba(231, 76, 60, 0.22); border: 1px solid rgba(231, 76, 60, 0.55); color: #ffb3b3; padding: 7px 10px; border-radius: 10px; cursor: pointer; font-weight: 900; font-size: 12px;">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="overflow-x:auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.06); position: sticky; top: 0; backdrop-filter: blur(10px);">
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">ID</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Account</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Plan</th>
                                    <th style="text-align:center; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Trial Left</th>
                                    <th style="text-align:right; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Credits</th>
                                    <th style="text-align:center; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Calls Today</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Last Call</th>
                                    <th style="text-align:left; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Status</th>
                                    <th style="text-align:right; padding: 10px 8px; color: rgba(255,255,255,0.85); font-size: 12px; letter-spacing: 0.4px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            } catch (error) { 
                console.error('Error loading accounts:', error); 
                document.getElementById('accountsList').innerHTML = '<div style="text-align: center; padding: 30px; color: #e74c3c;">Error loading accounts</div>'; 
            } 
        }

        function canExtendTrial(acc) {
            return acc.plan_status === 'trial' || acc.plan_status === 'trial_expired';
        }

        async function extendTrial(userId, userName) {
            const daysInput = prompt(`How many days to add to ${userName}'s trial?\n\nNote: Total trial days cannot exceed 5.\n\nEnter days (1-5):`, '1');
            if (!daysInput) return;

            const days = parseInt(daysInput, 10);
            if (isNaN(days) || days < 1 || days > 5) {
                showAlert('Please enter a valid number between 1 and 5', 'error', false);
                return;
            }

            try {
                const res = await fetch(`/api/super-admin/account/${userId}/extend-trial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: days })
                });

                const data = await res.json();

                if (!res.ok) {
                    showAlert(`Failed to extend trial: ${data.detail || data.error || 'Unknown error'}`, 'error', false);
                    return;
                }

                if (data.success) {
                    const added = Number(data.days_added ?? 0);
                    if (added > 0) {
                        showAlert(`‚úÖ Extended ${userName}'s trial by ${added} day(s)`, 'success', false);
                    } else {
                        showAlert(`‚ÑπÔ∏è ${userName} is already at the maximum trial length (5 days)`, 'error', false);
                    }
                    await loadAccountsList();
                } else {
                    showAlert(data.error || 'Failed to extend trial', 'error', false);
                }
            } catch (error) {
                showAlert(`Network error: ${error.message}`, 'error', false);
            }
        }

        async function refreshAccountsList(evt) {
            const btn = evt?.target;
            const prevText = btn?.textContent;
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.75';
                    btn.style.cursor = 'not-allowed';
                    btn.textContent = '‚è≥ Refreshing‚Ä¶';
                }
                await loadAccountsList();
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = 'pointer';
                    btn.textContent = prevText || 'üîÑ Refresh';
                }
            }
        }

        async function deleteAccount(userId, userName, phoneNumber) {
            console.log('deleteAccount called:', { userId, userName, phoneNumber });
            const phoneText = phoneNumber ? `\n\nAssigned number: ${phoneNumber}` : '';
            if (!confirm(`Delete account "${userName}" (ID: ${userId})?${phoneText}\n\nThis cannot be undone.`)) {
                console.log('User cancelled delete');
                return;
            }
            console.log('Sending DELETE request to:', `/api/super-admin/account/${userId}/delete`);
            try {
                const resp = await fetch(`/api/super-admin/account/${userId}/delete`, { method: 'DELETE' });
                console.log('Response status:', resp.status);
                const data = await resp.json();
                console.log('Response data:', data);
                if (!data || !data.success) throw new Error(data?.error || 'Delete failed');
                const released = (data.released_phone_number || '').trim();
                showAlert(released ? `üóëÔ∏è Deleted ${userName}. Number returned: ${released}` : `üóëÔ∏è Deleted ${userName}`, 'success', false);
                await loadAccountsList();
                if (typeof loadFlaggedAccountsBadge === 'function') loadFlaggedAccountsBadge();
            } catch (e) {
                console.error('Failed to delete account:', e);
                showAlert('‚ùå Failed to delete: ' + (e.message || e), 'error', false);
            }
        }
        
        async function manageCredits(userId, userName, action) {
            const actionText = action === 'add' ? 'Add' : 'Remove';
            const minutes = prompt(`${actionText} Credits for ${userName}\n\nEnter number of minutes to ${action === 'add' ? 'add' : 'remove'}:`, '60');
            
            if (minutes === null || minutes === '') return;
            
            const minutesNum = parseInt(minutes);
            if (isNaN(minutesNum) || minutesNum <= 0) {
                showAlert('Please enter a valid number', 'error', false);
                return;
            }
            
            try {
                const endpoint = action === 'add' ? 'add-minutes' : 'remove-minutes';
                const response = await fetch(`/api/super-admin/account/${userId}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ minutes: minutesNum })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const message = action === 'add' 
                        ? `‚úÖ Added ${data.minutes_added} minutes to ${userName}` 
                        : `‚úÖ Removed ${data.minutes_removed} minutes from ${userName}. New balance: ${data.new_balance} minutes`;
                    showAlert(message, 'success', false);
                    await loadAccountsList(); // Reload to show updated credits
                } else {
                    showAlert(`Failed to ${action} credits: ${data.error || 'Unknown error'}`, 'error', false);
                }
            } catch (error) {
                console.error(`Error ${action}ing credits:`, error);
                showAlert(`Error ${action}ing credits`, 'error', false);
            }
        }
        
        function _setFillerWordsBySizeStatus(msg, ok=true) {
            const el = document.getElementById('fillerWordsBySizeStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = ok ? 'rgba(120, 255, 160, 0.95)' : 'rgba(255, 140, 140, 0.95)';
        }

        // Vapi Assistants Management
        let globalVapiAssistants = [];

        async function loadVapiAssistants() {
            try {
                const response = await fetch('/api/super-admin/vapi-assistants');
                const data = await response.json();
                
                if (data.success) {
                    globalVapiAssistants = data.assistants || [];
                    renderVapiAssistantsList();
                    _setVapiStatus('Loaded', true);
                } else {
                    _setVapiStatus('Failed to load', false);
                }
            } catch (error) {
                console.error('Failed to load Vapi assistants:', error);
                _setVapiStatus('Failed to load', false);
            }
        }

        function renderVapiAssistantsList() {
            const container = document.getElementById('vapiAssistantsList');
            
            if (!container) return;
            
            if (globalVapiAssistants.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center;">No assistants added yet</p>';
                return;
            }
            
            container.innerHTML = globalVapiAssistants.map((assistant, index) => `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${assistant.name}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); font-family: monospace;">${assistant.id}</div>
                    </div>
                    <button class="btn-save" onclick="removeVapiAssistant(${index})" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.3);">
                        üóëÔ∏è Remove
                    </button>
                </div>
            `).join('');
        }

        function addVapiAssistant() {
            const name = document.getElementById('vapiAssistantName').value.trim();
            const id = document.getElementById('vapiAssistantId').value.trim();
            
            if (!name || !id) {
                showAlert('Please enter both name and assistant ID', 'error');
                return;
            }
            
            // Check for duplicates
            if (globalVapiAssistants.some(a => a.id === id)) {
                showAlert('An assistant with this ID already exists', 'error');
                return;
            }
            
            globalVapiAssistants.push({ name, id });
            renderVapiAssistantsList();
            
            // Clear inputs
            document.getElementById('vapiAssistantName').value = '';
            document.getElementById('vapiAssistantId').value = '';
            
            _setVapiStatus('‚ö†Ô∏è Unsaved changes', false);
        }

        function removeVapiAssistant(index) {
            if (confirm(`Remove "${globalVapiAssistants[index].name}"?`)) {
                globalVapiAssistants.splice(index, 1);
                renderVapiAssistantsList();
                _setVapiStatus('‚ö†Ô∏è Unsaved changes', false);
            }
        }

        async function saveVapiAssistants() {
            try {
                _setVapiStatus('Saving‚Ä¶', true);
                
                const response = await fetch('/api/super-admin/vapi-assistants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assistants: globalVapiAssistants })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Vapi assistants saved successfully', 'success');
                    _setVapiStatus('Saved', true);
                } else {
                    showAlert('Failed to save: ' + (data.error || 'Unknown error'), 'error');
                    _setVapiStatus('Failed to save', false);
                }
            } catch (error) {
                console.error('Failed to save Vapi assistants:', error);
                showAlert('Failed to save Vapi assistants', 'error');
                _setVapiStatus('Error', false);
            }
        }

        function _setVapiStatus(msg, ok) {
            const el = document.getElementById('vapiAssistantsStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = ok ? 'rgba(120, 255, 160, 0.95)' : 'rgba(255, 140, 140, 0.95)';
        }

        async function loadFillerWordsBySize() {
            try {
                _setFillerWordsBySizeStatus('Loading‚Ä¶', true);
                const resp = await fetch('/api/super-admin/filler-words-sized');
                const data = await resp.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed');
                const small = document.getElementById('fillerWordsSmall');
                const medium = document.getElementById('fillerWordsMedium');
                const large = document.getElementById('fillerWordsLarge');
                if (small) small.value = (data.filler_words_small || '').trim();
                if (medium) medium.value = (data.filler_words_medium || '').trim();
                if (large) large.value = (data.filler_words_large || '').trim();
                _setFillerWordsBySizeStatus('Loaded', true);
            } catch (e) {
                console.error('Failed to load filler words by size:', e);
                _setFillerWordsBySizeStatus('Failed to load', false);
            }
        }

        async function saveFillerWordsBySize() {
            try {
                _setFillerWordsBySizeStatus('Saving‚Ä¶', true);
                const small = (document.getElementById('fillerWordsSmall')?.value || '').trim();
                const medium = (document.getElementById('fillerWordsMedium')?.value || '').trim();
                const large = (document.getElementById('fillerWordsLarge')?.value || '').trim();
                const resp = await fetch('/api/super-admin/filler-words-sized', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filler_words_small: small,
                        filler_words_medium: medium,
                        filler_words_large: large,
                        updated_by: 'super-admin'
                    })
                });
                const data = await resp.json();
                if (!data || !data.success) throw new Error(data?.error || 'Failed');
                _setFillerWordsBySizeStatus('Saved', true);
                showAlert('Filler words saved successfully', 'success');
            } catch (e) {
                console.error('Failed to save filler words by size:', e);
                _setFillerWordsBySizeStatus('Failed to save', false);
                showAlert('Failed to save filler words', 'error');
            }
        }

        // Backwards-compatible shim (older UI paths)
        async function saveFillerWords() { return saveFillerWordsBySize(); }

        function _normalizeFillerSize(size) {
            const s = (size || '').toString().trim().toLowerCase();
            if (s === 'small' || s === 'medium' || s === 'large') return s;
            return 'small';
        }

        function _nextFillerSize(size) {
            const s = _normalizeFillerSize(size);
            if (s === 'small') return 'medium';
            if (s === 'medium') return 'large';
            return 'small';
        }

        function _sizeLabel(size) {
            const s = _normalizeFillerSize(size);
            if (s === 'small') return 'Small';
            if (s === 'medium') return 'Medium';
            return 'Large';
        }

        function getFillerSize(slot) {
            const btn = document.getElementById(`fillerSizeBtn${slot}`);
            return _normalizeFillerSize(btn?.dataset?.size || 'small');
        }

        function _setFillerSizeButton(slot, size) {
            const btn = document.getElementById(`fillerSizeBtn${slot}`);
            if (!btn) return;
            const s = _normalizeFillerSize(size);
            btn.dataset.size = s;
            btn.textContent = `üìè ${_sizeLabel(s)}`;
        }

        async function setFillerSize(slot, size) {
            const s = _normalizeFillerSize(size);
            const btn = document.getElementById(`fillerSizeBtn${slot}`);
            try {
                if (btn) btn.disabled = true;
                const response = await fetch(`/api/super-admin/set-filler-size/${slot}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voice_id: 'sarah', size: s })
                });
                const data = await response.json();
                if (!data?.success) throw new Error(data?.error || 'Failed');
                _setFillerSizeButton(slot, s);
                showAlert(`Filler ${slot} set to ${_sizeLabel(s)}`, 'success', false);
            } catch (e) {
                console.error('Failed to set filler size:', e);
                showAlert('Failed to set filler size', 'error', false);
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        async function cycleFillerSize(slot) {
            const current = getFillerSize(slot);
            const next = _nextFillerSize(current);
            await setFillerSize(slot, next);
        }

        async function loadFillerSlots() { try { const response = await fetch('/api/super-admin/list-fillers?voice_id=sarah'); const data = await response.json(); const container = document.getElementById('fillerSlots'); container.innerHTML = ''; const slotCount = Math.max(1, Math.min(50, parseInt(data.slot_count || 30, 10) || 30)); for (let i = 1; i <= slotCount; i++) { const filler = data.fillers?.find(f => f.number === i); const hasAudio = !!(filler && (filler.has_audio || filler.filename)); const card = document.createElement('div'); card.className = `filler-slot ${hasAudio ? 'has-audio' : ''}`; const fillerText = (filler?.text || ''); const fillerSize = _normalizeFillerSize(filler?.size || 'small'); card.innerHTML = `
                    <div class="filler-slot-header">
                        <div class="filler-slot-title">üéôÔ∏è Filler ${i}</div>
                        <div class="filler-slot-status ${hasAudio ? 'filled' : 'empty'}">${hasAudio ? '‚úÖ Ready' : '‚ö™ Empty'}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.8); margin-bottom: 6px;">Filler Text</div>
                        <textarea id="fillerText${i}" placeholder="Type any filler phrase here (e.g., 'Just a second‚Ä¶')" style="width: 100%; min-height: 55px; padding: 8px 10px; border: 2px solid rgba(255,255,255,0.18); border-radius: 10px; background: rgba(255,255,255,0.08); color: white; font-size: 13px; resize: vertical;">${fillerText}</textarea>
                        <div style="margin-top: 6px; font-size: 11px; color: rgba(255,255,255,0.55);">Tip: leave blank to generate a random filler. Long text will be trimmed.</div>
                    </div>
                    <div class="filler-slot-controls">
                        <button class="btn-slot play" onclick="playFiller(${i})" ${!hasAudio ? 'disabled' : ''}>‚ñ∂Ô∏è Play</button>
                        <button class="btn-slot regenerate" id="fillerSizeBtn${i}" data-size="${fillerSize}" onclick="cycleFillerSize(${i})">üìè ${_sizeLabel(fillerSize)}</button>
                        <button class="btn-slot regenerate" onclick="regenerateFiller(${i})">üîÑ Generate</button>
                        <button class="btn-slot delete" onclick="deleteFiller(${i})" ${!hasAudio ? 'disabled' : ''}>üóëÔ∏è Delete</button>
                    </div>
                `; container.appendChild(card); } } catch (error) { console.error('Error loading filler slots:', error); showAlert('Error loading filler slots', 'error'); } }
        async function playFiller(slot) { try { const audio = new Audio(`/api/super-admin/get-filler/${slot}?voice_id=sarah&t=${Date.now()}`); audio.play(); } catch (error) { console.error('Error playing filler:', error); showAlert('Error playing audio', 'error'); } }
        async function regenerateFiller(slot) { 
            try { 
                const btn = event.target; 
                btn.disabled = true; 
                btn.textContent = '‚è≥ Generating...'; 
                const textEl = document.getElementById(`fillerText${slot}`); 
                let customText = (textEl?.value || '').trim();
                
                // Clear the textarea if user wants AI to choose a new word
                if (!customText) {
                    console.log('No custom text provided, AI will choose random filler');
                }
                
                const response = await fetch(`/api/super-admin/regenerate-filler/${slot}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        voice_id: 'sarah', 
                        updated_by: 'super-admin', 
                        use_ai: true, 
                        text: customText || '',
                        size: getFillerSize(slot)
                    }) 
                }); 
                const data = await response.json(); 
                if (data.success) { 
                    showAlert(`Filler ${slot} generated successfully`, 'success', false); 
                    await loadFillerSlots(); 
                } else { 
                    showAlert(data.error || 'Failed to generate filler', 'error', false); 
                    btn.disabled = false; 
                    btn.textContent = 'üîÑ Generate'; 
                } 
            } catch (error) { 
                console.error('Error regenerating filler:', error); 
                showAlert('Error generating filler', 'error', false); 
            } 
        }
        async function deleteFiller(slot) { 
            if (!confirm(`Delete filler ${slot}?`)) return; 
            try { 
                const response = await fetch(`/api/super-admin/delete-filler/${slot}?voice_id=sarah`, { method: 'DELETE' }); 
                const data = await response.json(); 
                if (data.success) { 
                    showAlert(`Filler ${slot} deleted`, 'success', false); 
                    await loadFillerSlots(); 
                } else { 
                    showAlert('Failed to delete filler', 'error', false); 
                } 
            } catch (error) { 
                console.error('Error deleting filler:', error); 
                showAlert('Error deleting filler', 'error', false); 
            } 
        }
        async function generateAllFillers() { 
            if (!confirm('Generate all 30 filler audio files? This will overwrite existing ones.')) return; 
            try { 
                const statusEl = document.getElementById('generateAllStatus'); 
                statusEl.textContent = '‚è≥ Generating all 30 fillers...'; 
                statusEl.style.color = '#f39c12'; 
                const response = await fetch('/api/super-admin/generate-speechmatics-fillers', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ voice_id: 'sarah', updated_by: 'super-admin' }) 
                }); 
                const data = await response.json(); 
                if (data.success) { 
                    showAlert('All 10 fillers generated successfully!', 'success', false); 
                    statusEl.textContent = '‚úÖ Complete!'; 
                    statusEl.style.color = '#2ecc71'; 
                    await loadFillerSlots(); 
                    setTimeout(() => { statusEl.textContent = ''; }, 3000); 
                } else { 
                    showAlert(data.error || 'Failed to generate fillers', 'error', false); 
                    statusEl.textContent = '‚ùå Failed'; 
                    statusEl.style.color = '#e74c3c'; 
                } 
            } catch (error) { 
                console.error('Error generating all fillers:', error); 
                showAlert('Error generating fillers', 'error', false); 
            } 
        }
        function showAlert(message, type, scrollToTop = false, duration = 5000) { 
            const alertBox = document.getElementById('alertBox'); 
            if (!alertBox) {
                console.error('Alert box not found');
                alert(message); // Fallback to browser alert
                return;
            }
            
            // Use innerHTML if message contains HTML tags, otherwise textContent
            if (message.includes('<')) {
                alertBox.innerHTML = message;
            } else {
                alertBox.textContent = message;
            }
            alertBox.className = `alert alert-${type}`; 
            alertBox.style.display = 'block'; 
            alertBox.style.animation = 'slideIn 0.3s ease-out';
            
            // Optionally scroll to top to make alert visible
            if (scrollToTop) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // Auto-hide after specified duration
            setTimeout(() => { 
                alertBox.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    alertBox.style.display = 'none'; 
                }, 300);
            }, duration); 
        }
        
        // Call Performance Analysis Functions
        // (selectedCallUuid declared at top of script)
        
        // Speechmatics Streaming Status Polling
        // (streamingStatusInterval declared at top of script)
        
        async function updateStreamingStatus() {
            try {
                const response = await fetch('/api/super-admin/speechmatics-streaming-status');
                const data = await response.json();
                
                const indicator = document.getElementById('streamingIndicator');
                const label = document.getElementById('streamingLabel');
                const mode = document.getElementById('streamingMode');
                const statusDiv = document.getElementById('streamingStatus');
                
                if (data.is_streaming) {
                    indicator.className = 'streaming-indicator active';
                    label.textContent = 'WebSocket Streaming';
                    mode.textContent = 'Real-time chunks';
                } else {
                    indicator.className = 'streaming-indicator inactive';
                    label.textContent = 'HTTP Fallback';
                    mode.textContent = 'Batch generation';
                }
                
                statusDiv.style.display = 'flex';
                
                // Make draggable after showing
                if (!statusDiv.classList.contains('draggable-initialized')) {
                    makeStreamingStatusDraggable();
                    statusDiv.classList.add('draggable-initialized');
                }
            } catch (error) {
                console.error('Error fetching streaming status:', error);
            }
        }
        
        function startStreamingStatusPolling() {
            updateStreamingStatus(); // Initial update
            if (streamingStatusInterval) clearInterval(streamingStatusInterval);
            streamingStatusInterval = setInterval(updateStreamingStatus, 2000); // Poll every 2 seconds
        }
        
        function stopStreamingStatusPolling() {
            if (streamingStatusInterval) {
                clearInterval(streamingStatusInterval);
                streamingStatusInterval = null;
            }
        }

        // Live Brain Usage Polling (OpenAI vs DeepSeek vs Groq)
        let brainUsageInterval = null;

        async function updateLiveBrainUsage() {
            try {
                const resp = await fetch('/api/super-admin/live-brain-usage');
                const data = await resp.json();

                const callEl = document.getElementById('liveBrainUsageCall');
                const textEl = document.getElementById('liveBrainUsageText');
                const providersEl = document.getElementById('liveBrainUsageProviders');
                const reasonsEl = document.getElementById('liveBrainUsageReasons');
                if (!callEl || !textEl) return;

                if (!data || !data.success) {
                    callEl.textContent = 'Unavailable';
                    textEl.textContent = 'OpenAI 0% | DeepSeek 0% | Groq 0% | OpenRouter 0%';
                    if (providersEl) providersEl.textContent = '';
                    if (reasonsEl) reasonsEl.textContent = '';
                    return;
                }

                const active = (data.active_calls || []);
                if (!active.length) {
                    callEl.textContent = 'No active call';
                    textEl.textContent = 'OpenAI 0% | DeepSeek 0% | Groq 0% | OpenRouter 0%';
                    if (providersEl) providersEl.textContent = '';
                    if (reasonsEl) reasonsEl.textContent = '';
                    return;
                }

                const a = active[0];
                const selected = (a.selected_provider || 'openai');
                const effective = (a.effective_provider || 'openai');
                const reasons = Array.isArray(a.gating_reasons) ? a.gating_reasons : [];
                callEl.textContent = `Call UUID: ${a.call_uuid || 'unknown'}`;
                if (providersEl) {
                    providersEl.innerHTML = `<span style="font-weight: 700;">Selected:</span> ${selected} &nbsp; <span style="font-weight: 700;">Effective:</span> ${effective} &nbsp; <span style="opacity: 0.85;">(turns: ${a.openai_turns || 0} OpenAI / ${a.deepseek_turns || 0} DeepSeek / ${a.groq_turns || 0} Groq / ${a.openrouter_turns || 0} OpenRouter)</span>`;
                }
                if (reasonsEl) {
                    reasonsEl.textContent = reasons.length ? `Why fallback happened: ${reasons.join(', ')}` : '';
                }
                textEl.textContent = `OpenAI ${a.openai_percent || 0}% | DeepSeek ${a.deepseek_percent || 0}% | Groq ${a.groq_percent || 0}% | OpenRouter ${a.openrouter_percent || 0}%`;
            } catch (e) {
                const callEl = document.getElementById('liveBrainUsageCall');
                const textEl = document.getElementById('liveBrainUsageText');
                const providersEl = document.getElementById('liveBrainUsageProviders');
                const reasonsEl = document.getElementById('liveBrainUsageReasons');
                if (callEl) callEl.textContent = 'Error loading';
                if (textEl) textEl.textContent = 'OpenAI 0% | DeepSeek 0% | Groq 0% | OpenRouter 0%';
                if (providersEl) providersEl.textContent = '';
                if (reasonsEl) reasonsEl.textContent = '';
                console.error('Error fetching live brain usage:', e);
            }
        }

        function startBrainUsagePolling() {
            updateLiveBrainUsage();
            if (brainUsageInterval) clearInterval(brainUsageInterval);
            brainUsageInterval = setInterval(updateLiveBrainUsage, 2000);
        }

        function stopBrainUsagePolling() {
            if (brainUsageInterval) {
                clearInterval(brainUsageInterval);
                brainUsageInterval = null;
            }
        }
        
        async function loadRecentCalls() {
            try {
                const container = document.getElementById('recentCallsList');
                if (!container) {
                    console.warn('recentCallsList container not found; skipping recent calls load');
                    return;
                }

                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.75); padding: 20px;">Loading‚Ä¶</div>';

                const response = await fetch('/api/super-admin/recent-calls');

                if (!response.ok) {
                    let detail = '';
                    try {
                        const errJson = await response.json();
                        detail = errJson?.error || errJson?.detail || '';
                    } catch (_) {
                        // ignore parse errors
                    }
                    if (response.status === 401) {
                        container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.75); padding: 20px;">Session expired ‚Äî please log in again.</div>';
                        return;
                    }
                    container.innerHTML = `<div style="text-align: center; color: #e74c3c; padding: 20px;">Error loading calls (HTTP ${response.status})${detail ? `: ${detail}` : ''}</div>`;
                    return;
                }

                const data = await response.json().catch(() => ({}));
                
                if (data.success && data.calls.length > 0) {
                    container.innerHTML = '';
                    
                    data.calls.forEach(call => {
                        const startTime = new Date(call.start_time);
                        const duration = call.duration || 0;
                        const avgResponse = call.average_response_time ? `${call.average_response_time.toFixed(0)}ms avg` : 'N/A';

                        const selected = (call.selected_brain_provider || '').toString().trim();
                        const effective = (call.effective_brain_provider || '').toString().trim();
                        const callMode = (call.call_mode || '').toString().trim();
                        let reasons = call.brain_gating_reasons;
                        try {
                            if (typeof reasons === 'string' && reasons.trim().startsWith('[')) {
                                reasons = JSON.parse(reasons);
                            }
                        } catch (e) {
                            // ignore parse errors
                        }
                        if (!Array.isArray(reasons)) reasons = [];
                        const providerLine = (selected || effective)
                            ? `üß† ${selected ? `Selected: ${selected}` : ''}${selected && effective ? ' / ' : ''}${effective ? `Effective: ${effective}` : ''}${callMode ? ` (${callMode})` : ''}`
                            : '';
                        const reasonsLine = reasons.length ? `Why: ${reasons.join(', ')}` : '';
                        
                        const callItem = document.createElement('div');
                        callItem.className = 'call-item';
                        callItem.onclick = () => selectCall(call.call_uuid, callItem);
                        callItem.innerHTML = `
                            <div class="call-time">${startTime.toLocaleString()}</div>
                            <div class="call-from">üìû ${call.caller_number} ‚Üí ${call.user_phone || 'Unknown'}</div>
                            <div class="call-duration">‚è±Ô∏è ${duration}s | ${avgResponse} | ${call.business_name || 'No business'}</div>
                            ${providerLine ? `<div class="call-duration" style="opacity: 0.9;">${providerLine}</div>` : ''}
                            ${reasonsLine ? `<div class="call-duration" style="opacity: 0.8;">${reasonsLine}</div>` : ''}
                        `;
                        container.appendChild(callItem);
                    });
                } else {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">No recent calls found</div>';
                }
            } catch (error) {
                console.error('Error loading recent calls:', error);
                const container = document.getElementById('recentCallsList');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">Error loading calls</div>';
                }
            }
        }
        
        function selectCall(callUuid, element) {
            selectedCallUuid = callUuid;
            
            // Update UI
            document.querySelectorAll('.call-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            
            // Optional: if a call analysis UI exists in this build, enable it.
            const analyzeBtn = document.getElementById('analyzeCallBtn');
            if (analyzeBtn) analyzeBtn.disabled = false;
            const results = document.getElementById('analysisResults');
            if (results) results.style.display = 'none';
        }
        
        async function analyzeSelectedCall() {
            if (!selectedCallUuid) return;
            
            const btn = document.getElementById('analyzeBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚è≥</span> Analyzing...';
            
            try {
                const response = await fetch(`/api/super-admin/call-analysis/${selectedCallUuid}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResults(data);
                } else {
                    showAlert('Failed to analyze call: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error analyzing call:', error);
                showAlert('Error analyzing call', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function displayAnalysisResults(data) {
            const resultsDiv = document.getElementById('analysisResults');
            const stagesDiv = document.getElementById('timingStages');
            const bottleneckDiv = document.getElementById('bottleneckInfo');
            
            // Display quality score and analysis if available
            let qualityHtml = '';
            if (data.call_info.quality_score !== null && data.call_info.quality_score !== undefined) {
                const score = data.call_info.quality_score;
                let scoreColor = '#27ae60'; // Green
                if (score < 50) scoreColor = '#e74c3c'; // Red
                else if (score < 75) scoreColor = '#f39c12'; // Orange
                
                qualityHtml = `
                    <div class="quality-card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                            <div style="font-size: 48px; font-weight: 900; color: ${scoreColor};">${score}/100</div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 5px;">Call Quality Score</div>
                                <div style="font-size: 13px; opacity: 0.8;">${score >= 80 ? '‚úÖ Excellent' : score >= 60 ? '‚ö†Ô∏è Good' : 'üö® Needs Improvement'}</div>
                            </div>
                            <button onclick="analyzeCallQuality('${data.call_info.call_uuid}')" class="btn-analyze" style="padding: 10px 20px;">
                                üîÑ Re-analyze Quality
                            </button>
                        </div>
                        ${data.call_info.instruction_adherence ? `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">üìã Instruction Adherence:</div>
                                <div style="font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${data.call_info.instruction_adherence}</div>
                            </div>
                        ` : ''}
                        ${data.call_info.performance_issues && data.call_info.performance_issues !== 'None detected' ? `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; border-left: 4px solid #e74c3c;">
                                <div style="font-weight: 600; color: #e74c3c; margin-bottom: 8px;">‚ö†Ô∏è Performance Issues:</div>
                                <div style="font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${data.call_info.performance_issues}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                qualityHtml = `
                    <div class="quality-card" style="background: rgba(255, 193, 7, 0.1); border: 2px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: center;">
                        <div style="font-size: 16px; color: white; margin-bottom: 15px;">üìä No quality analysis yet for this call</div>
                        <button onclick="analyzeCallQuality('${data.call_info.call_uuid}')" class="btn-analyze" style="padding: 12px 24px;">
                            ü§ñ Analyze Call Quality with AI
                        </button>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 10px;">Uses DeepSeek AI to evaluate instruction adherence and performance</div>
                    </div>
                `;
            }
            
            // Display quality section first
            stagesDiv.innerHTML = qualityHtml;
            
            // Display timing stages
            data.timing_analysis.stages.forEach(stage => {
                const stageEl = document.createElement('div');
                stageEl.className = `timing-stage ${stage.status}`;
                
                let durationHtml = '';
                if (stage.actual_duration) {
                    const isLonger = stage.actual_duration && parseInt(stage.actual_duration) > 2000;
                    durationHtml = `<span class="stage-duration ${isLonger ? 'critical' : ''}">${stage.actual_duration}</span>`;
                } else if (stage.typical_duration) {
                    durationHtml = `<span class="stage-duration">${stage.typical_duration}</span>`;
                }
                
                stageEl.innerHTML = `
                    <div class="stage-header">
                        <div class="stage-name">${stage.stage}</div>
                        ${durationHtml}
                    </div>
                    <div class="stage-desc">${stage.description}</div>
                    ${stage.note ? `<div class="stage-note">‚ö†Ô∏è ${stage.note}</div>` : ''}
                `;
                stagesDiv.appendChild(stageEl);
            });
            
            // Display bottleneck info
            if (data.timing_analysis.bottleneck) {
                const bottleneck = data.timing_analysis.bottleneck;
                bottleneckDiv.innerHTML = `
                    <div class="bottleneck-card">
                        <div class="bottleneck-title">üö® Critical Bottleneck Identified</div>
                        <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 10px;">
                            ${bottleneck.stage}: <span style="color: #e74c3c;">${bottleneck.impact}</span>
                        </div>
                        <div class="recommendation">
                            <div class="recommendation-title">üí° Recommended Solutions:</div>
                            <div style="color: rgba(255,255,255,0.9); margin-bottom: 12px;">${bottleneck.recommendation}</div>
                            ${bottleneck.alternatives.map(alt => 
                                `<div class="alternative">
                                    <strong>${alt.provider}:</strong> ${alt.estimated_improvement}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                bottleneckDiv.innerHTML = '';
            }
            
            resultsDiv.style.display = 'block';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function analyzeCallQuality(callUuid) {
            if (!callUuid) return;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">ü§ñ</span> Analyzing with AI...';
            
            try {
                const response = await fetch(`/api/super-admin/analyze-call-quality/${callUuid}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Call quality analysis complete!', 'success');
                    // Reload the analysis to show new scores
                    await analyzeSelectedCall();
                } else {
                    showAlert('‚ùå Analysis failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error analyzing call quality:', error);
                showAlert('‚ùå Error analyzing call quality', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ===== SERVICE HEALTH MONITORING =====
        // (healthCheckInterval and healthData declared at top of script)

        // Health check definitions
        const healthChecks = {
            openai: {
                icon: 'üß†',
                name: 'OpenAI Connection',
                desc: 'Monitors OpenAI API connectivity and authentication. If this is red, the AI brain cannot process calls.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/openai-key');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'error', message: 'API key not configured' };
                        return { status: 'ok', message: 'Connected' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            speechmatics: {
                icon: 'üéôÔ∏è',
                name: 'Speechmatics TTS',
                desc: 'Monitors Speechmatics text-to-speech service. If this is red, voice synthesis will fail.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/speechmatics-key');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'error', message: 'API key not configured' };
                        return { status: 'ok', message: 'TTS ready' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            vonage: {
                icon: 'üìû',
                name: 'Vonage Telephony',
                desc: 'Monitors Vonage API for phone call handling. If this is red, incoming/outgoing calls cannot be processed.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/vonage-keys');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'error', message: 'Credentials not configured' };
                        return { status: 'ok', message: 'Telephony active' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            database: {
                icon: 'üíæ',
                name: 'Database Access',
                desc: 'Checks SQLite database connectivity. If this is red, call logs and settings cannot be stored/retrieved.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/accounts');
                        if (!resp.ok) return { status: 'error', message: 'Query failed' };
                        await resp.json();
                        return { status: 'ok', message: 'DB accessible' };
                    } catch (e) {
                        return { status: 'error', message: 'Connection error' };
                    }
                }
            },
            webhook: {
                icon: 'üåê',
                name: 'Ngrok Webhook',
                desc: 'Monitors webhook URL accessibility for Vonage callbacks. If this is red, incoming calls will not reach the server.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/health');
                        if (!resp.ok) return { status: 'warning', message: 'May not be exposed' };
                        await resp.json();
                        return { status: 'ok', message: 'Webhook accessible' };
                    } catch (e) {
                        return { status: 'warning', message: 'Cannot verify' };
                    }
                }
            },
            deepseek: {
                icon: 'üîÆ',
                name: 'DeepSeek API',
                desc: 'Monitors DeepSeek AI provider (alternative brain). If this is red and selected as brain, AI calls will fail.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/super-admin/deepseek-key');
                        if (!resp.ok) return { status: 'error', message: 'API unreachable' };
                        const data = await resp.json();
                        if (!data.configured) return { status: 'warning', message: 'Not configured' };
                        
                        // Check if it's the active brain
                        try {
                            const brainResp = await fetch('/api/super-admin/brain-provider');
                            if (brainResp.ok) {
                                const brainData = await brainResp.json();
                                if (brainData.provider === 'deepseek') {
                                    return { status: 'ok', message: 'Active brain' };
                                }
                            }
                        } catch (e) {
                            // Ignore brain check error
                        }
                        return { status: 'ok', message: 'Configured (standby)' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            credits: {
                icon: 'üí≥',
                name: 'Account Credits',
                desc: 'Monitors API credit balances. If this is red, one or more services may have exhausted their credits.',
                checkFn: async () => {
                    // This is a placeholder - actual credit checking would require API provider balance endpoints
                    return { status: 'ok', message: 'Monitoring active' };
                }
            },
            server: {
                icon: 'üñ•Ô∏è',
                name: 'Server Health',
                desc: 'Overall server health including memory, CPU, and uptime. If this is red, performance degradation is occurring.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/health');
                        if (!resp.ok) return { status: 'error', message: 'Not responding' };
                        const data = await resp.json();
                        if (data.status === 'healthy') {
                            return { status: 'ok', message: 'Running normally' };
                        }
                        return { status: 'warning', message: 'Performance issues' };
                    } catch (e) {
                        return { status: 'error', message: 'Not responding' };
                    }
                }
            },
            ngrok: {
                icon: 'üåâ',
                name: 'Ngrok Tunnel',
                desc: 'Monitors ngrok tunnel status and public URL availability. If this is red, incoming calls from Vonage cannot reach your server.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/admin/ngrok-status');
                        if (!resp.ok) return { status: 'error', message: 'API error' };
                        const data = await resp.json();
                        const reachable = !!data.ngrok_reachable;
                        if (data.running && reachable) {
                            const url = data.url || '';
                            const shortUrl = url.replace('https://', '').substring(0, 25);
                            return { status: 'ok', message: `Active: ${shortUrl}...`, details: data };
                        }
                        if (data.running && !reachable) {
                            return { status: 'error', message: 'Running (but unreachable)', details: data };
                        }
                        return { status: 'error', message: data.message || 'Not running', details: data };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            cloudflare: {
                icon: '‚òÅÔ∏è',
                name: 'Cloudflare Tunnel',
                desc: 'Monitors Cloudflare tunnel status and public URL availability. If this is red, incoming calls from Vonage cannot reach your server. Double-click to start the tunnel.',
                checkFn: async () => {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const resp = await fetch('/api/admin/ngrok-status', {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        if (!resp.ok) return { status: 'error', message: 'Not running' };
                        const data = await resp.json();
                        const cloudflareRunning = data.cloudflare_running || false;
                        const reachable = !!data.cloudflare_reachable;
                        
                        if (cloudflareRunning && reachable) {
                            const url = data.cloudflare_url || '';
                            if (url && url.includes('trycloudflare.com')) {
                                const shortUrl = url.replace('https://', '').replace('http://', '').substring(0, 30);
                                return { status: 'ok', message: shortUrl, details: data };
                            }
                            return { status: 'warning', message: 'Running (no URL yet)', details: data };
                        }
                        if (cloudflareRunning && !reachable) {
                            return { status: 'error', message: 'Disconnected (restart tunnel)', details: data };
                        }
                        return { status: 'error', message: 'Offline - double-click to start' };
                    } catch (e) {
                        if (e.name === 'AbortError') {
                            return { status: 'error', message: 'Offline' };
                        }
                        return { status: 'error', message: 'Offline' };
                    }
                }
            },
            activecalls: {
                icon: 'üìû',
                name: 'Active Calls',
                desc: 'Shows current active call sessions. Turns green when calls are in progress. If always red, no calls are being handled.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/active-calls');
                        if (!resp.ok) return { status: 'error', message: 'API error' };
                        const data = await resp.json();
                        const count = data.count || 0;
                        if (count > 0) {
                            return { status: 'ok', message: `${count} active call${count > 1 ? 's' : ''}` };
                        }
                        return { status: 'checking', message: 'No active calls' };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            },
            resources: {
                icon: '‚ö°',
                name: 'System Resources',
                desc: 'Monitors CPU and RAM usage. If this is red or yellow, the server is under heavy load and may experience performance issues.',
                checkFn: async () => {
                    try {
                        const resp = await fetch('/api/health');
                        if (!resp.ok) return { status: 'error', message: 'API error' };
                        const data = await resp.json();
                        const cpu = data.system?.cpu_percent || 0;
                        const mem = data.system?.memory_percent || 0;
                        
                        // Critical thresholds
                        if (cpu > 85 || mem > 90) {
                            return { status: 'error', message: `CPU ${cpu.toFixed(0)}% | RAM ${mem.toFixed(0)}% - Critical!` };
                        }
                        // Warning thresholds
                        if (cpu > 70 || mem > 75) {
                            return { status: 'warning', message: `CPU ${cpu.toFixed(0)}% | RAM ${mem.toFixed(0)}% - High` };
                        }
                        // All good
                        return { status: 'ok', message: `CPU ${cpu.toFixed(0)}% | RAM ${mem.toFixed(0)}%` };
                    } catch (e) {
                        return { status: 'error', message: 'Check failed' };
                    }
                }
            }
        };

        async function updateHealthStatus(serviceId) {
            const check = healthChecks[serviceId];
            if (!check) {
                console.error(`No health check found for: ${serviceId}`);
                return;
            }

            const circleEl = document.getElementById(`health-${serviceId}`);
            const statusEl = document.getElementById(`status-${serviceId}`);
            
            if (!circleEl || !statusEl) {
                console.error(`Elements not found for ${serviceId}`);
                return;
            }
            
            try {
                console.log(`Checking ${serviceId}...`);
                
                // Add timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Check timeout')), 8000)
                );
                
                const result = await Promise.race([
                    check.checkFn(),
                    timeoutPromise
                ]);
                
                healthData[serviceId] = result;
                
                // Update circle status
                circleEl.className = 'health-circle ' + result.status;
                
                // Update status text
                statusEl.textContent = result.message;
                
                console.log(`${serviceId}: ${result.status} - ${result.message}`);
                
            } catch (error) {
                console.error(`Health check failed for ${serviceId}:`, error);
                const errorMsg = error.message === 'Check timeout' ? 'Timeout' : 'Check failed';
                healthData[serviceId] = { status: 'error', message: errorMsg };
                circleEl.className = 'health-circle error';
                statusEl.textContent = errorMsg;
            }
        }

        async function updateAllHealthStatuses() {
            console.log('üîç Running health checks for all services...');
            const services = Object.keys(healthChecks);
            console.log('Services to check:', services);
            
            await Promise.all(services.map(service => updateHealthStatus(service)));
            
            console.log('‚úÖ All health checks completed');
            
            // Check if we need to show the configuration warning
            checkConfigurationState();
        }
        
        function checkConfigurationState() {
            // Count API key errors
            let apiKeyErrors = 0;
            const apiKeyChecks = ['openai', 'speechmatics', 'vonage', 'deepseek'];
            
            for (const checkName of apiKeyChecks) {
                const data = healthData[checkName];
                if (data && data.status === 'error' && data.message && data.message.includes('not configured')) {
                    apiKeyErrors++;
                }
            }
            
            // Show warning banner and reload button if 2+ API keys show as not configured
            // (likely means they're in DB but not loaded into memory)
            const warningBanner = document.getElementById('configWarningBanner');
            const reloadBtn = document.getElementById('reloadConfigBtn');
            if (apiKeyErrors >= 2) {
                if (warningBanner) warningBanner.style.display = 'block';
                if (reloadBtn) reloadBtn.style.display = 'block';
            } else {
                if (warningBanner) warningBanner.style.display = 'none';
                if (reloadBtn) reloadBtn.style.display = 'none';
            }
        }
        
        async function reloadConfiguration() {
            try {
                showAlert('üîÑ Reloading configuration from database...', 'info');
                
                const response = await fetch('/api/super-admin/reload-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ ' + data.message + ' - Refreshing status indicators...', 'success');
                    
                    // Wait a moment for server to settle, then refresh status checks
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    // Force refresh all health statuses (runs all checks in parallel)
                    await updateAllHealthStatuses();
                    
                    // Hide warning banner after successful reload
                    checkConfigurationState();
                } else {
                    showAlert('‚ùå ' + (data.message || data.error || 'Failed to reload configuration'), 'error');
                }
            } catch (error) {
                console.error('Error reloading configuration:', error);
                showAlert('‚ùå Error: ' + error.message, 'error');
            }
        }

        function startHealthMonitoring() {
            console.log('Starting health monitoring...');
            // Initial check
            updateAllHealthStatuses();
            
            // Poll every 10 seconds for live status updates
            if (healthCheckInterval) clearInterval(healthCheckInterval);
            healthCheckInterval = setInterval(updateAllHealthStatuses, 10000);
            console.log('Health monitoring started, polling every 10 seconds');
        }

        function stopHealthMonitoring() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
        }

        function showHealthDetails(serviceId) {
            const check = healthChecks[serviceId];
            const data = healthData[serviceId] || { status: 'checking', message: 'Loading...' };
            
            const modal = document.getElementById('healthModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalDesc = document.getElementById('modalDesc');
            const modalDetails = document.getElementById('modalDetails');
            const modalStatus = document.getElementById('modalStatus');
            
            // Set content
            modalIcon.textContent = check.icon;
            modalTitle.textContent = check.name;
            modalDesc.textContent = check.desc;
            
            // Build details
            let detailsHTML = '';
            if (data.status === 'error') {
                detailsHTML = `
                    <div class="health-modal-detail">
                        <span class="health-modal-label">What's wrong?</span>
                        <span class="health-modal-value">${data.message}</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Impact</span>
                        <span class="health-modal-value">Service degraded</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Action required</span>
                        <span class="health-modal-value">Configure API keys</span>
                    </div>
                `;
            } else if (data.status === 'warning') {
                detailsHTML = `
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Status</span>
                        <span class="health-modal-value">${data.message}</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Impact</span>
                        <span class="health-modal-value">Limited functionality</span>
                    </div>
                `;
            } else {
                detailsHTML = `
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Status</span>
                        <span class="health-modal-value">${data.message}</span>
                    </div>
                    <div class="health-modal-detail">
                        <span class="health-modal-label">Last checked</span>
                        <span class="health-modal-value">Just now</span>
                    </div>
                `;
            }
            modalDetails.innerHTML = detailsHTML;
            
            // Set overall status
            modalStatus.className = 'health-modal-status ' + data.status;
            if (data.status === 'ok') {
                modalStatus.innerHTML = '‚úÖ All systems operational';
            } else if (data.status === 'warning') {
                modalStatus.innerHTML = '‚ö†Ô∏è Minor issues detected';
            } else {
                modalStatus.innerHTML = 'üö® Service requires attention';
            }
            
            // Show modal
            modal.classList.add('show');
        }

        function closeHealthModal(event) {
            const modal = document.getElementById('healthModal');
            modal.classList.remove('show');
        }

        // ===== SYSTEM CONTROLS =====
        
        async function testCall() {
            showAlert('üîç Testing call system...', 'info');
            try {
                const resp = await fetch('/api/admin/test-call', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Test failed: ' + e.message, 'error');
            }
        }

        async function restartVoiceEngine() {
            if (!confirm('‚ö†Ô∏è This will restart the voice system. Active calls will be dropped. Continue?')) return;
            showAlert('üîÑ Restarting voice engine...', 'info');
            try {
                const resp = await fetch('/api/admin/restart-voice', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert('‚úÖ Voice engine restarted successfully', 'success');
                    setTimeout(() => updateAllHealthStatuses(), 2000);
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Restart failed: ' + e.message, 'error');
            }
        }

        async function clearCallCache() {
            if (!confirm('Clear cached call data? This may help if calls are stuck.')) return;
            showAlert('üóëÔ∏è Clearing call cache...', 'info');
            try {
                const resp = await fetch('/api/admin/clear-cache', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    setTimeout(() => updateAllHealthStatuses(), 2000);
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Clear cache failed: ' + e.message, 'error');
            }
        }

        async function restartServer() {
            if (!confirm('‚ö†Ô∏è RESTART SERVER: This will restart the entire server process. All active calls will be dropped and the page will reload. Continue?')) return;
            
            // Stop health monitoring to prevent errors during restart
            stopHealthMonitoring();
            
            showAlert('üîÅ Server restart initiated... Please wait.', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/restart-server', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data.success) {
                    showAlert('‚úÖ Server is restarting... Waiting for it to come back online.', 'success');
                }
            } catch (e) {
                // Server disconnected (expected during restart)
                showAlert('üîÅ Server is restarting... Waiting for it to come back online.', 'info');
            }
            
            // Wait for server to come back online before reloading
            let attempts = 0;
            const maxAttempts = 30; // 30 seconds max wait
            const checkInterval = setInterval(async () => {
                attempts++;
                try {
                    const healthResp = await fetch('/api/health', { method: 'GET', cache: 'no-cache' });
                    if (healthResp.ok || healthResp.status === 500) {
                        // Server is responding (even if unhealthy status, it's online)
                        clearInterval(checkInterval);
                        showAlert('‚úÖ Server is back online! Reloading page...', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } catch (e) {
                    // Server still down, keep waiting
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        showAlert('‚ö†Ô∏è Server restart timeout. Please refresh the page manually.', 'warning');
                    }
                }
            }, 1000); // Check every second
        }

        async function checkWebhooks() {
            showAlert('üåê Checking webhook configuration...', 'info');
            try {
                const resp = await fetch('/api/admin/check-webhooks');
                const data = await resp.json();
                if (data.success) {
                    const info = `
                        <div style="text-align: left; line-height: 1.8;">
                            <strong>Answer URL:</strong> ${data.answer_url}<br>
                            <strong>Event URL:</strong> ${data.event_url}<br>
                            <strong>Status:</strong> ${data.status}
                        </div>
                    `;
                    showAlert(info, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Check failed: ' + e.message, 'error');
            }
        }

        async function testOpenAI() {
            showAlert('üß† Testing OpenAI connection...', 'info');
            try {
                const resp = await fetch('/api/admin/test-openai', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ OpenAI test passed: ${data.message}`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Test failed: ' + e.message, 'error');
            }
        }

        async function testVoicePipeline() {
            showAlert('üî¨ Running comprehensive voice pipeline diagnostics...', 'info');
            try {
                const resp = await fetch('/api/super-admin/test-voice-pipeline', { method: 'POST' });
                const data = await resp.json();
                
                if (data.success && data.report) {
                    const report = data.report;
                    
                    // Build plain text report for clipboard
                    let plainTextReport = `VOICE PIPELINE DIAGNOSTIC REPORT\n`;
                    plainTextReport += `=================================\n\n`;
                    plainTextReport += `${report.summary}\n\n`;
                    plainTextReport += `Tests: ${report.test_counts.passed} passed, ${report.test_counts.failed} failed, ${report.test_counts.warned} warnings\n`;
                    plainTextReport += `Timestamp: ${report.timestamp}\n\n`;
                    
                    if (report.critical_issues.length > 0) {
                        plainTextReport += `CRITICAL ISSUES:\n`;
                        report.critical_issues.forEach(issue => {
                            plainTextReport += `  - ${issue}\n`;
                        });
                        plainTextReport += `\n`;
                    }
                    
                    if (report.warnings.length > 0) {
                        plainTextReport += `WARNINGS:\n`;
                        report.warnings.forEach(warn => {
                            plainTextReport += `  - ${warn}\n`;
                        });
                        plainTextReport += `\n`;
                    }
                    
                    plainTextReport += `DETAILED TEST RESULTS:\n`;
                    plainTextReport += `======================\n\n`;
                    report.tests.forEach(test => {
                        plainTextReport += `[${test.status}] ${test.name}\n`;
                        plainTextReport += `    ${test.details}\n\n`;
                    });
                    
                    // Copy to clipboard
                    try {
                        await navigator.clipboard.writeText(plainTextReport);
                        console.log('Report copied to clipboard');
                    } catch (e) {
                        console.error('Failed to copy to clipboard:', e);
                    }
                    
                    // Build detailed HTML report
                    let reportHtml = `
                        <div style="text-align: left; max-height: 500px; overflow-y: auto; line-height: 1.6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #2c3e50;">${report.summary}</h3>
                                <button onclick="copyDiagnosticReport()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    üìã Copy Report
                                </button>
                            </div>
                            <div style="margin-bottom: 20px; padding: 10px; background: #ecf0f1; border-radius: 8px;">
                                <strong>Tests:</strong> ${report.test_counts.passed} passed, 
                                ${report.test_counts.failed} failed, 
                                ${report.test_counts.warned} warnings
                            </div>
                    `;
                    
                    // Show critical issues first
                    if (report.critical_issues.length > 0) {
                        reportHtml += `
                            <div style="background: #ffe6e6; padding: 15px; border-left: 4px solid #e74c3c; margin-bottom: 15px; border-radius: 4px;">
                                <strong style="color: #c0392b;">üö® Critical Issues:</strong><br>
                                ${report.critical_issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    // Show warnings
                    if (report.warnings.length > 0) {
                        reportHtml += `
                            <div style="background: #fff3cd; padding: 15px; border-left: 4px solid #f39c12; margin-bottom: 15px; border-radius: 4px;">
                                <strong style="color: #e67e22;">‚ö†Ô∏è Warnings:</strong><br>
                                ${report.warnings.map(warn => `‚Ä¢ ${warn}`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    // Show all test results
                    reportHtml += '<h4 style="margin-top: 20px; color: #34495e;">Detailed Test Results:</h4>';
                    report.tests.forEach(test => {
                        let icon = '';
                        let color = '';
                        if (test.status === 'PASS') {
                            icon = '‚úÖ';
                            color = '#27ae60';
                        } else if (test.status === 'FAIL') {
                            icon = '‚ùå';
                            color = '#e74c3c';
                        } else if (test.status === 'WARN') {
                            icon = '‚ö†Ô∏è';
                            color = '#f39c12';
                        } else {
                            icon = '‚ÑπÔ∏è';
                            color = '#3498db';
                        }
                        
                        reportHtml += `
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${color};">
                                <div style="font-weight: 600; color: ${color};">
                                    ${icon} ${test.name}
                                </div>
                                <div style="font-size: 13px; color: #555; margin-top: 5px;">
                                    ${test.details}
                                </div>
                            </div>
                        `;
                    });
                    
                    reportHtml += `
                            <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 8px; font-size: 13px; color: #155724;">
                                <strong>‚úÖ Report copied to clipboard!</strong><br>
                                You can paste it directly to share with support.
                            </div>
                        </div>
                    `;
                    
                    // Store report for copy button
                    window.lastDiagnosticReport = plainTextReport;
                    
                    showAlert(reportHtml, 'info');
                } else {
                    showAlert(`‚ùå Diagnostic failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Diagnostic test failed: ' + e.message, 'error');
            }
        }

        function copyDiagnosticReport() {
            if (window.lastDiagnosticReport) {
                navigator.clipboard.writeText(window.lastDiagnosticReport).then(() => {
                    showAlert('‚úÖ Report copied to clipboard!', 'success');
                }).catch(err => {
                    showAlert('‚ùå Failed to copy: ' + err.message, 'error');
                });
            }
        }

        async function autoFixVoice() {
            showAlert('ü§ñ Running auto-fix... This will diagnose and automatically apply known solutions.', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/auto-fix-voice', { method: 'POST' });
                const data = await resp.json();
                
                if (data.success) {
                    // Build detailed report
                    let reportHtml = `
                        <div style="text-align: left; max-height: 500px; overflow-y: auto; line-height: 1.6;">
                            <h3 style="margin-top: 0; color: #2c3e50;">${data.message}</h3>
                    `;
                    
                    if (data.fixes_applied && data.fixes_applied.length > 0) {
                        reportHtml += `
                            <div style="margin: 15px 0; padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">
                                <strong style="color: #155724;">‚úÖ Fixes Applied (${data.fixes_applied.length}):</strong><br>
                        `;
                        data.fixes_applied.forEach(fix => {
                            reportHtml += `
                                <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>${fix.fix}</strong><br>
                                    <span style="font-size: 13px; color: #666;">${fix.description}</span>
                                </div>
                            `;
                        });
                        reportHtml += `</div>`;
                    }
                    
                    if (data.log) {
                        reportHtml += `
                            <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap;">
                                ${data.log.replace(/\n/g, '<br>')}
                            </div>
                        `;
                    }
                    
                    if (data.verification && data.verification.critical_issues && data.verification.critical_issues.length > 0) {
                        reportHtml += `
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                <strong style="color: #856404;">‚ö†Ô∏è Remaining Issues:</strong><br>
                                ${data.verification.critical_issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    reportHtml += `
                            <div style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; font-size: 13px;">
                                <strong>üí° What happened:</strong><br>
                                ‚Ä¢ System analyzed voice issues<br>
                                ‚Ä¢ Applied ${data.fixes_applied ? data.fixes_applied.length : 0} known solutions from fix history<br>
                                ‚Ä¢ Re-ran diagnostic to verify results
                            </div>
                        </div>
                    `;
                    
                    showAlert(reportHtml, data.verification && data.verification.critical_issues && data.verification.critical_issues.length === 0 ? 'success' : 'info');
                } else {
                    showAlert(`‚ùå Auto-fix failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Auto-fix failed: ' + e.message, 'error');
            }
        }

        // ===== TUNNEL PROVIDER MANAGEMENT =====

        // Cached tunnel config loaded from /api/super-admin/tunnel-config
        let _cachedTunnelConfig = null;

        function _getPreferredPublicUrl(statusData) {
            try {
                const cfg = _cachedTunnelConfig || {};
                const provider = (cfg.provider || '').toLowerCase();
                const domain = (cfg.cloudflare_domain || '').trim();
                const tokenSaved = !!cfg.cloudflare_tunnel_token;

                // If permanent Cloudflare is configured, always prefer it.
                if (provider === 'cloudflare' && domain && tokenSaved) {
                    return `https://${domain}`;
                }
            } catch (e) {
                // Ignore
            }
            return (statusData && statusData.url) ? statusData.url : '';
        }
        
        async function loadTunnelConfig() {
            try {
                const resp = await fetch('/api/super-admin/tunnel-config');
                const data = await resp.json();
                
                if (data.success) {
                    _cachedTunnelConfig = data;
                    document.getElementById('tunnelProvider').value = data.provider || 'ngrok';
                    document.getElementById('cloudflareDomain').value = data.cloudflare_domain || '';
                    
                    // Check if token is saved
                    const tokenInput = document.getElementById('cloudflareTunnelToken');
                    const tokenSavedIndicator = document.getElementById('tokenSavedIndicator');
                    const toggleTokenBtn = document.getElementById('toggleTokenEdit');
                    
                    if (data.cloudflare_tunnel_token) {
                        // Token is saved - show masked value and edit button
                        tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        tokenInput.disabled = true;
                        tokenSavedIndicator.style.display = 'inline-block';
                        toggleTokenBtn.style.display = 'block';
                    } else {
                        // No token saved - enable input
                        tokenInput.value = '';
                        tokenInput.disabled = false;
                        tokenSavedIndicator.style.display = 'none';
                        toggleTokenBtn.style.display = 'none';
                    }
                    
                    // Show/hide cloudflare options
                    handleTunnelProviderChange();
                    
                    // Load current configured webhook URLs immediately
                    await loadCurrentWebhookUrls();
                    
                    // Update status
                    await updateTunnelStatus();
                }
            } catch (e) {
                console.error('Failed to load tunnel config:', e);
            }
        }

        async function loadCurrentWebhookUrls() {
            try {
                const resp = await fetch('/api/admin/ngrok-status');
                const data = await resp.json();

                // If permanent Cloudflare is configured, prefer it over status-derived URLs.
                const preferredUrl = _getPreferredPublicUrl(data);
                if (preferredUrl) {
                    updateWebhookUrls(preferredUrl, true); // initial load
                    return;
                }
                
                // Use the stored public URL (cloudflare_url or ngrok_url based on provider)
                let publicUrl = '';
                if (data.provider === 'cloudflare') {
                    publicUrl = data.cloudflare_url;
                } else {
                    publicUrl = data.ngrok_url;
                }
                
                // If no active URL, try to get from CONFIG/DB
                if (!publicUrl) {
                    try {
                        const configResp = await fetch('/api/health');
                        const configData = await configResp.json();
                        publicUrl = configData.public_url || '';
                    } catch (e) {
                        console.debug('Could not fetch public URL from health endpoint');
                    }
                }
                
                if (publicUrl && publicUrl !== 'Unknown') {
                    updateWebhookUrls(publicUrl, true); // Pass true to skip change detection on initial load
                }
            } catch (e) {
                console.error('Failed to load current webhook URLs:', e);
            }
        }

        function handleTunnelProviderChange() {
            const provider = document.getElementById('tunnelProvider').value;
            const cloudflareOptions = document.getElementById('cloudflareOptions');
            
            if (provider === 'cloudflare') {
                cloudflareOptions.style.display = 'block';
            } else {
                cloudflareOptions.style.display = 'none';
            }
        }

        function toggleTokenEdit() {
            const tokenInput = document.getElementById('cloudflareTunnelToken');
            const toggleBtn = document.getElementById('toggleTokenEdit');
            const tokenSavedIndicator = document.getElementById('tokenSavedIndicator');
            
            if (tokenInput.disabled) {
                // Enable editing
                tokenInput.disabled = false;
                tokenInput.value = '';
                tokenInput.placeholder = 'Enter new tunnel token...';
                tokenInput.focus();
                toggleBtn.textContent = 'Cancel';
                toggleBtn.style.background = 'rgba(231, 76, 60, 0.2)';
                toggleBtn.style.borderColor = 'rgba(231, 76, 60, 0.4)';
            } else {
                // Cancel editing - restore masked value
                tokenInput.disabled = true;
                tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                tokenInput.placeholder = 'eyJhIjoixxxx...';
                toggleBtn.textContent = 'Edit';
                toggleBtn.style.background = 'rgba(102, 126, 234, 0.2)';
                toggleBtn.style.borderColor = 'rgba(102, 126, 234, 0.4)';
            }
        }

        async function saveTunnelConfig() {
            const provider = document.getElementById('tunnelProvider').value;
            const domain = document.getElementById('cloudflareDomain').value;
            const tokenInput = document.getElementById('cloudflareTunnelToken');
            const token = tokenInput.disabled ? null : tokenInput.value; // Only send if editing
            
            showAlert('üíæ Saving tunnel configuration...', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/tunnel-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        provider, 
                        cloudflare_domain: domain, 
                        cloudflare_tunnel_token: token 
                    })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    showAlert('‚úÖ Tunnel configuration saved', 'success');
                    // Reload config to show saved state
                    await loadTunnelConfig();
                } else {
                    showAlert('‚ùå Failed to save: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Save failed: ' + e.message, 'error');
            }
        }

        async function startCloudflare(event) {
            if (event) event.stopPropagation(); // Prevent showHealthDetails from firing
            
            const currentStatus = healthData['cloudflare'];
            if (currentStatus && currentStatus.status === 'ok') {
                showAlert('‚ÑπÔ∏è Cloudflare tunnel is already running', 'info');
                return;
            }
            
            if (!confirm('Start Cloudflare tunnel? This will take a few seconds.')) return;
            
            showAlert('‚ñ∂Ô∏è Starting Cloudflare tunnel...', 'info');
            
            try {
                const resp = await fetch('/api/super-admin/start-tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: 'cloudflare' })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    const url = data.url || '';
                    showAlert(`‚úÖ Cloudflare tunnel started successfully! ${url ? 'URL: ' + url : 'Check logs for URL.'}`, 'success');
                    
                    // Wait a moment then refresh the health status
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    await updateHealthStatus('cloudflare');
                } else {
                    showAlert(`‚ùå Failed to start Cloudflare tunnel: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error starting Cloudflare tunnel:', error);
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function startTunnel() {
            const provider = document.getElementById('tunnelProvider').value;
            showAlert(`‚ñ∂Ô∏è Starting ${provider} tunnel...`, 'info');
            
            try {
                const resp = await fetch('/api/super-admin/start-tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    const msg = data.message || (data.url ? `‚úÖ ${provider} tunnel started: ${data.url}` : `‚úÖ ${provider} tunnel started`);
                    showAlert(msg, 'success');
                    await updateTunnelStatus();
                } else {
                    showAlert('‚ùå Failed to start: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Start failed: ' + e.message, 'error');
            }
        }

        async function stopTunnel() {
            const provider = document.getElementById('tunnelProvider').value;
            
            if (!confirm(`‚ö†Ô∏è Stop ${provider} tunnel? Incoming calls will not reach the server until you restart it.`)) return;
            
            showAlert(`‚èπÔ∏è Stopping ${provider} tunnel...`, 'info');
            
            try {
                const resp = await fetch('/api/super-admin/stop-tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    showAlert(data.message || `‚úÖ ${provider} tunnel stopped`, 'success');
                    await updateTunnelStatus();
                } else {
                    showAlert('‚ùå Failed to stop: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Stop failed: ' + e.message, 'error');
            }
        }

        async function fixEngagedTone() {
            const provider = document.getElementById('tunnelProvider').value || 'cloudflare';
            if (!confirm('üõ† This will restart the tunnel and clear active sessions. Continue?')) return;

            showAlert('üõ† Fixing engaged tone (restarting tunnel)...', 'info');
            try {
                const resp = await fetch('/api/super-admin/fix-engaged', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                const data = await resp.json();
                if (data.success) {
                    showAlert(data.message || '‚úÖ Engaged tone fix complete', 'success');
                    await updateTunnelStatus();
                } else {
                    showAlert('‚ùå Fix failed: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå Fix failed: ' + e.message, 'error');
            }
        }

        async function testOpenRouter() {
            const btn = document.getElementById('testOpenRouterBtn');
            const resultDiv = document.getElementById('openrouterTestResult');
            const messageDiv = document.getElementById('openrouterTestMessage');
            const detailsDiv = document.getElementById('openrouterTestDetails');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Testing...';
            resultDiv.style.display = 'none';
            
            try {
                const resp = await fetch('/api/super-admin/test-openrouter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();
                
                resultDiv.style.display = 'block';
                
                if (data.success) {
                    resultDiv.style.background = 'rgba(46, 204, 113, 0.2)';
                    resultDiv.style.border = '2px solid #2ecc71';
                    messageDiv.innerHTML = '‚úÖ ' + data.message;
                    
                    if (data.details) {
                        const details = data.details;
                        detailsDiv.innerHTML = `
                            Model: ${details.model || 'N/A'}<br>
                            Latency: ${details.latency_ms || 'N/A'}ms<br>
                            Response: "${details.response_preview || ''}"
                        `;
                    }
                    
                    showAlert('‚úÖ OpenRouter API is working correctly', 'success');
                } else {
                    resultDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                    resultDiv.style.border = '2px solid #e74c3c';
                    messageDiv.innerHTML = '‚ùå ' + data.message;
                    
                    if (data.details) {
                        if (typeof data.details === 'string') {
                            detailsDiv.textContent = data.details;
                        } else {
                            detailsDiv.textContent = JSON.stringify(data.details, null, 2);
                        }
                    }
                    
                    showAlert('‚ùå OpenRouter test failed: ' + data.message, 'error');
                }
            } catch (e) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                resultDiv.style.border = '2px solid #e74c3c';
                messageDiv.innerHTML = '‚ùå Test failed';
                detailsDiv.textContent = e.message;
                
                showAlert('‚ùå Test failed: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîå Test OpenRouter Connection';
            }
        }

        function _setOpenRouterModelStatus(msg, ok=true) {
            const el = document.getElementById('openrouterModelStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = ok ? 'rgba(120, 255, 160, 0.95)' : 'rgba(255, 140, 140, 0.95)';
        }

        async function loadOpenRouterModels() {
            const refreshBtn = document.getElementById('refreshOpenRouterModelsBtn');
            const selectEl = document.getElementById('openrouterModelSelect');
            if (!selectEl) return;

            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'üîÑ Loading...';
            }
            _setOpenRouterModelStatus('Loading models‚Ä¶', true);

            try {
                // Get current selected model
                let selected = '';
                try {
                    const curResp = await fetch('/api/super-admin/openrouter-model');
                    const curData = await curResp.json();
                    if (curData && curData.success) selected = curData.model || '';
                } catch (_) {}

                const resp = await fetch('/api/super-admin/openrouter-models');
                const data = await resp.json();

                if (!data || !data.success) {
                    const msg = data?.error || data?.message || `Failed to load models (HTTP ${resp.status})`;
                    _setOpenRouterModelStatus(msg, false);
                    return;
                }

                const models = Array.isArray(data.models) ? data.models : [];
                const selectedModel = selected || data.selected_model || '';

                selectEl.innerHTML = '';
                if (!models.length) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No models returned from OpenRouter';
                    selectEl.appendChild(opt);
                    _setOpenRouterModelStatus('No models returned', false);
                    return;
                }

                for (const m of models) {
                    const id = m?.id || '';
                    if (!id) continue;
                    const score = m?.call_latency_score || 5;
                    const priceLabel = m?.pricing_per_million?.label ? ` ‚Äî ${m.pricing_per_million.label}` : '';
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = `‚òÖ${score} ${id}${priceLabel}`;
                    opt.style.background = '#34495e';
                    opt.style.color = '#ecf0f1';
                    selectEl.appendChild(opt);
                }

                if (selectedModel) {
                    selectEl.value = selectedModel;
                }

                _setOpenRouterModelStatus('Loaded', true);
                
                // Also populate racing model dropdowns with the same models
                await populateRacingModelDropdowns();
            } catch (e) {
                console.error('Error loading OpenRouter models:', e);
                _setOpenRouterModelStatus(`Load failed: ${e.message || e}`, false);
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'üîÑ Refresh Models';
                }
            }
        }

        async function saveOpenRouterModel() {
            const btn = document.getElementById('saveOpenRouterModelBtn');
            const selectEl = document.getElementById('openrouterModelSelect');
            if (!selectEl) return;

            const model = (selectEl.value || '').trim();
            if (!model) {
                _setOpenRouterModelStatus('Select a model first', false);
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'üíæ Saving...';
            }
            _setOpenRouterModelStatus('Saving‚Ä¶', true);

            try {
                const resp = await fetch('/api/super-admin/openrouter-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, updated_by: 'super-admin' })
                });
                const data = await resp.json();

                if (resp.ok && data && data.success) {
                    _setOpenRouterModelStatus(`Saved: ${data.model || model}`, true);
                    showAlert(`‚úÖ OpenRouter model saved: ${data.model || model}`, 'success');
                } else {
                    const err = data?.error || data?.message || `Save failed (HTTP ${resp.status})`;
                    _setOpenRouterModelStatus(err, false);
                    showAlert('‚ùå Failed to save model: ' + err, 'error');
                }
            } catch (e) {
                _setOpenRouterModelStatus(`Save failed: ${e.message || e}`, false);
                showAlert('‚ùå Failed to save model: ' + (e.message || e), 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üíæ Save Model';
                }
            }
        }

        async function useFastestModels() {
            const btn = document.getElementById('useFastestModelsBtn');
            const selectEl = document.getElementById('openrouterModelSelect');
            const model2Select = document.getElementById('racingModel2Select');
            const model3Select = document.getElementById('racingModel3Select');
            const racingCheckbox = document.getElementById('racingEnabledCheckbox');

            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚ö° Setting...';
            }
            _setOpenRouterModelStatus('Setting fastest models‚Ä¶', true);

            try {
                // Proven fastest models for voice calls (low latency + reliable)
                const fastestModels = {
                    model1: 'google/gemini-2.0-flash-exp:free',  // Ultra-fast, free
                    model2: 'openai/gpt-4o-mini',                // Very fast, cheap
                    model3: 'deepseek/deepseek-chat'             // Fast, quality
                };

                // Set main model
                if (selectEl) {
                    selectEl.value = fastestModels.model1;
                }

                // Enable racing and set models
                if (racingCheckbox) {
                    racingCheckbox.checked = true;
                    toggleRacingInputs();
                }
                if (model2Select) {
                    model2Select.value = fastestModels.model2;
                }
                if (model3Select) {
                    model3Select.value = fastestModels.model3;
                }

                // Save main model
                const resp1 = await fetch('/api/super-admin/openrouter-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: fastestModels.model1, updated_by: 'super-admin' })
                });

                // Save racing settings
                const resp2 = await fetch('/api/super-admin/racing-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        racing_enabled: 1,
                        model_2: fastestModels.model2,
                        model_3: fastestModels.model3,
                        updated_by: 'super-admin'
                    })
                });

                if (resp1.ok && resp2.ok) {
                    _setOpenRouterModelStatus('‚úÖ Fastest models configured!', true);
                    showAlert('‚úÖ Fastest models configured! Racing 3 ultra-fast models for <400ms responses.', 'success');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (e) {
                _setOpenRouterModelStatus(`Failed: ${e.message || e}`, false);
                showAlert('‚ùå Failed to set fastest models: ' + (e.message || e), 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '‚ö° Use Fastest Models';
                }
            }
        }

        // ========== Racing Mode Functions ==========
        
        async function loadRacingSettings() {
            try {
                const resp = await fetch('/api/super-admin/racing-settings');
                const data = await resp.json();
                
                if (data && data.success) {
                    const checkbox = document.getElementById('racingEnabledCheckbox');
                    if (checkbox) {
                        checkbox.checked = !!data.racing_enabled;
                        toggleRacingInputs();
                    }
                    
                    // Set selected models (dropdowns already populated by loadOpenRouterModels)
                    const model2Select = document.getElementById('racingModel2Select');
                    const model3Select = document.getElementById('racingModel3Select');
                    if (model2Select && data.model_2) {
                        model2Select.value = data.model_2;
                    }
                    if (model3Select && data.model_3) {
                        model3Select.value = data.model_3;
                    }
                }
            } catch (e) {
                console.error('Error loading racing settings:', e);
            }
        }
        
        async function populateRacingModelDropdowns() {
            try {
                const resp = await fetch('/api/super-admin/openrouter-models');
                const data = await resp.json();
                
                if (!data || !data.success) return;
                
                const models = Array.isArray(data.models) ? data.models : [];
                const model2Select = document.getElementById('racingModel2Select');
                const model3Select = document.getElementById('racingModel3Select');
                
                if (!model2Select || !model3Select) return;
                
                // Clear existing options except "None"
                model2Select.innerHTML = '<option value="">None</option>';
                model3Select.innerHTML = '<option value="">None</option>';
                
                // Add all models
                for (const m of models) {
                    const id = m?.id || '';
                    if (!id) continue;
                    const score = m?.call_latency_score || 5;
                    const priceLabel = m?.pricing_per_million?.label ? ` ‚Äî ${m.pricing_per_million.label}` : '';
                    
                    const opt2 = document.createElement('option');
                    opt2.value = id;
                    opt2.textContent = `‚òÖ${score} ${id}${priceLabel}`;
                    opt2.style.background = '#34495e';
                    opt2.style.color = '#ecf0f1';
                    model2Select.appendChild(opt2);
                    
                    const opt3 = document.createElement('option');
                    opt3.value = id;
                    opt3.textContent = `‚òÖ${score} ${id}${priceLabel}`;
                    opt3.style.background = '#34495e';
                    opt3.style.color = '#ecf0f1';
                    model3Select.appendChild(opt3);
                }
            } catch (e) {
                console.error('Error populating racing model dropdowns:', e);
            }
        }
        
        function toggleRacingInputs() {
            const checkbox = document.getElementById('racingEnabledCheckbox');
            const inputs = document.getElementById('racingModelInputs');
            if (checkbox && inputs) {
                inputs.style.display = checkbox.checked ? 'block' : 'none';
            }
        }
        
        async function saveRacingSettings() {
            const btn = document.getElementById('saveRacingSettingsBtn');
            const checkbox = document.getElementById('racingEnabledCheckbox');
            const model2Select = document.getElementById('racingModel2Select');
            const model3Select = document.getElementById('racingModel3Select');
            const statusEl = document.getElementById('racingStatus');
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'üíæ Saving...';
            }
            
            if (statusEl) statusEl.innerHTML = '<span style="color: #f39c12;">Saving‚Ä¶</span>';
            
            try {
                const racing_enabled = checkbox && checkbox.checked ? 1 : 0;
                const model_2 = model2Select ? (model2Select.value || '').trim() : '';
                const model_3 = model3Select ? (model3Select.value || '').trim() : '';
                
                const resp = await fetch('/api/super-admin/racing-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        racing_enabled,
                        model_2,
                        model_3,
                        updated_by: 'super-admin'
                    })
                });
                
                const data = await resp.json();
                
                if (resp.ok && data && data.success) {
                    if (statusEl) statusEl.innerHTML = '<span style="color: #2ecc71;">‚úÖ Racing settings saved!</span>';
                    showAlert('‚úÖ Racing settings saved!', 'success');
                } else {
                    const err = data?.error || data?.message || `Save failed (HTTP ${resp.status})`;
                    if (statusEl) statusEl.innerHTML = `<span style="color: #e74c3c;">${err}</span>`;
                    showAlert('‚ùå Failed to save racing settings: ' + err, 'error');
                }
            } catch (e) {
                if (statusEl) statusEl.innerHTML = `<span style="color: #e74c3c;">Save failed: ${e.message || e}</span>`;
                showAlert('‚ùå Failed to save racing settings: ' + (e.message || e), 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üíæ Save Racing Settings';
                }
            }
        }

        // ========== Performance Tuning Functions ==========
        
        async function loadPerformanceSettings() {
            try {
                const resp = await fetch('/api/super-admin/performance-settings');
                const data = await resp.json();
                
                if (data && data.success) {
                    document.getElementById('perfHistoryParts').value = data.settings.history_parts || 4;
                    document.getElementById('perfMaxTokens').value = data.settings.max_tokens || 100;
                    document.getElementById('perfMaxMessageChars').value = data.settings.max_message_chars || 300;
                    document.getElementById('perfRequestTimeout').value = data.settings.request_timeout || 8;
                    document.getElementById('perfSystemMaxChars').value = data.settings.system_max_chars || 4000;
                    document.getElementById('perfTotalPromptMaxChars').value = data.settings.total_prompt_max_chars || 6000;
                    
                    updatePerformanceProfile();
                    showCurrentSettings();
                }
            } catch (e) {
                console.error('Failed to load performance settings:', e);
            }
        }

        async function savePerformanceSettings(options = {}) {
            const showToast = (options && Object.prototype.hasOwnProperty.call(options, 'showToast')) ? !!options.showToast : true;
            const timeoutMs = (options && Object.prototype.hasOwnProperty.call(options, 'timeoutMs')) ? Number(options.timeoutMs) : 12000;

            const statusEl = document.getElementById('perfSaveStatus');
            if (statusEl) {
                statusEl.textContent = 'üíæ Saving...';
                statusEl.style.color = '#3498db';
            }
            
            try {
                const settings = {
                    history_parts: parseInt(document.getElementById('perfHistoryParts').value),
                    max_tokens: parseInt(document.getElementById('perfMaxTokens').value),
                    max_message_chars: parseInt(document.getElementById('perfMaxMessageChars').value),
                    request_timeout: parseFloat(document.getElementById('perfRequestTimeout').value),
                    system_max_chars: parseInt(document.getElementById('perfSystemMaxChars').value),
                    total_prompt_max_chars: parseInt(document.getElementById('perfTotalPromptMaxChars').value)
                };

                console.log('Saving performance settings:', settings);

                const controller = new AbortController();
                const actualTimeout = isFinite(timeoutMs) && timeoutMs > 0 ? timeoutMs : 12000;
                const timeoutId = setTimeout(() => {
                    console.warn('Performance settings save timeout reached:', actualTimeout);
                    try { controller.abort(); } catch (_) {}
                }, actualTimeout);

                let resp;
                try {
                    resp = await fetch('/api/super-admin/performance-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings),
                        signal: controller.signal
                    });
                } finally {
                    clearTimeout(timeoutId);
                }

                console.log('Performance settings response status:', resp.status);
                
                const data = await resp.json();
                console.log('Performance settings response data:', data);
                
                if (resp.ok && data && data.success) {
                    if (statusEl) {
                        statusEl.textContent = '‚úÖ Settings saved! Applied to all new calls.';
                        statusEl.style.color = '#27ae60';
                    }
                    if (showToast) {
                        showAlert('‚ö° Performance settings updated successfully!', 'success');
                    }
                    if (typeof updatePerformanceProfile === 'function') updatePerformanceProfile();
                    if (typeof showCurrentSettings === 'function') showCurrentSettings();
                    return true;
                } else {
                    const err = data?.error || `Save failed (HTTP ${resp.status})`;
                    console.error('Performance settings save failed:', err);
                    if (statusEl) {
                        statusEl.textContent = '‚ùå ' + err;
                        statusEl.style.color = '#e74c3c';
                    }
                    if (showToast) {
                        showAlert('‚ùå Failed to save settings: ' + err, 'error');
                    }
                    return false;
                }
            } catch (e) {
                console.error('Performance settings save exception:', e);
                const msg = (e && (e.name === 'AbortError' || String(e.message || '').includes('aborted')))
                    ? `Save timed out after ${Math.round((isFinite(timeoutMs) && timeoutMs > 0 ? timeoutMs : 12000) / 1000)}s. Try again.`
                    : (e.message || String(e));

                if (statusEl) {
                    statusEl.textContent = '‚ùå Save failed: ' + msg;
                    statusEl.style.color = '#e74c3c';
                }
                if (showToast) {
                    showAlert('‚ùå Failed to save settings: ' + msg, 'error');
                }
                return false;
            }
        }

        function applyPerformancePreset(preset) {
            if (preset === 'maximum_speed') {
                document.getElementById('perfHistoryParts').value = 2;
                document.getElementById('perfMaxTokens').value = 60;
                document.getElementById('perfMaxMessageChars').value = 200;
                document.getElementById('perfRequestTimeout').value = 5;
                document.getElementById('perfSystemMaxChars').value = 2000;
                document.getElementById('perfTotalPromptMaxChars').value = 3000;
                showAlert('üöÄ Maximum Speed preset applied! (Save to activate)', 'success');
            } else if (preset === 'balanced') {
                document.getElementById('perfHistoryParts').value = 4;
                document.getElementById('perfMaxTokens').value = 100;
                document.getElementById('perfMaxMessageChars').value = 300;
                document.getElementById('perfRequestTimeout').value = 8;
                document.getElementById('perfSystemMaxChars').value = 4000;
                document.getElementById('perfTotalPromptMaxChars').value = 6000;
                showAlert('‚öñÔ∏è Balanced preset applied! (Save to activate)', 'success');
            } else if (preset === 'maximum_quality') {
                document.getElementById('perfHistoryParts').value = 6;
                document.getElementById('perfMaxTokens').value = 150;
                document.getElementById('perfMaxMessageChars').value = 500;
                document.getElementById('perfRequestTimeout').value = 12;
                document.getElementById('perfSystemMaxChars').value = 6000;
                document.getElementById('perfTotalPromptMaxChars').value = 10000;
                showAlert('üíé Maximum Quality preset applied! (Save to activate)', 'success');
            }
            updatePerformanceProfile();
        }

        function updatePerformanceProfile() {
            const history = parseInt(document.getElementById('perfHistoryParts').value);
            const tokens = parseInt(document.getElementById('perfMaxTokens').value);
            const msgChars = parseInt(document.getElementById('perfMaxMessageChars').value);
            const timeout = parseFloat(document.getElementById('perfRequestTimeout').value);
            
            let speed = 'Unknown';
            let speedColor = '#95a5a6';
            
            // Calculate rough speed estimate
            if (history <= 2 && tokens <= 70 && msgChars <= 250 && timeout <= 6) {
                speed = 'Very Fast (~300-500ms)';
                speedColor = '#27ae60';
            } else if (history <= 4 && tokens <= 100 && msgChars <= 350 && timeout <= 8) {
                speed = 'Fast (~600-1000ms)';
                speedColor = '#3498db';
            } else if (history <= 5 && tokens <= 130 && msgChars <= 450 && timeout <= 10) {
                speed = 'Moderate (~1000-1500ms)';
                speedColor = '#f39c12';
            } else {
                speed = 'Slower (~1500ms+)';
                speedColor = '#e67e22';
            }
            
            const profileEl = document.getElementById('perfCurrentProfile');
            if (profileEl) {
                profileEl.innerHTML = `
                    <div style="color: ${speedColor}; font-weight: 700; font-size: 14px; margin-bottom: 8px;">‚ö° Estimated Speed: ${speed}</div>
                    <div style="opacity: 0.8;">
                        ‚Ä¢ History: ${history} message pairs<br>
                        ‚Ä¢ Max tokens: ${tokens}<br>
                        ‚Ä¢ Message limit: ${msgChars} chars<br>
                        ‚Ä¢ Timeout: ${timeout}s
                    </div>
                `;
            }
        }

        function showCurrentSettings() {
            const container = document.getElementById('perfCurrentSettings');
            if (container) {
                container.style.display = 'block';
            }
        }

        // Store suggestions globally
        let currentPerfSuggestions = null;

        let lastCallFeedback = null;

        function openCallFeedbackModal() {
            const modal = document.getElementById('callFeedbackModal');
            const status = document.getElementById('callFeedbackStatus');
            if (status) status.textContent = '';
            if (modal) modal.style.display = 'flex';
        }

        function closeCallFeedbackModal() {
            const modal = document.getElementById('callFeedbackModal');
            if (modal) modal.style.display = 'none';
        }

        function _getRadioValue(name) {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? (el.value || '') : '';
        }

        async function submitCallFeedbackAndAnalyze() {
            const status = document.getElementById('callFeedbackStatus');
            const btn = document.getElementById('callFeedbackRunBtn');
            const prevText = btn ? btn.textContent : '';

            const talkedOver = _getRadioValue('fb_talked_over');
            const fastEnough = _getRadioValue('fb_fast_enough');
            const gibberish = _getRadioValue('fb_gibberish');
            const disconnected = _getRadioValue('fb_disconnected');

            if (!talkedOver || !fastEnough || !gibberish || !disconnected) {
                if (status) {
                    status.textContent = '‚ö†Ô∏è Please answer the required questions.';
                    status.style.color = '#f39c12';
                }
                return;
            }

            const feedback = {
                talked_over: talkedOver === 'yes',
                response_fast_enough: fastEnough === 'yes',
                gibberish: gibberish === 'yes',
                disconnected: disconnected === 'yes',
            };

            const transferProblem = _getRadioValue('fb_transfer_problem');
            if (transferProblem) feedback.transfer_problem = transferProblem === 'yes';

            const instructionNoncompliance = _getRadioValue('fb_instruction_noncompliance');
            if (instructionNoncompliance) feedback.instruction_noncompliance = instructionNoncompliance === 'yes';

            const notes = (document.getElementById('fb_notes')?.value || '').trim();
            if (notes) feedback.notes = notes;

            lastCallFeedback = feedback;

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ Analyzing...';
                }
                if (status) {
                    status.textContent = 'Analyzing last call (using your answers)‚Ä¶';
                    status.style.color = 'rgba(255,255,255,0.85)';
                }

                const resp = await fetch('/api/super-admin/analyze-last-call-performance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback })
                });
                const data = await resp.json();

                if (!resp.ok || !data || !data.success) {
                    const err = data?.error || `Analysis failed (HTTP ${resp.status})`;
                    if (status) {
                        status.textContent = '‚ùå ' + err;
                        status.style.color = '#e74c3c';
                    }
                    showAlert('‚ùå ' + err, 'error', true);
                    return;
                }

                closeCallFeedbackModal();

                currentPerfSuggestions = data.suggestions;

                clearPerfHighlights();
                const highlights = data.highlights || [];
                highlights.forEach(field => {
                    const el = document.getElementById('perf' + field.charAt(0).toUpperCase() + field.slice(1));
                    if (el && el.parentElement) {
                        el.parentElement.style.background = 'rgba(243, 156, 18, 0.15)';
                        el.parentElement.style.border = '2px solid #f39c12';
                        el.parentElement.style.transition = 'all 0.3s ease';
                    }
                });

                showPerfSuggestionsModal(data);
            } catch (e) {
                const msg = 'Failed to analyze: ' + (e.message || e);
                if (status) {
                    status.textContent = '‚ùå ' + msg;
                    status.style.color = '#e74c3c';
                }
                showAlert('‚ùå ' + msg, 'error', true);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = prevText || '‚ñ∂ Run analysis';
                }
            }
        }

        async function analyzeLastCallPerformance() {
            // New flow: ask quick questions first, then run analysis with answers.
            openCallFeedbackModal();
        }

        function showPerfSuggestionsModal(data) {
            const modal = document.getElementById('perfSuggestionsModal');
            const content = document.getElementById('perfSuggestionsContent');
            
            if (!modal || !content) return;
            
            let html = '';

            // User feedback summary (if provided)
            const fb = data.user_feedback || null;
            if (fb) {
                const yn = (v) => (v === true ? 'Yes' : (v === false ? 'No' : 'Unknown'));
                html += `
                    <div style="background: rgba(155, 89, 182, 0.12); border-left: 4px solid rgba(155, 89, 182, 0.9); padding: 15px; border-radius: 8px; margin-bottom: 18px;">
                        <div style="font-size: 15px; font-weight: 800; margin-bottom: 8px; color: rgba(220, 190, 255, 0.95);">üßæ Your answers</div>
                        <div style="font-size: 13px; opacity: 0.92; display: grid; grid-template-columns: auto 1fr; gap: 8px;">
                            <div><strong>Talked over you:</strong></div><div>${yn(fb.talked_over)}</div>
                            <div><strong>Fast enough:</strong></div><div>${yn(fb.response_fast_enough)}</div>
                            <div><strong>Gibberish:</strong></div><div>${yn(fb.gibberish)}</div>
                            <div><strong>Disconnected:</strong></div><div>${yn(fb.disconnected)}</div>
                        </div>
                        ${fb.notes ? `<div style="margin-top: 10px; font-size: 12px; opacity: 0.9;"><strong>Notes:</strong> ${String(fb.notes).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>` : ''}
                    </div>
                `;
            }
            
            // Call Info Summary
            if (data.call_info) {
                html += `
                    <div style="background: rgba(52, 152, 219, 0.1); border-left: 4px solid #3498db; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #3498db;">üìä Call Summary</div>
                        <div style="font-size: 13px; opacity: 0.9; display: grid; grid-template-columns: auto 1fr; gap: 8px;">
                            <div><strong>Duration:</strong></div><div>${data.call_info.duration || 'N/A'}</div>
                            <div><strong>Response Time:</strong></div><div>${data.call_info.avg_response_time || 'N/A'}</div>
                            <div><strong>Model:</strong></div><div>${data.call_info.model || 'N/A'}</div>
                        </div>
                    </div>
                `;
            }
            
            // Issues Detected
            const issues = data.issues || [];
            if (issues.length > 0) {
                html += `<div style="font-size: 18px; font-weight: 700; margin-bottom: 15px; color: #e74c3c;">‚ö†Ô∏è Issues Detected (${issues.length})</div>`;
                
                issues.forEach((issue, idx) => {
                    const severityColors = {
                        critical: '#e74c3c',
                        high: '#e67e22',
                        medium: '#f39c12',
                        low: '#3498db'
                    };
                    const color = severityColors[issue.severity] || '#95a5a6';
                    
                    html += `
                        <div style="background: rgba(0, 0, 0, 0.2); border-left: 4px solid ${color}; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 15px; font-weight: 700; color: ${color}; margin-bottom: 6px;">
                                        ${issue.icon || '‚ö†Ô∏è'} ${issue.title}
                                    </div>
                                    <div style="font-size: 13px; opacity: 0.85; margin-bottom: 8px;">${issue.description}</div>
                                </div>
                            </div>
                    `;
                    
                    // Show affected settings with individual apply buttons
                    if (issue.settings && Object.keys(issue.settings).length > 0) {
                        html += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">`;
                        html += `<div style="font-size: 12px; font-weight: 700; margin-bottom: 8px; opacity: 0.7;">üí° Recommended Fix:</div>`;
                        
                        for (const [key, value] of Object.entries(issue.settings)) {
                            const currentEl = document.getElementById('perf' + key.charAt(0).toUpperCase() + key.slice(1));
                            const currentValue = currentEl ? currentEl.value : 'N/A';
                            const settingLabels = {
                                historyParts: 'History',
                                maxTokens: 'Max Tokens',
                                maxMessageChars: 'Msg Chars',
                                requestTimeout: 'Timeout',
                                systemMaxChars: 'System Chars',
                                totalPromptMaxChars: 'Total Chars'
                            };
                            const label = settingLabels[key] || key;
                            
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                                    <div style="font-size: 12px;">
                                        <strong>${label}:</strong> ${currentValue} ‚Üí <span style="color: #2ecc71;">${value}</span>
                                    </div>
                                    <button onclick="applySingleSetting('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})" 
                                            class="btn" style="padding: 4px 12px; font-size: 11px; background: linear-gradient(135deg, #2ecc71, #27ae60);">
                                        Apply
                                    </button>
                                </div>
                            `;
                        }
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            // Performance Suggestions
            const suggestions = data.suggestions || {};
            if (Object.keys(suggestions).length > 0) {
                html += `<div style="font-size: 18px; font-weight: 700; margin: 20px 0 15px 0; color: #2ecc71;">‚úÖ General Optimizations</div>`;
                
                const settingLabels = {
                    historyParts: 'üí¨ Conversation History',
                    maxTokens: 'üé§ Max Response Length',
                    maxMessageChars: '‚úÇÔ∏è Message Character Limit',
                    requestTimeout: '‚è±Ô∏è Request Timeout',
                    systemMaxChars: 'üìã System Instructions Limit',
                    totalPromptMaxChars: 'üìù Total Prompt Limit'
                };
                
                for (const [key, value] of Object.entries(suggestions)) {
                    const label = settingLabels[key] || key;
                    const currentEl = document.getElementById('perf' + key.charAt(0).toUpperCase() + key.slice(1));
                    const currentValue = currentEl ? currentEl.value : 'N/A';
                    
                    html += `
                        <div style="background: rgba(46, 204, 113, 0.1); border: 1px solid #2ecc71; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; font-weight: 700; margin-bottom: 4px; color: #2ecc71;">${label}</div>
                                <div style="font-size: 12px; opacity: 0.8;">
                                    Current: <strong>${currentValue}</strong> ‚Üí Suggested: <strong style="color: #2ecc71;">${value}</strong>
                                </div>
                            </div>
                            <button onclick="applySingleSetting('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})" 
                                    class="btn" style="padding: 8px 16px; font-size: 12px; background: linear-gradient(135deg, #2ecc71, #27ae60);">
                                Apply
                            </button>
                        </div>
                    `;
                }
            }
            
            // No issues found
            if (issues.length === 0 && Object.keys(suggestions).length === 0) {
                html += `
                    <div style="background: rgba(46, 204, 113, 0.1); border-left: 4px solid #2ecc71; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <div style="font-size: 16px; font-weight: 700; color: #2ecc71; margin-bottom: 8px;">Excellent Performance!</div>
                        <div style="font-size: 13px; opacity: 0.9;">No issues detected. Your current settings are working well for this type of call.</div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closePerfSuggestionsModal() {
            const modal = document.getElementById('perfSuggestionsModal');
            if (modal) {
                modal.style.display = 'none';
            }
            clearPerfHighlights();
        }

        function clearPerfHighlights() {
            const fields = ['historyParts', 'maxTokens', 'maxMessageChars', 'requestTimeout', 'systemMaxChars', 'totalPromptMaxChars'];
            fields.forEach(field => {
                const el = document.getElementById('perf' + field.charAt(0).toUpperCase() + field.slice(1));
                if (el && el.parentElement) {
                    el.parentElement.style.background = '';
                    el.parentElement.style.border = '';
                }
            });
        }

        async function applySingleSetting(settingKey, value) {
            const elementId = 'perf' + settingKey.charAt(0).toUpperCase() + settingKey.slice(1);
            const element = document.getElementById(elementId);
            
            if (element) {
                element.value = value;
                
                // Save the setting
                const ok = await savePerformanceSettings({ showToast: false });
                if (ok) {
                    showAlert('‚úÖ Applied: ' + settingKey, 'success', true);
                } else {
                    showAlert('‚ùå Failed to apply setting: ' + settingKey, 'error', true);
                }
            }
        }

        async function applyPerfSuggestions() {
            if (!currentPerfSuggestions) return;

            const btn = document.getElementById('applyPerfSuggestionsBtn');
            const statusEl = document.getElementById('perfSuggestionsApplyStatus');
            const prevText = btn ? btn.textContent : '';

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ Applying...';
                }
                if (statusEl) {
                    statusEl.textContent = 'Applying recommendations and saving‚Ä¶';
                    statusEl.style.color = 'rgba(255, 255, 255, 0.85)';
                }

                for (const [key, value] of Object.entries(currentPerfSuggestions)) {
                    const el = document.getElementById('perf' + key.charAt(0).toUpperCase() + key.slice(1));
                    if (el) {
                        el.value = value;
                    }
                }

                const ok = await savePerformanceSettings({ showToast: false, timeoutMs: 20000 });
                if (ok) {
                    if (statusEl) {
                        statusEl.textContent = '‚úÖ Applied and saved.';
                        statusEl.style.color = '#2ecc71';
                    }
                    showAlert('‚úÖ All recommendations applied and saved.', 'success', true);
                    setTimeout(() => {
                        closePerfSuggestionsModal();
                        if (statusEl) statusEl.textContent = '';
                    }, 650);
                } else {
                    if (statusEl) {
                        statusEl.textContent = '‚ùå Failed to save. Nothing confirmed as applied.';
                        statusEl.style.color = '#e74c3c';
                    }
                    showAlert('‚ùå Failed to apply recommendations (save failed).', 'error', true);
                }
            } catch (e) {
                console.error('Error applying recommendations:', e);
                if (statusEl) {
                    statusEl.textContent = '‚ùå Error: ' + (e.message || String(e));
                    statusEl.style.color = '#e74c3c';
                }
                showAlert('‚ùå Error applying recommendations: ' + (e.message || String(e)), 'error', true);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = prevText || '‚úÖ Apply All Recommendations';
                }
            }
        }

        // Track last known webhook URLs to detect changes
        let lastKnownWebhookUrls = {
            answer: null,
            event: null
        };

        async function updateTunnelStatus() {
            try {
                const resp = await fetch('/api/admin/ngrok-status');
                const data = await resp.json();
                
                const statusEl = document.getElementById('tunnelStatus');
                const urlEl = document.getElementById('tunnelUrl');
                const urlDisplay = document.getElementById('tunnelUrlDisplay');
                const startBtn = document.getElementById('startTunnelBtn');
                const stopBtn = document.getElementById('stopTunnelBtn');
                
                if (data.running) {
                    statusEl.style.background = 'rgba(46, 204, 113, 0.2)';
                    statusEl.style.color = '#2ecc71';
                    statusEl.textContent = 'Running';

                    const preferredUrl = _getPreferredPublicUrl(data);
                    urlEl.textContent = preferredUrl || data.url || 'Unknown';
                    urlDisplay.style.display = 'block';
                    
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                    
                    // Update webhook URLs and check for changes
                    updateWebhookUrls(preferredUrl || data.url);
                } else {
                    statusEl.style.background = 'rgba(231, 76, 60, 0.2)';
                    statusEl.style.color = '#e74c3c';
                    statusEl.textContent = 'Not Running';
                    
                    urlDisplay.style.display = 'none';
                    
                    startBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to update tunnel status:', e);
            }
        }

        function updateWebhookUrls(publicUrl, skipChangeDetection = false) {
            if (!publicUrl || publicUrl === 'Unknown') return;
            
            const answerUrl = `${publicUrl}/webhooks/answer`;
            const eventUrl = `${publicUrl}/webhooks/events`;
            
            // Update display
            const answerEl = document.getElementById('vonageAnswerUrl');
            const eventEl = document.getElementById('vonageEventUrl');
            
            if (answerEl) answerEl.textContent = answerUrl;
            if (eventEl) eventEl.textContent = eventUrl;
            
            // Check if URLs have changed (only if not initial load)
            const hasChanged = !skipChangeDetection && (
                lastKnownWebhookUrls.answer !== null &&
                (lastKnownWebhookUrls.answer !== answerUrl || lastKnownWebhookUrls.event !== eventUrl)
            );
            
            if (hasChanged) {
                showWebhookChangeAlert(answerUrl, eventUrl);
            }
            
            // Update tracking
            lastKnownWebhookUrls.answer = answerUrl;
            lastKnownWebhookUrls.event = eventUrl;
        }

        function showWebhookChangeAlert(answerUrl, eventUrl) {
            const alertHtml = `
                <div style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.95) 0%, rgba(230, 126, 34, 0.95) 100%); 
                            color: white; padding: 20px; border-radius: 12px; max-width: 600px; 
                            box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">‚ö†Ô∏è Webhook URLs Changed!</div>
                    <div style="font-size: 14px; margin-bottom: 15px; line-height: 1.5;">
                        Your tunnel URL has changed. Update these URLs in your <strong>Vonage Dashboard</strong>:
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">Answer URL (HTTP POST):</div>
                        <code style="display: block; font-size: 12px; word-break: break-all; font-family: 'Courier New', monospace;">${answerUrl}</code>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">Event URL (HTTP POST):</div>
                        <code style="display: block; font-size: 12px; word-break: break-all; font-family: 'Courier New', monospace;">${eventUrl}</code>
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        üí° Go to: <strong>Vonage Dashboard ‚Üí Your Application ‚Üí Edit Settings</strong>
                    </div>
                </div>
            `;
            showAlert(alertHtml, 'warning', 15000);  // Show for 15 seconds
        }

        async function viewServerLogs() {
            showAlert('üìã Fetching recent logs...', 'info');
            try {
                const resp = await fetch('/api/admin/recent-logs');
                const data = await resp.json();
                if (data.success) {
                    const logHtml = `
                        <div style="background: #000; color: #0f0; padding: 15px; border-radius: 8px; 
                                    font-family: monospace; font-size: 11px; max-height: 400px; 
                                    overflow-y: auto; text-align: left; white-space: pre-wrap;">
${data.logs}
                        </div>
                    `;
                    showAlert(logHtml, 'info');
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Failed to fetch logs: ' + e.message, 'error');
            }
        }

        // ========== VONAGE NUMBER MANAGEMENT ==========

        async function syncVonageNumbers() {
            showAlert('üîÑ Syncing numbers from Vonage...', 'info');
            try {
                const resp = await fetch('/api/sync-vonage-numbers', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                    // Auto-refresh after sync
                    setTimeout(() => loadVonageNumbers(), 1000);
                } else {
                    showAlert(`‚ö†Ô∏è Sync failed: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Sync error: ' + e.message, 'error');
            }
        }

        async function loadVonageNumbers() {
            const container = document.getElementById('numbersContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.6;"><div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div><div>Loading numbers...</div></div>';

            try {
                const resp = await fetch('/api/owned-numbers');
                const data = await resp.json();
                
                if (!data.success) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #e74c3c;"><div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div><div>${data.error}</div></div>`;
                    return;
                }

                const numbers = data.numbers || [];
                
                if (numbers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; opacity: 0.6;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                            <div>No Vonage numbers found.</div>
                            <div style="margin-top: 10px; font-size: 13px;">Purchase numbers from your Vonage dashboard.</div>
                        </div>
                    `;
                    return;
                }

                // Count available vs assigned
                const availableCount = numbers.filter(n => n.available).length;
                const assignedCount = numbers.length - availableCount;

                let html = `
                    <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">üìä Number Overview</div>
                        <div style="display: flex; justify-content: center; gap: 30px; font-size: 14px;">
                            <div><strong>Total:</strong> ${numbers.length}</div>
                            <div style="color: #27ae60;"><strong>Available:</strong> ${availableCount}</div>
                            <div style="color: #e67e22;"><strong>Assigned:</strong> ${assignedCount}</div>
                        </div>
                    </div>
                `;

                // Display each number
                numbers.forEach(number => {
                    const isAvailable = number.available;
                    const borderColor = isAvailable ? '#27ae60' : '#e67e22';
                    const statusBg = isAvailable ? '#27ae60' : '#e67e22';
                    const statusText = isAvailable ? '‚úÖ AVAILABLE' : `üë§ ${number.assigned_to || 'Unavailable'}`;

                    html += `
                        <div style="background: linear-gradient(135deg, #2c3e50, #34495e); 
                                    padding: 20px; border-radius: 8px; margin-bottom: 15px;
                                    border-left: 4px solid ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                                        üìû ${number.number}
                                    </div>
                                    <div style="font-size: 13px; opacity: 0.7;">
                                        ${number.country || 'Unknown'} ‚Ä¢ ${number.type || 'Unknown Type'}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <div style="background: ${statusBg}; color: white; padding: 8px 15px; 
                                                border-radius: 20px; font-size: 13px; font-weight: bold;">
                                        ${statusText}
                                    </div>
                                    ${generateNumberActionButton(number)}
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #e74c3c;"><div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div><div>Error: ${e.message}</div></div>`;
            }
        }

        function generateNumberActionButton(number) {
            if (number.available) {
                // Available number - option to make unavailable
                return `
                    <button onclick="toggleNumberAvailability('${number.number}', false)" 
                            style="background: linear-gradient(135deg, #e74c3c, #c0392b); 
                                   color: white; border: none; padding: 8px 15px; 
                                   border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        üîí Make Unavailable
                    </button>
                `;
            } else if (number.assigned_to && number.user_id) {
                // Assigned to a user - option to deassign
                return `
                    <button onclick="deassignNumber('${number.number}', ${number.user_id})" 
                            style="background: linear-gradient(135deg, #e67e22, #d35400); 
                                   color: white; border: none; padding: 8px 15px; 
                                   border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        ‚ùå Deassign
                    </button>
                `;
            } else {
                // Manually made unavailable - option to make available
                return `
                    <button onclick="toggleNumberAvailability('${number.number}', true)" 
                            style="background: linear-gradient(135deg, #27ae60, #229954); 
                                   color: white; border: none; padding: 8px 15px; 
                                   border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        üîì Make Available
                    </button>
                `;
            }
        }

        async function toggleNumberAvailability(phoneNumber, makeAvailable) {
            const action = makeAvailable ? 'available' : 'unavailable';
            if (!confirm(`Make ${phoneNumber} ${action}?`)) return;

            showAlert(`üîÑ Updating ${phoneNumber}...`, 'info');
            
            try {
                const resp = await fetch('/api/toggle-number-availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone_number: phoneNumber,
                        available: makeAvailable
                    })
                });
                
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${phoneNumber} is now ${action}`, 'success');
                    loadVonageNumbers(); // Refresh list
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Update failed: ' + e.message, 'error');
            }
        }

        async function deassignNumber(phoneNumber, userId) {
            if (!confirm(`Deassign ${phoneNumber} from this user? The number will become available for reassignment.`)) return;

            showAlert(`üîÑ Deassigning ${phoneNumber}...`, 'info');
            
            try {
                const resp = await fetch('/api/deassign-number', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone_number: phoneNumber,
                        user_id: userId
                    })
                });
                
                const data = await resp.json();
                if (data.success) {
                    showAlert(`‚úÖ ${phoneNumber} has been deassigned`, 'success');
                    loadVonageNumbers(); // Refresh list
                } else {
                    showAlert(`‚ö†Ô∏è ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Deassign failed: ' + e.message, 'error');
            }
        }

        // Update logout to stop health monitoring
        const originalLogout = logout;
        logout = function() {
            stopHealthMonitoring();
            originalLogout();
        };

        // Global Instructions Modal Functions
        function openInstructionsModal() {
            document.getElementById('instructionsModal').classList.add('show');
        }

        function closeInstructionsModal(event) {
            if (event && event.target.classList.contains('instructions-modal-content')) {
                return; // Don't close if clicking inside modal
            }
            document.getElementById('instructionsModal').classList.remove('show');
        }

        // Make Streaming Status Box Draggable
        function makeStreamingStatusDraggable() {
            const box = document.getElementById('streamingStatus');
            if (!box) {
                console.log('Streaming status box not found');
                return;
            }

            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;

            function dragStart(e) {
                // Get the current transform values
                const style = window.getComputedStyle(box);
                const matrix = new DOMMatrixReadOnly(style.transform);
                currentX = matrix.m41;
                currentY = matrix.m42;

                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
                isDragging = true;

                box.style.cursor = 'grabbing';
                e.preventDefault();
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    box.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
                box.style.cursor = 'move';
            }

            // Remove old listeners if any
            box.removeEventListener('mousedown', dragStart);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', dragEnd);

            // Add new listeners
            box.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            console.log('Streaming status box is now draggable');
        }

        // Don't initialize on timeout, let updateStreamingStatus do it
        // setTimeout(makeStreamingStatusDraggable, 1000);

        // ========== CONSOLE DIAGNOSTICS ==========
        
        // Store console logs
        let consoleLogs = [];
        let consoleErrors = [];

        // Override console methods to capture logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleInfo = console.info;

        console.log = function(...args) {
            captureLog('log', args);
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            captureLog('error', args);
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            captureLog('warn', args);
            originalConsoleWarn.apply(console, args);
        };

        console.info = function(...args) {
            captureLog('info', args);
            originalConsoleInfo.apply(console, args);
        };

        // Capture window errors
        window.addEventListener('error', (event) => {
            captureLog('error', [`${event.message} at ${event.filename}:${event.lineno}:${event.colno}`]);
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            captureLog('error', [`Unhandled Promise Rejection: ${event.reason}`]);
        });

        function captureLog(type, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            const logEntry = {
                type,
                timestamp,
                message
            };

            consoleLogs.push(logEntry);
            if (type === 'error') {
                consoleErrors.push(logEntry);
            }

            // Keep only last 100 logs
            if (consoleLogs.length > 100) {
                consoleLogs.shift();
            }

            // Update diagnostics modal if open
            updateDiagnosticsDisplay();
        }

        function openDiagnostics() {
            document.getElementById('diagnosticsModal').classList.add('show');
            updateDiagnosticsDisplay();
        }

        function closeDiagnosticsModal(event) {
            if (event && event.target.classList.contains('diagnostics-modal-content')) {
                return;
            }
            document.getElementById('diagnosticsModal').classList.remove('show');
            // Hide analysis when closing
            document.getElementById('errorAnalysis').classList.remove('show');
        }

        function updateDiagnosticsDisplay() {
            const logsContainer = document.getElementById('consoleLogs');
            const logCount = document.getElementById('logCount');
            const errorCount = document.getElementById('errorCount');
            const analyzeBtn = document.getElementById('analyzeBtn');

            if (!logsContainer) return;

            logCount.textContent = consoleLogs.length;
            errorCount.textContent = consoleErrors.length;

            // Enable/disable analyze button
            analyzeBtn.disabled = consoleErrors.length === 0;

            if (consoleLogs.length === 0) {
                logsContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No logs captured yet...</div>';
                return;
            }

            // Display last 50 logs (most recent first)
            const recentLogs = consoleLogs.slice(-50).reverse();
            logsContainer.innerHTML = recentLogs.map(log => `
                <div class="console-log-entry ${log.type}">
                    <span class="console-log-timestamp">[${log.timestamp}]</span>
                    <span>[${log.type.toUpperCase()}]</span>
                    ${log.message}
                </div>
            `).join('');
        }

        function clearConsoleLogs() {
            if (!confirm('Clear all console logs?')) return;
            consoleLogs = [];
            consoleErrors = [];
            document.getElementById('errorAnalysis').classList.remove('show');
            updateDiagnosticsDisplay();
            showAlert('Console logs cleared', 'success');
        }

        async function analyzeErrors() {
            if (consoleErrors.length === 0) {
                showAlert('No errors to analyze', 'error');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const errorAnalysis = document.getElementById('errorAnalysis');
            const analysisContent = document.getElementById('analysisContent');

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '‚è≥ Analyzing...';
            errorAnalysis.classList.add('show');
            analysisContent.textContent = 'Analyzing errors with DeepSeek AI...';

            try {
                // Prepare error summary
                const errorSummary = consoleErrors.map(err => 
                    `[${err.timestamp}] ${err.message}`
                ).join('\n\n');

                const response = await fetch('/api/analyze-errors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        errors: errorSummary,
                        context: {
                            page: 'Super Admin Dashboard',
                            timestamp: new Date().toISOString(),
                            errorCount: consoleErrors.length
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    analysisContent.textContent = data.analysis;
                    showAlert('‚úÖ Error analysis complete!', 'success');
                } else {
                    analysisContent.textContent = `Analysis failed: ${data.error}`;
                    showAlert('‚ùå Analysis failed: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error analyzing:', error);
                analysisContent.textContent = `Failed to analyze errors: ${error.message}`;
                showAlert('‚ùå Analysis request failed', 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ü§ñ Analyze Errors';
            }
        }

        function copyAnalysisToClipboard() {
            const analysisContent = document.getElementById('analysisContent').textContent;
            
            navigator.clipboard.writeText(analysisContent).then(() => {
                showAlert('‚úÖ Analysis copied to clipboard!', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = analysisContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('‚úÖ Analysis copied to clipboard!', 'success');
            });
        }

        // Log page load
        console.log('Super Admin Dashboard loaded successfully');
    </script>
