<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - VoiceAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f23;
            color: #ffffff;
            overflow-x: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 36px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-info-name {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .user-info-phone {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .header-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-home {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-home:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .main-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 50px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #fff 0%, #e0c3fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Welcome Modal */
        .welcome-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .welcome-modal {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 24px;
            padding: 45px;
            max-width: 550px;
            width: 90%;
            text-align: center;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-icon {
            font-size: 72px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff 0%, #e0c3fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.75);
            margin-bottom: 35px;
            line-height: 1.5;
        }

        .progress-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 12px;
        }

        .progress-bar-bg {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
        }

        .progress-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 10px;
            min-height: 20px;
        }

        .tabs-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #fff;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes flashYellow {
            0%, 100% { background-color: rgba(255, 255, 255, 0.05); }
            50% { background-color: rgba(255, 220, 0, 0.4); box-shadow: 0 0 20px rgba(255, 220, 0, 0.6); }
        }

        /* Custom scrollbar for billing modal */
        #billingCallListContainer::-webkit-scrollbar {
            width: 20px;
        }

        #billingCallListContainer::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 0;
        }

        #billingCallListContainer::-webkit-scrollbar-thumb {
            background: #f39c12;
            border-radius: 10px;
            border: 4px solid #1a1a2e;
        }

        #billingCallListContainer::-webkit-scrollbar-thumb:hover {
            background: #e67e22;
        }

        #billingCallListContainer::-webkit-scrollbar-button {
            background: #2a2a3e;
            height: 30px;
            border-radius: 0;
            display: block;
            border: 2px solid #f39c12;
        }

        #billingCallListContainer::-webkit-scrollbar-button:hover {
            background: #f39c12;
        }

        #billingCallListContainer::-webkit-scrollbar-button:vertical:decrement {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="%23f39c12"><path d="M10 6l-8 8h16z"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 14px;
        }

        #billingCallListContainer::-webkit-scrollbar-button:vertical:increment {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="%23f39c12"><path d="M10 14l8-8H2z"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 14px;
        }

        #billingCallListContainer::-webkit-scrollbar-button:hover:vertical:decrement {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="%23ffffff"><path d="M10 6l-8 8h16z"/></svg>');
        }

        #billingCallListContainer::-webkit-scrollbar-button:hover:vertical:increment {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="%23ffffff"><path d="M10 14l8-8H2z"/></svg>');
        }

        /* Firefox scrollbar */
        #billingCallListContainer {
            scrollbar-width: auto;
            scrollbar-color: #f39c12 #1a1a2e;
        }

        .sidebar-nav-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: white !important;
        }

        .sidebar-nav-btn.active {
            background: rgba(102, 126, 234, 0.2);
            color: white !important;
            border-left-color: #667eea !important;
        }

        .main-tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .example-box {
            margin-top: 12px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            border-radius: 8px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 15px 40px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }

        .call-log {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .call-log:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .call-log.completed {
            opacity: 0.6;
            border-left-color: #4ade80;
        }

        .call-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .call-number {
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .call-duration {
            background: rgba(102, 126, 234, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .call-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .call-summary {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .call-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-complete {
            background: #4ade80;
            color: #0f0f23;
        }

        .btn-complete:hover {
            background: #22c55e;
            transform: translateY(-2px);
        }

        .btn-complete:disabled {
            background: rgba(74, 222, 128, 0.3);
            cursor: not-allowed;
            transform: none;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .no-calls {
            text-align: center;
            padding: 60px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
        }

        .message {
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: rgba(74, 222, 128, 0.2);
            border: 2px solid #4ade80;
            color: #4ade80;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .diagnostic-card {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .diagnostic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .diagnostic-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-ok {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-error {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 20px;
            }

            .admin-header {
                padding: 20px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-content {
                padding: 20px;
            }

            .call-log-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Bundle Toggle Styles */
        input[type="checkbox"]:checked ~ .bundle-toggle-slider {
            background-color: #2ed573 !important;
            border-color: #2ed573 !important;
        }

        input[type="checkbox"]:checked ~ .bundle-toggle-knob {
            transform: translateX(34px) !important;
        }
        
        .bundle-toggle-knob {
            transition: transform 0.4s !important;
        }
    </style>
</head>
<body>
    <!-- Billing Modal -->
    <div id="billingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%); border-radius: 20px; width: 90%; max-width: 1000px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 2px solid rgba(243, 156, 18, 0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 30px 40px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="font-size: 28px; font-weight: 800; margin: 0; color: white;">üí∞ Billing & Call History</h2>
                    <p style="font-size: 14px; color: rgba(255,255,255,0.9); margin: 5px 0 0 0;">All calls and charges for your account</p>
                </div>
                <button onclick="closeBillingModal()" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
            </div>

            <!-- Balance Summary -->
            <div style="padding: 25px 40px; background: rgba(243, 156, 18, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Current Balance</div>
                        <div style="font-size: 32px; font-weight: 900; color: #f39c12;" id="modalCurrentBalance">--</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 3px;">Available Credits</div>
                    </div>
                    <div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Total Used</div>
                        <div style="font-size: 32px; font-weight: 900; color: #e74c3c;" id="modalTotalUsed">--</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 3px;">Credits Spent</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Total Calls</div>
                        <div style="font-size: 32px; font-weight: 900; color: #667eea;" id="modalTotalCalls">--</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 3px;">Call Records</div>
                    </div>
                </div>
            </div>

            <!-- Call List -->
            <div id="billingCallListContainer" style="padding: 30px 40px 30px 30px; height: 350px; overflow-y: scroll; overflow-x: hidden; background: rgba(0,0,0,0.3);">
                <h3 style="font-size: 18px; font-weight: 700; color: white; margin: 0 0 20px 0;">üìû Call Records</h3>
                <div id="billingCallList">
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.4);">
                        Loading call records...
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 20px 40px; background: rgba(255,255,255,0.02); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 12px; color: rgba(255,255,255,0.5);">
                    Pricing: <span style="color: #667eea; font-weight: 600;" id="modalPricePerCall">--</span> credits/call + <span style="color: #2ecc71; font-weight: 600;" id="modalPricePerMinute">--</span> credits/minute
                </div>
                <button onclick="closeBillingModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Close</button>
            </div>
        </div>
    </div>

    <!-- Credit Breakdown Popup -->
    <div id="creditBreakdownPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20000; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%); border-radius: 16px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 2px solid #f39c12; min-width: 400px;">
        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 20px 25px; border-radius: 14px 14px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 800; color: white;">üí≥ Credit Calculation</h3>
            <button onclick="closeBreakdownPopup()" style="background: rgba(255,255,255,0.2); border: none; width: 30px; height: 30px; border-radius: 50%; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
        </div>
        <div style="padding: 25px;">
            <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Call Details</div>
                <div style="font-size: 16px; color: white; font-weight: 600;" id="breakdownCallDetails">--</div>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tbody id="breakdownCharges">
                        <!-- Charges will be inserted here dynamically -->
                    </tbody>
                    <tfoot>
                        <tr style="border-top: 2px solid rgba(255,255,255,0.2);">
                            <td style="padding: 12px 0 0 0; font-size: 16px; color: white; font-weight: 700;">üí∞ Total Credits</td>
                            <td style="padding: 12px 0 0 0; font-size: 22px; font-weight: 900; color: #e74c3c; text-align: right;" id="breakdownTotal">--</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <button onclick="closeBreakdownPopup()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">Close</button>
        </div>
    </div>

    <!-- Sidebar -->
    <div style="position: fixed; left: 0; top: 0; bottom: 0; width: 280px; background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1e 100%); border-right: 1px solid rgba(102, 126, 234, 0.2); display: flex; flex-direction: column; z-index: 1000; box-shadow: 4px 0 20px rgba(0,0,0,0.3);">
        <!-- Logo -->
        <div style="padding: 30px 25px; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">ü§ñ</div>
                <div>
                    <div style="font-size: 20px; font-weight: 800; color: white;">Hi Julie</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 500;">AI Voice Assistant</div>
                </div>
            </div>
            
            <!-- Trial Days Progress Bar -->
            <div id="trialContainer" style="margin-top: 20px; display: block;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">Free Trial</div>
                    <div id="trialDaysText" style="font-size: 13px; font-weight: 800; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Loading‚Ä¶</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; overflow: hidden; position: relative;">
                    <div id="trialProgressBar" style="height: 100%; width: 100%; background: linear-gradient(90deg, #FFD700 0%, #FFA500 50%, #FF6B6B 100%); border-radius: 10px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);"></div>
                </div>
                <div style="margin-top: 6px; font-size: 10px; color: rgba(255,255,255,0.4); text-align: center;" id="trialSubtext">Upgrade anytime to unlock full features</div>
            </div>
        </div>

        <!-- Navigation -->
        <div style="flex: 1; overflow-y: auto; padding: 20px 0;">
            <div style="padding: 0 25px; margin-bottom: 15px;">
                <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px;">Menu</div>
            </div>
            <button class="sidebar-nav-btn active" data-tab="dashboard" onclick="switchMainTab('dashboard')" style="width: 100%; background: none; border: none; padding: 14px 25px; color: white; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="sidebar-nav-btn" data-tab="calls" onclick="switchMainTab('calls')" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">üìû</span>
                <span>Calls</span>
            </button>
            <button class="sidebar-nav-btn" data-tab="config" onclick="switchMainTab('config')" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">‚öôÔ∏è</span>
                <span>Configuration</span>
            </button>
            <button class="sidebar-nav-btn" onclick="openTasksModal()" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">‚úÖ</span>
                <span>Tasks</span>
                <span id="incompleteTaskCount" style="margin-left: auto; background: rgba(102,126,234,0.3); color: rgba(255,255,255,0.9); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 700; display: none;"></span>
            </button>
            <button class="sidebar-nav-btn" onclick="openCalendarModal()" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">üìÖ</span>
                <span>Calendar</span>
            </button>
            <button class="sidebar-nav-btn" onclick="openBillingModal()" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">üí∞</span>
                <span>Billing</span>
            </button>
            <button class="sidebar-nav-btn" onclick="openBundlesModal()" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent;">
                <span style="font-size: 20px;">üì¶</span>
                <span>Bundles</span>
            </button>
            <a href="/pricing" class="sidebar-nav-btn" style="width: 100%; background: none; border: none; padding: 14px 25px; color: rgba(255,255,255,0.6); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent; text-decoration: none;">
                <span style="font-size: 20px;">üíé</span>
                <span>Pricing</span>
            </a>
        </div>

        <!-- User Profile -->
        <div style="padding: 20px 25px; border-top: 1px solid rgba(102, 126, 234, 0.2);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;">üë§</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 14px; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="userName">Loading...</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="userPhone">Loading...</div>
                </div>
            </div>
            <button onclick="logout()" style="width: 100%; background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.4); padding: 10px; border-radius: 8px; color: white; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                üö™ Logout
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div style="margin-left: 280px; min-height: 100vh; background: #0f0f23;">
        <!-- New Account Button (Top Right) -->
        <div style="position: fixed; top: 20px; right: 30px; z-index: 500; display: flex; gap: 10px; align-items: center;">
            <button id="reduceTrialBtn" onclick="reduceTrialDay()" style="padding: 8px 16px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 12px; font-weight: 700; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; display: inline-flex; align-items: center;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="Test: Reduce trial by 1 day">
                ‚è±Ô∏è -1 Day
            </button>
            <button onclick="startNewAccountSetup()" style="padding: 8px 16px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 12px; font-weight: 700; box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ‚ú® New Account
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="main-tab-content" style="display: block;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 50px 50px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative; overflow: hidden;">
                <!-- Animated background decoration -->
                <div style="position: absolute; top: -50%; right: -5%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%; animation: float 6s ease-in-out infinite;"></div>
                <div style="position: absolute; bottom: -30%; left: -5%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); border-radius: 50%; animation: float 8s ease-in-out infinite reverse;"></div>
                
                <div style="position: relative; z-index: 1;">
                    <h1 style="font-size: 42px; font-weight: 900; margin-bottom: 12px; text-shadow: 0 2px 20px rgba(0,0,0,0.2);">‚ú® Your Dashboard</h1>
                    <p style="font-size: 16px; color: rgba(255,255,255,0.95); font-weight: 500;">Everything you need at a glance</p>
                </div>
            </div>

            <div style="padding: 35px 40px;">
                <!-- Stats Grid - Compact 5-column layout -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
                    <!-- Your Phone Number Card -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 30px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(102, 126, 234, 0.3)'">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 60px; opacity: 0.15;">üìû</div>
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Your Phone Number</div>
                            <div style="font-size: 20px; font-weight: 800; color: white; margin-bottom: 8px;" id="statsPhoneNumber">--</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6);">Customer calls here</div>
                        </div>
                    </div>

                    <!-- Account Manager Card -->
                    <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 30px rgba(37, 211, 102, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(37, 211, 102, 0.3)'">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 60px; opacity: 0.15;">üí¨</div>
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Account Manager</div>
                            <div style="font-size: 16px; font-weight: 800; color: white; margin-bottom: 10px;" id="statsAccountManager">Support Team</div>
                            <a href="https://wa.me/447595289669" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.95); color: #128C7E; padding: 8px 14px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                <span>WhatsApp</span>
                            </a>
                        </div>
                    </div>

                    <!-- Calls Today Card -->
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 16px; padding: 20px; border: 2px solid rgba(102, 126, 234, 0.3); position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer;" onclick="viewTodayCalls()" onmouseover="this.style.borderColor='rgba(102, 126, 234, 0.5)'; this.style.background='linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%)'" onmouseout="this.style.borderColor='rgba(102, 126, 234, 0.3)'; this.style.background='linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)'">
                        <div style="position: absolute; top: -5px; right: -5px; font-size: 50px; opacity: 0.08;">üìä</div>
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Calls Today</div>
                            <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; margin-bottom: 4px;" id="callsToday">0</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5);">Total calls received</div>
                        </div>
                    </div>

                    <!-- Unread Appointments Card -->
                    <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(238, 90, 111, 0.1) 100%); border-radius: 16px; padding: 20px; border: 2px solid rgba(255, 107, 107, 0.3); position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer;" onclick="openCalendarModal(unreadAppointmentsList.length > 0 ? unreadAppointmentsList[0].id : null)" onmouseover="this.style.borderColor='rgba(255, 107, 107, 0.6)'; this.style.background='linear-gradient(135deg, rgba(255, 107, 107, 0.15) 0%, rgba(238, 90, 111, 0.15) 100%)'" onmouseout="this.style.borderColor='rgba(255, 107, 107, 0.3)'; this.style.background='linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(238, 90, 111, 0.1) 100%)'">
                        <div style="position: absolute; top: -5px; right: -5px; font-size: 50px; opacity: 0.08;">üìÖ</div>
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">New Appointments</div>
                            <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; margin-bottom: 4px;" id="unreadAppointmentsCard">0</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5);">Not yet viewed</div>
                        </div>
                    </div>

                    <!-- Credits Card -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border-radius: 16px; padding: 20px; border: 2px solid rgba(255, 215, 0, 0.3); position: relative; overflow: hidden; transition: all 0.3s;" onmouseover="this.style.borderColor='rgba(255, 215, 0, 0.6)'; this.style.background='linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 165, 0, 0.15) 100%)'" onmouseout="this.style.borderColor='rgba(255, 215, 0, 0.3)'; this.style.background='linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%)'">
                        <div style="position: absolute; top: -5px; right: -5px; font-size: 50px; opacity: 0.08;">üíé</div>
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Available Credits</div>
                            <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; margin-bottom: 4px;" id="creditsRemaining">--</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 12px;">Call credits remaining</div>
                            <button onclick="handleTopUp()" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #1a1a2e; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.3s; width: 100%; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 215, 0, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 215, 0, 0.3)'">
                                üí∞ Top Up 30p ‚Üí 50 Credits
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Unread Appointments Alert -->
                <div id="unreadAppointmentsAlert" style="display: none; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 16px; padding: 20px 25px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3); animation: pulse 2s ease-in-out infinite;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">üìÖ</div>
                            <div>
                                <div style="font-size: 18px; font-weight: 800; color: white; margin-bottom: 4px;">
                                    <span id="unreadAppointments">0</span> Unread Appointment<span id="unreadAppointmentsPlural">s</span>
                                </div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.9);">You have new appointments from AI calls that need your attention</div>
                            </div>
                        </div>
                        <button onclick="openCalendarModal(unreadAppointmentsList.length > 0 ? unreadAppointmentsList[0].id : null); closeUnreadAlert();" style="background: rgba(255,255,255,0.95); color: #ff6b6b; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            View Calendar ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calls Tab -->
        <div id="callsTab" class="main-tab-content" style="display: none;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">Call History</h1>
                        <p style="font-size: 15px; color: rgba(255,255,255,0.9);">View and manage your call records.</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="filterCalls('today')" id="filterToday" style="background: rgba(255,255,255,0.3); border: 2px solid white; padding: 10px 20px; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Today</button>
                        <button onclick="filterCalls('7days')" id="filter7days" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Last 7 Days</button>
                        <button onclick="filterCalls('30days')" id="filter30days" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Last Month</button>
                        <button onclick="filterCalls('6months')" id="filter6months" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Last 6 Months</button>
                    </div>
                </div>
            </div>
            
            <div id="callHistoryContent" style="padding: 40px 50px;">
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.4);">
                    Loading calls...
                </div>
            </div>
        </div>

        <!-- Config Tab -->
        <div id="configTab" class="main-tab-content" style="display: none;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">Configuration</h1>
                <p style="font-size: 15px; color: rgba(255,255,255,0.9);">Customize your AI voice assistant.</p>
            </div>

            <div style="padding: 40px 50px;">
            <div id="configTabContent">
                <form id="configForm">
                    <div class="form-section">
                        <h3>ü§ñ Agent Identity</h3>
                        <div class="form-group">
                            <label for="agentName">Agent Name</label>
                            <input type="text" id="agentName" placeholder="e.g., Julie, Alex, Sarah" required>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Your Phone Number</label>
                            <input type="text" id="phoneNumber" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #667eea; font-size: 16px; font-weight: 600; cursor: not-allowed;" placeholder="Not assigned yet">
                            <div class="example-box">
                                <strong>Note:</strong> Your phone number is assigned automatically. Contact your administrator if you need to change it.
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üé§ Voice Settings</h3>
                        <div class="form-group">
                            <label for="voiceProvider">Voice Provider</label>
                            <select id="voiceProvider" onchange="switchVoiceProvider()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px; cursor: pointer;">
                                <option value="speechmatics">Speechmatics (Sarah)</option>
                            </select>
                            <!-- Voice provider descriptions hidden as requested -->
                            <div class="example-box" style="margin-top: 10px; display: none;">
                                <strong>üé≠ Voice Providers:</strong><br>
                                <strong>OpenAI:</strong> 6 high-quality voices, fastest response<br>
                                <strong>Speechmatics:</strong> Real-time streaming with natural UK voices
                            </div>
                        </div>

                        <!-- OpenAI Voice Selection -->
                        <div id="openaiVoiceSection" style="display: none;">
                            <div class="form-group">
                                <label for="agentVoice">OpenAI Voice</label>
                                <select id="agentVoice" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px; cursor: pointer;">
                                    <option value="shimmer">Shimmer (Female - Warm & Friendly)</option>
                                    <option value="nova">Nova (Female - Bright & Energetic)</option>
                                    <option value="alloy">Alloy (Male - Professional & Clear)</option>
                                    <option value="echo">Echo (Male - Deep & Authoritative)</option>
                                    <option value="fable">Fable (Male - Expressive & Dynamic)</option>
                                    <option value="onyx">Onyx (Male - Strong & Confident)</option>
                                </select>
                                <button onclick="testOpenAIVoice()" style="margin-top: 10px; padding: 12px 24px; background: linear-gradient(135deg, #10a37f 0%, #0e8c6f 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    üîä Test Voice
                                </button>
                            </div>
                        </div>

                        <!-- Google Cloud Voice Selection -->
                        <div id="googleVoiceSection" style="display: none;">
                            <div class="form-group">
                                <label for="googleVoice">Google Cloud Voice (UK English)</label>
                                <select id="googleVoice" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px; cursor: pointer;">
                                    <optgroup label="UK Female - Neural2 (Highest Quality)">
                                        <option value="en-GB-Neural2-A">Neural2-A (Female - Clear & Professional)</option>
                                        <option value="en-GB-Neural2-C">Neural2-C (Female - Warm & Friendly)</option>
                                        <option value="en-GB-Neural2-F">Neural2-F (Female - Bright & Energetic)</option>
                                    </optgroup>
                                    <optgroup label="UK Male - Neural2 (Highest Quality)">
                                        <option value="en-GB-Neural2-B">Neural2-B (Male - Deep & Authoritative)</option>
                                        <option value="en-GB-Neural2-D">Neural2-D (Male - Professional & Clear)</option>
                                    </optgroup>
                                    <optgroup label="UK Female - Wavenet (High Quality)">
                                        <option value="en-GB-Wavenet-A">Wavenet-A (Female - Natural)</option>
                                        <option value="en-GB-Wavenet-C">Wavenet-C (Female - Smooth)</option>
                                        <option value="en-GB-Wavenet-F">Wavenet-F (Female - Expressive)</option>
                                    </optgroup>
                                    <optgroup label="UK Male - Wavenet (High Quality)">
                                        <option value="en-GB-Wavenet-B">Wavenet-B (Male - Strong)</option>
                                        <option value="en-GB-Wavenet-D">Wavenet-D (Male - Calm)</option>
                                    </optgroup>
                                </select>
                                <button onclick="testGoogleVoice()" style="margin-top: 10px; padding: 12px 24px; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    üîä Test Voice
                                </button>
                                <div class="example-box">
                                    <strong>Fast & Natural:</strong> Google Cloud offers 40+ UK English voices with very fast response times, comparable to OpenAI.
                                </div>
                            </div>
                        </div>

                        <!-- ElevenLabs Voice Selection -->
                        <div id="elevenLabsVoiceSection" style="display: none;">
                            <div class="form-group">
                                <label for="elevenLabsVoice">ElevenLabs Voice</label>
                                <select id="elevenLabsVoice" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px; cursor: pointer;">
                                    <option value="EXAVITQu4vr4xnSDxMaL">Bella (UK Female - Warm & Professional)</option>
                                    <option value="21m00Tcm4TlvDq8ikWAM">Rachel (US Female - Clear & Friendly)</option>
                                    <option value="AZnzlk1XvdvUeBnXmlld">Domi (US Female - Confident & Strong)</option>
                                    <option value="CYw3kZ02Hs0563khs1Fj">Dave (UK Male - Conversational)</option>
                                    <option value="D38z5RcWu1voky8WS1ja">Fin (Irish Male - Energetic)</option>
                                    <option value="ErXwobaYiN019PkySvjV">Antoni (US Male - Well-Rounded)</option>
                                    <option value="GBv7mTt0atIp3Br8iCZE">Thomas (US Male - Calm & Professional)</option>
                                    <option value="IKne3meq5aSn9XLyUdCD">Charlie (Australian Male - Casual)</option>
                                    <option value="JBFqnCBsd6RMkjVDRZzb">George (UK Male - Warm & Engaging)</option>
                                    <option value="N2lVS1w4EtoT3dr4eOWO">Callum (US Male - Professional)</option>
                                    <option value="TX3LPaxmHKxFdv7VOQHJ">Liam (US Male - Articulate)</option>
                                    <option value="XB0fDUnXU5powFXDhCwa">Charlotte (UK Female - Refined)</option>
                                    <option value="Xb7hH8MSUJpSbSDYk0k2">Alice (UK Female - Confident)</option>
                                    <option value="onwK4e9ZLuTAKqWW03F9">Daniel (UK Male - Deep & Authoritative)</option>
                                    <option value="pNInz6obpgDQGcFmaJgB">Adam (US Male - Narrative & Deep)</option>
                                    <option value="yoZ06aMxZJJ28mfd3POQ">Sam (US Male - Raspy & Dynamic)</option>
                                </select>
                                <button onclick="testElevenLabsVoice()" style="margin-top: 10px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    üîä Test Voice
                                </button>
                                <div class="example-box">
                                    <strong>Premium Voices:</strong> ElevenLabs provides the highest quality, most natural-sounding voices. Click "Test Voice" to hear a sample.
                                </div>
                            </div>
                        </div>

                        <!-- PlayHT Voice Selection -->
                        <div id="playhtVoiceSection" style="display: none;">
                            <div class="form-group">
                                <label for="playhtVoice">Play.HT Voice</label>
                                <select id="playhtVoice" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px; cursor: pointer;">
                                    <option value="s3://voice-cloning-zero-shot/d9ff78ba-d016-47f6-b0ef-dd630f59414e/female-cs/manifest.json">Charlotte (UK Female - Warm & Professional)</option>
                                    <option value="s3://voice-cloning-zero-shot/baf1d619-19e5-42fc-a8da-f530c0a6a8d5/original/manifest.json">Jennifer (US Female - Clear & Friendly)</option>
                                    <option value="s3://voice-cloning-zero-shot/d82d246c-148b-457f-9668-37b789e61a3e/original/manifest.json">Matthew (US Male - Professional)</option>
                                    <option value="s3://voice-cloning-zero-shot/e3827ec5-697a-4b7c-9704-1a23041bbc51/original/manifest.json">Ruby (UK Female - Energetic)</option>
                                    <option value="s3://voice-cloning-zero-shot/034e929c-245d-4b68-b0a3-f5e3e9c8f3f3/original/manifest.json">Larry (US Male - Conversational)</option>
                                </select>
                                <div class="example-box">
                                    <strong>Ultra-Realistic:</strong> Play.HT 2.0 voices are virtually indistinguishable from real humans, with natural inflections and emotions.
                                </div>
                            </div>
                        </div>

                        <!-- Voice Selection -->
                        <div id="speechmaticsVoiceSection" style="display: none;">
                            <div class="form-group">
                                <label for="speechmaticsVoice">Agent Voice</label>
                                <select id="speechmaticsVoice" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px; cursor: pointer;">
                                    <option value="sarah">Sarah (UK Female - Natural & Clear)</option>
                                    <option value="will" style="display: none;">Will (UK Male - Professional)</option>
                                </select>
                                <button onclick="testSpeechmaticsVoice()" style="margin-top: 10px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    üîä Test Voice
                                </button>
                                <div class="example-box" style="display: none;">
                                    <strong>Real-Time Streaming:</strong> Speechmatics provides natural UK voices with real-time streaming capabilities for low latency conversations.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üëã Opening Greeting</h3>
                        <div class="form-group">
                            <label for="callGreeting">Opening Greeting (Strict)</label>
                            <input type="text" id="callGreeting" placeholder="e.g., Hello, thanks for calling Beryl's Cars, how can I help you?">
                            <div class="example-box">
                                <strong>Tip:</strong> If set, the AI will say this line exactly first when the call connects.
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="transferNumber">üì≤ Transfer Number</label>
                            <input type="text" id="transferNumber" placeholder="e.g., 07958968621">
                            <div class="example-box">
                                <strong>Important:</strong> This number will be used when the AI needs to transfer calls or when caller matches one of the transfer triggers below.
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Transfer Instructions</label>
                            <textarea id="transferInstructions" rows="4" placeholder="Provide guidance on when and how to transfer calls..."></textarea>
                            <div class="example-box">
                                <strong>How it works:</strong> Use this to guide the AI on when to transfer calls. For example: "Transfer to Bob if they ask for the manager or owner. Transfer to reception for general inquiries. Transfer to Sarah for appointment bookings." The AI will ask who's calling and offer to transfer to the appropriate person using your <strong>Transfer Number</strong>. If declined, it will take a message.
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üè¢ Business Information</h3>
                        <div class="form-group">
                            <label for="businessInfo">Services, Pricing & Hours</label>
                            <textarea id="businessInfo" rows="5" placeholder="Describe your business, services, pricing, hours, etc..."></textarea>
                            <div class="example-box">
                                <strong>Example:</strong> "Garden Pros - Professional gardening services. Lawn mowing ¬£20/hour, hedge trimming ¬£30/hour, full garden maintenance ¬£50/visit. Open Mon-Sat 8am-6pm. Service area: Manchester."
                            </div>
                            
                            <!-- AI Website Analyzer -->
                            <div style="margin-top: 20px; padding: 18px; background: linear-gradient(135deg, rgba(16,163,127,0.08) 0%, rgba(14,140,111,0.12) 100%); border: 2px solid rgba(16,163,127,0.3); border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="font-size: 20px;">ü§ñ</span>
                                    <span style="font-weight: 700; color: white; font-size: 15px;">AI Website Analyzer</span>
                                </div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">Enter your website URL and let AI extract business information automatically</div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="url" id="websiteUrl" placeholder="https://yourwebsite.com" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px;">
                                    <button type="button" onclick="analyzeWebsite()" id="analyzeBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #10a37f 0%, #0e8c6f 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16,163,127,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        üîç Analyze
                                    </button>
                                </div>
                                <div id="analyzeStatus" style="margin-top: 12px; padding: 10px; border-radius: 6px; display: none; font-size: 13px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üé≠ Agent Personality</h3>
                        <div class="form-group">
                            <label for="agentPersonality">Tone & Communication Style</label>
                            <textarea id="agentPersonality" rows="4" placeholder="Describe how the agent should speak and behave..."></textarea>
                            <div class="example-box">
                                <strong>Example:</strong> "Friendly and professional. Use casual language but remain respectful. Be enthusiastic about helping customers. Keep responses brief and conversational."
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìã Additional Instructions</h3>
                        <div class="form-group">
                            <label for="agentInstructions">Call Handling Guidelines</label>
                            <textarea id="agentInstructions" rows="4" placeholder="Any other specific instructions for handling calls..."></textarea>
                            <div class="example-box">
                                <strong>Example:</strong> "Take messages if the owner isn't available. Offer to schedule appointments. Always ask for contact details."
                            </div>
                        </div>
                    </div>

                    <!-- Calendar & Appointments section hidden - users can enable via bundles -->
                    <div class="form-section" style="display: none;">
                        <h3>üìÖ Calendar & Appointments</h3>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 15px; cursor: pointer;">
                                <input type="checkbox" id="calendarBookingEnabled" style="width: 24px; height: 24px; cursor: pointer;" onchange="updateCalendarBookingStatus()">
                                <div>
                                    <div style="font-size: 16px; font-weight: 700; color: white;">Enable Calendar Bookings</div>
                                    <div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 4px;">Allow the AI agent to book appointments in your calendar during calls</div>
                                </div>
                            </label>
                            <div class="example-box" style="margin-top: 15px;">
                                <strong>üí∞ Note:</strong> Calendar bookings cost <strong><span id="bookingCreditCost">10</span> credits</strong> per appointment made by the agent. This pricing can be adjusted in the Vonage Agent Server Control billing settings.
                            </div>
                            <div id="calendarBookingStatus" style="margin-top: 12px; padding: 12px; border-radius: 8px; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); display: none;">
                                <div style="font-size: 13px; color: #e74c3c; font-weight: 600;">‚ö†Ô∏è Calendar bookings are currently disabled</div>
                                <div style="font-size: 12px; color: rgba(231, 76, 60, 0.8); margin-top: 4px;">The AI agent will not be able to create appointments until this feature is enabled.</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn-primary">üíæ Save Configuration</button>
                        <button type="button" class="btn-secondary" onclick="loadConfig()">üîÑ Reload</button>
                    </div>
                </form>

                <div id="message" class="message"></div>
            </div>

            <div id="callsTab" class="tab-content">
                <div id="callLogs"></div>
            </div>



            <!-- Billing Tab -->
            <div id="billingTab" class="main-tab-content" style="display: none;">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 40px 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">üí∞ Billing & Usage</h1>
                    <p style="font-size: 15px; color: rgba(255,255,255,0.9);">Track your credit usage and charges</p>
                </div>
                
                <div style="padding: 40px 50px;">
                    <!-- Current Balance -->
                    <div style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(230, 126, 34, 0.1) 100%); border: 2px solid rgba(243, 156, 18, 0.3); border-radius: 16px; padding: 30px; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 8px; font-weight: 600;">CURRENT BALANCE</div>
                                <div style="font-size: 48px; font-weight: 900; color: #f39c12;" id="billingCurrentBalance">--</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 4px;">Available Credits</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 8px; font-weight: 600;">TOTAL USED</div>
                                <div style="font-size: 32px; font-weight: 700; color: rgba(255,255,255,0.8);" id="billingTotalUsed">--</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 4px;">Credits This Month</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Information -->
                    <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-bottom: 30px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: white;">üìã Current Pricing</h2>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 40px; margin-bottom: 10px;">üìû</div>
                                <div style="font-size: 28px; font-weight: 700; color: #667eea; margin-bottom: 8px;" id="pricePerCall">--</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.7);">Credits per connected call</div>
                            </div>
                            <div style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 40px; margin-bottom: 10px;">‚è±Ô∏è</div>
                                <div style="font-size: 28px; font-weight: 700; color: #2ecc71; margin-bottom: 8px;" id="pricePerMinute">--</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.7);">Credits per minute</div>
                            </div>
                            <div style="background: rgba(241, 196, 15, 0.1); border: 1px solid rgba(241, 196, 15, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 40px; margin-bottom: 10px;">üìÖ</div>
                                <div style="font-size: 28px; font-weight: 700; color: #f1c40f; margin-bottom: 8px;" id="pricePerBooking">--</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.7);">Credits per calendar booking</div>
                            </div>
                        </div>
                    </div>

                    <!-- Usage History -->
                    <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: white;">üìä Usage History</h2>
                        <div id="billingHistoryContent">
                            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.4);">
                                Loading billing history...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Calendar Tab -->
        <div id="calendarTab" class="main-tab-content" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">üìÖ Calendar</h1>
                <p style="font-size: 15px; color: rgba(255,255,255,0.9);">Calendar feature coming soon</p>
            </div>
        </div>

            <div id="adminTab" class="tab-content">
                <div class="diagnostic-card">
                    <h3 style="margin-bottom: 15px; font-size: 20px;">üîç System Status</h3>
                    <div class="diagnostic-item">
                        <div>
                            <span class="status-indicator status-ok"></span>
                            <strong>Server Status</strong>
                        </div>
                        <span id="serverStatus">Running on Port 5004</span>
                    </div>
                    <div class="diagnostic-item">
                        <div>
                            <span class="status-indicator" id="ngrokIndicator"></span>
                            <strong>ngrok Tunnel</strong>
                        </div>
                        <span id="ngrokStatus">Checking...</span>
                    </div>
                    <div class="diagnostic-item">
                        <div>
                            <span class="status-indicator" id="cloudflareIndicator"></span>
                            <strong>Cloudflare Tunnel</strong>
                        </div>
                        <span id="cloudflareStatus">Checking...</span>
                    </div>
                    <div class="diagnostic-item">
                        <div>
                            <span class="status-indicator status-ok"></span>
                            <strong>OpenAI Connection</strong>
                        </div>
                        <span id="openaiStatus">Active</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="testConnection()">üîó Test Connection</button>
                    <button class="btn-primary" onclick="checkNgrok()">üåê Check ngrok</button>
                    <button class="btn-primary" onclick="restartNgrok()">üîÅ Restart ngrok</button>
                    <button class="btn-primary" onclick="runSystemDiagnostics()">üî¨ Run Diagnostics & Fix</button>
                    <button class="btn-secondary" onclick="restartServices()">üîÑ Restart Services</button>
                </div>

                <div id="diagnosticMessage" class="message"></div>
                <div id="diagnosticResults" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; display: none;">
                    <h4 style="margin-bottom: 10px;">üìã Diagnostic Results</h4>
                    <div id="diagnosticDetails" style="font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication check on page load
        function showAccountRestrictionOverlay(title, message) {
            const overlay = document.getElementById('accountRestrictionOverlay');
            const titleEl = document.getElementById('accountRestrictionTitle');
            const msgEl = document.getElementById('accountRestrictionMessage');
            const iconEl = document.getElementById('accountRestrictionIcon');

            if (!overlay || !titleEl || !msgEl) {
                alert((title || 'Account Restricted') + "\n\n" + (message || 'Please contact support.'));
                return;
            }

            const safeTitle = String(title || 'Account Restricted');
            const safeMsg = String(message || 'Please contact support.');
            titleEl.textContent = safeTitle;
            msgEl.textContent = safeMsg;
            if (iconEl) {
                iconEl.textContent = safeTitle.toLowerCase().includes('banned') ? '‚õî' : 'üîí';
            }

            overlay.style.display = 'flex';
        }

        async function checkAuth() {
            const sessionToken = localStorage.getItem('session_token');
            const userName = localStorage.getItem('user_name');
            
            if (!sessionToken || !userName) {
                window.location.href = '/signin.html';
                return false;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (response.status === 403) {
                    const data = await response.json().catch(() => ({}));
                    showAccountRestrictionOverlay(data.error, data.message);
                    return false;
                }

                if (!response.ok) {
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_name');
                    window.location.href = '/signin.html';
                    return false;
                }

                const data = await response.json();
                
                // Display username and phone number in header
                document.getElementById('userName').textContent = data.user_name || userName;
                document.getElementById('userPhone').textContent = data.phone_number ? `üìû ${data.phone_number}` : 'üìû No phone number set';
                
                // Update dashboard phone number box
                const statsPhoneEl = document.getElementById('statsPhoneNumber');
                if (statsPhoneEl && data.phone_number) {
                    statsPhoneEl.textContent = data.phone_number;
                }
                
                // Store user name for display
                localStorage.setItem('user_name', data.user_name);
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                if (error.name === 'AbortError') {
                    console.error('Auth check timed out');
                }
                window.location.href = '/signin.html';
                return false;
            }
        }
        
        // Logout function
        function logout() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (sessionToken) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                }).catch(err => console.error('Logout error:', err));
            }
            
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_name');
            window.location.href = '/signin.html';
        }
        
        // Helper to get auth headers
        function getAuthHeaders() {
            const sessionToken = localStorage.getItem('session_token');
            return {
                'Authorization': `Bearer ${sessionToken}`,
                'Content-Type': 'application/json'
            };
        }
        
        // Run auth check when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // Will redirect to signin
            }

            // If returning from Lemon Squeezy after a successful payment, refresh credits.
            try {
                const url = new URL(window.location.href);
                const topup = url.searchParams.get('topup');
                const sessionId = url.searchParams.get('session_id');
                if (topup === 'success') {
                    await handleReturnFromTopUp(sessionId);
                    url.searchParams.delete('topup');
                    url.searchParams.delete('session_id');
                    window.history.replaceState({}, document.title, url.pathname + url.search);
                }
            } catch (e) {
                console.error('Top up return handling failed:', e);
            }
            
            // Check if first-time user and show welcome modal
            await checkFirstLogin();

            // Load trial status early so it shows even if other init code errors
            try {
                loadTrialStatus();
            } catch (e) {
                console.error('‚ùå loadTrialStatus failed during init:', e);
            }
            
            // Load dashboard as default view
            loadDashboard();
            loadTodayStats();
            loadCredits();
            loadConfig(); // Load config to populate phone number and other settings
            loadBundles(); // Load bundle settings
            loadTaskCount(); // Load task count badge

            // Update tunnel status indicators early
            try {
                await checkNgrok();
            } catch (e) {
                console.warn('Tunnel status check failed:', e);
            }
            
            // Handle form submission - must be inside DOMContentLoaded
            document.getElementById('configForm').addEventListener('submit', handleConfigSubmit);
        });

        async function handleReturnFromTopUp(sessionId) {
            // Stripe webhooks can take a moment to arrive (or fail locally). Verify on return if possible.
            alert('‚úÖ Payment successful! Updating your credits‚Ä¶');

            if (sessionId) {
                try {
                    const verifyResp = await fetch('/api/stripe/verify-session', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    const verifyJson = await verifyResp.json().catch(() => ({}));
                    if (!verifyResp.ok) {
                        console.warn('Stripe verify-session failed:', verifyResp.status, verifyJson);
                    }
                } catch (e) {
                    console.warn('Stripe verify-session threw:', e);
                }
            }

            const delaysMs = [0, 1500, 3000, 5000, 8000];
            for (const d of delaysMs) {
                if (d) {
                    await new Promise(resolve => setTimeout(resolve, d));
                }
                try {
                    await loadCredits();
                } catch (e) {
                    console.warn('loadCredits failed while waiting for topup:', e);
                }
            }
        }

        // Fallback: run again after full page load (covers any delayed DOM/render issues)
        window.addEventListener('load', () => {
            try {
                loadTrialStatus();
            } catch (e) {
                console.error('‚ùå loadTrialStatus failed on window.load:', e);
            }
        });

        async function checkFirstLogin() {
            try {
                const response = await fetch('/api/config', { headers: getAuthHeaders() });
                const config = await response.json();
                
                // Show welcome modal if first login OR if no phone number assigned yet
                if (!config.FIRST_LOGIN_COMPLETED || !config.PHONE_NUMBER || config.PHONE_NUMBER === '') {
                    showWelcomeModal();
                }
            } catch (error) {
                console.error('Failed to check first login:', error);
            }
        }

        async function showWelcomeModal() {
            const overlay = document.getElementById('welcomeOverlay');
            const progressBar = document.getElementById('welcomeProgressBar');
            const progressMessage = document.getElementById('welcomeProgressMessage');
            
            if (!overlay) return;
            overlay.style.display = 'flex';
            
            // Simulate number provisioning progress
            const stages = [
                { percent: 15, message: 'Connecting to telephony network...', delay: 500 },
                { percent: 40, message: 'Searching available numbers...', delay: 800 },
                { percent: 70, message: 'Provisioning your number...', delay: 1000 },
                { percent: 90, message: 'Configuring AI agent...', delay: 700 },
                { percent: 100, message: 'Complete! Setting up your dashboard...', delay: 500 }
            ];
            
            for (const stage of stages) {
                await new Promise(resolve => setTimeout(resolve, stage.delay));
                progressBar.style.width = stage.percent + '%';
                progressMessage.textContent = stage.message;
            }
            
            // Mark first login as complete
            await fetch('/api/complete-first-login', {
                method: 'POST',
                headers: getAuthHeaders()
            });
            
            // Hide modal after completion
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 1200);
        }

        function switchMainTab(tabName) {
            console.log('Switching to tab:', tabName);
            // Hide all main tabs
            document.querySelectorAll('.main-tab-content').forEach(c => c.style.display = 'none');
            
            // Remove active class from all sidebar buttons
            document.querySelectorAll('.sidebar-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = 'rgba(255,255,255,0.6)';
                btn.style.borderLeftColor = 'transparent';
            });
            
            // Show selected tab
            const tabElement = document.getElementById(tabName + 'Tab');
            console.log('Tab element:', tabElement);
            if (tabElement) {
                tabElement.style.display = 'block';
                console.log('Tab displayed');
            } else {
                console.error('Tab element not found:', tabName + 'Tab');
            }
            
            // Activate sidebar button
            const activeBtn = document.querySelector(`.sidebar-nav-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.color = 'white';
                activeBtn.style.borderLeftColor = '#667eea';
            }
            
            // Load content for specific tabs
            if (tabName === 'calls') {
                loadCalls('today'); // Load with default 'today' filter
                setActiveFilter('today'); // Set today button as active
            } else if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'tasks') {
                loadTasks();
            } else if (tabName === 'billing') {
                loadBillingHistory();
            } else if (tabName === 'admin') {
                runDiagnostics();
            } else if (tabName === 'config') {
                // Config tab is already populated on page load
            }
        }

        function switchTab(tabName) {
            // Legacy function - redirect to new sidebar navigation
            switchMainTab(tabName);
        }

        function openCalendarModal(appointmentId = null) {
            targetAppointmentId = appointmentId;
            document.getElementById('calendarModal').style.display = 'block';
            loadCalendar();
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').style.display = 'none';
        }

        function openBundlesModal() {
            document.getElementById('bundlesModal').style.display = 'block';
            loadBundles();
        }

        function closeBundlesModal() {
            document.getElementById('bundlesModal').style.display = 'none';
        }

        async function loadBundles() {
            try {
                const response = await fetch('/api/config', {
                    headers: getAuthHeaders()
                });
                const config = await response.json();
                
                // Load calendar bundle state
                const calendarEnabled = config.CALENDAR_BOOKING_ENABLED !== false;
                document.getElementById('calendarBundleToggle').checked = calendarEnabled;
                updateToggleStyle('calendarBundleToggle', calendarEnabled);
                
                // Load tasks bundle state
                const tasksEnabled = config.TASKS_ENABLED !== false;
                document.getElementById('tasksBundleToggle').checked = tasksEnabled;
                updateToggleStyle('tasksBundleToggle', tasksEnabled);
                
                // Load advanced voice bundle state
                const advancedVoiceEnabled = config.ADVANCED_VOICE_ENABLED === true;
                document.getElementById('advancedVoiceBundleToggle').checked = advancedVoiceEnabled;
                updateToggleStyle('advancedVoiceBundleToggle', advancedVoiceEnabled);
                
                // Load sales detector bundle state
                const salesDetectorEnabled = config.SALES_DETECTOR_ENABLED === true;
                document.getElementById('salesDetectorBundleToggle').checked = salesDetectorEnabled;
                updateToggleStyle('salesDetectorBundleToggle', salesDetectorEnabled);

                // Load SMS notification state
                const smsEnabled = config.SMS_NOTIFICATIONS_ENABLED === true;
                document.getElementById('smsNotificationsToggle').checked = smsEnabled;
                updateToggleStyle('smsNotificationsToggle', smsEnabled);
                
                // Load pricing from config (display only)
                document.getElementById('calendarPriceDisplay').textContent = config.CALENDAR_BOOKING_CREDITS || 10;
                document.getElementById('tasksPriceDisplay').textContent = config.TASK_CREDITS || 5;
                document.getElementById('advancedVoicePriceDisplay').textContent = config.ADVANCED_VOICE_CREDITS || 3;
                document.getElementById('salesDetectorPriceDisplay').textContent = config.SALES_DETECTOR_CREDITS || 2;
            } catch (error) {
                console.error('Failed to load bundles:', error);
            }
        }

        function toggleBundle(bundleType) {
            // Just update the UI, don't save yet - user will click Save button
            const toggleId = bundleType + 'BundleToggle';
            const checkbox = document.getElementById(toggleId);
            const isEnabled = checkbox.checked;
            
            updateToggleStyle(toggleId, isEnabled);
        }

        async function saveBundleSettings() {
            try {
                // Get all toggle states
                const calendarEnabled = document.getElementById('calendarBundleToggle').checked;
                const tasksEnabled = document.getElementById('tasksBundleToggle').checked;
                const advancedVoiceEnabled = document.getElementById('advancedVoiceBundleToggle').checked;
                const salesDetectorEnabled = document.getElementById('salesDetectorBundleToggle').checked;
                const smsNotificationsEnabled = document.getElementById('smsNotificationsToggle').checked;
                
                // Save all settings in one request
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        CALENDAR_BOOKING_ENABLED: calendarEnabled,
                        TASKS_ENABLED: tasksEnabled,
                        ADVANCED_VOICE_ENABLED: advancedVoiceEnabled,
                        SALES_DETECTOR_ENABLED: salesDetectorEnabled,
                        SMS_NOTIFICATIONS_ENABLED: smsNotificationsEnabled
                    })
                });
                
                if (response.ok) {
                    showBundleMessage('‚úÖ Bundle settings saved successfully!', 'success');
                } else {
                    throw new Error('Failed to save bundle settings');
                }
            } catch (error) {
                console.error('Failed to save bundle settings:', error);
                showBundleMessage('‚ùå Failed to save bundle settings. Please try again.', 'error');
            }
        }

        function updateToggleStyle(toggleId, isEnabled) {
            const checkbox = document.getElementById(toggleId);
            const slider = checkbox.nextElementSibling;
            const knob = slider.nextElementSibling;
            
            if (isEnabled) {
                slider.style.backgroundColor = '#2ed573';
                slider.style.borderColor = '#2ed573';
                knob.style.transform = 'translateX(34px)';
            } else {
                slider.style.backgroundColor = 'rgba(255,255,255,0.2)';
                slider.style.borderColor = 'rgba(255,255,255,0.3)';
                knob.style.transform = 'translateX(0)';
            }
        }

        function showBundleMessage(message, type) {
            const messageDiv = document.getElementById('bundleMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.background = type === 'success' 
                ? 'linear-gradient(135deg, #2ed573 0%, #00b894 100%)' 
                : 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
            messageDiv.style.color = 'white';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        function showSalesReasoning(reasoning, confidence) {
            const confidenceColor = confidence >= 70 ? '#ff4444' : confidence >= 50 ? '#ffaa44' : '#44aa44';
            const confidenceLabel = confidence >= 70 ? 'HIGH CONFIDENCE' : confidence >= 50 ? 'MEDIUM CONFIDENCE' : 'LOW CONFIDENCE';
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(30,30,40,0.98) 0%, rgba(20,20,30,0.98) 100%); border-radius: 20px; padding: 35px; max-width: 600px; width: 90%; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="margin: 0; font-size: 24px; color: white; display: flex; align-items: center; gap: 12px;">
                            üö´ Sales Call Detection
                        </h2>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: rgba(255,100,100,0.2); border: 2px solid rgba(255,100,100,0.4); color: white; font-size: 24px; cursor: pointer; padding: 8px 16px; border-radius: 10px; transition: all 0.3s;">‚úï</button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="background: ${confidenceColor}; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 14px;">
                                ${confidence}% ${confidenceLabel}
                            </div>
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 16px; line-height: 1.6;">
                            ${reasoning}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="this.closest('div').parentElement.remove()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 32px; border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        function openTasksModal() {
            document.getElementById('tasksModal').style.display = 'block';
            loadTasks();
        }

        function closeTasksModal() {
            document.getElementById('tasksModal').style.display = 'none';
            hideAddTaskForm();
        }

        async function runDiagnostics() {
            await checkNgrok();
        }

        async function checkNgrok() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('/api/admin/ngrok-status', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                const indicator = document.getElementById('ngrokIndicator');
                const status = document.getElementById('ngrokStatus');
                const cfIndicator = document.getElementById('cloudflareIndicator');
                const cfStatus = document.getElementById('cloudflareStatus');
                
                const ngrokRunning = (typeof data.ngrok_running === 'boolean') ? data.ngrok_running : ((data.provider || '').toLowerCase() === 'ngrok' ? !!data.running : false);
                const cloudflareRunning = (typeof data.cloudflare_running === 'boolean') ? data.cloudflare_running : ((data.provider || '').toLowerCase() === 'cloudflare' ? !!data.running : false);

                // ngrok circle
                indicator.className = ngrokRunning ? 'status-indicator status-ok' : 'status-indicator status-error';
                status.textContent = ngrokRunning ? (data.ngrok_url || data.url || 'ngrok running') : 'Not running';

                // Cloudflare circle
                if (cfIndicator) cfIndicator.className = cloudflareRunning ? 'status-indicator status-ok' : 'status-indicator status-error';
                if (cfStatus) cfStatus.textContent = cloudflareRunning ? (data.cloudflare_url || 'Cloudflare running') : 'Not running';
            } catch (error) {
                const indicator = document.getElementById('ngrokIndicator');
                const status = document.getElementById('ngrokStatus');
                const cfIndicator = document.getElementById('cloudflareIndicator');
                const cfStatus = document.getElementById('cloudflareStatus');
                indicator.className = 'status-indicator status-error';
                if (cfIndicator) cfIndicator.className = 'status-indicator status-error';
                if (error.name === 'AbortError') {
                    status.textContent = 'Timeout checking status';
                    if (cfStatus) cfStatus.textContent = 'Timeout checking status';
                } else {
                    status.textContent = 'Error checking';
                    if (cfStatus) cfStatus.textContent = 'Error checking';
                }
            }
        }

        async function testConnection() {
            showDiagnosticMessage('Testing OpenAI connection...', 'success');
            try {
                const response = await fetch('/test-openai');
                if (response.ok) {
                    showDiagnosticMessage('‚úÖ OpenAI connection successful!', 'success');
                } else {
                    showDiagnosticMessage('‚ùå OpenAI connection failed', 'error');
                }
            } catch (error) {
                showDiagnosticMessage('‚ùå Connection test failed', 'error');
            }
        }

        async function restartServices() {
            showDiagnosticMessage('üîÑ Restarting services...', 'success');
            try {
                const response = await fetch('/api/admin/restart', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showDiagnosticMessage('‚úÖ Services restarted! New URL: ' + data.url, 'success');
                    await checkNgrok();
                } else {
                    showDiagnosticMessage('‚ùå Restart failed: ' + data.message, 'error');
                }
            } catch (error) {
                showDiagnosticMessage('‚ùå Failed to restart: ' + error.message, 'error');
            }
        }

        async function restartNgrok() {
            showDiagnosticMessage('üîÅ Restarting ngrok...', 'success');
            try {
                const response = await fetch('/api/admin/restart-ngrok', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showDiagnosticMessage('‚úÖ ngrok restarted! New URL: ' + data.url, 'success');
                    setTimeout(() => checkNgrok(), 2000);
                } else {
                    showDiagnosticMessage('‚ùå Restart failed: ' + data.message, 'error');
                }
            } catch (error) {
                showDiagnosticMessage('‚ùå Failed to restart ngrok: ' + error.message, 'error');
            }
        }

        async function runSystemDiagnostics() {
            showDiagnosticMessage('üî¨ Running comprehensive system diagnostics...', 'success');
            document.getElementById('diagnosticResults').style.display = 'block';
            const detailsDiv = document.getElementById('diagnosticDetails');
            detailsDiv.textContent = 'Running tests...\n';
            
            try {
                const response = await fetch('/api/admin/diagnostics', { method: 'POST' });
                const data = await response.json();
                
                let details = '';
                data.tests.forEach(test => {
                    const icon = test.passed ? '‚úÖ' : '‚ùå';
                    details += `${icon} ${test.name}: ${test.message}\n`;
                    if (test.fixed) {
                        details += `   üîß Auto-fixed: ${test.fix_message}\n`;
                    }
                });
                
                detailsDiv.textContent = details;
                
                if (data.all_passed) {
                    showDiagnosticMessage('‚úÖ All diagnostics passed!', 'success');
                } else if (data.fixed_count > 0) {
                    showDiagnosticMessage(`‚ö†Ô∏è Found ${data.failed_count} issues, fixed ${data.fixed_count}`, 'success');
                } else {
                    showDiagnosticMessage(`‚ùå Found ${data.failed_count} issues - check details below`, 'error');
                }
            } catch (error) {
                showDiagnosticMessage('‚ùå Diagnostics failed: ' + error.message, 'error');
            }
        }

        function showDiagnosticMessage(text, type) {
            const messageDiv = document.getElementById('diagnosticMessage');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        async function markCallComplete(callUuid) {
            try {
                const response = await fetch(`/api/calls/${callUuid}/complete`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadCalls();
                } else {
                    alert('Failed to mark call as complete');
                }
            } catch (error) {
                console.error('Error marking call complete:', error);
                alert('Error marking call as complete');
            }
        }

        async function deleteCall(callUuid) {
            if (!confirm('Are you sure you want to delete this call?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/calls/${callUuid}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadCalls();
                } else {
                    alert('Failed to delete call');
                }
            } catch (error) {
                console.error('Error deleting call:', error);
                alert('Error deleting call');
            }
        }

        async function loadDashboard() {
            try {
                // Dashboard loads stats via loadTodayStats() and loadCredits()
                // No additional loading needed here
                console.log('Dashboard view activated');
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function handleTopUp() {
            // Open a new tab synchronously to avoid popup blockers.
            // We'll navigate it to the checkout URL once the API call returns.
            const checkoutWindow = window.open('about:blank', '_blank');
            try {
                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    if (checkoutWindow && !checkoutWindow.closed) checkoutWindow.close();
                    alert(error.detail || `Failed to create checkout (HTTP ${response.status}). Please try again.`);
                    return;
                }

                const data = await response.json();
                if (data.checkout_url) {
                    // Open Lemon Squeezy checkout in new window
                    if (checkoutWindow && !checkoutWindow.closed) {
                        checkoutWindow.location = data.checkout_url;
                    } else {
                        window.open(data.checkout_url, '_blank');
                    }
                } else {
                    if (checkoutWindow && !checkoutWindow.closed) checkoutWindow.close();
                    alert('Failed to create checkout session');
                }
            } catch (error) {
                console.error('Top up error:', error);
                if (checkoutWindow && !checkoutWindow.closed) checkoutWindow.close();
                alert('Error creating checkout. Please try again.');
            }
        }

        async function loadCalls(filterPeriod = 'today') {
            try {
                console.log('Loading calls with filter:', filterPeriod);
                const response = await fetch('/api/calls', {
                    headers: getAuthHeaders()
                });
                console.log('Calls response status:', response.status);
                
                const data = await response.json();
                console.log('Calls data:', data);
                
                const callHistoryContent = document.getElementById('callHistoryContent');
                
                let callsToDisplay = data.calls || [];
                
                // Filter calls based on period
                if (callsToDisplay.length > 0 && filterPeriod !== 'all') {
                    const now = new Date();
                    let startDate = new Date();
                    
                    switch(filterPeriod) {
                        case 'today':
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case '7days':
                            startDate.setDate(now.getDate() - 7);
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case '30days':
                            startDate.setDate(now.getDate() - 30);
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case '6months':
                            startDate.setMonth(now.getMonth() - 6);
                            startDate.setHours(0, 0, 0, 0);
                            break;
                    }
                    
                    callsToDisplay = callsToDisplay.filter(call => {
                        const callDate = new Date(call.start_time);
                        return callDate >= startDate;
                    });
                }
                
                const filterLabels = {
                    'today': 'today',
                    '7days': 'in the last 7 days',
                    '30days': 'in the last month',
                    '6months': 'in the last 6 months',
                    'all': 'yet'
                };
                
                if (!callsToDisplay || callsToDisplay.length === 0) {
                    console.log('No calls found');
                    callHistoryContent.innerHTML = `
                        <div style="text-align: center; padding: 80px 20px; background: rgba(255,255,255,0.02); border-radius: 16px; border: 2px dashed rgba(255,255,255,0.1);">
                            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.4;">üìû</div>
                            <div style="font-size: 20px; color: rgba(255,255,255,0.7); margin-bottom: 10px; font-weight: 600;">No calls ${filterLabels[filterPeriod]}</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.4);">No customer calls have been received in this time period</div>
                        </div>
                    `;
                    return;
                }

                console.log(`Displaying ${callsToDisplay.length} calls`);
                
                callHistoryContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        ${callsToDisplay.map(call => {
                            const startTime = new Date(call.start_time);
                            const formattedTime = startTime.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) + ' at ' + startTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                            const duration = call.duration ? `${call.duration}s` : 'N/A';
                            const isCompleted = call.status === 'completed';
                            const apptBadge = call.has_appointment ? `<span onclick="openCalendarModal(${call.appointment_id}); event.stopPropagation();" style="background: #ff4444; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 10px; display: inline-block; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ff6666'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ff4444'; this.style.transform='scale(1)'">üìÖ APPOINTMENT</span>` : '';
                            
                            // Add sales confidence badge if available
                            let salesBadge = '';
                            if (call.sales_confidence !== null && call.sales_confidence !== undefined) {
                                const confidence = call.sales_confidence;
                                let badgeColor, label, icon;
                                
                                if (confidence >= 70) {
                                    badgeColor = '#ff4444';
                                    label = 'SALES CALL';
                                    icon = 'üö´';
                                } else if (confidence >= 30) {
                                    badgeColor = '#ffaa44';
                                    label = 'POSSIBLE SALES';
                                    icon = '‚ö†Ô∏è';
                                } else {
                                    badgeColor = '#44aa44';
                                    label = 'NOT SALES';
                                    icon = '‚úÖ';
                                }
                                
                                const reasoning = (call.sales_reasoning || 'No reasoning provided').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const endedIndicator = call.sales_ended_by_detector ? ' ‚ö° ENDED' : '';
                                salesBadge = `<span onclick='showSalesReasoning(\`${reasoning}\`, ${confidence}); event.stopPropagation();' style="background: ${badgeColor}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 10px; display: inline-block; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.opacity='0.9'" onmouseout="this.style.transform='scale(1)'; this.style.opacity='1'">${icon} ${label} (${confidence}%)${endedIndicator}</span>`;
                            }
                            
                            return `
                                <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; border: 1px solid rgba(255,255,255,0.06); transition: all 0.3s;" 
                                     onmouseover="this.style.background='rgba(255,255,255,0.06)'; this.style.borderColor='rgba(102,126,234,0.3)'" 
                                     onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.06)'">
                                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 15px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 6px;">
                                                üì± ${call.caller_number}
                                                ${apptBadge}
                                                ${salesBadge}
                                            </div>
                                            <div style="font-size: 13px; color: rgba(255,255,255,0.5);">
                                                üìÖ ${formattedTime} ‚Ä¢ ‚è±Ô∏è ${duration}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 10px; flex-shrink: 0;">
                                            ${isCompleted 
                                                ? '<button disabled style="background: rgba(100,255,100,0.2); border: 1px solid rgba(100,255,100,0.4); padding: 8px 16px; border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 600; cursor: not-allowed;">‚úì Complete</button>'
                                                : `<button onclick="markCallComplete('${call.call_uuid}')" style="background: linear-gradient(135deg, #66ea96 0%, #66c8ea 100%); border: none; padding: 8px 16px; border-radius: 8px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Mark Complete</button>`
                                            }
                                            <button onclick="deleteCall('${call.call_uuid}')" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.4); padding: 8px 16px; border-radius: 8px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; border-left: 3px solid #667eea;">
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); line-height: 1.6;">
                                            ${call.summary || '<span style="color: rgba(255,255,255,0.4);">Generating AI summary...</span>'}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Failed to load calls:', error);
            }
        }

        // Analyze website and extract business information
        async function analyzeWebsite() {
            const urlInput = document.getElementById('websiteUrl');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const statusDiv = document.getElementById('analyzeStatus');
            const businessInfoTextarea = document.getElementById('businessInfo');
            
            const url = urlInput.value.trim();
            
            if (!url) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(255,100,100,0.2)';
                statusDiv.style.border = '1px solid rgba(255,100,100,0.4)';
                statusDiv.style.color = '#ff6b6b';
                statusDiv.innerHTML = '‚ö†Ô∏è Please enter a valid URL';
                return;
            }
            
            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(255,100,100,0.2)';
                statusDiv.style.border = '1px solid rgba(255,100,100,0.4)';
                statusDiv.style.color = '#ff6b6b';
                statusDiv.innerHTML = '‚ö†Ô∏è Invalid URL format. Please include https:// or http://';
                return;
            }
            
            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '‚è≥ Analyzing...';
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(100,150,255,0.2)';
            statusDiv.style.border = '1px solid rgba(100,150,255,0.4)';
            statusDiv.style.color = '#6496ff';
            statusDiv.innerHTML = 'ü§ñ AI is analyzing the website...';
            
            try {
                const response = await fetch('/api/admin/analyze-website', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to analyze website');
                }
                
                const data = await response.json();
                
                // Populate business information
                businessInfoTextarea.value = data.business_info;
                
                // Show success
                statusDiv.style.background = 'rgba(100,255,100,0.2)';
                statusDiv.style.border = '1px solid rgba(100,255,100,0.4)';
                statusDiv.style.color = '#64ff64';
                statusDiv.innerHTML = '‚úÖ Business information extracted successfully!';
                
                // Hide status after 3 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Website analysis error:', error);
                statusDiv.style.background = 'rgba(255,100,100,0.2)';
                statusDiv.style.border = '1px solid rgba(255,100,100,0.4)';
                statusDiv.style.color = '#ff6b6b';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'üîç Analyze';
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config', {
                    headers: getAuthHeaders()
                });
                const config = await response.json();
                
                const agentNameEl = document.getElementById('agentName');
                if (agentNameEl) agentNameEl.value = config.AGENT_NAME;
                
                const phoneNumberEl = document.getElementById('phoneNumber');
                if (phoneNumberEl) phoneNumberEl.value = config.PHONE_NUMBER || '';
                
                const agentVoiceEl = document.getElementById('agentVoice');
                if (agentVoiceEl) agentVoiceEl.value = config.VOICE || 'shimmer';
                
                const voiceProviderEl = document.getElementById('voiceProvider');
                if (voiceProviderEl) voiceProviderEl.value = config.VOICE_PROVIDER || 'openai';
                
                // useElevenlabs checkbox removed
                const elevenLabsVoiceEl = document.getElementById('elevenLabsVoice');
                if (elevenLabsVoiceEl) {
                    elevenLabsVoiceEl.value = config.ELEVENLABS_VOICE_ID || 'EXAVITQu4vr4xnSDxMaL';
                }
                
                const googleVoiceEl = document.getElementById('googleVoice');
                if (googleVoiceEl) {
                    googleVoiceEl.value = config.GOOGLE_VOICE || 'en-GB-Neural2-A';
                }
                
                const playhtVoiceEl = document.getElementById('playhtVoice');
                if (playhtVoiceEl) {
                    playhtVoiceEl.value = config.PLAYHT_VOICE_ID || 's3://voice-cloning-zero-shot/d9ff78ba-d016-47f6-b0ef-dd630f59414e/female-cs/manifest.json';
                }
                
                const responseLatencyEl = document.getElementById('responseLatency');
                if (responseLatencyEl) responseLatencyEl.value = config.RESPONSE_LATENCY || 500;
                
                const businessInfoEl = document.getElementById('businessInfo');
                if (businessInfoEl) businessInfoEl.value = config.BUSINESS_INFO || '';
                
                const agentPersonalityEl = document.getElementById('agentPersonality');
                if (agentPersonalityEl) agentPersonalityEl.value = config.AGENT_PERSONALITY || '';
                
                const agentInstructionsEl = document.getElementById('agentInstructions');
                if (agentInstructionsEl) agentInstructionsEl.value = config.AGENT_INSTRUCTIONS;

                const callGreetingEl = document.getElementById('callGreeting');
                if (callGreetingEl) callGreetingEl.value = config.CALL_GREETING || '';

                const transferNumberEl = document.getElementById('transferNumber');
                if (transferNumberEl) transferNumberEl.value = config.TRANSFER_NUMBER || '';

                // Transfer instructions
                const transferInstructionsEl = document.getElementById('transferInstructions');
                if (transferInstructionsEl) transferInstructionsEl.value = config.TRANSFER_INSTRUCTIONS || '';
                
                const headerTransferNumberEl = document.getElementById('headerTransferNumber');
                if (headerTransferNumberEl) headerTransferNumberEl.value = config.TRANSFER_NUMBER || '';
                
                // Load calendar booking setting
                const calendarBookingEl = document.getElementById('calendarBookingEnabled');
                if (calendarBookingEl) calendarBookingEl.checked = config.CALENDAR_BOOKING_ENABLED !== false;
                updateCalendarBookingStatus();
                
                // Update assigned phone number in numbers tab
                const assignedNumberEl = document.getElementById('assignedPhoneNumber');
                if (assignedNumberEl) {
                    assignedNumberEl.textContent = config.PHONE_NUMBER || 'Not assigned';
                    assignedNumberEl.style.color = config.PHONE_NUMBER ? '#667eea' : 'rgba(255,255,255,0.4)';
                }
                
                // Update phone number in dashboard stats
                const statsPhoneEl = document.getElementById('statsPhoneNumber');
                if (statsPhoneEl) {
                    statsPhoneEl.textContent = config.PHONE_NUMBER || 'Not assigned yet';
                }
                
                // Update header phone number
                const headerPhoneEl = document.getElementById('userPhone');
                if (headerPhoneEl && config.PHONE_NUMBER) {
                    headerPhoneEl.textContent = `üìû ${config.PHONE_NUMBER}`;
                }
                
                // Load voice provider preference and show correct section
                await loadVoiceProviderPreference();
                
                // Load available owned numbers for assignment
                await loadAvailableOwnedNumbers();
                
                // Load billing config to show calendar booking cost
                await loadBillingConfig();
                
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Store voice selections in memory
        const savedVoiceSelections = {
            openai: null,
            google: null,
            elevenlabs: null,
            playht: null,
            provider: null
        };

        // Update calendar booking status display
        function updateCalendarBookingStatus() {
            const checkbox = document.getElementById('calendarBookingEnabled');
            const statusDiv = document.getElementById('calendarBookingStatus');
            
            if (checkbox && statusDiv) {
                if (checkbox.checked) {
                    statusDiv.style.display = 'none';
                } else {
                    statusDiv.style.display = 'block';
                }
            }
        }

        // Load billing configuration
        async function loadBillingConfig() {
            try {
                const response = await fetch('/api/billing-config');
                const config = await response.json();
                
                // Display calendar booking cost
                const bookingCostEl = document.getElementById('bookingCreditCost');
                if (bookingCostEl) {
                    bookingCostEl.textContent = config.credits_per_calendar_booking || 10;
                }
                
            } catch (error) {
                console.error('Failed to load billing config:', error);
            }
        }

        // Load billing history
        async function loadBillingHistory() {
            console.log('Loading billing history...');
            try {
                const response = await fetch('/api/billing-history', {
                    headers: getAuthHeaders()
                });
                console.log('Billing API response status:', response.status);
                const data = await response.json();
                console.log('Billing data received:', data);
                
                // Update balance and totals
                document.getElementById('billingCurrentBalance').textContent = data.current_balance || 0;
                document.getElementById('billingTotalUsed').textContent = data.total_used || 0;
                
                // Update pricing
                document.getElementById('pricePerCall').textContent = data.pricing.per_call || 5;
                document.getElementById('pricePerMinute').textContent = data.pricing.per_minute || 2;
                document.getElementById('pricePerBooking').textContent = data.pricing.per_booking || 10;
                
                console.log('Updated balance and pricing');
                
                // Display transactions
                const historyContent = document.getElementById('billingHistoryContent');
                console.log('History content element:', historyContent);
                console.log('Transactions count:', data.transactions ? data.transactions.length : 0);
                console.log('Transactions:', data.transactions);
                
                if (!historyContent) {
                    console.error('ERROR: billingHistoryContent element not found!');
                    return;
                }
                
                if (!data.transactions || data.transactions.length === 0) {
                    historyContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.4;">üìä</div>
                            <div style="font-size: 18px; color: rgba(255,255,255,0.6);">No billing activity yet</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.4); margin-top: 8px;">Your usage and charges will appear here</div>
                        </div>
                    `;
                    return;
                }
                
                // Create table
                console.log('Creating transaction table...');
                try {
                    historyContent.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                                    <th style="padding: 15px; text-align: left; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 700; text-transform: uppercase;">Date</th>
                                    <th style="padding: 15px; text-align: left; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 700; text-transform: uppercase;">Type</th>
                                    <th style="padding: 15px; text-align: left; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 700; text-transform: uppercase;">Description</th>
                                    <th style="padding: 15px; text-align: left; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 700; text-transform: uppercase;">Duration</th>
                                    <th style="padding: 15px; text-align: right; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 700; text-transform: uppercase;">Credits</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.transactions.map(trans => {
                                    const date = new Date(trans.date);
                                    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                                    const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                                    
                                    const typeIcon = trans.type === 'call' ? 'üìû' : 'üìÖ';
                                    const typeLabel = trans.type === 'call' ? 'Call' : 'Booking';
                                    const typeColor = trans.type === 'call' ? '#667eea' : '#f1c40f';
                                    
                                    const duration = trans.duration ? `${Math.floor(trans.duration / 60)}m ${trans.duration % 60}s` : '-';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
                                            <td style="padding: 18px; color: rgba(255,255,255,0.8); font-size: 14px;">
                                                <div style="font-weight: 600;">${formattedDate}</div>
                                                <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 2px;">${formattedTime}</div>
                                            </td>
                                            <td style="padding: 18px;">
                                                <span style="background: ${typeColor}22; border: 1px solid ${typeColor}44; padding: 6px 12px; border-radius: 6px; color: ${typeColor}; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                                                    ${typeIcon} ${typeLabel}
                                                </span>
                                            </td>
                                            <td style="padding: 18px; color: rgba(255,255,255,0.9); font-size: 14px;">${trans.description}</td>
                                            <td style="padding: 18px; color: rgba(255,255,255,0.7); font-size: 14px;">${duration}</td>
                                            <td style="padding: 18px; text-align: right; color: #e74c3c; font-size: 16px; font-weight: 700;">-${trans.credits}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                    console.log('Transaction table created successfully');
                } catch (tableError) {
                    console.error('Error creating transaction table:', tableError);
                    historyContent.innerHTML = `<div style="color: red;">Error rendering transactions: ${tableError.message}</div>`;
                }
                
            } catch (error) {
                console.error('Failed to load billing history:', error);
                document.getElementById('billingHistoryContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(231, 76, 60, 0.8);">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <div style="font-size: 16px;">Failed to load billing history</div>
                    </div>
                `;
            }
        }

        // Open billing modal
        async function openBillingModal() {
            const modal = document.getElementById('billingModal');
            modal.style.display = 'flex';
            
            try {
                const response = await fetch('/api/billing-history', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                // Update summary
                document.getElementById('modalCurrentBalance').textContent = Math.round(data.current_balance || 0);
                document.getElementById('modalTotalUsed').textContent = Math.round(data.total_used || 0);
                document.getElementById('modalPricePerCall').textContent = Math.round(data.pricing.per_call || 5);
                document.getElementById('modalPricePerMinute').textContent = Math.round(data.pricing.per_minute || 2);
                
                // Filter only calls (not bookings)
                const calls = data.transactions ? data.transactions.filter(t => t.type === 'call') : [];
                document.getElementById('modalTotalCalls').textContent = calls.length;
                
                const callList = document.getElementById('billingCallList');
                
                if (calls.length === 0) {
                    callList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.4);">
                            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.4;">üìû</div>
                            <div style="font-size: 16px;">No call records yet</div>
                        </div>
                    `;
                    return;
                }
                
                // Display calls - one line per call
                callList.innerHTML = calls.map((call, index) => {
                    const date = new Date(call.date);
                    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    const duration = call.duration ? `${Math.floor(call.duration / 60)}m ${call.duration % 60}s` : '0s';
                    
                    return `
                        <div onclick="showCreditBreakdown(${index})" style="padding: 15px 20px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.background='rgba(243, 156, 18, 0.15)'; this.style.borderColor='rgba(243, 156, 18, 0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'; this.style.borderColor='rgba(255,255,255,0.05)'">
                            <div style="flex: 1;">
                                <span style="color: rgba(255,255,255,0.9); font-weight: 600; font-size: 14px;">${call.description}</span>
                                <span style="color: rgba(255,255,255,0.5); font-size: 13px; margin-left: 15px;">${formattedDate} at ${formattedTime}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <span style="color: rgba(255,255,255,0.6); font-size: 13px; min-width: 60px; text-align: right;">‚è±Ô∏è ${duration}</span>
                                <span style="color: #e74c3c; font-weight: 700; font-size: 15px; min-width: 80px; text-align: right;">-${Math.round(call.credits)} credits</span>
                                <span style="color: rgba(255,255,255,0.4); font-size: 18px;">‚ÑπÔ∏è</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Store calls data for breakdown popup
                window.billingCalls = calls;
                window.billingPricing = data.pricing;
                
            } catch (error) {
                console.error('Failed to load billing data:', error);
                document.getElementById('billingCallList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(231, 76, 60, 0.8);">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <div style="font-size: 16px;">Failed to load call records</div>
                    </div>
                `;
            }
        }

        // Close billing modal
        function closeBillingModal() {
            document.getElementById('billingModal').style.display = 'none';
        }

        // Show credit breakdown popup
        function showCreditBreakdown(callIndex) {
            const call = window.billingCalls[callIndex];
            const pricing = window.billingPricing;
            
            if (!call || !pricing) return;
            
            const date = new Date(call.date);
            const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            
            // Calculate breakdown
            const connectionFee = pricing.per_call;
            const minutes = call.duration ? (call.duration / 60).toFixed(2) : 0;
            const durationCharge = minutes * pricing.per_minute;
            
            // Parse description to extract booking/task/voice charges
            let bookingCharge = 0;
            let taskCharge = 0;
            let voiceCharge = 0;
            let salesCharge = 0;
            let transferCharge = 0;
            
            if (call.description && call.description.includes(' + ')) {
                const parts = call.description.split(' + ');
                console.log('Description parts:', parts);
                parts.forEach(part => {
                    const match = part.match(/([\d.]+) credits for (bookings|tasks|advanced voice|sales detection|transfer)/);
                    if (match) {
                        const amount = parseFloat(match[1]);
                        const type = match[2];
                        console.log('Matched:', type, '=', amount);
                        if (type === 'bookings') bookingCharge = amount;
                        else if (type === 'tasks') taskCharge = amount;
                        else if (type === 'advanced voice') voiceCharge = amount;
                        else if (type === 'sales detection') salesCharge = amount;
                        else if (type === 'transfer') transferCharge = amount;
                    }
                });
            }
            
            console.log('Transfer charge extracted:', transferCharge);
            
            // Build charges table
            let chargesHTML = '';
            
            // Connection Fee
            chargesHTML += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                        <div style="font-weight: 600;">üìû Connection Fee</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">One-time per call</div>
                    </td>
                    <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #667eea; text-align: right;">${Math.round(connectionFee)}</td>
                </tr>
            `;
            
            // Duration Charge
            chargesHTML += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                        <div style="font-weight: 600;">‚è±Ô∏è Duration Charge</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">${minutes} min √ó ${pricing.per_minute} credits/min</div>
                    </td>
                    <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #2ecc71; text-align: right;">${Math.round(durationCharge)}</td>
                </tr>
            `;
            
            // Booking Charge (if applicable)
            if (bookingCharge > 0) {
                chargesHTML += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                            <div style="font-weight: 600;">üìÖ Calendar Booking</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">AI-created appointment</div>
                        </td>
                        <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #f39c12; text-align: right;">${Math.round(bookingCharge)}</td>
                    </tr>
                `;
            }
            
            // Task Charge (if applicable)
            if (taskCharge > 0) {
                chargesHTML += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                            <div style="font-weight: 600;">‚úÖ Task Extraction</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">AI-extracted tasks</div>
                        </td>
                        <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #9b59b6; text-align: right;">${Math.round(taskCharge)}</td>
                    </tr>
                `;
            }
            
            // Advanced Voice Charge (if applicable)
            if (voiceCharge > 0) {
                chargesHTML += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                            <div style="font-weight: 600;">üéôÔ∏è Advanced Voice</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">Premium voice quality</div>
                        </td>
                        <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #3498db; text-align: right;">${Math.round(voiceCharge)}</td>
                    </tr>
                `;
            }
            
            // Sales Detection Charge (if applicable)
            if (salesCharge > 0) {
                chargesHTML += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                            <div style="font-weight: 600;">üö´ Sales Detection</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">AI-powered sales call screening</div>
                        </td>
                        <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #e74c3c; text-align: right;">${Math.round(salesCharge)}</td>
                    </tr>
                `;
            }
            
            // Transfer Charge (if applicable)
            if (transferCharge > 0) {
                chargesHTML += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px 0; font-size: 14px; color: rgba(255,255,255,0.9);">
                            <div style="font-weight: 600;">üìû Call Transfer</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">5 base + 3 credits/min transfer time</div>
                        </td>
                        <td style="padding: 10px 0; font-size: 16px; font-weight: 700; color: #f39c12; text-align: right;">${Math.round(transferCharge)}</td>
                    </tr>
                `;
            }
            
            // Extract caller number from description (first part before '+')
            const callerMatch = call.description.match(/Call from ([^\+]+)/);
            const callerNumber = callerMatch ? callerMatch[1].trim() : 'Unknown';
            
            // Update popup content
            document.getElementById('breakdownCallDetails').textContent = `Call from ${callerNumber} - ${formattedDate} at ${formattedTime}`;
            document.getElementById('breakdownCharges').innerHTML = chargesHTML;
            document.getElementById('breakdownTotal').textContent = `${Math.round(call.credits)} credits`;
            
            // Show popup
            document.getElementById('creditBreakdownPopup').style.display = 'block';
        }

        // Close breakdown popup
        function closeBreakdownPopup() {
            document.getElementById('creditBreakdownPopup').style.display = 'none';
        }

        // Load available owned numbers for assignment
        async function loadAvailableOwnedNumbers() {
            try {
                const response = await fetch('/api/owned-numbers', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.error('Failed to fetch owned numbers');
                    return;
                }
                
                const data = await response.json();
                const phoneNumberSelect = document.getElementById('phoneNumber');
                
                // Clear existing options
                phoneNumberSelect.innerHTML = '<option value="">-- Select a Number --</option>';
                
                if (data.success && data.numbers && data.numbers.length > 0) {
                    // Get current assigned number
                    const currentNumber = phoneNumberSelect.dataset.currentNumber || '';
                    
                    // Add available numbers
                    let hasAvailable = false;
                    data.numbers.forEach(number => {
                        // Show available numbers OR the currently assigned number
                        if (number.available || number.number === currentNumber) {
                            const option = document.createElement('option');
                            option.value = number.number;
                            option.textContent = `${number.number} (${number.country || 'Unknown'})`;
                            if (number.number === currentNumber) {
                                option.textContent += ' - Currently Assigned';
                                option.selected = true;
                            }
                            phoneNumberSelect.appendChild(option);
                            hasAvailable = true;
                        }
                    });
                    
                    if (!hasAvailable && !currentNumber) {
                        phoneNumberSelect.innerHTML = '<option value="">No available numbers - Purchase in Phone Numbers tab</option>';
                    }
                } else {
                    phoneNumberSelect.innerHTML = '<option value="">No numbers found - Purchase in Phone Numbers tab</option>';
                }
                
            } catch (error) {
                console.error('Error loading owned numbers:', error);
                const phoneNumberSelect = document.getElementById('phoneNumber');
                phoneNumberSelect.innerHTML = '<option value="">Error loading numbers</option>';
            }
        }

        // Refresh available numbers
        async function refreshAvailableNumbers() {
            showMessage('üîÑ Refreshing available numbers...', 'info');
            await loadAvailableOwnedNumbers();
            showMessage('‚úÖ Numbers refreshed', 'success');
        }

        async function autoAssignNumber() {
            const resultDiv = document.getElementById('autoAssignResult');
            const messageDiv = document.getElementById('autoAssignMessage');
            
            // Show loading state
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(52, 152, 219, 0.2)';
            resultDiv.style.border = '1px solid rgba(52, 152, 219, 0.4)';
            messageDiv.innerHTML = '<div style="text-align: center;"><span style="font-size: 24px;">üîÑ</span><br><span style="color: rgba(255,255,255,0.8);">Searching for available numbers...</span></div>';
            
            try {
                // Fetch all owned numbers
                const response = await fetch('/api/owned-numbers', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch numbers');
                }
                
                const data = await response.json();
                
                if (!data.success || !data.numbers || data.numbers.length === 0) {
                    // No numbers found
                    resultDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                    resultDiv.style.border = '1px solid rgba(231, 76, 60, 0.4)';
                    messageDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <div style="font-size: 18px; font-weight: 600; color: #e74c3c; margin-bottom: 8px;">No Numbers Available</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">There are no Vonage numbers available to assign. Please contact your administrator to purchase numbers.</div>
                        </div>
                    `;
                    return;
                }
                
                // Find first available number
                const availableNumber = data.numbers.find(num => num.available);
                
                if (!availableNumber) {
                    // All numbers are taken
                    resultDiv.style.background = 'rgba(230, 126, 34, 0.2)';
                    resultDiv.style.border = '1px solid rgba(230, 126, 34, 0.4)';
                    messageDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                            <div style="font-size: 18px; font-weight: 600; color: #e67e22; margin-bottom: 8px;">All Numbers Assigned</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">All ${data.numbers.length} available numbers are currently assigned to other users. Please contact your administrator.</div>
                        </div>
                    `;
                    return;
                }
                
                // Assign the number to current user
                const phoneNumberSelect = document.getElementById('phoneNumber');
                phoneNumberSelect.value = availableNumber.number;
                
                // Show success message
                resultDiv.style.background = 'rgba(46, 204, 113, 0.2)';
                resultDiv.style.border = '1px solid rgba(46, 204, 113, 0.4)';
                messageDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                        <div style="font-size: 18px; font-weight: 600; color: #2ecc71; margin-bottom: 8px;">Number Assigned!</div>
                        <div style="font-size: 24px; font-weight: 700; color: #667eea; margin: 15px 0; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">${availableNumber.number}</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">Country: ${availableNumber.country} | Type: ${availableNumber.type}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6); padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid #f39c12;">
                            <strong>‚ö†Ô∏è Important:</strong> Click "üíæ Save Configuration" below to confirm this assignment.
                        </div>
                    </div>
                `;
                
                // Auto-scroll to save button
                setTimeout(() => {
                    document.querySelector('.btn-primary').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
                
            } catch (error) {
                console.error('Auto-assign error:', error);
                resultDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                resultDiv.style.border = '1px solid rgba(231, 76, 60, 0.4)';
                messageDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <div style="font-size: 18px; font-weight: 600; color: #e74c3c; margin-bottom: 8px;">Error</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.7);">${error.message}</div>
                    </div>
                `;
            }
        }

        async function startNewAccountSetup() {
            console.log('Starting new account setup...');
            const modal = document.getElementById('newAccountModal');
            const progressSection = document.getElementById('progressSection');
            const resultSection = document.getElementById('resultSection');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const resultContent = document.getElementById('resultContent');
            
            console.log('Modal element:', modal);
            
            // Show modal
            modal.style.display = 'flex';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            progressBar.style.width = '0%';
            
            console.log('Modal displayed');
            console.log('Progress bar element:', progressBar);
            console.log('Progress text element:', progressText);
            
            if (!progressBar || !progressText) {
                console.error('ERROR: Progress elements not found!');
                alert('Error: Progress bar elements not found. Please contact support.');
                return;
            }
            
            // Simulate progress with stages
            const stages = [
                { percent: 20, text: 'Connecting to Vonage...', duration: 500 },
                { percent: 40, text: 'Fetching available numbers...', duration: 800 },
                { percent: 60, text: 'Checking assignments...', duration: 600 },
                { percent: 80, text: 'Finding best match...', duration: 700 },
                { percent: 100, text: 'Finalizing...', duration: 500 }
            ];
            
            console.log('Starting progress animation...');
            // Animate progress bar
            try {
                for (const stage of stages) {
                    await new Promise(resolve => {
                        progressText.textContent = stage.text;
                        setTimeout(() => {
                            progressBar.style.width = stage.percent + '%';
                            resolve();
                        }, 100);
                    });
                    await new Promise(resolve => setTimeout(resolve, stage.duration));
                }
            } catch (error) {
                console.error('Error during progress animation:', error);
            }
            
            console.log('Progress animation complete');
            
            // Fetch actual number
            try {
                console.log('Fetching owned numbers...');
                const response = await fetch('/api/owned-numbers', {
                    headers: getAuthHeaders()
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch numbers');
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                console.log('Available numbers:', data.numbers.filter(num => num.available));
                console.log('All numbers with availability:', data.numbers.map(num => ({ number: num.number, available: num.available })));
                
                // Hide progress, show result
                progressSection.style.display = 'none';
                resultSection.style.display = 'block';
                
                if (!data.success || !data.numbers || data.numbers.length === 0) {
                    // No numbers found
                    resultContent.innerHTML = `
                        <div style="text-align: center; animation: fadeIn 0.5s ease;">
                            <div style="font-size: 80px; margin-bottom: 25px;">üòî</div>
                            <h2 style="font-size: 32px; font-weight: 800; color: #e74c3c; margin-bottom: 16px;">No Numbers Available</h2>
                            <p style="font-size: 16px; color: rgba(255,255,255,0.7); line-height: 1.6; margin-bottom: 30px;">
                                Unfortunately, there are no phone numbers available at this time.<br>
                                Please contact your administrator to purchase Vonage numbers.
                            </p>
                            <button onclick="closeNewAccountModal()" style="padding: 14px 32px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); transition: all 0.3s;">
                                Close
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const availableNumber = data.numbers.find(num => num.available);
                
                if (!availableNumber) {
                    // All numbers taken
                    resultContent.innerHTML = `
                        <div style="text-align: center; animation: fadeIn 0.5s ease;">
                            <div style="font-size: 80px; margin-bottom: 25px;">üìµ</div>
                            <h2 style="font-size: 32px; font-weight: 800; color: #e67e22; margin-bottom: 16px;">All Numbers Assigned</h2>
                            <p style="font-size: 16px; color: rgba(255,255,255,0.7); line-height: 1.6; margin-bottom: 30px;">
                                All ${data.numbers.length} available numbers are currently in use.<br>
                                Please contact your administrator for assistance.
                            </p>
                            <button onclick="closeNewAccountModal()" style="padding: 14px 32px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 6px 20px rgba(230, 126, 34, 0.4); transition: all 0.3s;">
                                Close
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Success! Show beautiful result
                resultContent.innerHTML = `
                    <div style="text-align: center; animation: fadeIn 0.6s ease;">
                        <div style="font-size: 80px; margin-bottom: 25px; animation: bounce 1s ease;">üéâ</div>
                        <h2 style="font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px;">
                            Your Number is Ready!
                        </h2>
                        
                        <!-- Beautiful Number Display Box -->
                        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 20px; padding: 35px; margin: 30px 0; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%); animation: pulse 3s ease-in-out infinite;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="font-size: 14px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 12px;">Your Phone Number</div>
                                <div style="font-size: 48px; font-weight: 900; color: #667eea; letter-spacing: 2px; margin-bottom: 15px; text-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);">
                                    ${availableNumber.number}
                                </div>
                                <div style="display: inline-flex; gap: 20px; margin-top: 10px;">
                                    <div style="background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 8px;">
                                        <span style="font-size: 12px; color: rgba(255,255,255,0.5);">Country:</span>
                                        <span style="font-size: 14px; color: white; font-weight: 600; margin-left: 6px;">${availableNumber.country}</span>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 8px;">
                                        <span style="font-size: 12px; color: rgba(255,255,255,0.5);">Type:</span>
                                        <span style="font-size: 14px; color: white; font-weight: 600; margin-left: 6px;">${availableNumber.type}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <p style="font-size: 15px; color: rgba(255,255,255,0.7); line-height: 1.6; margin-bottom: 25px;">
                            This number has been assigned to your account.<br>
                            Click continue to complete your setup.
                        </p>
                        
                        <button onclick="completeNewAccountSetup('${availableNumber.number}')" style="padding: 16px 40px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 18px; font-weight: 700; box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.transform='translateY(-2px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                            Continue ‚Üí
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error:', error);
                progressSection.style.display = 'none';
                resultSection.style.display = 'block';
                resultContent.innerHTML = `
                    <div style="text-align: center; animation: fadeIn 0.5s ease;">
                        <div style="font-size: 80px; margin-bottom: 25px;">‚ùå</div>
                        <h2 style="font-size: 32px; font-weight: 800; color: #e74c3c; margin-bottom: 16px;">Setup Failed</h2>
                        <p style="font-size: 16px; color: rgba(255,255,255,0.7); margin-bottom: 30px;">${error.message}</p>
                        <button onclick="closeNewAccountModal()" style="padding: 14px 32px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 16px; font-weight: 700;">
                            Close
                        </button>
                    </div>
                `;
            }
        }

        function closeNewAccountModal() {
            document.getElementById('newAccountModal').style.display = 'none';
        }

        async function completeNewAccountSetup(phoneNumber) {
            // Close modal first
            closeNewAccountModal();
            
            // Show loading message
            showMessage('üíæ Saving your account configuration...', 'info');
            
            try {
                // Get current values from form
                const agentName = document.getElementById('agentName').value || 'Julie';
                const voiceProvider = document.getElementById('voiceProvider').value || 'openai';
                const agentVoice = document.getElementById('agentVoice').value || 'shimmer';
                const businessInfo = document.getElementById('businessInfo').value || '';
                const agentPersonality = document.getElementById('agentPersonality').value || '';
                const agentInstructions = document.getElementById('agentInstructions').value || '';
                const callGreeting = document.getElementById('callGreeting')?.value || '';
                
                // Save voice provider first
                const voiceResponse = await fetch('/api/update-voice-provider', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        user_id: parseInt(localStorage.getItem('user_id')),
                        voice_provider: voiceProvider,
                        openai_voice: agentVoice,
                        elevenlabs_voice_id: 'EXAVITQu4vr4xnSDxMaL',
                        cartesia_voice_id: 'a0e99841-438c-4a64-b679-ae501e7d6091',
                        google_voice: 'en-GB-Neural2-A',
                        playht_voice_id: 's3://voice-cloning-zero-shot/d9ff78ba-d016-47f6-b0ef-dd630f59414e/female-cs/manifest.json'
                    })
                });
                
                if (!voiceResponse.ok) {
                    throw new Error('Failed to save voice settings');
                }
                
                // Save main configuration with phone number
                const configResponse = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        AGENT_NAME: agentName,
                        PHONE_NUMBER: phoneNumber,
                        VOICE: agentVoice,
                        USE_ELEVENLABS: 0,
                        ELEVENLABS_VOICE_ID: 'EXAVITQu4vr4xnSDxMaL',
                        RESPONSE_LATENCY: 500,
                        BUSINESS_INFO: businessInfo,
                        AGENT_PERSONALITY: agentPersonality,
                        AGENT_INSTRUCTIONS: agentInstructions,
                        CALL_GREETING: callGreeting,
                        CALENDAR_BOOKING_ENABLED: document.getElementById('calendarBookingEnabled').checked
                    })
                });
                
                if (!configResponse.ok) {
                    throw new Error('Failed to save configuration');
                }
                
                // Update the UI
                const phoneNumberInput = document.getElementById('phoneNumber');
                if (phoneNumberInput) {
                    phoneNumberInput.value = phoneNumber;
                }
                
                // Update header with new phone number
                document.getElementById('userPhone').textContent = `üìû ${phoneNumber}`;
                
                // Reload config to reflect changes
                await loadConfig();
                
                // Switch to dashboard
                switchMainTab('dashboard');
                
                // Show success message
                showMessage('‚úÖ Your account is ready! Phone number assigned and saved.', 'success');
                
                // Refresh dashboard to show new number
                await loadDashboard();
                
            } catch (error) {
                console.error('Error during account setup:', error);
                showMessage('‚ùå Failed to complete setup. Please try again.', 'error');
                // Switch to config tab so user can manually save if needed
                switchMainTab('config');
            }
        }

        // Load voice provider preference from database
        async function loadVoiceProviderPreference() {
            try {
                const response = await fetch('/api/config', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                // Store all voice selections in memory
                savedVoiceSelections.provider = data.VOICE_PROVIDER || 'openai';
                savedVoiceSelections.openai = data.VOICE || 'shimmer';
                savedVoiceSelections.google = data.GOOGLE_VOICE || 'en-GB-Neural2-A';
                savedVoiceSelections.elevenlabs = data.ELEVENLABS_VOICE_ID || 'EXAVITQu4vr4xnSDxMaL';
                savedVoiceSelections.playht = data.PLAYHT_VOICE_ID || 's3://voice-cloning-zero-shot/d9ff78ba-d016-47f6-b0ef-dd630f59414e/female-cs/manifest.json';
                savedVoiceSelections.speechmatics = data.SPEECHMATICS_VOICE_ID || 'sarah';
                
                console.log('Loaded voice settings:', savedVoiceSelections);
                
                // Set voice provider dropdown
                document.getElementById('voiceProvider').value = savedVoiceSelections.provider;
                
                // Set all voice dropdowns to their saved values
                document.getElementById('agentVoice').value = savedVoiceSelections.openai;
                document.getElementById('googleVoice').value = savedVoiceSelections.google;
                document.getElementById('elevenLabsVoice').value = savedVoiceSelections.elevenlabs;
                document.getElementById('playhtVoice').value = savedVoiceSelections.playht;
                document.getElementById('speechmaticsVoice').value = savedVoiceSelections.speechmatics;
                
                // Add change listeners to remember manual selections
                document.getElementById('agentVoice').addEventListener('change', (e) => {
                    savedVoiceSelections.openai = e.target.value;
                });
                document.getElementById('googleVoice').addEventListener('change', (e) => {
                    savedVoiceSelections.google = e.target.value;
                });
                document.getElementById('elevenLabsVoice').addEventListener('change', (e) => {
                    savedVoiceSelections.elevenlabs = e.target.value;
                });
                document.getElementById('playhtVoice').addEventListener('change', (e) => {
                    savedVoiceSelections.playht = e.target.value;
                });
                document.getElementById('speechmaticsVoice').addEventListener('change', (e) => {
                    savedVoiceSelections.speechmatics = e.target.value;
                });
                document.getElementById('voiceProvider').addEventListener('change', (e) => {
                    savedVoiceSelections.provider = e.target.value;
                });
                
                // Show correct voice section
                await switchVoiceProvider();
                
            } catch (error) {
                console.error('Failed to load voice provider:', error);
            }
        }

        // Switch voice provider sections
        async function switchVoiceProvider() {
            const provider = document.getElementById('voiceProvider').value || 'speechmatics';
            
            // Hide all sections first
            document.getElementById('openaiVoiceSection').style.display = 'none';
            document.getElementById('googleVoiceSection').style.display = 'none';
            document.getElementById('elevenLabsVoiceSection').style.display = 'none';
            document.getElementById('playhtVoiceSection').style.display = 'none';
            document.getElementById('speechmaticsVoiceSection').style.display = 'none';
            
            // Show the selected provider section
            if (provider === 'openai') {
                document.getElementById('openaiVoiceSection').style.display = 'block';
            } else if (provider === 'speechmatics') {
                document.getElementById('speechmaticsVoiceSection').style.display = 'block';
            }
            
            // Force a repaint to ensure dropdown is visible
            await new Promise(resolve => setTimeout(resolve, 0));
        }

        // Toggle ElevenLabs voice dropdown visibility (legacy function - no longer used)
        function toggleElevenLabsVoices() {
            const useElevenlabs = document.getElementById('useElevenlabs').checked;
            const section = document.getElementById('elevenLabsVoiceSection');
            section.style.display = useElevenlabs ? 'block' : 'none';
        }

        // Test Google Cloud voice
        async function testGoogleVoice() {
            const voiceId = document.getElementById('googleVoice').value;
            const voiceSelect = document.getElementById('googleVoice');
            const voiceName = voiceSelect.options[voiceSelect.selectedIndex].text;
            
            try {
                showMessage(`üîä Testing ${voiceName}...`, 'info');
                
                const response = await fetch('/api/test-google-voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ voice_name: voiceId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate voice sample');
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                };
                
                audio.onerror = (e) => {
                    console.error('Audio playback error:', e);
                    showMessage('‚ùå Failed to play audio', 'error');
                    URL.revokeObjectURL(audioUrl);
                };
                
                try {
                    await audio.play();
                    showMessage(`‚úÖ Playing ${voiceName} sample`, 'success');
                } catch (playError) {
                    showMessage(`‚ö†Ô∏è Click here to play sample`, 'warning');
                    const messageEl = document.querySelector('.message');
                    if (messageEl) {
                        messageEl.style.cursor = 'pointer';
                        messageEl.onclick = async () => {
                            try {
                                await audio.play();
                                showMessage(`‚úÖ Playing ${voiceName} sample`, 'success');
                            } catch (e) {
                                showMessage('‚ùå Failed to play audio', 'error');
                            }
                        };
                    }
                }
                
            } catch (error) {
                console.error('Google voice test error:', error);
                showMessage(`‚ùå Failed to test voice: ${error.message}`, 'error');
            }
        }

        // Search available phone numbers
        async function searchNumbers() {
            const country = document.getElementById('numberCountry').value;
            const pattern = document.getElementById('numberPattern').value;
            const resultsDiv = document.getElementById('numberResults');
            
            try {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #667eea; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                        <p style="font-size: 16px; margin: 0;">Searching for available numbers...</p>
                    </div>
                `;
                
                const params = new URLSearchParams({ country });
                if (pattern) params.append('pattern', pattern);
                
                const sessionToken = localStorage.getItem('session_token');
                const response = await fetch(`/api/available-numbers?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.numbers && data.numbers.length > 0) {
                    resultsDiv.innerHTML = data.numbers.map(num => {
                        const flags = { GB: 'üá¨üáß', US: 'üá∫üá∏', CA: 'üá®üá¶', AU: 'üá¶üá∫', FR: 'üá´üá∑', DE: 'üá©üá™', ES: 'üá™üá∏', IT: 'üáÆüáπ' };
                        const flag = flags[num.country] || 'üåç';
                        const price = parseFloat(num.cost || '0').toFixed(2);
                        
                        return `
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="font-size: 32px;">${flag}</span>
                                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        ${num.country}
                                    </span>
                                </div>
                                <div style="font-size: 20px; font-weight: 600; color: #333; margin-bottom: 8px; font-family: monospace;">
                                    +${num.msisdn}
                                </div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 15px;">
                                    ${num.type === '1' ? 'Mobile' : 'Landline'} ‚Ä¢ ¬£${price}/month
                                </div>
                                <button onclick="purchaseNumber('${num.msisdn}', '${num.country}')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                    üõí Purchase Number
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #999; grid-column: 1 / -1;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                            <p style="font-size: 16px; margin: 0;">No numbers found. Try a different country or pattern.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Search numbers error:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #e74c3c; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <p style="font-size: 16px; margin: 0;">Error searching numbers: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Purchase a phone number
        async function purchaseNumber(msisdn, country) {
            if (!confirm(`Are you sure you want to purchase +${msisdn}?\n\nThis will be charged to your Vonage account.`)) {
                return;
            }
            
            try {
                showMessage('üõí Purchasing number...', 'info');
                
                const response = await fetch('/api/purchase-number', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ msisdn, country })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to purchase number');
                }
                
                showMessage(`‚úÖ Successfully purchased +${msisdn}!`, 'success');
                
                // Update the phone number display in the config if it exists
                const phoneDisplay = document.querySelector('.info-card:has(.info-label:contains("Phone Number")) .info-value');
                if (phoneDisplay) {
                    phoneDisplay.textContent = `+${msisdn}`;
                }
                
                // Refresh the search results
                setTimeout(() => searchNumbers(), 2000);
                
            } catch (error) {
                console.error('Purchase number error:', error);
                showMessage(`‚ùå Failed to purchase number: ${error.message}`, 'error');
            }
        }

        // Test OpenAI voice
        async function testOpenAIVoice() {
            const voiceSelect = document.getElementById('agentVoice');
            const voiceName = voiceSelect.value;
            const voiceLabel = voiceSelect.options[voiceSelect.selectedIndex].text.split(' (')[0];
            
            try {
                showMessage(`üîä Testing ${voiceLabel} voice...`, 'info');
                
                const response = await fetch('/api/test-openai-voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ voice: voiceName })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate voice sample');
                }
                
                const audioBlob = await response.blob();
                console.log('Audio blob received:', audioBlob.size, 'bytes, type:', audioBlob.type);
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                // Handle cleanup
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    console.log('Audio playback completed');
                };
                
                audio.onerror = (e) => {
                    console.error('Audio playback error:', e);
                    showMessage('‚ùå Failed to play audio. Check browser console.', 'error');
                    URL.revokeObjectURL(audioUrl);
                };
                
                // Try to play - handle autoplay restrictions
                try {
                    await audio.play();
                    showMessage(`‚úÖ Playing ${voiceLabel} voice sample`, 'success');
                } catch (playError) {
                    console.error('Autoplay prevented:', playError);
                    showMessage(`‚ö†Ô∏è Click here to play ${voiceLabel} sample`, 'warning');
                    
                    // Add click handler to play on user interaction
                    const messageEl = document.querySelector('.message');
                    if (messageEl) {
                        messageEl.style.cursor = 'pointer';
                        messageEl.onclick = async () => {
                            try {
                                await audio.play();
                                showMessage(`‚úÖ Playing ${voiceLabel} voice sample`, 'success');
                            } catch (e) {
                                console.error('Play error:', e);
                                showMessage('‚ùå Failed to play audio', 'error');
                            }
                        };
                    }
                }
                
            } catch (error) {
                console.error('Voice test error:', error);
                showMessage(`‚ùå Failed to test voice: ${error.message}`, 'error');
            }
        }

        // Test ElevenLabs voice
        async function testElevenLabsVoice() {
            const voiceId = document.getElementById('elevenLabsVoice').value;
            const voiceSelect = document.getElementById('elevenLabsVoice');
            const voiceName = voiceSelect.options[voiceSelect.selectedIndex].text.split(' (')[0];
            
            try {
                showMessage(`üîä Testing ${voiceName} voice...`, 'info');
                
                const response = await fetch('/api/test-elevenlabs-voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ voice_id: voiceId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate voice sample');
                }
                
                const audioBlob = await response.blob();
                console.log('Audio blob received:', audioBlob.size, 'bytes, type:', audioBlob.type);
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                // Handle cleanup
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    console.log('Audio playback completed');
                };
                
                audio.onerror = (e) => {
                    console.error('Audio playback error:', e);
                    showMessage('‚ùå Failed to play audio. Check browser console.', 'error');
                    URL.revokeObjectURL(audioUrl);
                };
                
                // Try to play - handle autoplay restrictions
                try {
                    await audio.play();
                    showMessage(`‚úÖ Playing ${voiceName} voice sample`, 'success');
                } catch (playError) {
                    console.error('Autoplay prevented:', playError);
                    showMessage(`‚ö†Ô∏è Click here to play ${voiceName} sample`, 'warning');
                    
                    // Add click handler to play on user interaction
                    const messageEl = document.querySelector('.message');
                    if (messageEl) {
                        messageEl.style.cursor = 'pointer';
                        messageEl.onclick = async () => {
                            try {
                                await audio.play();
                                showMessage(`‚úÖ Playing ${voiceName} voice sample`, 'success');
                            } catch (e) {
                                console.error('Play error:', e);
                                showMessage('‚ùå Failed to play audio', 'error');
                            }
                        };
                    }
                }
                
            } catch (error) {
                console.error('Voice test error:', error);
                showMessage(`‚ùå Failed to test voice: ${error.message}`, 'error');
            }
        }

        // Test Speechmatics voice
        async function testSpeechmaticsVoice() {
            const voiceId = document.getElementById('speechmaticsVoice').value;
            const voiceSelect = document.getElementById('speechmaticsVoice');
            const voiceName = voiceSelect.options[voiceSelect.selectedIndex].text.split(' (')[0];
            
            try {
                showMessage(`üîä Testing ${voiceName} voice...`, 'info');
                
                const response = await fetch('/api/test-speechmatics-voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ voice_id: voiceId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate voice sample');
                }
                
                const audioBlob = await response.blob();
                console.log('Audio blob received:', audioBlob.size, 'bytes, type:', audioBlob.type);
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                // Handle cleanup
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    console.log('Audio playback completed');
                };
                
                audio.onerror = (e) => {
                    console.error('Audio playback error:', e);
                    showMessage('‚ùå Failed to play audio. Check browser console.', 'error');
                    URL.revokeObjectURL(audioUrl);
                };
                
                // Try to play - handle autoplay restrictions
                try {
                    await audio.play();
                    showMessage(`‚úÖ Playing ${voiceName} voice sample`, 'success');
                } catch (playError) {
                    console.error('Autoplay prevented:', playError);
                    showMessage('üîä Click anywhere to play the audio sample', 'info');
                    document.addEventListener('click', async function playOnClick() {
                        try {
                            await audio.play();
                            showMessage(`‚úÖ Playing ${voiceName} voice sample`, 'success');
                            document.removeEventListener('click', playOnClick);
                        } catch (e) {
                            console.error('Play error:', e);
                            showMessage('‚ùå Failed to play audio', 'error');
                        }
                    }, { once: true });
                }
                
            } catch (error) {
                console.error('Speechmatics voice test error:', error);
                showMessage(`‚ùå Failed to test voice: ${error.message}`, 'error');
            }
        }

        // Analyze response times and optimize settings
        async function analyzeResponseTimes() {
            const analysisResult = document.getElementById('analysisResult');
            const analysisContent = document.getElementById('analysisContent');
            
            try {
                analysisContent.innerHTML = '<p style="text-align: center; color: #667eea;">üîÑ Analyzing your call performance...</p>';
                analysisResult.style.display = 'block';
                
                const response = await fetch('/api/analyze-latency', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    analysisContent.innerHTML = `
                        <p style="color: #f59e0b; font-weight: 600;">‚ö†Ô∏è ${result.message || 'No data available'}</p>
                        <p style="margin-top: 10px; font-size: 13px;">Make some phone calls first, then come back to analyze performance.</p>
                    `;
                    return;
                }
                
                const stats = result.statistics;
                const assessment = result.assessment;
                
                // Determine status color
                let statusColor = '#10b981'; // green
                let statusIcon = '‚úÖ';
                let statusText = 'Excellent';
                
                if (stats.average_response_ms > 1000) {
                    statusColor = '#ef4444'; // red
                    statusIcon = '‚ö†Ô∏è';
                    statusText = 'Needs Optimization';
                } else if (stats.average_response_ms > 800) {
                    statusColor = '#f59e0b'; // yellow
                    statusIcon = '‚ö°';
                    statusText = 'Good';
                }
                
                let html = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: ${statusColor}; margin: 0 0 10px 0;">${statusIcon} Performance: ${statusText}</h4>
                        <p style="margin: 5px 0; font-size: 14px;">
                            <strong>Average Response:</strong> ${stats.average_response_ms}ms 
                            (${assessment.performance_vs_human > 0 ? '+' : ''}${assessment.performance_vs_human}% vs human baseline)
                        </p>
                        <p style="margin: 5px 0; font-size: 13px; color: rgba(255,255,255,0.7);">
                            Analyzed ${stats.total_calls_analyzed} calls | 
                            Median: ${stats.median_response_ms}ms | 
                            95th: ${stats.p95th_percentile_ms}ms
                        </p>
                    </div>
                `;
                
                // Show AI analysis if available
                if (result.ai_analysis) {
                    const ai = result.ai_analysis;
                    html += `
                        <div style="background: rgba(102, 126, 234, 0.15); padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                            <h4 style="margin: 0 0 8px 0; color: #667eea;">ü§ñ AI Analysis</h4>
                            <p style="white-space: pre-wrap; font-size: 13px; line-height: 1.6; margin: 0;">${ai.recommendations}</p>
                        </div>
                    `;
                }
                
                // Show auto-applied changes
                if (result.auto_applied) {
                    const applied = result.auto_applied;
                    html += `
                        <div style="background: rgba(16, 185, 129, 0.15); padding: 12px; border-radius: 6px; border-left: 3px solid #10b981;">
                            <h4 style="margin: 0 0 8px 0; color: #10b981;">‚ú® Auto-Optimized!</h4>
                            <p style="font-size: 13px; margin: 5px 0;">
                                Response latency: <strong>${applied.old_latency}ms ‚Üí ${applied.new_latency}ms</strong>
                            </p>
                            ${applied.detailed_changes ? `
                                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; line-height: 1.6;">${applied.detailed_changes}</div>
                            ` : ''}
                            <p style="font-size: 12px; margin: 5px 0; color: rgba(255,255,255,0.8);">${applied.message}</p>
                            <p style="font-size: 12px; margin-top: 10px; color: rgba(255,255,255,0.7);">
                                üí° Reload this page to see the updated settings.
                            </p>
                        </div>
                    `;
                    
                    // Automatically reload config after 2 seconds
                    setTimeout(() => {
                        loadConfig();
                    }, 2000);
                } else if (!assessment.needs_optimization) {
                    html += `
                        <div style="background: rgba(16, 185, 129, 0.15); padding: 12px; border-radius: 6px; border-left: 3px solid #10b981;">
                            <p style="margin: 0; font-size: 13px;">
                                ‚úÖ Your settings are already optimized! Response times are within natural conversation range.
                            </p>
                        </div>
                    `;
                }
                
                analysisContent.innerHTML = html;
                showMessage('‚úÖ Analysis complete!', 'success');
                
            } catch (error) {
                console.error('Analysis error:', error);
                analysisContent.innerHTML = `
                    <p style="color: #ef4444;">‚ùå Analysis failed: ${error.message}</p>
                `;
                showMessage('‚ùå Failed to analyze response times', 'error');
            }
        }

        // Handle form submission
        async function handleConfigSubmit(e) {
            e.preventDefault();
            
            console.log('üîµ Form submitted - starting save...');
            
            const agentName = document.getElementById('agentName')?.value || 'Judie';
            const phoneNumber = document.getElementById('phoneNumber')?.value || '';
            const voiceProvider = document.getElementById('voiceProvider')?.value || 'openai';
            const agentVoice = document.getElementById('agentVoice')?.value || 'shimmer';
            const elevenLabsVoiceId = document.getElementById('elevenLabsVoice')?.value || 'EXAVITQu4vr4xnSDxMaL';
            const cartesiaVoiceId = 'a0e99841-438c-4a64-b679-ae501e7d6091'; // Cartesia removed
            const googleVoice = document.getElementById('googleVoice')?.value || 'en-GB-Neural2-A';
            const playhtVoiceId = document.getElementById('playhtVoice')?.value || 's3://voice-cloning-zero-shot/d9ff78ba-d016-47f6-b0ef-dd630f59414e/female-cs/manifest.json';
            const speechmaticsVoiceId = document.getElementById('speechmaticsVoice')?.value || 'sarah';
            const responseLatency = parseInt(document.getElementById('responseLatency')?.value || '500');
            const businessInfo = document.getElementById('businessInfo')?.value || '';
            const agentPersonality = document.getElementById('agentPersonality')?.value || '';
            const agentInstructions = document.getElementById('agentInstructions')?.value || '';
            const callGreeting = document.getElementById('callGreeting')?.value || '';
            const transferNumber = document.getElementById('transferNumber')?.value || '';
            const transferInstructions = document.getElementById('transferInstructions')?.value || '';
            
            console.log('üîµ Voice provider selected:', voiceProvider);
            console.log('üîµ Google voice selected:', googleVoice);
            console.log('üîµ PlayHT voice selected:', playhtVoiceId);
            console.log('üîµ Speechmatics voice selected:', speechmaticsVoiceId);
            
            try {
                showMessage('üíæ Saving voice settings...', 'info');
                
                console.log('üîµ Calling /api/update-voice-provider...');
                // Save voice provider separately
                const voiceResponse = await fetch('/api/update-voice-provider', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        user_id: parseInt(localStorage.getItem('user_id')),
                        voice_provider: voiceProvider,
                        openai_voice: agentVoice,
                        elevenlabs_voice_id: elevenLabsVoiceId,
                        cartesia_voice_id: cartesiaVoiceId,
                        google_voice: googleVoice,
                        playht_voice_id: playhtVoiceId,
                        speechmatics_voice_id: speechmaticsVoiceId
                    })
                });
                
                console.log('üîµ Voice provider response status:', voiceResponse.status);
                
                if (!voiceResponse.ok) {
                    const voiceError = await voiceResponse.json();
                    console.error('‚ùå Voice provider save failed:', voiceError);
                    showMessage('‚ùå Failed to save voice settings: ' + (voiceError.error || voiceResponse.statusText), 'error');
                    throw new Error('Voice provider save failed: ' + (voiceError.error || voiceResponse.statusText));
                }
                
                console.log('‚úÖ Voice provider saved successfully');
                showMessage('‚úÖ Voice settings saved! Saving other configuration...', 'info');
                
                console.log('üîµ Calling /api/config...');
                // Save other config
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        AGENT_NAME: agentName,
                        PHONE_NUMBER: phoneNumber,
                        VOICE: agentVoice,
                        USE_ELEVENLABS: voiceProvider === 'elevenlabs' ? 1 : 0,
                        ELEVENLABS_VOICE_ID: elevenLabsVoiceId,
                        RESPONSE_LATENCY: responseLatency,
                        BUSINESS_INFO: businessInfo,
                        AGENT_PERSONALITY: agentPersonality,
                        AGENT_INSTRUCTIONS: agentInstructions,
                        CALL_GREETING: callGreeting,
                        TRANSFER_NUMBER: transferNumber,
                        TRANSFER_INSTRUCTIONS: transferInstructions
                    })
                });
                
                console.log('üîµ Config response status:', response.status);
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Configuration saved successfully');
                    showMessage('‚úÖ All settings saved successfully! Changes will apply to new calls.', 'success');
                    
                    // Brief delay so user sees the message
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Update header with new phone number
                    if (phoneNumber) {
                        document.getElementById('userPhone').textContent = `üìû ${phoneNumber}`;
                    }
                } else {
                    console.error('‚ùå Config save failed:', result);
                    showMessage('‚ùå Failed to save: ' + result.detail, 'error');
                }
            } catch (error) {
                console.error('‚ùå Save error:', error);
                showMessage('‚ùå Error saving configuration: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Save transfer number from header input
        async function saveHeaderTransferNumber() {
            const transferNumber = document.getElementById('headerTransferNumber')?.value || '';
            const statusEl = document.getElementById('transferNumberStatus');
            
            try {
                statusEl.style.display = 'block';
                statusEl.style.color = 'rgba(255,255,255,0.6)';
                statusEl.textContent = 'üíæ Saving...';
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        TRANSFER_NUMBER: transferNumber
                    })
                });
                
                if (response.ok) {
                    statusEl.style.color = '#2ecc71';
                    statusEl.textContent = '‚úÖ Saved!';
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 2000);
                } else {
                    statusEl.style.color = '#e74c3c';
                    statusEl.textContent = '‚ùå Failed to save';
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error saving transfer number:', error);
                statusEl.style.color = '#e74c3c';
                statusEl.textContent = '‚ùå Error: ' + error.message;
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // Load credits remaining
        async function loadCredits() {
            try {
                const response = await fetch('/api/minutes', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const creditsEl = document.getElementById('creditsRemaining');
                creditsEl.textContent = Math.floor(data.minutes_remaining);  // Show as whole number
                
                // Change color based on remaining credits
                if (data.minutes_remaining === 0) {
                    creditsEl.style.color = '#ff6b6b';
                } else if (data.minutes_remaining < 10) {
                    creditsEl.style.color = '#ffa500';
                } else {
                    creditsEl.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    creditsEl.style.webkitBackgroundClip = 'text';
                    creditsEl.style.webkitTextFillColor = 'transparent';
                    creditsEl.style.backgroundClip = 'text';
                }
            } catch (error) {
                console.error('Error loading credits:', error);
            }
        }

        // Load trial status
        async function loadTrialStatus() {
            try {
                console.log('üîÑ Loading trial status...');
                const trialContainer = document.getElementById('trialContainer');
                const trialDaysText = document.getElementById('trialDaysText');
                const trialProgressBar = document.getElementById('trialProgressBar');
                const trialSubtext = document.getElementById('trialSubtext');
                const reduceTrialBtn = document.getElementById('reduceTrialBtn');

                // Make sure something is visible even before the fetch completes
                if (trialContainer) trialContainer.style.display = 'block';
                if (trialDaysText) trialDaysText.textContent = 'Loading‚Ä¶';
                if (trialProgressBar) trialProgressBar.style.width = '100%';
                // Keep the test button visible under "New Account"
                if (reduceTrialBtn) reduceTrialBtn.style.display = 'inline-flex';

                const response = await fetch('/api/trial-status', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.error('‚ùå Trial status response not OK:', response.status);
                    if (trialDaysText) trialDaysText.textContent = 'Trial status unavailable';
                    if (trialSubtext) trialSubtext.textContent = 'Please refresh or contact support';
                    if (reduceTrialBtn) reduceTrialBtn.style.display = 'inline-flex';
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Trial status data:', data);
                
                if (!trialContainer) {
                    console.error('‚ùå Trial container element not found');
                    return;
                }
                
                if (data.trial_days_remaining !== undefined && data.trial_days_remaining !== null) {
                    console.log('üìä Showing trial with', data.trial_days_remaining, 'days left');
                    trialContainer.style.display = 'block';
                    if (reduceTrialBtn) reduceTrialBtn.style.display = 'inline-flex';
                    
                    const daysLeft = data.trial_days_remaining;
                    const totalTrialDays = 3;
                    const percentage = (daysLeft / totalTrialDays) * 100;
                    
                    // Update text
                    if (daysLeft === 0) {
                        trialDaysText.textContent = 'Trial Expired';
                        trialDaysText.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                        trialSubtext.textContent = 'Please upgrade to continue using the service';
                    } else if (daysLeft === 1) {
                        trialDaysText.textContent = '1 day left';
                        trialDaysText.style.background = 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)';
                    } else {
                        trialDaysText.textContent = `${daysLeft} days left`;
                        trialDaysText.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    }
                    
                    trialDaysText.style.webkitBackgroundClip = 'text';
                    trialDaysText.style.webkitTextFillColor = 'transparent';
                    trialDaysText.style.backgroundClip = 'text';
                    
                    // Update progress bar
                    trialProgressBar.style.width = percentage + '%';
                    
                    // Change colors based on days left
                    if (daysLeft === 0) {
                        trialProgressBar.style.background = 'linear-gradient(90deg, #e74c3c 0%, #c0392b 100%)';
                        trialProgressBar.style.boxShadow = '0 0 10px rgba(231, 76, 60, 0.6)';
                    } else if (daysLeft === 1) {
                        trialProgressBar.style.background = 'linear-gradient(90deg, #e67e22 0%, #d35400 100%)';
                        trialProgressBar.style.boxShadow = '0 0 10px rgba(230, 126, 34, 0.6)';
                    }
                } else {
                    console.log('‚ÑπÔ∏è No trial data, hiding trial container');
                    trialContainer.style.display = 'none';
                    if (reduceTrialBtn) reduceTrialBtn.style.display = 'inline-flex';
                }
            } catch (error) {
                console.error('‚ùå Error loading trial status:', error);
                const trialContainer = document.getElementById('trialContainer');
                const trialDaysText = document.getElementById('trialDaysText');
                const trialSubtext = document.getElementById('trialSubtext');
                const reduceTrialBtn = document.getElementById('reduceTrialBtn');
                if (trialContainer) trialContainer.style.display = 'block';
                if (trialDaysText) trialDaysText.textContent = 'Trial status unavailable';
                if (trialSubtext) trialSubtext.textContent = 'Please refresh or contact support';
                if (reduceTrialBtn) reduceTrialBtn.style.display = 'inline-flex';
            }
        }

        // Reduce trial day (test function)
        async function reduceTrialDay() {
            try {
                const response = await fetch('/api/reduce-trial-day', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Trial day reduced:', data);
                    await loadTrialStatus(); // Reload trial status
                    
                    // Show notification
                    const daysLeft = data.trial_days_remaining;
                    alert(`Trial reduced! ${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining.`);
                } else {
                    alert('Failed to reduce trial day');
                }
            } catch (error) {
                console.error('Error reducing trial day:', error);
                alert('Error reducing trial day');
            }
        }

        // Load today stats
        async function loadTodayStats() {
            try {
                const response = await fetch('/api/stats/today', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                const callsTodayEl = document.getElementById('callsToday');
                const messagesTodayEl = document.getElementById('messagesToday');
                const unreadAppointmentsEl = document.getElementById('unreadAppointments');
                const unreadAppointmentsCardEl = document.getElementById('unreadAppointmentsCard');
                const alertDiv = document.getElementById('unreadAppointmentsAlert');
                const pluralSpan = document.getElementById('unreadAppointmentsPlural');
                
                if (callsTodayEl) callsTodayEl.textContent = data.calls_today || 0;
                if (messagesTodayEl) messagesTodayEl.textContent = data.messages_today || 0;
                
                const unreadCount = data.unread_appointments || 0;
                if (unreadAppointmentsEl) unreadAppointmentsEl.textContent = unreadCount;
                if (unreadAppointmentsCardEl) unreadAppointmentsCardEl.textContent = unreadCount;
                
                // Fetch unread appointments list for navigation
                if (unreadCount > 0) {
                    const apptResponse = await fetch('/api/appointments', {
                        headers: getAuthHeaders()
                    });
                    const apptData = await apptResponse.json();
                    unreadAppointmentsList = (apptData.appointments || []).filter(
                        apt => apt.status === 'scheduled' && apt.created_by === 'ai_agent'
                    );
                }
                
                // Show/hide unread appointments alert
                if (alertDiv && pluralSpan) {
                    if (unreadCount > 0) {
                        alertDiv.style.display = 'block';
                        pluralSpan.textContent = unreadCount === 1 ? '' : 's';
                    } else {
                        alertDiv.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading today stats:', error);
            }
        }

        // View today's calls
        function viewTodayCalls() {
            switchMainTab('calls');
            loadCalls('today');
            setActiveFilter('today');
        }
        
        // Filter calls by time period
        function filterCalls(period) {
            loadCalls(period);
            setActiveFilter(period);
        }
        
        // Set active filter button style
        function setActiveFilter(period) {
            // Reset all filter buttons
            ['today', '7days', '30days', '6months'].forEach(p => {
                const btn = document.getElementById('filter' + p.replace('days', 'days').replace('months', 'months'));
                if (btn) {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.borderColor = 'rgba(255,255,255,0.3)';
                }
            });
            
            // Highlight active filter
            const activeBtn = document.getElementById('filter' + period.replace('days', 'days').replace('months', 'months'));
            if (activeBtn) {
                activeBtn.style.background = 'rgba(255,255,255,0.3)';
                activeBtn.style.borderColor = 'white';
            }
        }
        
        function closeUnreadAlert() {
            document.getElementById('unreadAppointmentsAlert').style.display = 'none';
        }

        // Navigate to appointment in calendar and highlight it
        async function goToAppointment(callUuid) {
            try {
                console.log('=== APPOINTMENT LOOKUP DEBUG ===');
                console.log('Looking for appointment with call_uuid:', callUuid);
                console.log('Auth token:', localStorage.getItem('authToken'));
                
                // Get all appointments
                const response = await fetch('/api/appointments', {
                    headers: getAuthHeaders()
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const data = await response.json();
                
                console.log('API Response:', data);
                console.log('Appointments array:', data.appointments);
                
                if (!data.appointments || !Array.isArray(data.appointments)) {
                    console.error('No appointments data returned:', data);
                    alert('Could not load appointments');
                    return;
                }
                
                console.log(`Total appointments fetched: ${data.appointments.length}`);
                data.appointments.forEach((appt, idx) => {
                    console.log(`Appointment ${idx + 1}:`, {
                        id: appt.id,
                        call_uuid: appt.call_uuid,
                        customer_name: appt.customer_name,
                        date: appt.date,
                        time: appt.time,
                        user_id: appt.user_id
                    });
                });
                
                const appointment = data.appointments.find(a => a.call_uuid === callUuid);
                
                console.log('Found appointment:', appointment);
                
                if (!appointment) {
                    console.error('‚ùå Appointment not found!');
                    console.error('Searched for call_uuid:', callUuid);
                    console.error('Available call_uuids:', data.appointments.map(a => a.call_uuid));
                    alert('Appointment not found for this call. The appointment may not have been created yet or may be assigned to a different user.');
                    return;
                }
                
                console.log('‚úÖ Appointment found! Navigating to calendar...');
                
                // Parse appointment date to find which week it's in
                const apptDate = new Date(appointment.date + 'T00:00:00');
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay()); // Get Sunday
                const daysDiff = Math.floor((apptDate - startOfWeek) / (1000 * 60 * 60 * 24));
                const weekOffset = Math.floor(daysDiff / 7);
                
                // Set the week offset and load calendar
                currentWeekOffset = weekOffset;
                
                // Switch to calendar tab first
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[onclick*="switchTab(\'calendar\')"]').classList.add('active');
                document.getElementById('calendarTab').classList.add('active');
                
                // Open calendar modal
                openCalendarModal();
                
                // Load calendar with correct week
                await loadCalendar();
                
                // Wait for calendar to render, then highlight the appointment
                setTimeout(() => {
                    // Find all appointment elements in the calendar
                    const allApptElements = document.querySelectorAll('[onclick*="viewAppointment"]');
                    allApptElements.forEach(el => {
                        if (el.getAttribute('onclick').includes(`viewAppointment(${appointment.id})`)) {
                            // Add flash animation
                            el.style.animation = 'flashYellow 1s ease-in-out 5';
                            el.style.border = '3px solid #ffdd00';
                            el.style.boxShadow = '0 0 20px rgba(255, 221, 0, 0.8)';
                            
                            // Scroll into view
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove animation after 5 seconds
                            setTimeout(() => {
                                el.style.animation = '';
                                el.style.border = '';
                                el.style.boxShadow = '';
                            }, 5000);
                        }
                    });
                }, 800);
                
            } catch (error) {
                console.error('Error navigating to appointment:', error);
                alert('Error finding appointment');
            }
        }

        // Buy more minutes
        async function buyMoreMinutes() {
            try {
                const response = await fetch('/api/minutes/buy', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`‚úÖ Successfully added 60 credits! New balance: ${Math.floor(data.minutes_remaining)} credits`, 'success');
                    await loadCredits();
                } else {
                    showMessage('‚ùå Error purchasing credits: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error purchasing credits: ' + error.message, 'error');
            }
        }

        // Load configuration on page load
        loadConfig();
        loadCredits();
        loadTodayStats();

        // Auto-refresh every 10 seconds
        setInterval(() => {
            if (document.getElementById('callsTab').classList.contains('active')) {
                loadCalls();
            }
            loadCredits();
            loadTodayStats();
        }, 10000);

        // ============================================================================
        // CALENDAR FUNCTIONS
        // ============================================================================

        // ============================================================================
        // CALENDAR VIEW MANAGEMENT
        // ============================================================================

        let currentCalendarView = 'day'; // 'day', 'week', or 'month'
        let currentDayOffset = 0;

        function switchView(view) {
            currentCalendarView = view;
            
            // Update button styles
            const dayBtn = document.getElementById('viewDayBtn');
            const weekBtn = document.getElementById('viewWeekBtn');
            const monthBtn = document.getElementById('viewMonthBtn');
            
            [dayBtn, weekBtn, monthBtn].forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = 'rgba(255,255,255,0.6)';
            });
            
            if (view === 'day') {
                dayBtn.style.background = 'rgba(102,126,234,0.4)';
                dayBtn.style.color = 'white';
                document.getElementById('navPrevText').textContent = 'Previous';
                document.getElementById('navNextText').textContent = 'Next';
            } else if (view === 'week') {
                weekBtn.style.background = 'rgba(102,126,234,0.4)';
                weekBtn.style.color = 'white';
                document.getElementById('navPrevText').textContent = 'Previous';
                document.getElementById('navNextText').textContent = 'Next';
            } else {
                monthBtn.style.background = 'rgba(102,126,234,0.4)';
                monthBtn.style.color = 'white';
                document.getElementById('navPrevText').textContent = 'Previous';
                document.getElementById('navNextText').textContent = 'Next';
            }
            
            loadCalendar();
        }

        function navigatePrevious() {
            if (currentCalendarView === 'day') {
                currentDayOffset--;
            } else if (currentCalendarView === 'week') {
                currentWeekOffset--;
            } else {
                // Month view - go back one month
                currentWeekOffset -= 4;
            }
            loadCalendar();
        }

        function navigateNext() {
            if (currentCalendarView === 'day') {
                currentDayOffset++;
            } else if (currentCalendarView === 'week') {
                currentWeekOffset++;
            } else {
                // Month view - go forward one month
                currentWeekOffset += 4;
            }
            loadCalendar();
        }

        function previousWeek() {
            currentWeekOffset--;
            loadCalendar();
        }

        function nextWeek() {
            currentWeekOffset++;
            loadCalendar();
        }

        function goToToday() {
            currentWeekOffset = 0;
            currentDayOffset = 0;
            loadCalendar();
        }

        function showNewAppointmentForm() {
            document.getElementById('newAppointmentForm').style.display = 'block';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').value = today;
        }

        function hideNewAppointmentForm() {
            document.getElementById('newAppointmentForm').style.display = 'none';
            // Clear form
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentDuration').value = '30';
            document.getElementById('appointmentTitle').value = '';
            document.getElementById('appointmentCustomerName').value = '';
            document.getElementById('appointmentCustomerPhone').value = '';
            document.getElementById('appointmentDescription').value = '';
        }

        async function saveAppointment() {
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const duration = document.getElementById('appointmentDuration').value;
            const title = document.getElementById('appointmentTitle').value || 'Appointment';
            const customerName = document.getElementById('appointmentCustomerName').value;
            const customerPhone = document.getElementById('appointmentCustomerPhone').value;
            const description = document.getElementById('appointmentDescription').value;

            if (!date || !time) {
                alert('Please enter date and time');
                return;
            }

            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        date, time, duration, title, description,
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        created_by: 'user'
                    })
                });

                if (response.ok) {
                    hideNewAppointmentForm();
                    loadCalendar();
                    alert('‚úÖ Appointment created successfully!');
                } else {
                    alert('‚ùå Failed to create appointment');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function markDateBusy() {
            const date = prompt('Enter date to mark as busy (YYYY-MM-DD):');
            if (!date) return;

            try {
                const response = await fetch('/api/appointments/mark-busy', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ date })
                });

                if (response.ok) {
                    loadCalendar();
                    alert('‚úÖ Date marked as busy');
                } else {
                    alert('‚ùå Failed to mark date as busy');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Global variables for calendar navigation and highlighting
        let currentWeekOffset = 0;
        let unreadAppointmentsList = [];
        let targetAppointmentId = null;

        // ============================================================================
        // TASK MANAGEMENT FUNCTIONS
        // ============================================================================

        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.tasks && data.tasks.length > 0) {
                    document.getElementById('tasksEmptyState').style.display = 'none';
                    document.getElementById('tasksList').style.display = 'flex';
                    renderTasks(data.tasks);
                    
                    // Update incomplete task count badge
                    const incompleteCount = data.tasks.filter(task => task.completed !== 1).length;
                    updateIncompleteTaskCount(incompleteCount);
                } else {
                    document.getElementById('tasksEmptyState').style.display = 'block';
                    document.getElementById('tasksList').style.display = 'none';
                    updateIncompleteTaskCount(0);
                }
            } catch (error) {
                console.error('Failed to load tasks:', error);
                updateIncompleteTaskCount(0);
            }
        }

        function renderTasks(tasks) {
            const tasksList = document.getElementById('tasksList');
            
            tasksList.innerHTML = tasks.map(task => {
                const isCompleted = task.completed === 1;
                const createdDate = new Date(task.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                const sourceIcon = task.source === 'ai' ? 'ü§ñ' : '‚úçÔ∏è';
                const sourceLabel = task.source === 'ai' ? 'AI Generated' : 'Manual';
                const sourceBg = task.source === 'ai' ? 'linear-gradient(135deg, rgba(100,200,255,0.2) 0%, rgba(102,126,234,0.2) 100%)' : 'linear-gradient(135deg, rgba(118,75,162,0.2) 0%, rgba(102,126,234,0.2) 100%)';
                
                return `
                    <div style="background: ${isCompleted ? 'rgba(255,255,255,0.03)' : 'linear-gradient(135deg, rgba(102,126,234,0.12) 0%, rgba(118,75,162,0.08) 100%)'}; border-radius: 16px; padding: 24px; border: 2px solid ${isCompleted ? 'rgba(100,255,100,0.2)' : 'rgba(102,126,234,0.25)'}; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(102,126,234,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        ${!isCompleted ? '<div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);"></div>' : ''}
                        
                        <div style="display: flex; align-items: flex-start; gap: 18px;">
                            <div onclick="toggleTask(${task.id}, ${isCompleted ? 0 : 1})" style="flex-shrink: 0; width: 28px; height: 28px; border-radius: 8px; border: 2px solid ${isCompleted ? 'rgba(100,255,100,0.8)' : 'rgba(102,126,234,0.8)'}; background: ${isCompleted ? 'linear-gradient(135deg, rgba(100,255,100,0.3) 0%, rgba(66,234,150,0.3) 100%)' : 'rgba(255,255,255,0.05)'}; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.3s; margin-top: 2px;" onmouseover="this.style.transform='scale(1.15) rotate(5deg)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='scale(1) rotate(0)'; this.style.boxShadow='none'">
                                ${isCompleted ? '‚úî' : ''}
                            </div>
                            
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 17px; color: ${isCompleted ? 'rgba(255,255,255,0.4)' : 'rgba(255,255,255,0.95)'}; margin-bottom: 12px; ${isCompleted ? 'text-decoration: line-through;' : ''} line-height: 1.6; font-weight: 500;">
                                    ${task.description}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <span style="font-size: 13px; color: rgba(255,255,255,0.5); display: flex; align-items: center; gap: 6px;">
                                        <span>üìÖ</span>
                                        <span>${createdDate}</span>
                                    </span>
                                    <span style="background: ${sourceBg}; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.85); border: 1px solid rgba(102,126,234,0.3); display: flex; align-items: center; gap: 6px;">
                                        <span>${sourceIcon}</span>
                                        <span>${sourceLabel}</span>
                                    </span>
                                    ${task.call_uuid ? '<span style="background: rgba(100,200,255,0.15); padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; color: rgba(100,200,255,0.9); border: 1px solid rgba(100,200,255,0.3); display: flex; align-items: center; gap: 6px;"><span>üìû</span><span>From Call</span></span>' : ''}
                                    ${isCompleted ? '<span style="background: rgba(100,255,100,0.2); padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; color: rgba(100,255,100,0.9); border: 1px solid rgba(100,255,100,0.3); display: flex; align-items: center; gap: 6px;"><span>‚úÖ</span><span>Completed</span></span>' : ''}
                                </div>
                            </div>
                            
                            <button onclick="deleteTask(${task.id})" style="flex-shrink: 0; background: rgba(255,100,100,0.15); border: 2px solid rgba(255,100,100,0.3); padding: 10px 16px; border-radius: 10px; color: rgba(255,150,150,0.95); font-size: 13px; cursor: pointer; transition: all 0.3s; font-weight: 600; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='rgba(255,100,100,0.25)'; this.style.borderColor='rgba(255,100,100,0.5)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,100,100,0.15)'; this.style.borderColor='rgba(255,100,100,0.3)'; this.style.transform='scale(1)'">
                                <span>üóëÔ∏è</span>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateIncompleteTaskCount(count) {
            const badge = document.getElementById('incompleteTaskCount');
            console.log('Updating task count badge:', count, 'Badge element:', badge);
            if (!badge) {
                console.error('Task count badge element not found!');
                return;
            }
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
                console.log('Badge should now be visible with count:', count);
            } else {
                badge.style.display = 'none';
                console.log('Badge hidden (no incomplete tasks)');
            }
        }

        async function loadTaskCount() {
            console.log('Loading task count...');
            try {
                const response = await fetch('/api/tasks', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                console.log('Task data received:', data);
                
                if (data.tasks && data.tasks.length > 0) {
                    const incompleteCount = data.tasks.filter(task => task.completed !== 1).length;
                    console.log('Total tasks:', data.tasks.length, 'Incomplete:', incompleteCount);
                    updateIncompleteTaskCount(incompleteCount);
                } else {
                    console.log('No tasks found');
                    updateIncompleteTaskCount(0);
                }
            } catch (error) {
                console.error('Failed to load task count:', error);
                updateIncompleteTaskCount(0);
            }
        }

        function showAddTaskForm() {
            document.getElementById('addTaskForm').style.display = 'block';
            document.getElementById('newTaskDescription').focus();
        }

        function hideAddTaskForm() {
            document.getElementById('addTaskForm').style.display = 'none';
            document.getElementById('newTaskDescription').value = '';
        }

        async function addManualTask() {
            const description = document.getElementById('newTaskDescription').value.trim();
            
            if (!description) {
                alert('Please enter a task description');
                return;
            }

            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        description: description,
                        source: 'manual'
                    })
                });

                if (response.ok) {
                    hideAddTaskForm();
                    loadTasks();
                    loadTaskCount(); // Update badge count
                } else {
                    alert('Failed to add task');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Error adding task');
            }
        }

        async function toggleTask(taskId, completed) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ completed: completed })
                });

                if (response.ok) {
                    loadTasks();
                    loadTaskCount(); // Update badge count
                } else {
                    alert('Failed to update task');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    loadTasks();
                    loadTaskCount(); // Update badge count
                } else {
                    alert('Failed to delete task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task');
            }
        }

        // ============================================================================
        // END TASK MANAGEMENT FUNCTIONS
        // ============================================================================

        async function loadCalendar() {
            try {
                const response = await fetch('/api/appointments', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const appointments = data.appointments || [];
                const now = new Date();

                // Render based on current view
                if (currentCalendarView === 'day') {
                    renderDayView(appointments, now);
                } else if (currentCalendarView === 'week') {
                    renderWeekView(appointments, now);
                } else {
                    renderMonthView(appointments, now);
                }

                // Scroll to target appointment if exists
                if (targetAppointmentId !== null) {
                    setTimeout(() => {
                        const targetElement = document.querySelector('.flicker-target');
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                    targetAppointmentId = null;
                }
            } catch (error) {
                console.error('Failed to load calendar:', error);
                document.getElementById('calendarGrid').innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.5);">Error loading calendar</div>';
            }
        }

        function renderDayView(appointments, now) {
            const currentDate = new Date(now);
            currentDate.setDate(now.getDate() + currentDayOffset);
            const dateStr = currentDate.toISOString().split('T')[0];
            
            const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
            const monthYear = currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            document.getElementById('currentMonthDisplay').textContent = `${dayName}, ${monthYear}`;

            const dayAppointments = appointments.filter(apt => apt.date === dateStr);
            const isToday = dateStr === now.toISOString().split('T')[0];

            let html = '<div style="display: grid; grid-template-columns: 60px 1fr; gap: 1px; background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden;">';

            // Time slots (6 AM to 10 PM for day view)
            for (let hour = 6; hour <= 22; hour++) {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                const slotAppointments = dayAppointments.filter(apt => {
                    const aptHour = parseInt(apt.time.split(':')[0]);
                    return aptHour === hour;
                });

                // Time label
                html += `<div style="background: rgba(0,0,0,0.4); padding: 12px 8px; text-align: right; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.5); border-bottom: 1px solid rgba(255,255,255,0.05);">${timeStr}</div>`;
                
                // Content cell
                html += `<div onclick="showTimeSlot('${dateStr}', '${timeStr}')" style="background: ${isToday ? 'rgba(102,126,234,0.08)' : 'rgba(0,0,0,0.2)'}; padding: 12px; min-height: 50px; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(102,126,234,0.15)'" onmouseout="this.style.background='${isToday ? 'rgba(102,126,234,0.08)' : 'rgba(0,0,0,0.2)'}'">`;
                
                slotAppointments.forEach(apt => {
                    const emoji = apt.status === 'busy' ? 'üö´' : apt.status === 'completed' ? '‚úÖ' : 'üìÖ';
                    const bgColor = apt.status === 'busy' ? 'rgba(255,100,100,0.5)' : apt.created_by === 'ai_agent' ? 'rgba(100,200,255,0.5)' : 'rgba(102,126,234,0.7)';
                    const isTarget = targetAppointmentId !== null && apt.id === targetAppointmentId;
                    
                    html += `<div onclick="event.stopPropagation(); viewAppointment(${apt.id})" class="${isTarget ? 'flicker-target' : ''}" style="background: ${bgColor}; padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; font-size: 12px; font-weight: 600; border-left: 4px solid rgba(255,255,255,0.6); cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'">`;
                    html += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">`;
                    html += `<span style="font-size: 16px;">${emoji}</span>`;
                    html += `<span style="font-weight: 700;">${apt.time} ${apt.title || 'Appointment'}</span>`;
                    html += `</div>`;
                    if (apt.customer_name) {
                        html += `<div style="font-size: 11px; color: rgba(255,255,255,0.9); margin-left: 24px;">üë§ ${apt.customer_name}</div>`;
                    }
                    if (apt.description) {
                        html += `<div style="font-size: 10px; color: rgba(255,255,255,0.7); margin-left: 24px; margin-top: 4px;">${apt.description}</div>`;
                    }
                    html += `</div>`;
                });
                
                html += '</div>';
            }

            html += '</div>';
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function renderWeekView(appointments, now) {
            const currentDay = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - currentDay + (currentWeekOffset * 7));

            const weekMiddle = new Date(weekStart);
            weekMiddle.setDate(weekStart.getDate() + 3);
            const monthYear = weekMiddle.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            document.getElementById('currentMonthDisplay').textContent = monthYear;

            const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            let html = '<div style="display: flex; flex-direction: column;">';
            
            // Compact header
            html += '<div style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; margin-bottom: 2px;">';
            html += '<div style="background: rgba(102,126,234,0.25); padding: 10px; text-align: center; font-weight: 700;"></div>';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === now.toISOString().split('T')[0];
                
                html += `<div style="background: ${isToday ? 'linear-gradient(135deg, rgba(102,126,234,0.5), rgba(118,75,162,0.5))' : 'rgba(102,126,234,0.25)'}; padding: 10px; text-align: center;">`;
                html += `<div style="font-weight: 800; font-size: 10px; color: ${isToday ? '#fff' : 'rgba(255,255,255,0.6)'};">${dayNames[i]}</div>`;
                html += `<div style="font-size: 20px; font-weight: 900; margin-top: 2px;">${date.getDate()}</div>`;
                html += `</div>`;
            }
            html += '</div>';

            // Compact time slots (8 AM to 6 PM)
            html += '<div style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.03);">';
            
            for (let hour = 8; hour <= 18; hour++) {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                
                html += `<div style="background: rgba(0,0,0,0.3); padding: 12px 6px; text-align: right; font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.5); border-bottom: 1px solid rgba(255,255,255,0.05);">${timeStr}</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const slotAppointments = appointments.filter(apt => {
                        if (apt.date !== dateStr) return false;
                        const aptHour = parseInt(apt.time.split(':')[0]);
                        return aptHour === hour;
                    });
                    
                    const isToday = dateStr === now.toISOString().split('T')[0];
                    
                    html += `<div onclick="showTimeSlot('${dateStr}', '${timeStr}')" style="background: ${isToday ? 'rgba(102,126,234,0.08)' : 'rgba(0,0,0,0.2)'}; padding: 6px 4px; min-height: 45px; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(102,126,234,0.15)'" onmouseout="this.style.background='${isToday ? 'rgba(102,126,234,0.08)' : 'rgba(0,0,0,0.2)'}'">`;
                    
                    slotAppointments.forEach(apt => {
                        const emoji = apt.status === 'busy' ? 'üö´' : apt.status === 'completed' ? '‚úÖ' : 'üìÖ';
                        const bgColor = apt.status === 'busy' ? 'rgba(255,100,100,0.5)' : apt.created_by === 'ai_agent' ? 'rgba(100,200,255,0.5)' : 'rgba(102,126,234,0.7)';
                        const isTarget = targetAppointmentId !== null && apt.id === targetAppointmentId;
                        
                        html += `<div onclick="event.stopPropagation(); viewAppointment(${apt.id})" class="${isTarget ? 'flicker-target' : ''}" style="background: ${bgColor}; padding: 4px 6px; border-radius: 6px; margin-bottom: 3px; font-size: 10px; font-weight: 600; border-left: 3px solid rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">`;
                        html += `<div style="display: flex; align-items: center; gap: 3px;">`;
                        html += `<span style="font-size: 11px;">${emoji}</span>`;
                        html += `<span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 10px;">${apt.time.slice(0,5)} ${apt.title || 'Appt'}</span>`;
                        html += `</div>`;
                        html += `</div>`;
                    });
                    
                    html += '</div>';
                }
            }
            
            html += '</div></div>';
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function renderMonthView(appointments, now) {
            const currentDate = new Date(now);
            currentDate.setDate(1);
            currentDate.setMonth(now.getMonth() + Math.floor(currentWeekOffset / 4));
            
            const monthYear = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthDisplay').textContent = monthYear;

            const firstDay = currentDate.getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; padding: 2px;">';
            
            // Day names header
            const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            dayNames.forEach(day => {
                html += `<div style="background: rgba(102,126,234,0.25); padding: 12px; text-align: center; font-weight: 800; font-size: 11px; color: rgba(255,255,255,0.7);">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div style="background: rgba(0,0,0,0.2); padding: 12px; min-height: 90px;"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === now.toISOString().split('T')[0];
                
                const dayAppointments = appointments.filter(apt => apt.date === dateStr);
                
                html += `<div onclick="currentDayOffset = ${Math.floor((date - now) / (1000 * 60 * 60 * 24))}; switchView('day');" style="background: ${isToday ? 'linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3))' : 'rgba(0,0,0,0.2)'}; padding: 8px; min-height: 90px; cursor: pointer; transition: all 0.2s; border: ${isToday ? '2px solid rgba(102,126,234,0.6)' : '1px solid rgba(255,255,255,0.05)'}; border-radius: 8px;" onmouseover="this.style.background='rgba(102,126,234,0.2)'" onmouseout="this.style.background='${isToday ? 'linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3))' : 'rgba(0,0,0,0.2)'}'">`;
                html += `<div style="font-weight: 900; font-size: 16px; margin-bottom: 6px; color: ${isToday ? '#fff' : 'rgba(255,255,255,0.8)'};">${day}</div>`;
                
                dayAppointments.slice(0, 3).forEach(apt => {
                    const emoji = apt.status === 'busy' ? 'üö´' : apt.status === 'completed' ? '‚úÖ' : 'üìÖ';
                    const bgColor = apt.status === 'busy' ? 'rgba(255,100,100,0.6)' : apt.created_by === 'ai_agent' ? 'rgba(100,200,255,0.6)' : 'rgba(102,126,234,0.8)';
                    
                    html += `<div onclick="event.stopPropagation(); viewAppointment(${apt.id})" style="background: ${bgColor}; padding: 4px 6px; border-radius: 5px; margin-bottom: 3px; font-size: 9px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">`;
                    html += `${emoji} ${apt.time.slice(0,5)} ${apt.title || 'Appt'}`;
                    html += `</div>`;
                });
                
                if (dayAppointments.length > 3) {
                    html += `<div style="font-size: 9px; color: rgba(255,255,255,0.6); font-weight: 600; margin-top: 3px;">+${dayAppointments.length - 3} more</div>`;
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function showTimeSlot(date, time) {
            // Quick add appointment for this time slot
            showNewAppointmentForm();
            document.getElementById('appointmentDate').value = date;
            document.getElementById('appointmentTime').value = time;
        }

        async function viewAppointment(id) {
            try {
                const response = await fetch('/api/appointments', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (!data.appointments || !Array.isArray(data.appointments)) {
                    console.error('No appointments data returned:', data);
                    alert('Could not load appointments');
                    return;
                }
                
                const appointment = data.appointments.find(a => a.id === id);
                
                if (!appointment) {
                    alert('Appointment not found');
                    return;
                }
                
                // Mark as read if it's an AI-created appointment that's still scheduled
                if (appointment.created_by === 'ai_agent' && appointment.status === 'scheduled') {
                    await fetch(`/api/appointments/${id}/read`, { 
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
                    await loadTodayStats();
                }

                const statusEmoji = appointment.status === 'busy' ? 'üö´' : appointment.status === 'completed' ? '‚úÖ' : 'üìÖ';
                const createdByLabel = appointment.created_by === 'ai_agent' ? 'ü§ñ AI Agent' : 'üë§ User';
                
                let detailHTML = `<div style="background: rgba(15, 15, 35, 0.95); padding: 40px; border-radius: 20px; max-width: 600px; margin: 0; border: 2px solid rgba(102,126,234,0.5); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">`;
                detailHTML += `<h3 style="margin-bottom: 25px; font-size: 28px; display: flex; align-items: center; gap: 12px;">${statusEmoji} ${appointment.title || 'Appointment'}</h3>`;
                
                detailHTML += `<div style="background: rgba(102,126,234,0.15); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(102,126,234,0.3);">`;
                detailHTML += `<div style="display: grid; gap: 15px;">`;
                detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><span style="font-size: 20px;">üìÖ</span><strong>Date:</strong> ${new Date(appointment.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>`;
                detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><span style="font-size: 20px;">üïê</span><strong>Time:</strong> ${appointment.time}</div>`;
                detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><span style="font-size: 20px;">‚è±Ô∏è</span><strong>Duration:</strong> ${appointment.duration} minutes</div>`;
                if (appointment.customer_name) detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><span style="font-size: 20px;">üë§</span><strong>Customer:</strong> ${appointment.customer_name}</div>`;
                if (appointment.customer_phone) detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><span style="font-size: 20px;">üìû</span><strong>Phone:</strong> ${appointment.customer_phone}</div>`;
                detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><span style="font-size: 20px;">üìù</span><strong>Status:</strong> ${appointment.status}</div>`;
                detailHTML += `<div style="display: flex; align-items: center; gap: 12px; font-size: 16px;"><strong>Created by:</strong> ${createdByLabel}</div>`;
                detailHTML += `</div></div>`;
                
                if (appointment.description) {
                    detailHTML += `<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">`;
                    detailHTML += `<strong style="display: block; margin-bottom: 10px; font-size: 16px;">Description:</strong>`;
                    detailHTML += `<div style="color: rgba(255,255,255,0.8); line-height: 1.6; white-space: pre-wrap;">${appointment.description}</div>`;
                    detailHTML += `</div>`;
                }
                
                // Add View Call Summary button if appointment has a call_uuid
                if (appointment.call_uuid && appointment.created_by === 'ai_agent') {
                    detailHTML += `<div style="margin-bottom: 20px;">`;
                    detailHTML += `<button onclick="viewCallSummary('${appointment.call_uuid}')" style="width: 100%; background: rgba(102,200,234,0.3); border: 1px solid rgba(102,200,234,0.5); padding: 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(102,200,234,0.5)'" onmouseout="this.style.background='rgba(102,200,234,0.3)'">üìû View Full Call Summary</button>`;
                    detailHTML += `</div>`;
                }
                
                detailHTML += `<div style="display: flex; gap: 15px; margin-top: 25px;">`;
                detailHTML += `<button onclick="deleteAppointmentFromView(${appointment.id})" style="flex: 1; background: rgba(255,100,100,0.3); border: 1px solid rgba(255,100,100,0.5); padding: 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,100,100,0.5)'" onmouseout="this.style.background='rgba(255,100,100,0.3)'">üóëÔ∏è Delete</button>`;
                detailHTML += `<button onclick="closeAppointmentView()" style="flex: 1; background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); padding: 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(102,126,234,0.5)'" onmouseout="this.style.background='rgba(102,126,234,0.3)'">‚úï Close</button>`;
                detailHTML += `</div></div>`;
                
                const overlay = document.createElement('div');
                overlay.id = 'appointmentViewOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);';
                overlay.innerHTML = detailHTML;
                overlay.onclick = (e) => { if (e.target === overlay) closeAppointmentView(); };
                document.body.appendChild(overlay);
            } catch (error) {
                alert('Error loading appointment: ' + error.message);
            }
        }

        function closeAppointmentView() {
            const overlay = document.getElementById('appointmentViewOverlay');
            if (overlay) overlay.remove();
        }

        async function viewCallSummary(callUuid) {
            try {
                const response = await fetch('/api/calls', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (!data.calls || !Array.isArray(data.calls)) {
                    console.error('No calls data returned:', data);
                    alert('Could not load calls');
                    return;
                }
                
                const call = data.calls.find(c => c.call_uuid === callUuid);
                
                if (!call) {
                    alert('Call information not found');
                    return;
                }

                let summaryHTML = `<div style="background: rgba(15, 15, 35, 0.95); padding: 40px; border-radius: 20px; max-width: 800px; margin: 0; border: 2px solid rgba(102,200,234,0.5); box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto;">`;
                summaryHTML += `<h3 style="margin-bottom: 25px; font-size: 28px; display: flex; align-items: center; gap: 12px;">üìû Call Summary</h3>`;
                
                summaryHTML += `<div style="background: rgba(102,200,234,0.15); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(102,200,234,0.3);">`;
                summaryHTML += `<div style="display: grid; gap: 15px;">`;
                summaryHTML += `<div style="font-size: 16px;"><strong>Caller:</strong> ${call.caller_number || 'Unknown'}</div>`;
                summaryHTML += `<div style="font-size: 16px;"><strong>Date:</strong> ${new Date(call.start_time).toLocaleString()}</div>`;
                summaryHTML += `<div style="font-size: 16px;"><strong>Duration:</strong> ${call.duration || 'N/A'} seconds</div>`;
                summaryHTML += `</div></div>`;
                
                if (call.summary) {
                    summaryHTML += `<div style="background: rgba(100,200,100,0.15); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(100,200,100,0.3);">`;
                    summaryHTML += `<strong style="display: block; margin-bottom: 10px; font-size: 16px; color: rgba(100,255,100,0.9);">AI Summary:</strong>`;
                    summaryHTML += `<div style="color: rgba(255,255,255,0.9); line-height: 1.6; white-space: pre-wrap;">${call.summary}</div>`;
                    summaryHTML += `</div>`;
                }
                
                if (call.transcript) {
                    summaryHTML += `<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">`;
                    summaryHTML += `<strong style="display: block; margin-bottom: 10px; font-size: 16px;">Full Transcript:</strong>`;
                    summaryHTML += `<div style="color: rgba(255,255,255,0.8); line-height: 1.8; font-family: monospace; font-size: 13px; white-space: pre-wrap;">${call.transcript}</div>`;
                    summaryHTML += `</div>`;
                }
                
                summaryHTML += `<button onclick="closeCallSummary()" style="width: 100%; background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); padding: 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(102,126,234,0.5)'" onmouseout="this.style.background='rgba(102,126,234,0.3)'">‚úï Close</button>`;
                summaryHTML += `</div>`;
                
                const overlay = document.createElement('div');
                overlay.id = 'callSummaryOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);';
                overlay.innerHTML = summaryHTML;
                overlay.onclick = (e) => { if (e.target === overlay) closeCallSummary(); };
                document.body.appendChild(overlay);
            } catch (error) {
                alert('Error loading call summary: ' + error.message);
            }
        }

        function closeCallSummary() {
            const overlay = document.getElementById('callSummaryOverlay');
            if (overlay) overlay.remove();
        }

        async function deleteAppointmentFromView(id) {
            if (!confirm('Delete this appointment?')) return;

            try {
                const response = await fetch(`/api/appointments/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    closeAppointmentView();
                    loadCalendar();
                    alert('‚úÖ Appointment deleted');
                } else {
                    alert('‚ùå Failed to delete appointment');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function showDayAppointments(date) {
            try {
                const response = await fetch(`/api/appointments?date=${date}`);
                const data = await response.json();
                const appointments = data.appointments || [];

                if (appointments.length === 0) {
                    if (confirm(`No appointments on ${date}. Create one?`)) {
                        showNewAppointmentForm();
                        document.getElementById('appointmentDate').value = date;
                    }
                    return;
                }

                let detailHTML = `<div style="background: rgba(102, 126, 234, 0.15); padding: 25px; border-radius: 15px; max-width: 600px; margin: 20px auto;">`;
                detailHTML += `<h3 style="margin-bottom: 20px;">üìÖ ${date}</h3>`;
                
                appointments.forEach(apt => {
                    const statusEmoji = apt.status === 'busy' ? 'üö´' : apt.status === 'completed' ? '‚úÖ' : 'üìÖ';
                    detailHTML += `<div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">`;
                    detailHTML += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
                    detailHTML += `<strong style="font-size: 16px;">${statusEmoji} ${apt.time} - ${apt.title || 'Appointment'}</strong>`;
                    detailHTML += `<button onclick="deleteAppointment(${apt.id})" style="background: rgba(255,100,100,0.3); border: none; padding: 8px 15px; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">Delete</button>`;
                    detailHTML += `</div>`;
                    if (apt.customer_name) detailHTML += `<div style="margin: 5px 0;">üë§ ${apt.customer_name}</div>`;
                    if (apt.customer_phone) detailHTML += `<div style="margin: 5px 0;">üìû ${apt.customer_phone}</div>`;
                    if (apt.description) detailHTML += `<div style="margin: 10px 0; color: rgba(255,255,255,0.7);">${apt.description}</div>`;
                    detailHTML += `<div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.5);">Duration: ${apt.duration} min | Created by: ${apt.created_by}</div>`;
                    detailHTML += `</div>`;
                });
                
                detailHTML += `</div>`;
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
                overlay.innerHTML = detailHTML + `<button onclick="this.parentElement.remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 24px; cursor: pointer; padding: 10px 20px; border-radius: 10px;">‚úï</button>`;
                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
                document.body.appendChild(overlay);
            } catch (error) {
                alert('Error loading appointments: ' + error.message);
            }
        }

        async function deleteAppointment(id) {
            if (!confirm('Delete this appointment?')) return;

            try {
                const response = await fetch(`/api/appointments/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.querySelector('[onclick*="parentElement.remove"]').click(); // Close modal
                    loadCalendar();
                    alert('‚úÖ Appointment deleted');
                } else {
                    alert('‚ùå Failed to delete appointment');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
    </script>

    <!-- New Account Setup Modal -->
    <div id="newAccountModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; align-items: center; justify-content: center;">
        <div style="max-width: 600px; width: 90%; background: linear-gradient(135deg, rgba(15, 15, 35, 0.98) 0%, rgba(26, 26, 46, 0.98) 100%); border-radius: 24px; padding: 50px; border: 2px solid rgba(102, 126, 234, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5); backdrop-filter: blur(20px);">
            <!-- Progress Section -->
            <div id="progressSection">
                <div style="text-align: center; margin-bottom: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üîç</div>
                    <h2 style="font-size: 28px; font-weight: 800; color: white; margin-bottom: 12px;">Setting Up Your Account</h2>
                    <p style="font-size: 16px; color: rgba(255,255,255,0.7);">Finding your new number, please wait...</p>
                </div>
                
                <!-- Progress Bar Container -->
                <div style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 8px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="progressBar" style="height: 24px; background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f39c12 100%); border-radius: 8px; width: 0%; transition: width 0.3s ease; box-shadow: 0 0 20px rgba(102, 126, 234, 0.6); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 600;" id="progressText">Initializing...</div>
                </div>
            </div>
            
            <!-- Result Section (Hidden Initially) -->
            <div id="resultSection" style="display: none;">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <style>
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        @keyframes yellowFlicker {
            0%, 100% { background-color: inherit; box-shadow: none; }
            25% { background-color: rgba(255, 255, 100, 0.8); box-shadow: 0 0 20px rgba(255, 255, 100, 0.6); }
            50% { background-color: rgba(255, 255, 150, 0.9); box-shadow: 0 0 30px rgba(255, 255, 100, 0.8); }
            75% { background-color: rgba(255, 255, 100, 0.8); box-shadow: 0 0 20px rgba(255, 255, 100, 0.6); }
        }
        
        .flicker-target {
            animation: yellowFlicker 2s ease-in-out 3 !important;
        }
    </style>

    <!-- Tasks Modal -->
    <div id="tasksModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; backdrop-filter: blur(10px); animation: fadeIn 0.3s ease-out;">
        <div style="width: 100%; height: 100%; overflow-y: auto; padding: 20px;">
            <div style="max-width: 900px; margin: 0 auto; animation: slideUp 0.4s ease-out;">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%); border-radius: 20px 20px 0 0; padding: 30px 40px; box-shadow: 0 10px 40px rgba(102,126,234,0.4); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(40px);"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(30px);"></div>
                    <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="font-size: 36px; margin: 0 0 8px 0; font-weight: 900; display: flex; align-items: center; gap: 15px;">‚úÖ My Tasks</h2>
                            <p style="font-size: 15px; margin: 0; opacity: 0.95;">Manage your action items and reminders</p>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button onclick="showAddTaskForm()" style="background: rgba(255,255,255,0.95); color: #667eea; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'">
                                <span style="font-size: 18px;">‚ûï</span>
                                <span>Add Task</span>
                            </button>
                            <button onclick="closeTasksModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.3s; line-height: 1;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0)'">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Content -->
                <div style="background: linear-gradient(135deg, rgba(15, 15, 35, 0.98) 0%, rgba(20, 20, 40, 0.98) 100%); border-radius: 0 0 20px 20px; padding: 30px 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); min-height: 400px;">
                    <!-- Add Task Form -->
                    <div id="addTaskForm" style="display: none; background: linear-gradient(135deg, rgba(102,126,234,0.15) 0%, rgba(118,75,162,0.15) 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 2px solid rgba(102,126,234,0.3); animation: slideDown 0.3s ease-out;">
                        <div style="margin-bottom: 18px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 700; color: rgba(255,255,255,0.95); font-size: 15px;">üìù Task Description</label>
                            <textarea id="newTaskDescription" placeholder="What needs to be done? (e.g., Call back John tomorrow at 2pm, Send meeting notes to team...)" style="width: 100%; padding: 15px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: white; font-size: 15px; font-family: inherit; resize: vertical; min-height: 100px; transition: all 0.3s;" onfocus="this.style.borderColor='rgba(102,126,234,0.6)'; this.style.background='rgba(255,255,255,0.08)'" onblur="this.style.borderColor='rgba(255,255,255,0.15)'; this.style.background='rgba(255,255,255,0.05)'"></textarea>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="addManualTask()" style="background: linear-gradient(135deg, #66ea96 0%, #66c8ea 100%); border: none; padding: 12px 28px; border-radius: 12px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,234,150,0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102,234,150,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102,234,150,0.3)'">
                                <span>üíæ</span>
                                <span>Save Task</span>
                            </button>
                            <button onclick="hideAddTaskForm()" style="background: rgba(255,100,100,0.2); border: 2px solid rgba(255,100,100,0.4); padding: 12px 28px; border-radius: 12px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,100,100,0.3)'" onmouseout="this.style.background='rgba(255,100,100,0.2)'">
                                ‚úï Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Tasks List -->
                    <div id="tasksList" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Tasks will be loaded here -->
                    </div>

                    <!-- Empty State -->
                    <div id="tasksEmptyState" style="padding: 80px 40px; text-align: center;">
                        <div style="font-size: 80px; margin-bottom: 25px; opacity: 0.3; animation: float 3s ease-in-out infinite;">üìã</div>
                        <div style="font-size: 26px; color: rgba(255,255,255,0.9); margin-bottom: 15px; font-weight: 700;">No Tasks Yet</div>
                        <div style="font-size: 16px; color: rgba(255,255,255,0.5); line-height: 1.8; max-width: 500px; margin: 0 auto;">
                            Your AI assistant will automatically create tasks from your calls.<br>
                            <span style="color: rgba(102,126,234,0.8);">Click "Add Task" to create one manually.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <!-- Bundles Modal -->
    <div id="bundlesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; backdrop-filter: blur(10px); animation: fadeIn 0.3s ease-out; overflow-y: auto;">
        <div style="max-width: 850px; margin: 50px auto; padding: 0 20px;">
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border-radius: 20px; padding: 32px; border: 2px solid rgba(102,126,234,0.4); backdrop-filter: blur(20px); box-shadow: 0 25px 70px rgba(0,0,0,0.6);">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 26px;">
                    <div>
                        <h2 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 900; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 12px;"><span style="font-size: 30px;">üì¶</span> Feature Bundles</h2>
                        <p style="margin: 0; color: rgba(255,255,255,0.65); font-size: 14px;">Enable premium features for your AI agent ‚Ä¢ Only active features are available to callers</p>
                    </div>
                    <button onclick="closeBundlesModal()" style="background: rgba(255,100,100,0.25); border: 2px solid rgba(255,100,100,0.4); color: white; font-size: 24px; cursor: pointer; padding: 8px 16px; border-radius: 10px; transition: all 0.3s; font-weight: 700;" onmouseover="this.style.background='rgba(255,100,100,0.45)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,100,100,0.25)'; this.style.transform='scale(1)'">‚úï</button>
                </div>

                <!-- Feature Bundles -->
                <div style="display: grid; gap: 16px; margin-top: 24px;">
                    <!-- Calendar Bookings Bundle -->
                    <div style="background: linear-gradient(135deg, rgba(255,107,107,0.08) 0%, rgba(238,90,111,0.12) 100%); border: 2px solid rgba(255,107,107,0.35); border-radius: 14px; padding: 20px; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='rgba(255,107,107,0.6)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255,107,107,0.25)'" onmouseout="this.style.borderColor='rgba(255,107,107,0.35)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255,107,107,0.15) 0%, transparent 70%); pointer-events: none;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; position: relative; z-index: 1;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(255,107,107,0.25) 0%, rgba(238,90,111,0.25) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; border: 1px solid rgba(255,107,107,0.3);">üìÖ</div>
                                    <h3 style="margin: 0; font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.3px;">Calendar Bookings</h3>
                                </div>
                                <p style="margin: 0 0 12px 0; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.5; padding-left: 60px;">Create and manage calendar appointments during calls with automatic saving</p>
                                <div style="display: flex; align-items: center; gap: 10px; padding-left: 60px;">
                                    <span style="background: linear-gradient(135deg, rgba(255,107,107,0.3) 0%, rgba(238,90,111,0.3) 100%); padding: 6px 14px; border-radius: 8px; font-weight: 700; color: #ff6b6b; font-size: 13px; border: 1px solid rgba(255,107,107,0.4); box-shadow: 0 2px 8px rgba(255,107,107,0.2);"><span id="calendarPriceDisplay">10</span> credits per booking</span>
                                    <span style="color: rgba(255,255,255,0.45); font-size: 12px;">‚Ä¢ Set in Server Control</span>
                                </div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 64px; height: 34px; flex-shrink: 0; cursor: pointer;">
                                <input type="checkbox" id="calendarBundleToggle" onchange="toggleBundle('calendar')" style="opacity: 0; width: 0; height: 0;">
                                <span class="bundle-toggle-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.15); transition: 0.4s; border-radius: 34px; border: 2px solid rgba(255,255,255,0.25); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span class="bundle-toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 3px; bottom: 2px; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); transition: 0.4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Tasks Bundle -->
                    <div style="background: linear-gradient(135deg, rgba(46,213,115,0.08) 0%, rgba(0,184,148,0.12) 100%); border: 2px solid rgba(46,213,115,0.35); border-radius: 14px; padding: 20px; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='rgba(46,213,115,0.6)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(46,213,115,0.25)'" onmouseout="this.style.borderColor='rgba(46,213,115,0.35)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(46,213,115,0.15) 0%, transparent 70%); pointer-events: none;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; position: relative; z-index: 1;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(46,213,115,0.25) 0%, rgba(0,184,148,0.25) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; border: 1px solid rgba(46,213,115,0.3);">‚úì</div>
                                    <h3 style="margin: 0; font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.3px;">AI Task Extraction</h3>
                                </div>
                                <p style="margin: 0 0 12px 0; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.5; padding-left: 60px;">Automatically extract and save action items from conversations using AI</p>
                                <div style="display: flex; align-items: center; gap: 10px; padding-left: 60px;">
                                    <span style="background: linear-gradient(135deg, rgba(46,213,115,0.3) 0%, rgba(0,184,148,0.3) 100%); padding: 6px 14px; border-radius: 8px; font-weight: 700; color: #2ed573; font-size: 13px; border: 1px solid rgba(46,213,115,0.4); box-shadow: 0 2px 8px rgba(46,213,115,0.2);"><span id="tasksPriceDisplay">5</span> credits per task</span>
                                    <span style="color: rgba(255,255,255,0.45); font-size: 12px;">‚Ä¢ Set in Server Control</span>
                                </div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 64px; height: 34px; flex-shrink: 0; cursor: pointer;">
                                <input type="checkbox" id="tasksBundleToggle" onchange="toggleBundle('tasks')" style="opacity: 0; width: 0; height: 0;">
                                <span class="bundle-toggle-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.15); transition: 0.4s; border-radius: 34px; border: 2px solid rgba(255,255,255,0.25); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span class="bundle-toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 3px; bottom: 2px; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); transition: 0.4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Advanced Voice Bundle - Hidden as requested -->
                    <div style="display: none; background: linear-gradient(135deg, rgba(108,92,231,0.08) 0%, rgba(155,81,224,0.12) 100%); border: 2px solid rgba(108,92,231,0.35); border-radius: 14px; padding: 20px; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='rgba(108,92,231,0.6)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(108,92,231,0.25)'" onmouseout="this.style.borderColor='rgba(108,92,231,0.35)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(108,92,231,0.15) 0%, transparent 70%); pointer-events: none;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; position: relative; z-index: 1;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(108,92,231,0.25) 0%, rgba(155,81,224,0.25) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; border: 1px solid rgba(108,92,231,0.3);">üéôÔ∏è</div>
                                    <h3 style="margin: 0; font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.3px;">Advanced Voice</h3>
                                </div>
                                <p style="margin: 0 0 12px 0; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.5; padding-left: 60px;">Premium voice quality with ultra-low latency for natural conversations</p>
                                <div style="display: flex; align-items: center; gap: 10px; padding-left: 60px;">
                                    <span style="background: linear-gradient(135deg, rgba(108,92,231,0.3) 0%, rgba(155,81,224,0.3) 100%); padding: 6px 14px; border-radius: 8px; font-weight: 700; color: #9b51e0; font-size: 13px; border: 1px solid rgba(108,92,231,0.4); box-shadow: 0 2px 8px rgba(108,92,231,0.2);"><span id="advancedVoicePriceDisplay">3</span> credits per call</span>
                                    <span style="color: rgba(255,255,255,0.45); font-size: 12px;">‚Ä¢ Set in Server Control</span>
                                </div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 64px; height: 34px; flex-shrink: 0; cursor: pointer;">
                                <input type="checkbox" id="advancedVoiceBundleToggle" onchange="toggleBundle('advancedvoice')" style="opacity: 0; width: 0; height: 0;">
                                <span class="bundle-toggle-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.15); transition: 0.4s; border-radius: 34px; border: 2px solid rgba(255,255,255,0.25); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span class="bundle-toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 3px; bottom: 2px; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); transition: 0.4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Sales Call Detector Bundle -->
                    <div style="background: linear-gradient(135deg, rgba(231,76,60,0.08) 0%, rgba(192,57,43,0.12) 100%); border: 2px solid rgba(231,76,60,0.35); border-radius: 14px; padding: 20px; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='rgba(231,76,60,0.6)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(231,76,60,0.25)'" onmouseout="this.style.borderColor='rgba(231,76,60,0.35)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(231,76,60,0.15) 0%, transparent 70%); pointer-events: none;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; position: relative; z-index: 1;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(231,76,60,0.25) 0%, rgba(192,57,43,0.25) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; border: 1px solid rgba(231,76,60,0.3);">üö´</div>
                                    <h3 style="margin: 0; font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.3px;">Sales Call Detector</h3>
                                </div>
                                <p style="margin: 0 0 12px 0; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.5; padding-left: 60px;">AI analyzes calls and politely ends sales pitches (>70% confidence)</p>
                                <div style="display: flex; align-items: center; gap: 10px; padding-left: 60px;">
                                    <span style="background: linear-gradient(135deg, rgba(231,76,60,0.3) 0%, rgba(192,57,43,0.3) 100%); padding: 6px 14px; border-radius: 8px; font-weight: 700; color: #e74c3c; font-size: 13px; border: 1px solid rgba(231,76,60,0.4); box-shadow: 0 2px 8px rgba(231,76,60,0.2);"><span id="salesDetectorPriceDisplay">2</span> credits per call</span>
                                    <span style="color: rgba(255,255,255,0.45); font-size: 12px;">‚Ä¢ Set in Server Control</span>
                                </div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 64px; height: 34px; flex-shrink: 0; cursor: pointer;">
                                <input type="checkbox" id="salesDetectorBundleToggle" onchange="toggleBundle('salesDetector')" style="opacity: 0; width: 0; height: 0;">
                                <span class="bundle-toggle-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.15); transition: 0.4s; border-radius: 34px; border: 2px solid rgba(255,255,255,0.25); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span class="bundle-toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 3px; bottom: 2px; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); transition: 0.4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></span>
                            </label>
                        </div>
                    </div>

                    <!-- SMS Notifications -->
                    <div style="background: linear-gradient(135deg, rgba(241,196,15,0.08) 0%, rgba(243,156,18,0.12) 100%); border: 2px solid rgba(241,196,15,0.35); border-radius: 14px; padding: 20px; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='rgba(241,196,15,0.6)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(241,196,15,0.22)'" onmouseout="this.style.borderColor='rgba(241,196,15,0.35)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(241,196,15,0.15) 0%, transparent 70%); pointer-events: none;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; position: relative; z-index: 1;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(241,196,15,0.25) 0%, rgba(243,156,18,0.25) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; border: 1px solid rgba(241,196,15,0.3);">üì©</div>
                                    <h3 style="margin: 0; font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.3px;">Text Notifications</h3>
                                </div>
                                <p style="margin: 0 0 12px 0; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.5; padding-left: 60px;">Send you an SMS summary after calls your AI agent handles</p>
                                <div style="display: flex; align-items: center; gap: 10px; padding-left: 60px;">
                                    <span style="background: linear-gradient(135deg, rgba(241,196,15,0.3) 0%, rgba(243,156,18,0.3) 100%); padding: 6px 14px; border-radius: 8px; font-weight: 700; color: #f1c40f; font-size: 13px; border: 1px solid rgba(241,196,15,0.4); box-shadow: 0 2px 8px rgba(241,196,15,0.18);">3 credits per SMS</span>
                                    <span style="color: rgba(255,255,255,0.45); font-size: 12px;">‚Ä¢ Billed per call notification</span>
                                </div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 64px; height: 34px; flex-shrink: 0; cursor: pointer;">
                                <input type="checkbox" id="smsNotificationsToggle" onchange="toggleBundle('smsNotifications')" style="opacity: 0; width: 0; height: 0;">
                                <span class="bundle-toggle-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.15); transition: 0.4s; border-radius: 34px; border: 2px solid rgba(255,255,255,0.25); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span class="bundle-toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 3px; bottom: 2px; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); transition: 0.4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="saveBundleSettings()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 16px 48px; border-radius: 12px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102,126,234,0.4)'">
                            üíæ Save Bundle Settings
                        </button>
                    </div>
                </div>

                <div id="bundleMessage" style="margin-top: 20px; padding: 14px; border-radius: 10px; display: none; font-weight: 600; text-align: center; font-size: 14px;"></div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; overflow-y: auto;">
        <div style="max-width: 95%; margin: 20px auto; padding: 0 20px;">
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%); border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <h2 style="font-size: 28px; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900;">üìÖ Calendar</h2>
                        <div style="background: rgba(102,126,234,0.2); padding: 8px 16px; border-radius: 10px; font-size: 16px; font-weight: 700; border: 1px solid rgba(102,126,234,0.4);">
                            <span id="currentMonthDisplay">Loading...</span>
                        </div>
                    </div>
                    <button onclick="closeCalendarModal()" style="background: rgba(255,100,100,0.2); border: 2px solid rgba(255,100,100,0.4); color: white; font-size: 24px; cursor: pointer; padding: 8px 18px; border-radius: 10px; transition: all 0.3s; font-weight: 700;" onmouseover="this.style.background='rgba(255,100,100,0.4)'" onmouseout="this.style.background='rgba(255,100,100,0.2)'">‚úï</button>
                </div>

                <!-- View Switcher & Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <!-- View Mode Selector -->
                    <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 4px; display: flex; gap: 4px; border: 1px solid rgba(255,255,255,0.1);">
                        <button id="viewDayBtn" onclick="switchView('day')" style="background: rgba(102,126,234,0.3); border: none; color: white; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.3s;">üìÖ Day</button>
                        <button id="viewWeekBtn" onclick="switchView('week')" style="background: transparent; border: none; color: rgba(255,255,255,0.6); padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.3s;">üìÜ Week</button>
                        <button id="viewMonthBtn" onclick="switchView('month')" style="background: transparent; border: none; color: rgba(255,255,255,0.6); padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.3s;">üóìÔ∏è Month</button>
                    </div>
                    
                    <!-- Navigation -->
                    <button onclick="navigatePrevious()" class="btn-secondary" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 6px; font-weight: 600;">‚óÄ <span id="navPrevText">Previous</span></button>
                    <button onclick="goToToday()" class="btn-secondary" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">üìç Today</button>
                    <button onclick="navigateNext()" class="btn-secondary" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 6px; font-weight: 600;"><span id="navNextText">Next</span> ‚ñ∂</button>
                    
                    <div style="flex: 1;"></div>
                    
                    <!-- Actions -->
                    <button class="btn-primary" onclick="showNewAppointmentForm()" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">‚ûï New</button>
                    <button class="btn-secondary" onclick="markDateBusy()" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">üö´ Busy</button>
                </div>

                <!-- New Appointment Form -->
                <div id="newAppointmentForm" style="display: none; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin-bottom: 20px; font-size: 24px;">üìù New Appointment</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date</label>
                            <input type="date" id="appointmentDate" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Time</label>
                            <input type="time" id="appointmentTime" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Duration (minutes)</label>
                            <input type="number" id="appointmentDuration" value="30" min="15" step="15" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Title</label>
                            <input type="text" id="appointmentTitle" placeholder="Appointment title" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Customer Name</label>
                            <input type="text" id="appointmentCustomerName" placeholder="Optional" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Customer Phone</label>
                            <input type="tel" id="appointmentCustomerPhone" placeholder="Optional" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Description</label>
                        <textarea id="appointmentDescription" rows="3" placeholder="Optional notes..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px; font-family: inherit;"></textarea>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button class="btn-primary" onclick="saveAppointment()" style="padding: 12px 30px;">üíæ Save Appointment</button>
                        <button class="btn-secondary" onclick="hideNewAppointmentForm()" style="padding: 12px 30px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="calendarGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (First Login) -->
    <div id="accountRestrictionOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-modal" style="max-width: 680px;">
            <div id="accountRestrictionIcon" class="welcome-icon">üîí</div>
            <h1 id="accountRestrictionTitle" class="welcome-title">Account Suspended</h1>
            <p id="accountRestrictionMessage" class="welcome-subtitle">Your account is currently restricted. Please contact support.</p>
            <div style="display:flex; gap: 12px; justify-content:center; margin-top: 18px;">
                <button class="btn-secondary" onclick="logout()" style="padding: 12px 26px; font-weight: 800;">Sign out</button>
            </div>
        </div>
    </div>

    <div id="welcomeOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-modal">
            <div class="welcome-icon">üëã</div>
            <h1 class="welcome-title">Welcome to Your New Account!</h1>
            <p class="welcome-subtitle">
                We're setting up your AI phone agent. You'll forward your calls to this number so your AI can answer.
            </p>
            <div class="progress-container">
                <div class="progress-label">üîç Searching for your new number...</div>
                <div class="progress-bar-bg">
                    <div id="welcomeProgressBar" class="progress-bar-fill" style="width: 0%;"></div>
                </div>
                <div id="welcomeProgressMessage" class="progress-message">Initializing...</div>
            </div>
        </div>
    </div>

    <!-- Footer - Hidden on admin dashboard -->
    <footer style="display: none; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%); padding: 30px 20px; margin-top: 50px; border-top: 3px solid rgba(102, 126, 234, 0.3);">
        <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
            <div style="margin-bottom: 20px;">
                <h3 style="color: #66c8ea; font-size: 24px; margin-bottom: 10px; font-weight: 700;">Hi Julie</h3>
                <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">AI-Powered Phone Assistant</p>
            </div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; margin-bottom: 20px;">
                <a href="/static/terms.html" style="color: #66c8ea; text-decoration: none; font-size: 14px; transition: all 0.3s ease;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#66c8ea'">üìã Terms of Service</a>
                <a href="mailto:team@hijulie.com" style="color: #66c8ea; text-decoration: none; font-size: 14px; transition: all 0.3s ease;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#66c8ea'">‚úâÔ∏è Contact Us</a>
            </div>
            <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 20px;">
                <p style="color: rgba(255, 255, 255, 0.5); font-size: 12px; margin-bottom: 5px;">
                    ¬© 2025 Hi Julie. All rights reserved.
                </p>
                <p style="color: rgba(255, 255, 255, 0.4); font-size: 11px;">
                    Company No. 16685106 | Registered in England and Wales
                </p>
            </div>
        </div>
    </footer>
</body>
</html>